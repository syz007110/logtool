# ============================================
# 本地到云服务器的无感重定向配置
# ============================================
# 
# 使用方法：
# 1. 修改下面的 CLOUD_SERVER_URL 为你的云服务器地址
# 2. 将此配置合并到你的 nginx.conf 或 nginx-windows.conf 中
# 3. 或者创建一个新的 server 块，监听本地端口
# 4. 重启 Nginx: nginx -s reload (Linux) 或重启 Nginx 服务 (Windows)
#
# 方案说明：
# - 方案A：完全重定向（推荐）- 所有请求都重定向到云服务器
# - 方案B：部分重定向 - 只重定向 API 请求，静态资源本地提供
# - 方案C：智能重定向 - 根据路径或条件选择性重定向
#
# ============================================

# 配置云服务器地址（请修改为你的云服务器地址）
# 示例：
#   - HTTP:  http://42.121.15.87
#   - HTTPS: https://your-domain.com
#   - 带端口: http://42.121.15.87:8080
map $request_uri $cloud_server_url {
    default "http://42.121.15.87";  # 修改为你的云服务器地址
}

# ============================================
# 方案A：完全重定向（最简单，最无感）
# ============================================
# 所有请求都重定向到云服务器，包括静态资源
# 优点：配置简单，完全无感
# 缺点：静态资源也需要从云服务器加载
# ============================================
server {
    listen 80;
    server_name 192.168.1.100;  # 修改为你的本地 IP 或域名
    
    # 日志配置
    access_log C:/nginx/logs/redirect-access.log;
    error_log C:/nginx/logs/redirect-error.log;
    
    # 完全重定向：所有请求都重定向到云服务器
    location / {
        # 301 永久重定向（浏览器会缓存，SEO友好）
        # 如果只是临时迁移，可以使用 302 临时重定向
        return 301 $cloud_server_url$request_uri;
        
        # 或者使用 302 临时重定向（不缓存，适合测试阶段）
        # return 302 $cloud_server_url$request_uri;
    }
}

# ============================================
# 方案B：部分重定向（推荐用于过渡期）
# ============================================
# API 请求重定向到云服务器，静态资源本地提供
# 优点：静态资源加载快，减少云服务器带宽
# 缺点：需要维护两套部署
# ============================================
# server {
#     listen 80;
#     server_name 192.168.1.100;  # 修改为你的本地 IP 或域名
#     
#     # 前端静态文件目录（本地）
#     root C:/www/logtool;  # 修改为你的前端构建文件目录
#     index index.html;
#     
#     # 日志配置
#     access_log C:/nginx/logs/redirect-access.log;
#     error_log C:/nginx/logs/redirect-error.log;
#     
#     # 静态资源本地提供（最高优先级）
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#         try_files $uri =404;
#     }
#     
#     # API 请求重定向到云服务器
#     location /api {
#         # 使用 proxy_pass 转发请求（保持原始请求信息）
#         proxy_pass $cloud_server_url;
#         proxy_http_version 1.1;
#         
#         # WebSocket 支持
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         
#         # 标准代理头
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header X-Forwarded-Port $server_port;
#         
#         # 超时设置
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         
#         # 缓冲设置
#         proxy_buffering off;
#         proxy_request_buffering off;
#     }
#     
#     # WebSocket 重定向
#     location /ws {
#         proxy_pass $cloud_server_url;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "Upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         proxy_connect_timeout 7d;
#         proxy_send_timeout 7d;
#         proxy_read_timeout 7d;
#     }
#     
#     # 健康检查重定向
#     location /health {
#         proxy_pass $cloud_server_url/health;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         proxy_connect_timeout 5s;
#         proxy_send_timeout 5s;
#         proxy_read_timeout 5s;
#         proxy_buffering off;
#     }
#     
#     # 前端路由（本地提供）
#     location / {
#         try_files $uri $uri/ /index.html;
#     }
# }

# ============================================
# 方案C：智能重定向（根据条件选择性重定向）
# ============================================
# 可以根据 IP、User-Agent、路径等条件选择性重定向
# 优点：灵活，可以逐步迁移
# 缺点：配置复杂
# ============================================
# # 定义需要重定向的路径
# map $request_uri $should_redirect {
#     default 1;  # 默认重定向
#     ~^/static/ 0;  # /static/ 路径不重定向（本地提供）
# }
# 
# server {
#     listen 80;
#     server_name 192.168.1.100;
#     
#     root C:/www/logtool;
#     index index.html;
#     
#     # 根据条件决定是否重定向
#     location / {
#         if ($should_redirect) {
#             return 301 $cloud_server_url$request_uri;
#         }
#         try_files $uri $uri/ /index.html;
#     }
# }
