"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[700],{7700:function(e,a,t){t.r(a),t.d(a,{default:function(){return le}});var l=t(641),n=t(33);const o={class:"batch-analysis-container"},r={class:"analysis-card-wrapper"},i={class:"card-header",style:{borderBottom:"none"}},s={class:"header-left"},u={class:"selected-files-tooltip"},d={class:"header-right"},c={class:"search-section",style:{marginTop:"8px"}},p={class:"search-grid"},v={class:"grid-item"},g={class:"grid-item"},m={class:"grid-item"},h={class:"advanced-actions"},f={key:0,class:"advanced-summary"},b={class:"grid-item"},y={key:0,class:"search-expression"},w={class:"expr"},k={class:"entries-section"},C={class:"section-header"},A={key:0,class:"loading-section"},x={key:1,class:"table-container"},_={key:2,class:"pagination-wrapper"},S={class:"advanced-filter"},L={class:"section"},N={class:"section-title-row"},R={class:"ops-right"},F={key:0,class:"expr-preview",ref:"exprPreviewRef"},T={class:"expr"},E={key:1,class:"common-templates"},D={class:"tags-ops"},W={class:"tags-wrap antd-tags single-select"},O={class:"group-root"},K={class:"group-header"},V={class:"group-actions"},z={class:"section"},I={class:"import-row"},G={class:"dialog-footer"};function M(e,a,t,M,B,X){const j=(0,l.g2)("el-tag"),$=(0,l.g2)("el-tooltip"),H=(0,l.g2)("Download"),U=(0,l.g2)("el-icon"),Y=(0,l.g2)("el-button"),q=(0,l.g2)("DataAnalysis"),Q=(0,l.g2)("el-date-picker"),J=(0,l.g2)("Search"),P=(0,l.g2)("el-input"),Z=(0,l.g2)("el-empty"),ee=(0,l.g2)("ExplanationCell"),ae=(0,l.g2)("VirtualTable"),te=(0,l.g2)("el-table-column"),le=(0,l.g2)("el-table"),ne=(0,l.g2)("el-pagination"),oe=(0,l.g2)("el-card"),re=(0,l.g2)("el-switch"),ie=(0,l.g2)("a-checkable-tag"),se=(0,l.g2)("el-radio-button"),ue=(0,l.g2)("el-radio-group"),de=(0,l.g2)("ConditionGroup"),ce=(0,l.g2)("el-upload"),pe=(0,l.g2)("el-dialog"),ve=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",o,[(0,l.Lk)("div",r,[(0,l.bF)(oe,{class:"analysis-card"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",i,[(0,l.Lk)("div",s,[a[9]||(a[9]=(0,l.Lk)("span",{class:"title"},"批量日志查看",-1)),M.batchCount>0&&M.selectedLogsCount>0?((0,l.uX)(),(0,l.Wv)(j,{key:0,type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 设备编号："+(0,n.v_)(M.selectedLogs[0]?.device_id||"未知"),1)]),_:1})):(0,l.Q3)("",!0),(0,l.bF)($,{placement:"bottom",effect:"light",transition:"el-fade-in-linear","popper-class":"selected-files-popper",disabled:0===M.selectedLogsCount},{content:(0,l.k6)(()=>[(0,l.Lk)("div",u,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(M.selectedLogs,e=>((0,l.uX)(),(0,l.Wv)(j,{key:e.id,size:"small",style:{margin:"2px 4px 2px 0"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(e.original_name),1)]),_:2},1024))),128))])]),default:(0,l.k6)(()=>[(0,l.bF)(j,{type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 已选择 "+(0,n.v_)(M.selectedLogsCount)+" 个日志文件 ",1)]),_:1})]),_:1},8,["disabled"])]),(0,l.Lk)("div",d,[!M.loading&&M.batchCount>0?((0,l.uX)(),(0,l.Wv)(Y,{key:0,onClick:M.exportToCSV,type:"success",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(U,null,{default:(0,l.k6)(()=>[(0,l.bF)(H)]),_:1}),a[10]||(a[10]=(0,l.eW)(" 导出CSV "))]),_:1,__:[10]},8,["onClick"])):(0,l.Q3)("",!0),!M.loading&&M.selectedLogsCount>0&&M.batchCount>0?((0,l.uX)(),(0,l.Wv)(Y,{key:1,onClick:M.showSurgeryStatistics,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.bF)(U,null,{default:(0,l.k6)(()=>[(0,l.bF)(q)]),_:1}),a[11]||(a[11]=(0,l.eW)(" 手术统计 "))]),_:1,__:[11]},8,["onClick"])):(0,l.Q3)("",!0)])]),(0,l.Lk)("div",c,[(0,l.Lk)("div",p,[(0,l.Lk)("div",v,[a[12]||(a[12]=(0,l.Lk)("div",{class:"item-title"},"时间范围",-1)),(0,l.bF)(Q,{modelValue:M.timeRange,"onUpdate:modelValue":a[0]||(a[0]=e=>M.timeRange=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",class:"time-range",size:"small","default-value":M.defaultPickerRange,"disabled-date":M.disableOutOfRangeDates,onChange:M.handleTimeRangeChange},null,8,["modelValue","default-value","disabled-date","onChange"])]),(0,l.Lk)("div",g,[a[13]||(a[13]=(0,l.Lk)("div",{class:"item-title"},"关键字",-1)),(0,l.bF)(P,{modelValue:M.searchKeyword,"onUpdate:modelValue":a[1]||(a[1]=e=>M.searchKeyword=e),placeholder:"搜索释义内容或故障码",class:"search-input",clearable:"",onInput:M.handleSearch,onCompositionstart:e.onCompositionStart,onCompositionend:e.onCompositionEnd,size:"small"},{prefix:(0,l.k6)(()=>[(0,l.bF)(U,null,{default:(0,l.k6)(()=>[(0,l.bF)(J)]),_:1})]),_:1},8,["modelValue","onInput","onCompositionstart","onCompositionend"])]),(0,l.Lk)("div",m,[a[15]||(a[15]=(0,l.Lk)("div",{class:"item-title"},"高级搜索",-1)),(0,l.Lk)("div",h,[(0,l.bF)(Y,{size:"small",type:"primary",plain:"",onClick:a[2]||(a[2]=e=>M.showAdvancedFilter=!0)},{default:(0,l.k6)(()=>a[14]||(a[14]=[(0,l.eW)("打开高级筛选")])),_:1,__:[14]}),M.leafConditionCount>0?((0,l.uX)(),(0,l.CE)("div",f," 已添加 "+(0,n.v_)(M.leafConditionCount)+" 个条件（逻辑："+(0,n.v_)(M.filtersRoot.logic)+"） ",1)):(0,l.Q3)("",!0)])]),(0,l.Lk)("div",b,[a[17]||(a[17]=(0,l.Lk)("div",{class:"item-title"},"清除搜索",-1)),(0,l.bF)(Y,{size:"small",onClick:M.clearFilters},{default:(0,l.k6)(()=>a[16]||(a[16]=[(0,l.eW)("清除所有条件")])),_:1,__:[16]},8,["onClick"])])]),M.searchExpression?((0,l.uX)(),(0,l.CE)("div",y,[a[18]||(a[18]=(0,l.Lk)("span",{class:"label"},"搜索表达式：",-1)),(0,l.Lk)("span",w,(0,n.v_)(M.searchExpression),1)])):(0,l.Q3)("",!0)]),(0,l.Lk)("div",k,[(0,l.Lk)("div",C,[(0,l.Lk)("h3",null,"日志条目 ("+(0,n.v_)(M.filteredCount)+")",1)]),M.loading?((0,l.uX)(),(0,l.CE)("div",A,[(0,l.bF)(Z,{description:"正在加载日志数据..."})])):((0,l.uX)(),(0,l.CE)("div",x,[M.useVirtualScroll?((0,l.uX)(),(0,l.Wv)(ae,{key:0,ref:"virtualTableRef",data:M.paginatedEntries,columns:M.tableColumns,"item-height":40,buffer:10,style:{height:"60vh"},class:"antd-table",onLoadMore:M.handleLoadMore},{log_name:(0,l.k6)(({row:e})=>[(0,l.bF)(ee,{text:e.log_name},null,8,["text"])]),timestamp:(0,l.k6)(({row:e})=>[(0,l.eW)((0,n.v_)(M.formatTimestamp(e.timestamp)),1)]),explanation:(0,l.k6)(({row:e})=>[(0,l.bF)(ee,{text:e.explanation},null,8,["text"])]),_:1},8,["data","columns","onLoadMore"])):(0,l.bo)(((0,l.uX)(),(0,l.Wv)(le,{key:1,data:M.paginatedEntries,style:{width:"100%"},height:"60vh",stripe:!1,class:"antd-table","table-layout":"fixed",onCurrentChange:M.forceRelayout,onSelectionChange:M.forceRelayout,onSortChange:M.forceRelayout,onFilterChange:M.forceRelayout,onExpandChange:M.forceRelayout},{default:(0,l.k6)(()=>[(0,l.bF)(te,{prop:"log_name",label:"日志文件",width:"150"},{default:(0,l.k6)(({row:e})=>[(0,l.bF)(ee,{text:e.log_name},null,8,["text"])]),_:1}),(0,l.bF)(te,{prop:"timestamp",label:"时间戳",width:"180",sortable:""},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,n.v_)(M.formatTimestamp(e.timestamp)),1)]),_:1}),(0,l.bF)(te,{prop:"error_code",label:"故障码",width:"120",sortable:""}),(0,l.bF)(te,{prop:"param1",label:"参数1",width:"100"}),(0,l.bF)(te,{prop:"param2",label:"参数2",width:"100"}),(0,l.bF)(te,{prop:"param3",label:"参数3",width:"100"}),(0,l.bF)(te,{prop:"param4",label:"参数4",width:"100"}),(0,l.bF)(te,{prop:"explanation",label:"释义",width:"400"},{default:(0,l.k6)(({row:e})=>[(0,l.bF)(ee,{text:e.explanation},null,8,["text"])]),_:1})]),_:1},8,["data","onCurrentChange","onSelectionChange","onSortChange","onFilterChange","onExpandChange"])),[[ve,M.loading]])])),M.filteredCount>0?((0,l.uX)(),(0,l.CE)("div",_,[(0,l.bF)(ne,{"current-page":M.currentPage,"page-size":M.pageSize,"page-sizes":[50,100,200,500],total:M.totalCount,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M.handleSizeChange,onCurrentChange:M.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):(0,l.Q3)("",!0)])]),_:1})]),(0,l.bF)(pe,{modelValue:M.showAdvancedFilter,"onUpdate:modelValue":a[8]||(a[8]=e=>M.showAdvancedFilter=e),title:"高级筛选",width:"880px"},{footer:(0,l.k6)(()=>[(0,l.Lk)("span",G,[(0,l.bF)(Y,{onClick:a[7]||(a[7]=e=>M.showAdvancedFilter=!1)},{default:(0,l.k6)(()=>a[32]||(a[32]=[(0,l.eW)("取消")])),_:1,__:[32]}),(0,l.bF)(Y,{type:"primary",onClick:M.applyAdvancedFilters},{default:(0,l.k6)(()=>a[33]||(a[33]=[(0,l.eW)("应用")])),_:1,__:[33]},8,["onClick"])])]),default:(0,l.k6)(()=>[(0,l.Lk)("div",S,[(0,l.Lk)("div",L,[(0,l.Lk)("div",N,[a[20]||(a[20]=(0,l.Lk)("div",{class:"section-title"},"1. 条件组（支持嵌套）",-1)),(0,l.Lk)("div",R,[(0,l.bF)(re,{modelValue:M.useLocalAdvanced,"onUpdate:modelValue":a[3]||(a[3]=e=>M.useLocalAdvanced=e),size:"small","active-text":"本地","inactive-text":"服务端","inline-prompt":""},null,8,["modelValue"]),(0,l.bF)(Y,{size:"small",type:"danger",text:"",onClick:M.clearAllConditionsOnly,disabled:!M.filtersRoot.conditions||0===M.filtersRoot.conditions.length},{default:(0,l.k6)(()=>a[19]||(a[19]=[(0,l.eW)("清空所有条件")])),_:1,__:[19]},8,["onClick","disabled"])])]),M.advancedExpression?((0,l.uX)(),(0,l.CE)("div",F,[a[21]||(a[21]=(0,l.Lk)("span",{class:"label"},"表达式预览：",-1)),(0,l.Lk)("span",T,(0,n.v_)(M.advancedExpression),1)],512)):(0,l.Q3)("",!0),M.templates&&M.templates.length?((0,l.uX)(),(0,l.CE)("div",E,[a[24]||(a[24]=(0,l.Lk)("div",{class:"section-title"},"常用搜索表达式",-1)),(0,l.Lk)("div",D,[(0,l.bF)(Y,{size:"small",type:"primary",plain:"",onClick:M.applySelectedTemplate,disabled:!M.selectedTemplateName},{default:(0,l.k6)(()=>a[22]||(a[22]=[(0,l.eW)("应用选择表达式")])),_:1,__:[22]},8,["onClick","disabled"]),a[23]||(a[23]=(0,l.Lk)("span",{class:"hint"},"选择表达式并应用，条件会自动填充进“添加条件”区域",-1))]),(0,l.Lk)("div",W,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(M.templates,e=>((0,l.uX)(),(0,l.Wv)(ie,{key:e.name,checked:M.selectedTemplateName===e.name,onChange:a=>M.onTemplateSingleSelect(e.name,a),class:"tpl-tag bordered"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(e.name),1)]),_:2},1032,["checked","onChange"]))),128))])])):(0,l.Q3)("",!0),(0,l.Lk)("div",O,[(0,l.Lk)("div",K,[a[29]||(a[29]=(0,l.Lk)("span",null,"根组逻辑：",-1)),(0,l.bF)(ue,{modelValue:M.filtersRoot.logic,"onUpdate:modelValue":a[4]||(a[4]=e=>M.filtersRoot.logic=e)},{default:(0,l.k6)(()=>[(0,l.bF)(se,{label:"AND"},{default:(0,l.k6)(()=>a[25]||(a[25]=[(0,l.eW)("AND")])),_:1,__:[25]}),(0,l.bF)(se,{label:"OR"},{default:(0,l.k6)(()=>a[26]||(a[26]=[(0,l.eW)("OR")])),_:1,__:[26]})]),_:1},8,["modelValue"]),(0,l.Lk)("div",V,[(0,l.bF)(Y,{size:"small",type:"primary",onClick:a[5]||(a[5]=e=>M.addConditionToGroup(M.filtersRoot))},{default:(0,l.k6)(()=>a[27]||(a[27]=[(0,l.eW)("添加条件")])),_:1,__:[27]}),(0,l.bF)(Y,{size:"small",onClick:a[6]||(a[6]=e=>M.addGroupToGroup(M.filtersRoot))},{default:(0,l.k6)(()=>a[28]||(a[28]=[(0,l.eW)("添加子组")])),_:1,__:[28]})])]),(0,l.bF)(de,{group:M.filtersRoot,"get-operator-options":M.getOperatorOptions,"on-field-change":M.onFieldChange,"on-operator-change":M.onOperatorChange,"add-condition-to-group":M.addConditionToGroup,"add-group-to-group":M.addGroupToGroup,"remove-node-at":M.removeNodeAt,"is-root":!0},null,8,["group","get-operator-options","on-field-change","on-operator-change","add-condition-to-group","add-group-to-group","remove-node-at"])])]),(0,l.Lk)("div",z,[a[31]||(a[31]=(0,l.Lk)("div",{class:"section-title"},"2. 导入表达式",-1)),(0,l.Lk)("div",I,[(0,l.bF)(ce,{"show-file-list":!1,accept:"application/json","before-upload":M.beforeImportTemplates},{default:(0,l.k6)(()=>[(0,l.bF)(Y,{size:"small"},{default:(0,l.k6)(()=>a[30]||(a[30]=[(0,l.eW)("从文件导入(JSON)")])),_:1,__:[30]})]),_:1},8,["before-upload"])])])])]),_:1},8,["modelValue"])])}var B=t(953),X=t(6278),j=t(5220),$=t(163),H=t(8548),U=t(5495);const Y={class:"virtual-table-container",ref:"containerRef"},q={key:0,class:"virtual-table-header"};function Q(e,a,t,o,r,i){return(0,l.uX)(),(0,l.CE)("div",Y,[t.showHeader?((0,l.uX)(),(0,l.CE)("div",q,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(t.columns,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.prop,class:"virtual-table-cell header-cell",style:(0,n.Tr)({width:e.width||"auto",minWidth:e.minWidth||"auto"})},(0,n.v_)(e.label),5))),128))])):(0,l.Q3)("",!0),(0,l.Lk)("div",{class:"virtual-table-body",ref:"bodyRef",onScroll:a[0]||(a[0]=(...e)=>o.handleScroll&&o.handleScroll(...e))},[(0,l.Lk)("div",{class:"virtual-table-spacer",style:(0,n.Tr)({height:o.totalHeight+"px"})},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(o.visibleItems,(a,r)=>((0,l.uX)(),(0,l.CE)("div",{class:"virtual-table-row",key:o.getItemKey(a,o.startIndex+r),style:(0,n.Tr)({transform:`translateY(${(o.startIndex+r)*t.itemHeight}px)`,height:t.itemHeight+"px"})},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(t.columns,t=>((0,l.uX)(),(0,l.CE)("div",{key:t.prop,class:"virtual-table-cell",style:(0,n.Tr)({width:t.width||"auto",minWidth:t.minWidth||"auto"})},[(0,l.RG)(e.$slots,t.prop,{row:a,column:t,index:o.startIndex+r},()=>[(0,l.eW)((0,n.v_)(o.getCellValue(a,t.prop)),1)],!0)],4))),128))],4))),128))],4)],544)],512)}var J={name:"VirtualTable",props:{data:{type:Array,default:()=>[]},columns:{type:Array,default:()=>[]},itemHeight:{type:Number,default:40},showHeader:{type:Boolean,default:!0},itemKey:{type:String,default:"id"},buffer:{type:Number,default:5}},emits:["scroll","load-more"],setup(e,{emit:a}){const t=(0,B.KR)(null),n=(0,B.KR)(null),o=(0,B.KR)(0),r=(0,B.KR)(0),i=(0,l.EW)(()=>e.data.length*e.itemHeight),s=(0,l.EW)(()=>{const a=Math.floor(o.value/e.itemHeight),t=Math.ceil(r.value/e.itemHeight),l=Math.min(a+t+2*e.buffer,e.data.length),n=Math.max(0,a-e.buffer);return{start:n,end:l,startIndex:n}}),u=(0,l.EW)(()=>{const{start:a,end:t}=s.value;return e.data.slice(a,t)}),d=(0,l.EW)(()=>s.value.startIndex),c=(e,a)=>"function"===typeof a?a(e):e[a],p=(a,t)=>e.itemKey&&a[e.itemKey]?a[e.itemKey]:t,v=t=>{o.value=t.target.scrollTop,a("scroll",t);const{end:l}=s.value;l>=e.data.length-e.buffer&&a("load-more")},g=async()=>{await(0,l.dY)(),t.value&&(r.value=t.value.clientHeight)},m=a=>{if(n.value){const t=a*e.itemHeight;n.value.scrollTop=t}},h=()=>{m(0)},f=()=>{m(e.data.length-1)};return(0,l.sV)(()=>{g(),window.addEventListener("resize",g)}),(0,l.hi)(()=>{window.removeEventListener("resize",g)}),(0,l.wB)(()=>e.data.length,()=>{g()}),{containerRef:t,bodyRef:n,scrollTop:o,containerHeight:r,totalHeight:i,visibleItems:u,startIndex:d,getCellValue:c,getItemKey:p,handleScroll:v,scrollTo:m,scrollToTop:h,scrollToBottom:f}}},P=t(6262);const Z=(0,P.A)(J,[["render",Q],["__scopeId","data-v-2c01bede"]]);var ee=Z,ae={name:"BatchAnalysis",components:{Search:H.Search,Download:H.Download,ArrowLeft:H.ArrowLeft,DataAnalysis:H.DataAnalysis,Warning:H.Warning,VirtualTable:ee,ExplanationCell:{name:"ExplanationCell",props:{text:{type:String,default:""}},setup(e){const a=(0,B.KR)(null),t=(0,B.KR)(!1);let n=null;const o=()=>{const e=a.value;e&&(t.value=e.scrollWidth-e.clientWidth>1)},r=()=>{o()};return(0,l.sV)(async()=>{await(0,l.dY)(),o(),"ResizeObserver"in window?(n=new ResizeObserver(()=>o()),a.value&&n.observe(a.value)):window.addEventListener("resize",o)}),(0,l.xo)(()=>{n&&a.value&&n.unobserve(a.value),n&&n.disconnect(),n=null,window.removeEventListener("resize",o)}),()=>(0,l.h)((0,l.g2)("el-tooltip"),{content:e.text,placement:"top",effect:"dark",popperClass:"explanation-tooltip dark",teleported:!0,showAfter:120,disabled:!t.value},{default:()=>(0,l.h)("span",{ref:a,class:"explanation-ellipsis",style:"display:inline-block;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;",onMouseenter:r},e.text)})}},ConditionGroup:{name:"ConditionGroup",props:{group:{type:Object,required:!0},getOperatorOptions:{type:Function,required:!0},onFieldChange:{type:Function,required:!0},onOperatorChange:{type:Function,required:!0},addConditionToGroup:{type:Function,required:!0},addGroupToGroup:{type:Function,required:!0},removeNodeAt:{type:Function,required:!0},isRoot:{type:Boolean,default:!1}},setup(e){const a=(0,l.g2)("el-select"),t=(0,l.g2)("el-option"),n=(0,l.g2)("el-input"),o=(0,l.g2)("el-button"),r=(0,l.g2)("el-radio-group"),i=(0,l.g2)("el-radio-button"),s=(0,l.g2)("ConditionGroup"),u=(r,i,s)=>(0,l.h)("div",{class:"condition",key:i},[(0,l.h)(a,{modelValue:r.field,style:"width: 140px;",placeholder:"字段","onUpdate:modelValue":a=>{"object"===typeof r&&null!==r?(r.field=a,e.onFieldChange(r)):(Object.assign(r,{field:a}),e.onFieldChange(r))}},{default:()=>[(0,l.h)(t,{label:"时间戳",value:"timestamp"}),(0,l.h)(t,{label:"故障码",value:"error_code"}),(0,l.h)(t,{label:"参数1",value:"param1"}),(0,l.h)(t,{label:"参数2",value:"param2"}),(0,l.h)(t,{label:"参数3",value:"param3"}),(0,l.h)(t,{label:"参数4",value:"param4"}),(0,l.h)(t,{label:"释义",value:"explanation"})]}),(0,l.h)(a,{modelValue:r.operator,style:"width: 150px; margin-left: 8px;",placeholder:"操作符","onUpdate:modelValue":a=>{"object"===typeof r&&null!==r?(r.operator=a,e.onOperatorChange(r)):(Object.assign(r,{operator:a}),e.onOperatorChange(r))}},{default:()=>(e.getOperatorOptions(r.field)||[]).map(e=>(0,l.h)(t,{label:e.label,value:e.value,key:e.value}))}),"between"===r.operator?[(0,l.h)(n,{modelValue:Array.isArray(r.value)?r.value[0]:"",placeholder:"起",style:"width: 140px; margin-left:8px;","onUpdate:modelValue":e=>{const a=Array.isArray(r.value)?r.value.slice(0,2):["",""];a[0]=e,r.value=a}}),(0,l.h)(n,{modelValue:Array.isArray(r.value)?r.value[1]:"",placeholder:"止",style:"width: 140px; margin-left:8px;","onUpdate:modelValue":e=>{const a=Array.isArray(r.value)?r.value.slice(0,2):["",""];a[1]=e,r.value=a}})]:(0,l.h)(n,{modelValue:Array.isArray(r.value)?r.value.join(","):r.value??"",placeholder:"值",style:"width: 300px; margin-left:8px;","onUpdate:modelValue":e=>{"object"===typeof r.value&&null!==r.value?r.value=e:Object.assign(r,{value:e})}}),(0,l.h)(o,{type:"danger",text:!0,style:"margin-left:8px;",onClick:()=>e.removeNodeAt(s,i)},{default:()=>"删除"})]),d=(a,t,n=0)=>{const d=Array.isArray(a.conditions)?a.conditions:[],c=n>0?`margin-left: ${12*n}px;`:"";return(0,l.h)("div",{class:"group-box",style:c},[...d.map((t,d)=>t&&t.field?u(t,d,a):(0,l.h)("div",{class:"group-box",key:d,style:`margin-left: ${12*(n+1)}px;`},[(0,l.h)("div",{class:"group-header nested"},[(0,l.h)("span",null,"组逻辑："),(0,l.h)(r,{modelValue:t.logic||"AND","onUpdate:modelValue":e=>{"object"===typeof t&&null!==t?t.logic=e:Object.assign(t,{logic:e})}},{default:()=>[(0,l.h)(i,{label:"AND"},{default:()=>"AND"}),(0,l.h)(i,{label:"OR"},{default:()=>"OR"})]}),(0,l.h)("div",{class:"group-actions"},[(0,l.h)(o,{size:"small",type:"primary",onClick:()=>e.addConditionToGroup(t)},{default:()=>"添加条件"}),(0,l.h)(o,{size:"small",onClick:()=>e.addGroupToGroup(t)},{default:()=>"添加子组"}),(0,l.h)(o,{size:"small",type:"danger",text:!0,onClick:()=>e.removeNodeAt(a,d)},{default:()=>"删除组"})])]),(0,l.h)(s,{group:t,getOperatorOptions:e.getOperatorOptions,onFieldChange:e.onFieldChange,onOperatorChange:e.onOperatorChange,addConditionToGroup:e.addConditionToGroup,addGroupToGroup:e.addGroupToGroup,removeNodeAt:e.removeNodeAt,depth:n+1})])),(0,l.h)("div",{class:"group-actions"},[(0,l.h)(o,{size:"small",type:"primary",onClick:()=>e.addConditionToGroup(a)},{default:()=>"添加条件"}),(0,l.h)(o,{size:"small",onClick:()=>e.addGroupToGroup(a)},{default:()=>"添加子组"})])])};return()=>d(e.group,e.group,0)}}},setup(){const e=(0,X.Pj)(),a=(0,j.lq)(),t=(0,j.rd)(),n=(0,B.KR)(!1),o=(0,B.KR)([]),r=(0,B.KR)([]),i=(0,B.KR)(""),s=(0,B.KR)(null),u=(0,B.KR)(1),d=(0,B.KR)(100),c=(0,B.KR)(0),p=(0,B.KR)(0),v=(0,B.KR)(null),g=(0,B.KR)(null),m=(0,B.KR)(!1),h=(0,B.KR)(!1),f=(0,B.KR)(!0),b=(0,B.KR)(!1),y=(0,B.KR)(null),w=(0,B.KR)([{prop:"log_name",label:"日志文件",width:"150px"},{prop:"timestamp",label:"时间戳",width:"180px"},{prop:"error_code",label:"故障码",width:"120px"},{prop:"param1",label:"参数1",width:"100px"},{prop:"param2",label:"参数2",width:"100px"},{prop:"param3",label:"参数3",width:"100px"},{prop:"param4",label:"参数4",width:"100px"},{prop:"explanation",label:"释义",width:"400px"}]),k=(0,B.KR)(!1),C=(0,B.KR)({logic:"AND",conditions:[]}),A=(0,B.KR)(!1),x=(0,B.KR)(null),_=(0,B.KR)(!1),S=(0,B.KR)([]),L=(0,B.KR)(""),N=(0,B.KR)(""),R=e=>{if(!e)return"";if(e.field&&e.operator){const a=Array.isArray(e.value)?e.value.join(","):e.value??"";return`${e.field} ${e.operator} ${a}`}if(Array.isArray(e.conditions)){const a=e.logic||"AND",t=e.conditions.map(e=>R(e)).filter(Boolean).join(` ${a} `);return t?(C.value,`(${t})`):""}return""},F=(0,l.EW)(()=>{const e=[];if(s.value&&2===s.value.length){const[a,t]=s.value;e.push(`时间: ${de(a)} ~ ${de(t)}`)}i.value&&e.push(`关键字(全部): ${i.value}`);const a=R(C.value);return a&&e.push(`${a}`),e.join(" AND ")}),T=(0,l.EW)(()=>{const e=R(C.value);return e||""}),E=e=>e?e.field&&e.operator?1:Array.isArray(e.conditions)?e.conditions.reduce((e,a)=>e+E(a),0):0:0,D=(0,l.EW)(()=>E(C.value)),W=(0,l.EW)(()=>{const e=Array.isArray(r.value)?r.value:[];let a=e;return m.value&&h.value&&D.value>0&&(a=a.filter(e=>Ae(e))),a}),O=(0,l.EW)(()=>Array.isArray(r.value)?r.value.length:0),K=(0,l.EW)(()=>Array.isArray(o.value)?o.value.length:0),V=(0,l.EW)(()=>c.value),z=(0,l.EW)(()=>{if(v.value&&g.value){const e=new Date(v.value),a=new Date(g.value);if(!Number.isNaN(e.getTime())&&!Number.isNaN(a.getTime()))return[e,a]}const e=r.value;if(!e||0===e.length)return null;const a=e.map(e=>new Date(e.timestamp)).filter(e=>!isNaN(e));if(0===a.length)return null;const t=new Date(Math.min(...a)),l=new Date(Math.max(...a));return[t,l]}),I=(0,l.EW)(()=>W.value),G=async()=>{const t=a.params?.logIds,l=a.query?.logIds,n=a.params?.id,r=a.query?.id;let i=t||l||n||r;if(!i)return;const s=String(i).split(",").map(e=>parseInt(e)).filter(e=>!Number.isNaN(e));if(0!==s.length)try{const a=await e.dispatch("logs/fetchLogs",{page:1,limit:1e3}),t=a.data.logs;o.value=t.filter(e=>s.includes(e.id))}catch(u){$.nk.error("获取日志信息失败")}},M=async(a=1,t=!1)=>{if(0!==o.value.length)try{n.value=!0,t&&(r.value=[],u.value=a);const l=o.value.map(e=>e.id).join(","),h={log_ids:l,page:a,limit:d.value};if(m.value&&D.value>0){const e=Ne();e&&(h.filters=JSON.stringify(e))}s.value&&2===s.value.length&&(h.start_time=s.value[0],h.end_time=s.value[1]),i.value&&(h.search=i.value);const f=await e.dispatch("logs/fetchBatchLogEntries",h),{entries:b,total:y,totalPages:w,page:k,minTimestamp:C,maxTimestamp:A}=f.data,x=new Map(o.value.map(e=>[e.id,e.original_name])),_=b.map(e=>({...e,log_name:x.get(e.log_id)||""}));if(t?r.value=_:r.value.push(..._),c.value=y,p.value=w,"number"!==typeof k||Number.isNaN(k)||(u.value=k),C&&A){const e=new Date(C),a=new Date(A);if(!Number.isNaN(e.getTime())&&!Number.isNaN(a.getTime())){v.value=e,g.value=a;const t=!s.value||2!==s.value.length,[l,n]=t?[null,null]:s.value,o=l?new Date(l):null,r=n?new Date(n):null,i=!o||!r||o<e||r>a;(t||i)&&(s.value=[de(e),de(a)])}}}catch(l){$.nk.error("批量分析失败: "+(l.response?.data?.message||l.message))}finally{n.value=!1}},H=(0,B.KR)(!1);let Y=null;const q=()=>{H.value||(Y&&clearTimeout(Y),Y=setTimeout(()=>{u.value=1,M(1,!0)},300))},Q=()=>{q()},J=async()=>{u.value=1,await M(1,!0)},P=()=>{if(z.value&&s.value&&2===s.value.length){const[e,a]=z.value;let[t,l]=s.value;const n=new Date(t),o=new Date(l);let r=!1;n<e&&(t=e,r=!0),o>a&&(l=a,r=!0),r&&(s.value=[de(t),de(l)])}u.value=1,M(1,!0)},Z=async()=>{i.value="",s.value=null,C.value={logic:"AND",conditions:[]},m.value=!1,u.value=1,await M(1,!0)},ee=()=>{C.value&&Array.isArray(C.value.conditions)?C.value.conditions=[]:C.value={logic:"AND",conditions:[]},u.value=1},ae=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),te=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999),le=e=>{if(!z.value||!e)return!1;const[a,t]=z.value;return e<ae(new Date(a))||e>te(new Date(t))},ne=(0,l.EW)(()=>z.value?[z.value[0],z.value[1]]:null),oe=async()=>{try{$.nk.info("正在导出，请稍候...");const e=o.value.map(e=>e.id).join(","),a={log_ids:e};if(m.value&&D.value>0){const e=Ne();e&&(a.filters=JSON.stringify(e))}s.value&&2===s.value.length&&(a.start_time=s.value[0],a.end_time=s.value[1]),i.value&&(a.search=i.value);const t=await U.A.logs.exportBatchEntries(a),l=new Blob([t.data],{type:"text/csv;charset=utf-8"}),n=URL.createObjectURL(l),r=document.createElement("a");r.href=n,r.download=`batch_logs_analysis_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),$.nk.success("CSV导出完成")}catch(e){$.nk.error("导出CSV失败: "+(e.response?.data?.message||e.message))}},re=e=>{d.value=e,u.value=1,M(1,!0)},ie=async e=>{u.value=e,await M(e,!0)},se=async()=>{b.value&&u.value<p.value&&!n.value&&(u.value++,await M(u.value,!1))},ue=()=>{},de=e=>{if(!e)return"-";const a=new Date(e),t=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),o=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0"),i=String(a.getSeconds()).padStart(2,"0");return`${t}-${l}-${n} ${o}:${r}:${i}`},ce=e=>{if(!e||0===e)return"0 B";const a=1024,t=["B","KB","MB","GB"],l=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,l)).toFixed(2))+" "+t[l]},pe=async()=>{if(0===r.value.length)return void $.nk.warning("请先加载日志条目数据");const e=o.value.map(e=>e.id);sessionStorage.setItem("autoAnalyze","true");const a=t.resolve({path:"/surgery-statistics",query:{logIds:e.join(",")}});window.open(a.href,"_blank")},ve=async()=>{try{const e=await U.A.logs.getSearchTemplates();S.value=e.data.templates||[]}catch{}},ge=e=>{const a=S.value.find(a=>a.name===e);a&&(C.value={logic:a.filters?.logic||"AND",conditions:Array.isArray(a.filters?.conditions)?[...a.filters.conditions]:[]})},me=async e=>{try{const a=await e.text(),t=JSON.parse(a);let l="AND",n=[];if(t&&(Array.isArray(t.conditions)||Array.isArray(t.filters?.conditions)))l=t.logic||t.filters?.logic||"AND",n=Array.isArray(t.conditions)?t.conditions:t.filters?.conditions||[];else if(Array.isArray(t.templates)&&t.templates.length>0){const e=t.templates[0];l=e?.filters?.logic||"AND",n=Array.isArray(e?.filters?.conditions)?e.filters.conditions:[]}n.length>0?(C.value={logic:l,conditions:[...n]},$.nk.success("已从文件填充到高级条件")):$.nk.warning("未识别到可用的表达式内容")}catch(a){$.nk.error("解析失败："+a.message)}return!1},he=(e,a)=>{L.value=a?e:""},fe=new Set(["param1","param2","param3","param4"]),be=(e,a,t)=>{const l=String(a||"").toLowerCase(),n=fe.has(e);if(void 0===t||null===t||""===t)return null;if("between"===l||"notbetween"===l){const e=Array.isArray(t)?t:String(t).split(",");if(e.length<2)return null;const a=(e[0]??"").toString().trim(),l=(e[1]??"").toString().trim();if(n){const e=Number(a),t=Number(l);return Number.isNaN(e)||Number.isNaN(t)?null:[e,t]}return[a,l]}if("in"===l||"notin"===l){const e=Array.isArray(t)?t:[t],a=e.map(e=>e.toString().trim()).filter(e=>""!==e);return n?a.map(e=>Number(e)).filter(e=>!Number.isNaN(e)):a}if(n){const e=Number(t);return Number.isNaN(e)?t:e}return t},ye=(e,a)=>"timestamp"===a?new Date(e.timestamp):e[a],we=e=>{const a=Number(e);return Number.isNaN(a)?null:a},ke=(e,a,t,l)=>{const n=String(a||"").toLowerCase(),o=ye(l,e);if(void 0===o||null===o)return!1;const r=fe.has(e),i="timestamp"===e;if("between"===n||"notbetween"===n){const e=Array.isArray(t)?t:String(t??"").split(",");if(e.length<2)return!1;if(r){const a=we(e[0]),t=we(e[1]);if(null===a||null===t)return!1;const l=we(o);if(null===l)return!1;const r=l>=Math.min(a,t)&&l<=Math.max(a,t);return"between"===n?r:!r}if(i){const a=new Date(e[0]),t=new Date(e[1]),l=new Date(o),r=l>=(a<t?a:t)&&l<=(a<t?t:a);return"between"===n?r:!r}const a=String(o),l=a>=String(e[0])&&a<=String(e[1]);return"between"===n?l:!l}if("in"===n||"notin"===n){const e=Array.isArray(t)?t:String(t??"").split(",").map(e=>e.trim()).filter(Boolean);if(r){const a=new Set(e.map(we).filter(e=>null!==e)),t=we(o),l=null!==t&&a.has(t);return"in"===n?l:!l}const a=new Set(e.map(e=>e.toString())),l=a.has(String(o));return"in"===n?l:!l}if("regex"===n)try{const e=new RegExp(String(t));return e.test(String(o))}catch{return!1}if("contains"===n||"like"===n)return String(o).toLowerCase().includes(String(t??"").toLowerCase());if("notcontains"===n)return!String(o).toLowerCase().includes(String(t??"").toLowerCase());if("startswith"===n)return String(o).startsWith(String(t??""));if("endswith"===n)return String(o).endsWith(String(t??""));if(r){const e=we(o),a=we(t);if(null===e||null===a)return!1;switch(n){case"=":return e===a;case"!=":case"<>":return e!==a;case">":return e>a;case">=":return e>=a;case"<":return e<a;case"<=":return e<=a;default:return!1}}if(i){const e=new Date(o).getTime(),a=new Date(t).getTime();switch(n){case"=":return e===a;case"!=":case"<>":return e!==a;case">":return e>a;case">=":return e>=a;case"<":return e<a;case"<=":return e<=a;default:return!1}}const s=String(o),u=String(t??"");switch(n){case"=":return s===u;case"!=":case"<>":return s!==u;case">":return s>u;case">=":return s>=u;case"<":return s<u;case"<=":return s<=u;default:return!1}},Ce=(e,a)=>{if(!e)return!0;if(e.field&&e.operator)return ke(e.field,e.operator,e.value,a);if(Array.isArray(e.conditions)){const t=e.logic||"AND",l=e.conditions.map(e=>Ce(e,a));return"OR"===t?l.some(Boolean):l.every(Boolean)}return!0},Ae=e=>Ce(C.value,e),xe=(0,B.KR)(null),_e=async()=>{if(N.value)try{const e=JSON.parse(N.value);if(e&&(Array.isArray(e.conditions)||Array.isArray(e.filters?.conditions))){const a=e.logic||e.filters?.logic||"AND",t=Array.isArray(e.conditions)?e.conditions:e.filters?.conditions;C.value={logic:a,conditions:Array.isArray(t)?[...t]:[]},$.nk.success("表达式已填充，请点击“应用”执行搜索"),k.value=!0,await(0,l.dY)(),xe.value&&xe.value.scrollIntoView&&xe.value.scrollIntoView({behavior:"smooth",block:"nearest"})}else $.nk.error("JSON格式不正确，缺少 conditions")}catch(e){$.nk.error("解析失败："+e.message)}},Se=async()=>{if(N.value)try{const e=JSON.parse(N.value);if(e&&(Array.isArray(e.conditions)||Array.isArray(e.filters?.conditions))){const a=e.logic||e.filters?.logic||"AND",t=Array.isArray(e.conditions)?e.conditions:e.filters?.conditions;return C.value={logic:a,conditions:Array.isArray(t)?[...t]:[]},void $.nk.success("表达式已填充，请点击“应用”执行搜索")}$.nk.warning("未识别到可用的表达式内容")}catch(e){$.nk.error("仅支持 JSON 格式的表达式导入")}},Le=async()=>{_.value=!0;try{const e=o.value.map(e=>e.id),a=await U.A.surgeryStatistics.analyzeByLogIds(e);a.data.success?$.nk.success(a.data.message||`成功分析出 ${a.data.data?.length||0} 场手术`):$.nk.error(a.data.message||"批量分析手术数据失败")}catch(e){$.nk.error("批量分析手术数据失败: "+(e.response?.data?.message||e.message))}finally{_.value=!1}},Ne=()=>{const e=a=>{if(!a)return null;if(a.field&&a.operator){if(void 0===a.value||null===a.value||""===a.value)return null;const e=be(a.field,a.operator,a.value);return null===e?null:{field:a.field,operator:a.operator,value:e}}if(Array.isArray(a.conditions)){const t=a.conditions.map(e).filter(Boolean);return 0===t.length?null:{logic:a.logic||"AND",conditions:t}}return null},a=e(C.value);return a},Re={timestamp:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"}],error_code:[{label:"=",value:"="},{label:"!=",value:"!="},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"},{label:"正则",value:"regex"},{label:"前缀",value:"startsWith"},{label:"后缀",value:"endsWith"}],param1:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param2:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param3:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param4:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],explanation:[{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"},{label:"正则",value:"regex"},{label:"前缀",value:"startsWith"},{label:"后缀",value:"endsWith"}]},Fe=[{label:"=",value:"="},{label:"!=",value:"!="}],Te=e=>e&&Re[e]||Fe,Ee=e=>{if(!e)return;const a=Te(e.field);a.some(a=>a.value===e.operator)||(e.operator=a[0]?.value),"between"===String(e.operator).toLowerCase()?e.value=Array.isArray(e.value)?e.value.slice(0,2):["",""]:e.value=Array.isArray(e.value)?e.value.join(","):e.value??""},De=e=>{e.conditions||(e.conditions=[]),e.conditions.push({field:"error_code",operator:"contains",value:""})},We=e=>{e.conditions||(e.conditions=[]),e.conditions.push({logic:"AND",conditions:[]})},Oe=(e,a)=>{Array.isArray(e.conditions)&&a>=0&&a<e.conditions.length&&e.conditions.splice(a,1)},Ke=async()=>{k.value=!1,m.value=!0,u.value=1,await M(1,!0)},Ve=()=>{if(!L.value)return;const e=S.value.find(e=>e.name===L.value);e&&(C.value={logic:e.filters?.logic||"AND",conditions:Array.isArray(e.filters?.conditions)?[...e.filters.conditions]:[]})},ze=e=>{if(!e)return;const a=String(e.operator||"").toLowerCase();"between"===a?Array.isArray(e.value)?e.value.length<2&&(e.value=[e.value[0]||"",e.value[1]||""]):e.value=["",""]:Array.isArray(e.value)&&(e.value=e.value.join(","))};return(0,l.sV)(async()=>{await G(),await ve(),z.value&&(s.value=[de(z.value[0]),de(z.value[1])]),await M(1,!0)}),{loading:n,selectedLogs:o,batchLogEntries:r,searchKeyword:i,timeRange:s,currentPage:u,pageSize:d,totalCount:c,totalPages:p,advancedMode:m,useLocalAdvanced:h,useVirtualScroll:f,virtualTableRef:y,tableColumns:w,showAdvancedFilter:k,filtersRoot:C,filteredEntries:W,paginatedEntries:I,searchExpression:F,advancedExpression:T,batchCount:O,selectedLogsCount:K,filteredCount:V,leafConditionCount:D,loadSelectedLogs:G,loadBatchLogEntries:M,handleSearch:Q,handleQuery:J,handleTimeRangeChange:P,clearFilters:Z,exportToCSV:oe,handleSizeChange:re,handleCurrentChange:ie,handleLoadMore:se,forceRelayout:ue,formatTimestamp:de,formatFileSize:ce,showSurgeryStatistics:pe,analyzeSurgeryData:Le,surgeryStatisticsVisible:A,surgeryData:x,analyzing:_,timeRangeLimit:z,defaultPickerRange:ne,disableOutOfRangeDates:le,templates:S,applyTemplateByName:ge,beforeImportTemplates:me,selectedTemplateName:L,onTemplateSingleSelect:he,applySelectedTemplate:Ve,importExpressionText:N,applyExpressionJSON:_e,applyExpressionSmart:Se,addConditionToGroup:De,addGroupToGroup:We,removeNodeAt:Oe,exprPreviewRef:xe,applyAdvancedFilters:Ke,clearAllConditionsOnly:ee,getOperatorOptions:Te,onFieldChange:Ee,onOperatorChange:ze}}};const te=(0,P.A)(ae,[["render",M],["__scopeId","data-v-6b5fa746"]]);var le=te}}]);
//# sourceMappingURL=700.a67b0921.js.map