"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[662,865],{540:function(e,t,a){a.d(t,{Js:function(){return r},RD:function(){return n},fU:function(){return o},u4:function(){return s}});let l=null;const r=async()=>{try{const e=await fetch("/api/timezone"),t=await e.json();"number"===typeof t.offsetMinutes&&(l=t.offsetMinutes)}catch(e){console.warn("加载服务器时区信息失败:",e),l=null}},o=(e,t=!0,a=!0)=>{if(!e)return"-";if(!a&&"string"===typeof e&&/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e))return e;let r;if("string"===typeof e)if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e)){const t=e.replace(" ","T")+"Z";r=new Date(t)}else r=(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/.test(e),new Date(e));else r=new Date(e);if(isNaN(r.getTime()))return"-";if(t&&null!==l){const e=-r.getTimezoneOffset(),t=60*(l-e)*1e3;r.setTime(r.getTime()+t)}const o=r.getFullYear(),n=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0"),i=String(r.getHours()).padStart(2,"0"),u=String(r.getMinutes()).padStart(2,"0"),d=String(r.getSeconds()).padStart(2,"0"),c=`${o}-${n}-${s} ${i}:${u}:${d}`;return c},n=(e,t=!0,a=!0)=>{if(!e)return"-";const r=new Date(e);if(isNaN(r.getTime()))return"-";if(t&&null!==l){const e=-r.getTimezoneOffset(),t=60*(l-e)*1e3;r.setTime(r.getTime()+t)}const o=String(r.getHours()).padStart(2,"0"),n=String(r.getMinutes()).padStart(2,"0");return`${o}:${n}`},s=(e,t=!0)=>{if(!e.surgery_start_time||!e.surgery_end_time)return"手术时间未确定";const a=o(e.surgery_start_time,t,!0),l=o(e.surgery_end_time,t,!0);return`${a} ~ ${l}`}},3110:function(e,t,a){a.d(t,{A:function(){return c}});var l=a(641),r=a(33);function o(e,t,a,o,n,s){return(0,l.uX)(),(0,l.CE)("div",{ref:"chartContainer",style:(0,r.Tr)({width:a.width?a.width+"px":"100%",height:a.height+"px"})},null,4)}var n=a(953),s=a(8605),i={name:"TimeSeriesChart",props:{seriesData:{type:Array,default:()=>[]},seriesName:{type:String,default:"数据"},height:{type:Number,default:300},width:{type:Number,default:600},yAxisFormat:{type:String,default:"decimal"},showRangeLabels:{type:Boolean,default:!0}},setup(e){const t=(0,n.KR)(null);let a=null;const r=()=>{if(!t.value||!e.seriesData||0===e.seriesData.length)return;a&&a.dispose(),a=s.Ts(t.value);const l=e.seriesData.filter(e=>Array.isArray(e)&&e.length>=2&&"number"===typeof e[0]&&"number"===typeof e[1]&&!isNaN(e[0])&&!isNaN(e[1])&&isFinite(e[0])&&isFinite(e[1]));if(0===l.length)return a.dispose(),void(a=null);const r={title:void 0,tooltip:{trigger:"axis",position:e=>[e[0],"10%"]},legend:void 0,toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},xAxis:{type:"time",boundaryGap:!1,min:Math.min(...l.map(e=>e[0])),max:Math.max(...l.map(e=>e[0]))},yAxis:{type:"value",boundaryGap:[0,"100%"],axisLabel:{width:40,overflow:"truncate",formatter:t=>"integer"===e.yAxisFormat?Math.round(t).toString():"decimal"===e.yAxisFormat?t.toFixed(1):t.toString()}},dataZoom:[{type:"inside",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,xAxisIndex:0,filterMode:"filter",preventDefaultMouseMove:!0},{type:"slider",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,showDetail:!0,showDataShadow:!0,xAxisIndex:0,bottom:10,filterMode:"filter",moveHandleSize:8,preventDefaultMouseMove:!0}],series:[{name:e.seriesName,type:"line",symbol:"none",sampling:!1,data:l,lineStyle:{width:2},areaStyle:{opacity:.3}}]};a.setOption(r,!0)},o=()=>{a&&a.resize()};return(0,l.wB)(()=>e.seriesData,()=>{(0,l.dY)(()=>{r()})},{deep:!0}),(0,l.wB)(()=>e.height,()=>{(0,l.dY)(()=>{o()})}),(0,l.wB)(()=>e.width,()=>{(0,l.dY)(()=>{o()})}),(0,l.sV)(()=>{(0,l.dY)(()=>{r()}),window.addEventListener("resize",o)}),(0,l.xo)(()=>{a&&(a.dispose(),a=null),window.removeEventListener("resize",o)}),{chartContainer:t}}},u=a(6262);const d=(0,u.A)(i,[["render",o],["__scopeId","data-v-59aa7af9"]]);var c=d},5865:function(e,t,a){a.r(t),a.d(t,{default:function(){return Lt}});var l=a(641),r=a(33),o=a(3751);const n={class:"batch-analysis-container"},s={class:"analysis-card-wrapper"},i={class:"card-header",style:{borderBottom:"none"}},u={class:"header-left"},d={class:"selected-files-tooltip"},c={class:"header-right"},p={key:0,style:{padding:"24px 0"}},m={key:1},g={class:"search-section",style:{marginTop:"8px"}},v={class:"search-grid"},f={class:"grid-item"},y={class:"grid-item"},h={class:"grid-item"},b={class:"advanced-actions"},k={key:0,class:"advanced-summary"},_={class:"grid-item"},w={key:0,class:"search-expression"},C={class:"expr"},S={class:"entries-section"},x={class:"section-header"},A={key:0,class:"loading-section"},L={key:1,class:"table-container"},D={class:"color-mark-cell"},F=["onClick"],N={key:0,class:"color-picker-menu"},E=["onClick"],R={key:0,class:"checkmark"},V=["onMouseenter"],T={class:"timestamp"},z=["title"],I=["onClick"],O=["title"],$={class:"explanation-cell"},K={class:"parameters-cell"},W={class:"param-content"},M={class:"param-actions"},X={class:"parameter-popover"},P={key:0,class:"param-loading"},j={class:"popover-actions",style:{"margin-top":"8px","text-align":"right"}},B={class:"operations-cell"},U={key:0},J={class:"notes-header"},G={key:0,class:"notes-list"},q={class:"note-meta"},Q={class:"note-time"},Y={class:"note-actions"},H={key:0,class:"note-content"},Z={key:1,class:"note-edit"},ee={class:"note-edit-actions"},te={key:1,class:"notes-empty"},ae={class:"notes-pagination"},le={key:2,class:"notes-editor"},re={class:"notes-editor-actions"},oe={key:2,class:"pagination-wrapper"},ne={class:"context-analysis-form"},se={class:"time-range-inputs"},ie={class:"input-group"},ue={class:"input-group"},de={class:"dialog-footer"},ce={class:"sidebar-tabs"},pe={class:"logs-clipboard"},me={key:0},ge={class:"thumb-row"},ve={class:"fill-bar"},fe={class:"fill-bar-text"},ye={key:0,class:"chart-thumbnails"},he={class:"thumbnail-list"},be=["onClick"],ke={class:"thumbnail-title"},_e=["id"],we={class:"thumbnail-info"},Ce={class:"thumbnail-time"},Se={class:"clipboard-detail"},xe={class:"dialog-footer"},Ae={class:"chart-detail"},Le={class:"dialog-subtitle"},De={class:"chart-container",ref:"chartContainer"},Fe={key:1,style:{width:"100%",height:"450px",display:"flex","align-items":"center","justify-content":"center",color:"#909399"}},Ne={class:"advanced-filter"},Ee={class:"section"},Re={class:"section-title-row"},Ve={class:"ops-right"},Te={key:0,class:"expr-preview",ref:"exprPreviewRef"},ze={class:"expr"},Ie={key:1,class:"common-templates"},Oe={class:"tags-ops"},$e={class:"tags-wrap antd-tags single-select"},Ke={class:"group-root"},We={class:"group-header"},Me={class:"group-actions"},Xe={class:"section"},Pe={class:"import-row"},je={class:"dialog-footer"};function Be(e,t,a,Be,Ue,Je){const Ge=(0,l.g2)("el-tag"),qe=(0,l.g2)("el-tooltip"),Qe=(0,l.g2)("DocumentCopy"),Ye=(0,l.g2)("el-icon"),He=(0,l.g2)("el-button"),Ze=(0,l.g2)("Download"),et=(0,l.g2)("DataAnalysis"),tt=(0,l.g2)("el-empty"),at=(0,l.g2)("el-table-column"),lt=(0,l.g2)("el-table"),rt=(0,l.g2)("el-dialog"),ot=(0,l.g2)("el-input"),nt=(0,l.g2)("el-date-picker"),st=(0,l.g2)("Search"),it=(0,l.g2)("el-popover"),ut=(0,l.g2)("ExplanationCell"),dt=(0,l.g2)("el-radio"),ct=(0,l.g2)("el-radio-group"),pt=(0,l.g2)("View"),mt=(0,l.g2)("el-pagination"),gt=(0,l.g2)("Edit"),vt=(0,l.g2)("el-input-number"),ft=(0,l.g2)("Delete"),yt=(0,l.g2)("el-tab-pane"),ht=(0,l.g2)("el-tabs"),bt=(0,l.g2)("el-drawer"),kt=(0,l.g2)("TimeSeriesChart"),_t=(0,l.g2)("el-card"),wt=(0,l.g2)("el-switch"),Ct=(0,l.g2)("a-checkable-tag"),St=(0,l.g2)("el-radio-button"),xt=(0,l.g2)("ConditionGroup"),At=(0,l.g2)("el-upload"),Lt=(0,l.g2)("SurgeryDataCompare"),Dt=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",n,[(0,l.Lk)("div",s,[(0,l.bF)(_t,{class:"analysis-card"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",i,[(0,l.Lk)("div",u,[t[32]||(t[32]=(0,l.Lk)("span",{class:"title"},"批量日志查看",-1)),Be.batchCount>0&&Be.selectedLogsCount>0?((0,l.uX)(),(0,l.Wv)(Ge,{key:0,type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 设备编号："+(0,r.v_)(Be.selectedLogs[0]?.device_id||"未知"),1)]),_:1})):(0,l.Q3)("",!0),(0,l.bF)(qe,{placement:"bottom",effect:"light",transition:"el-fade-in-linear","popper-class":"selected-files-popper",disabled:0===Be.selectedLogsCount},{content:(0,l.k6)(()=>[(0,l.Lk)("div",d,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Be.selectedLogs,e=>((0,l.uX)(),(0,l.Wv)(Ge,{key:e.id,size:"small",style:{margin:"2px 4px 2px 0"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,r.v_)(e.original_name),1)]),_:2},1024))),128))])]),default:(0,l.k6)(()=>[(0,l.bF)(Ge,{type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 已选择 "+(0,r.v_)(Be.selectedLogsCount)+" 个日志文件 ",1)]),_:1})]),_:1},8,["disabled"])]),(0,l.Lk)("div",c,[!Be.loading&&Be.batchCount>0?((0,l.uX)(),(0,l.Wv)(He,{key:0,onClick:Be.showClipboard,type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(Qe)]),_:1}),t[33]||(t[33]=(0,l.eW)(" 剪贴板 ",-1))]),_:1},8,["onClick"])):(0,l.Q3)("",!0),!Be.loading&&Be.batchCount>0?((0,l.uX)(),(0,l.Wv)(He,{key:1,onClick:Be.exportToCSV,type:"success",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(Ze)]),_:1}),t[34]||(t[34]=(0,l.eW)(" 导出CSV ",-1))]),_:1},8,["onClick"])):(0,l.Q3)("",!0),!Be.loading&&Be.selectedLogsCount>0&&Be.batchCount>0?((0,l.uX)(),(0,l.Wv)(He,{key:2,onClick:Be.showSurgeryStatistics,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(et)]),_:1}),t[35]||(t[35]=(0,l.eW)(" 手术统计 ",-1))]),_:1},8,["onClick"])):(0,l.Q3)("",!0)])]),(0,l.bF)(rt,{modelValue:Be.showSurgeryStatsDialog,"onUpdate:modelValue":t[1]||(t[1]=e=>Be.showSurgeryStatsDialog=e),title:"手术统计结果",width:"900px","append-to-body":""},{footer:(0,l.k6)(()=>[(0,l.bF)(He,{onClick:t[0]||(t[0]=e=>Be.showSurgeryStatsDialog=!1)},{default:(0,l.k6)(()=>[...t[39]||(t[39]=[(0,l.eW)("关闭",-1)])]),_:1})]),default:(0,l.k6)(()=>[Be.surgeryStatsLoading?((0,l.uX)(),(0,l.CE)("div",p,[(0,l.bF)(tt,{description:"正在统计手术数据..."})])):((0,l.uX)(),(0,l.CE)("div",m,[(0,l.bF)(lt,{data:Be.surgeryStats,style:{width:"100%"}},{default:(0,l.k6)(()=>[(0,l.bF)(at,{prop:"surgery_id",label:"手术id",width:"220"}),(0,l.bF)(at,{label:"手术术式","min-width":"200"},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,r.v_)(e?.postgresql_structure?.surgery_stats?.procedure||e?.surgery_stats?.procedure||"-"),1)]),_:1}),(0,l.bF)(at,{label:"手术开始时间",width:"180"},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,r.v_)(Be.formatTimeForDisplay(e.surgery_start_time||e.start_time)),1)]),_:1}),(0,l.bF)(at,{label:"手术结束时间",width:"180"},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,r.v_)(Be.formatTimeForDisplay(e.surgery_end_time||e.end_time)),1)]),_:1}),(0,l.bF)(at,{label:"操作",width:"320",fixed:Be.surgeryStats.length>0&&"right"},{default:(0,l.k6)(({row:e})=>[(0,l.bF)(He,{size:"small",type:"success",onClick:t=>Be.visualizeSurgeryStat(e)},{default:(0,l.k6)(()=>[...t[36]||(t[36]=[(0,l.eW)("可视化",-1)])]),_:2},1032,["onClick"]),(0,l.bF)(He,{size:"small",onClick:t=>Be.previewSurgeryData(e)},{default:(0,l.k6)(()=>[...t[37]||(t[37]=[(0,l.eW)("查看数据",-1)])]),_:2},1032,["onClick"]),Be.hasExportPermission?((0,l.uX)(),(0,l.Wv)(He,{key:0,size:"small",type:"primary",loading:!0===Be.exportingRow[e.id],onClick:t=>Be.exportSurgeryRow(e)},{default:(0,l.k6)(()=>[...t[38]||(t[38]=[(0,l.eW)("导出",-1)])]),_:2},1032,["loading","onClick"])):(0,l.Q3)("",!0)]),_:1},8,["fixed"])]),_:1},8,["data"])]))]),_:1},8,["modelValue"]),(0,l.bF)(rt,{modelValue:Be.surgeryJsonDialogVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>Be.surgeryJsonDialogVisible=e),title:"手术数据（PostgreSQL格式）",width:"760px","append-to-body":""},{footer:(0,l.k6)(()=>[(0,l.bF)(He,{onClick:t[3]||(t[3]=e=>Be.surgeryJsonDialogVisible=!1)},{default:(0,l.k6)(()=>[...t[40]||(t[40]=[(0,l.eW)("关闭",-1)])]),_:1})]),default:(0,l.k6)(()=>[t[41]||(t[41]=(0,l.Lk)("div",{style:{"margin-bottom":"8px",color:"#666","font-size":"12px"}}," 此数据格式为准备写入PostgreSQL数据库的格式 ",-1)),(0,l.bF)(ot,{type:"textarea",rows:18,modelValue:Be.surgeryJsonText,"onUpdate:modelValue":t[2]||(t[2]=e=>Be.surgeryJsonText=e),readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),(0,l.Lk)("div",g,[(0,l.Lk)("div",v,[(0,l.Lk)("div",f,[t[42]||(t[42]=(0,l.Lk)("div",{class:"item-title"},"时间范围",-1)),(0,l.bF)(nt,{modelValue:Be.timeRange,"onUpdate:modelValue":t[5]||(t[5]=e=>Be.timeRange=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",class:"time-range",size:"small","default-value":Be.defaultPickerRange,"disabled-date":Be.disableOutOfRangeDates,onChange:Be.handleTimeRangeChange},null,8,["modelValue","default-value","disabled-date","onChange"])]),(0,l.Lk)("div",y,[t[43]||(t[43]=(0,l.Lk)("div",{class:"item-title"},"关键字",-1)),(0,l.bF)(ot,{modelValue:Be.searchKeyword,"onUpdate:modelValue":t[6]||(t[6]=e=>Be.searchKeyword=e),placeholder:"搜索释义内容或故障码",class:"search-input",clearable:"",onInput:Be.handleSearch,onCompositionstart:Be.onCompositionStart,onCompositionend:Be.onCompositionEnd,size:"small"},{prefix:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(st)]),_:1})]),_:1},8,["modelValue","onInput","onCompositionstart","onCompositionend"])]),(0,l.Lk)("div",h,[t[45]||(t[45]=(0,l.Lk)("div",{class:"item-title"},"高级搜索",-1)),(0,l.Lk)("div",b,[(0,l.bF)(He,{size:"small",type:"primary",plain:"",onClick:t[7]||(t[7]=e=>Be.showAdvancedFilter=!0)},{default:(0,l.k6)(()=>[...t[44]||(t[44]=[(0,l.eW)("打开高级筛选",-1)])]),_:1}),Be.leafConditionCount>0?((0,l.uX)(),(0,l.CE)("div",k," 已添加 "+(0,r.v_)(Be.leafConditionCount)+" 个条件（逻辑："+(0,r.v_)(Be.filtersRoot.logic)+"） ",1)):(0,l.Q3)("",!0)])]),(0,l.Lk)("div",_,[t[47]||(t[47]=(0,l.Lk)("div",{class:"item-title"},"清除搜索",-1)),(0,l.bF)(He,{size:"small",onClick:Be.clearFilters},{default:(0,l.k6)(()=>[...t[46]||(t[46]=[(0,l.eW)("清除所有条件",-1)])]),_:1},8,["onClick"])])]),Be.searchExpression?((0,l.uX)(),(0,l.CE)("div",w,[t[48]||(t[48]=(0,l.Lk)("span",{class:"label"},"搜索表达式：",-1)),(0,l.Lk)("span",C,(0,r.v_)(Be.searchExpression),1)])):(0,l.Q3)("",!0)]),(0,l.Lk)("div",S,[(0,l.Lk)("div",x,[(0,l.Lk)("h3",null,"日志条目 ("+(0,r.v_)(Be.filteredCount)+")",1)]),Be.loading?((0,l.uX)(),(0,l.CE)("div",A,[(0,l.bF)(tt,{description:"正在加载日志数据..."})])):((0,l.uX)(),(0,l.CE)("div",L,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(lt,{data:Be.paginatedEntries,style:{width:"100%"},height:"60vh",stripe:!1,"table-layout":"fixed","row-key":"id","row-class-name":Be.getRowClassName,"row-style":Be.getRowStyle,onCurrentChange:Be.forceRelayout,onSelectionChange:Be.forceRelayout,onSortChange:Be.forceRelayout,onFilterChange:Be.forceRelayout,onExpandChange:Be.forceRelayout},{default:(0,l.k6)(()=>[(0,l.bF)(at,{prop:"color_mark",width:"4%"},{header:(0,l.k6)(()=>[...t[49]||(t[49]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",D,[(0,l.bF)(it,{placement:"bottom-start",width:200,trigger:"manual",visible:Be.activeColorPopoverRowId===e.id,"popper-class":"color-picker-popover"},{reference:(0,l.k6)(()=>[(0,l.Lk)("div",{class:(0,r.C4)(["color-indicator",{"has-color":e.color_mark}]),style:(0,r.Tr)(e.color_mark?{backgroundColor:e.color_mark}:{}),onClick:(0,o.D$)(t=>Be.toggleColorPopover(e),["stop"])},null,14,F)]),default:(0,l.k6)(()=>[Be.activeColorPopoverRowId===e.id?((0,l.uX)(),(0,l.CE)("div",N,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Be.colorOptions,t=>((0,l.uX)(),(0,l.CE)("div",{key:t.value||"none",class:(0,r.C4)(["color-option",{active:e.color_mark===t.value,"no-color":null===t.value}]),style:(0,r.Tr)(t.value?{backgroundColor:t.value}:{}),onClick:a=>Be.selectColor(e,t.value)},[e.color_mark===t.value?((0,l.uX)(),(0,l.CE)("div",R,"✓")):(0,l.Q3)("",!0)],14,E))),128))])):(0,l.Q3)("",!0)]),_:2},1032,["visible"])])]),_:1}),(0,l.bF)(at,{prop:"file_info",width:"15%"},{header:(0,l.k6)(()=>[...t[50]||(t[50]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span",null,"时间戳（文件名）")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",{class:"file-info-cell",onMouseenter:t=>Be.hoveredNameRowId=e.id,onMouseleave:t[8]||(t[8]=e=>Be.hoveredNameRowId=null)},[Be.hoveredNameRowId===e.id?((0,l.uX)(),(0,l.Wv)(qe,{key:0,content:e.log_name,placement:"top",effect:"dark","popper-class":"explanation-tooltip dark",teleported:!0,"show-after":120},{default:(0,l.k6)(()=>[(0,l.Lk)("div",T,(0,r.v_)(e.timestamp_text),1)]),_:2},1032,["content"])):((0,l.uX)(),(0,l.CE)("div",{key:1,class:"timestamp",title:e.log_name},(0,r.v_)(e.timestamp_text),9,z))],40,V)]),_:1}),(0,l.bF)(at,{prop:"error_code",width:"12%"},{header:(0,l.k6)(()=>[...t[51]||(t[51]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span",null,"故障码")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",{class:"error-code-cell",onClick:t=>Be.toggleErrorCodeStatistics(e.error_code)},[(0,l.eW)((0,r.v_)(e.error_code)+" ",1),Be.showStatisticsForErrorCode===e.error_code&&Be.getErrorCodeCountDisplay(e.error_code)?((0,l.uX)(),(0,l.CE)("span",{key:0,class:"error-code-badge",title:Be.getErrorCodeStatisticsTooltip(e.error_code)},(0,r.v_)(Be.getErrorCodeCountDisplay(e.error_code)),9,O)):(0,l.Q3)("",!0)],8,I)]),_:1}),(0,l.bF)(at,{prop:"explanation",width:"45%"},{header:(0,l.k6)(()=>[...t[52]||(t[52]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span",null,"释义")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",$,[(0,l.bF)(ut,{text:e.explanation},null,8,["text"])])]),_:1}),(0,l.bF)(at,{prop:"parameters",width:"20%"},{header:(0,l.k6)(()=>[...t[53]||(t[53]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span",null,"参数(1~4)")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",K,[(0,l.Lk)("div",W,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(e.display_params,(e,t)=>((0,l.uX)(),(0,l.CE)("span",{key:t,class:"param-item"},(0,r.v_)(e),1))),128))]),(0,l.Lk)("div",M,[(0,l.bF)(it,{visible:Be.activeParamPopoverRowId===e.id,trigger:"manual",placement:"bottom",width:"260px",teleported:!0,"popper-class":"param-popover"},{reference:(0,l.k6)(()=>[(0,l.bF)(He,{text:"",onClick:(0,o.D$)(t=>Be.handleVisualization(e),["stop"]),class:"visualization-btn",disabled:Be.chartThumbnails.length>=5,title:Be.chartThumbnails.length>=5?"已有5张可视化数据表":""},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(et)]),_:1})]),_:2},1032,["onClick","disabled","title"])]),default:(0,l.k6)(()=>[(0,l.Lk)("div",X,[t[56]||(t[56]=(0,l.Lk)("div",{class:"popover-title",style:{"margin-bottom":"8px"}},"选择可视化参数",-1)),Be.paramNamesLoading?((0,l.uX)(),(0,l.CE)("div",P,"正在加载参数含义...")):((0,l.uX)(),(0,l.Wv)(ct,{key:1,modelValue:Be.selectedParameter,"onUpdate:modelValue":t[9]||(t[9]=e=>Be.selectedParameter=e),class:"param-radio-group"},{default:(0,l.k6)(()=>[((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)(4,e=>(0,l.bF)(dt,{key:e,label:e,disabled:Be.paramNamesLoading||!Be.isParameterAvailable(e)},{default:(0,l.k6)(()=>[(0,l.eW)((0,r.v_)(Be.paramNames[e-1]||`参数${e}`),1)]),_:2},1032,["label","disabled"])),64))]),_:1},8,["modelValue"])),(0,l.Lk)("div",j,[(0,l.bF)(He,{size:"small",onClick:t[10]||(t[10]=e=>Be.activeParamPopoverRowId=null)},{default:(0,l.k6)(()=>[...t[54]||(t[54]=[(0,l.eW)("取消",-1)])]),_:1}),(0,l.bF)(He,{size:"small",type:"primary",onClick:Be.confirmVisualization},{default:(0,l.k6)(()=>[...t[55]||(t[55]=[(0,l.eW)("确认",-1)])]),_:1},8,["onClick"])])])]),_:2},1032,["visible"])])])]),_:1}),(0,l.bF)(at,{prop:"operations",width:"13%"},{header:(0,l.k6)(()=>[...t[57]||(t[57]=[(0,l.Lk)("div",{class:"col-header"},[(0,l.Lk)("span",null,"操作")],-1)])]),default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",B,[(0,l.bF)(He,{text:"",onClick:t=>Be.handleContextAnalysis(e),class:"operation-btn"},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(pt)]),_:1})]),_:2},1032,["onClick"]),(0,l.bF)(He,{text:"",onClick:t=>Be.handleLogCapture(e),class:"operation-btn"},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(Qe)]),_:1})]),_:2},1032,["onClick"]),(0,l.bF)(it,{placement:"left-start",width:360,trigger:"manual",visible:Be.activeNotesPopoverRowId===e.id,"popper-class":"notes-popover"},{default:(0,l.k6)(()=>[Be.activeNotesPopoverRowId===e.id?((0,l.uX)(),(0,l.CE)("div",U,[(0,l.Lk)("div",J,[t[59]||(t[59]=(0,l.Lk)("span",null,"备注",-1)),(0,l.bF)(He,{link:"",size:"small",onClick:t=>Be.reloadNotes(e)},{default:(0,l.k6)(()=>[...t[58]||(t[58]=[(0,l.eW)("刷新",-1)])]),_:2},1032,["onClick"])]),Be.getNotes(e).items.length>0?((0,l.uX)(),(0,l.CE)("div",G,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Be.getNotes(e).items,e=>((0,l.uX)(),(0,l.CE)("div",{class:"note-item",key:e.id},[(0,l.Lk)("div",q,[(0,l.Lk)("span",{class:(0,r.C4)(["note-user","role-"+(e.created_by||"user")])},(0,r.v_)(e.username)+"（"+(0,r.v_)(Be.roleLabel(e.created_by))+"）",3),(0,l.Lk)("span",Q,(0,r.v_)(Be.formatTimeForDisplay(e.created_at)),1),(0,l.Lk)("span",Y,[Be.canEditNote(e)?((0,l.uX)(),(0,l.Wv)(He,{key:0,link:"",type:"primary",size:"small",onClick:t=>Be.startEditNote(e)},{default:(0,l.k6)(()=>[...t[60]||(t[60]=[(0,l.eW)("编辑",-1)])]),_:2},1032,["onClick"])):(0,l.Q3)("",!0),Be.canDeleteNote(e)?((0,l.uX)(),(0,l.Wv)(He,{key:1,link:"",type:"danger",size:"small",onClick:t=>Be.confirmDeleteNote(e)},{default:(0,l.k6)(()=>[...t[61]||(t[61]=[(0,l.eW)("删除",-1)])]),_:2},1032,["onClick"])):(0,l.Q3)("",!0)])]),Be.editingNoteId!==e.id?((0,l.uX)(),(0,l.CE)("div",H,(0,r.v_)(e.content),1)):((0,l.uX)(),(0,l.CE)("div",Z,[(0,l.bF)(ot,{modelValue:Be.editingNoteContent,"onUpdate:modelValue":t[11]||(t[11]=e=>Be.editingNoteContent=e),maxlength:"50","show-word-limit":"",type:"textarea",rows:"2"},null,8,["modelValue"]),(0,l.Lk)("div",ee,[(0,l.bF)(He,{size:"small",onClick:Be.cancelEditNote},{default:(0,l.k6)(()=>[...t[62]||(t[62]=[(0,l.eW)("取消",-1)])]),_:1},8,["onClick"]),(0,l.bF)(He,{size:"small",type:"primary",onClick:t=>Be.submitEditNote(e)},{default:(0,l.k6)(()=>[...t[63]||(t[63]=[(0,l.eW)("保存",-1)])]),_:2},1032,["onClick"])])]))]))),128))])):((0,l.uX)(),(0,l.CE)("div",te,"暂无备注")),(0,l.Lk)("div",ae,[(0,l.bF)(mt,{layout:"prev, pager, next",small:"","page-size":Be.getNotes(e).pageSize,total:Be.getNotes(e).total,"current-page":Be.getNotes(e).page,onCurrentChange:t=>Be.changeNotesPage(e,t)},null,8,["page-size","total","current-page","onCurrentChange"])]),Be.canCreateNote?((0,l.uX)(),(0,l.CE)("div",le,[(0,l.bF)(ot,{modelValue:Be.newNoteContent,"onUpdate:modelValue":t[12]||(t[12]=e=>Be.newNoteContent=e),placeholder:"添加备注（最多50字）",maxlength:"50","show-word-limit":"",type:"textarea",rows:"2"},null,8,["modelValue"]),(0,l.Lk)("div",re,[(0,l.bF)(He,{size:"small",type:"primary",onClick:t=>Be.submitNewNote(e)},{default:(0,l.k6)(()=>[...t[64]||(t[64]=[(0,l.eW)("提交备注",-1)])]),_:2},1032,["onClick"])])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)]),reference:(0,l.k6)(()=>[(0,l.bF)(He,{text:"",class:"operation-btn",onClick:(0,o.D$)(t=>Be.openNotes(e),["stop"])},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(gt)]),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["visible"])])]),_:1})]),_:1},8,["data","row-class-name","row-style","onCurrentChange","onSelectionChange","onSortChange","onFilterChange","onExpandChange"])),[[Dt,Be.loading]])])),Be.filteredCount>0?((0,l.uX)(),(0,l.CE)("div",oe,[(0,l.bF)(mt,{"current-page":Be.currentPage,"page-size":Be.pageSize,"page-sizes":[50,100,200,500],total:Be.totalCount,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Be.handleSizeChange,onCurrentChange:Be.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):(0,l.Q3)("",!0),(0,l.bF)(rt,{modelValue:Be.contextAnalysisVisible,"onUpdate:modelValue":t[17]||(t[17]=e=>Be.contextAnalysisVisible=e),title:"上下文分析",width:"500px","close-on-click-modal":!1},{footer:(0,l.k6)(()=>[(0,l.Lk)("div",de,[(0,l.bF)(He,{type:"primary",onClick:Be.executeContextAnalysis},{default:(0,l.k6)(()=>[...t[73]||(t[73]=[(0,l.eW)("确认分析",-1)])]),_:1},8,["onClick"])])]),default:(0,l.k6)(()=>[(0,l.Lk)("div",ne,[t[72]||(t[72]=(0,l.Lk)("div",{class:"context-intro"},"将以选中的日志条目为基点",-1)),(0,l.Lk)("div",se,[(0,l.Lk)("div",ie,[t[65]||(t[65]=(0,l.Lk)("label",null,"前",-1)),(0,l.bF)(vt,{modelValue:Be.beforeMinutes,"onUpdate:modelValue":t[13]||(t[13]=e=>Be.beforeMinutes=e),min:0,max:60,"controls-position":"right",style:{width:"80px"}},null,8,["modelValue"]),t[66]||(t[66]=(0,l.Lk)("span",{class:"unit-label"},"分钟",-1)),(0,l.bF)(vt,{modelValue:Be.beforeSeconds,"onUpdate:modelValue":t[14]||(t[14]=e=>Be.beforeSeconds=e),min:0,max:60,"controls-position":"right",style:{width:"80px","margin-left":"4px"}},null,8,["modelValue"]),t[67]||(t[67]=(0,l.Lk)("span",{class:"unit-label"},"秒",-1))]),t[71]||(t[71]=(0,l.Lk)("span",null,"，",-1)),(0,l.Lk)("div",ue,[t[68]||(t[68]=(0,l.Lk)("label",null,"后",-1)),(0,l.bF)(vt,{modelValue:Be.afterMinutes,"onUpdate:modelValue":t[15]||(t[15]=e=>Be.afterMinutes=e),min:0,max:60,"controls-position":"right",style:{width:"80px"}},null,8,["modelValue"]),t[69]||(t[69]=(0,l.Lk)("span",{class:"unit-label"},"分钟",-1)),(0,l.bF)(vt,{modelValue:Be.afterSeconds,"onUpdate:modelValue":t[16]||(t[16]=e=>Be.afterSeconds=e),min:0,max:60,"controls-position":"right",style:{width:"80px","margin-left":"4px"}},null,8,["modelValue"]),t[70]||(t[70]=(0,l.Lk)("span",{class:"unit-label"},"秒",-1))])])])]),_:1},8,["modelValue"]),(0,l.bF)(bt,{modelValue:Be.clipboardVisible,"onUpdate:modelValue":t[20]||(t[20]=e=>Be.clipboardVisible=e),direction:"rtl",size:"340px","with-header":!1},{default:(0,l.k6)(()=>[(0,l.Lk)("div",ce,[(0,l.bF)(ht,{modelValue:Be.sidebarActiveTab,"onUpdate:modelValue":t[19]||(t[19]=e=>Be.sidebarActiveTab=e),stretch:""},{default:(0,l.k6)(()=>[(0,l.bF)(yt,{label:`日志摘取 (${Be.clipboardCount})`,name:"logs"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",pe,[Be.clipboardEntries.length>0||Be.clipboardContent?((0,l.uX)(),(0,l.CE)("div",me,[(0,l.Lk)("div",{class:"clipboard-thumbnail",onClick:t[18]||(t[18]=e=>Be.clipboardDetailVisible=!0)},[(0,l.Lk)("div",ge,[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(Qe)]),_:1}),t[74]||(t[74]=(0,l.Lk)("span",{class:"thumb-label"},"日志摘取板",-1))]),(0,l.Lk)("div",ve,[(0,l.Lk)("div",{class:"fill-bar-inner",style:(0,r.Tr)({width:Be.fillPercent+"%"})},null,4),(0,l.Lk)("div",fe,(0,r.v_)(Be.clipboardCount)+"/"+(0,r.v_)(Be.maxClipboardEntries),1)]),(0,l.bF)(He,{class:"delete-btn",text:"",circle:"",onClick:(0,o.D$)(Be.clearClipboard,["stop"])},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(ft)]),_:1})]),_:1},8,["onClick"])])])):((0,l.uX)(),(0,l.Wv)(tt,{key:1,description:"暂无摘取的日志"}))])]),_:1},8,["label"]),(0,l.bF)(yt,{label:`可视化 (${Be.chartThumbnails.length})`,name:"charts"},{default:(0,l.k6)(()=>[Be.chartThumbnails.length>0?((0,l.uX)(),(0,l.CE)("div",ye,[(0,l.Lk)("div",he,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Be.chartThumbnails,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:"chart-thumbnail-item",onClick:t=>Be.showChartDetail(e)},[(0,l.Lk)("div",ke,(0,r.v_)(e.title),1),(0,l.Lk)("div",{class:"thumbnail-chart",id:`chart-thumb-${e.id}`},null,8,_e),(0,l.Lk)("div",we,[(0,l.Lk)("div",Ce,(0,r.v_)(Be.formatTimestamp(e.timestamp)),1)]),(0,l.bF)(He,{size:"small",text:"",circle:"",class:"thumbnail-delete-btn",onClick:(0,o.D$)(t=>Be.deleteChartThumbnail(e.id),["stop"])},{default:(0,l.k6)(()=>[(0,l.bF)(Ye,null,{default:(0,l.k6)(()=>[(0,l.bF)(ft)]),_:1})]),_:2},1032,["onClick"])],8,be))),128))])])):((0,l.uX)(),(0,l.Wv)(tt,{key:1,description:"暂无可视化图表"}))]),_:1},8,["label"])]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"]),(0,l.bF)(rt,{modelValue:Be.clipboardDetailVisible,"onUpdate:modelValue":t[22]||(t[22]=e=>Be.clipboardDetailVisible=e),title:"日志摘取板",width:"700px"},{footer:(0,l.k6)(()=>[(0,l.Lk)("div",xe,[(0,l.bF)(He,{onClick:Be.clearClipboard,disabled:!Be.clipboardContent},{default:(0,l.k6)(()=>[...t[75]||(t[75]=[(0,l.eW)("清空",-1)])]),_:1},8,["onClick","disabled"]),(0,l.bF)(He,{type:"primary",onClick:Be.exportClipboardToTxt,disabled:!Be.clipboardContent},{default:(0,l.k6)(()=>[...t[76]||(t[76]=[(0,l.eW)("导出TXT",-1)])]),_:1},8,["onClick","disabled"])])]),default:(0,l.k6)(()=>[(0,l.Lk)("div",Se,[(0,l.bF)(ot,{type:"textarea",modelValue:Be.clipboardContent,"onUpdate:modelValue":t[21]||(t[21]=e=>Be.clipboardContent=e),autosize:{minRows:12,maxRows:24},class:"clipboard-textarea",placeholder:"在这里编辑摘取的日志文本..."},null,8,["modelValue"])])]),_:1},8,["modelValue"]),(0,l.bF)(rt,{modelValue:Be.chartDetailVisible,"onUpdate:modelValue":t[23]||(t[23]=e=>Be.chartDetailVisible=e),title:"数据可视化图表",width:"56%","close-on-click-modal":!0,onOpened:Be.onChartDialogOpened},{default:(0,l.k6)(()=>[(0,l.Lk)("div",Ae,[(0,l.Lk)("div",Le,(0,r.v_)(Be.chartTitle),1),(0,l.Lk)("div",De,[Be.currentChartData&&Array.isArray(Be.currentChartData.data)&&Be.currentChartData.data.length>0?((0,l.uX)(),(0,l.Wv)(kt,{key:0,"series-data":Be.currentChartData.data,"series-name":Be.currentChartData.parameterValue||"数据",height:450,"show-range-labels":!1},null,8,["series-data","series-name"])):((0,l.uX)(),(0,l.CE)("div",Fe,"暂无数据"))],512)])]),_:1},8,["modelValue","onOpened"])])]),_:1})]),(0,l.bF)(rt,{modelValue:Be.showAdvancedFilter,"onUpdate:modelValue":t[29]||(t[29]=e=>Be.showAdvancedFilter=e),title:"高级筛选",width:"880px"},{footer:(0,l.k6)(()=>[(0,l.Lk)("span",je,[(0,l.bF)(He,{onClick:t[28]||(t[28]=e=>Be.showAdvancedFilter=!1)},{default:(0,l.k6)(()=>[...t[90]||(t[90]=[(0,l.eW)("取消",-1)])]),_:1}),(0,l.bF)(He,{type:"primary",onClick:Be.applyAdvancedFilters},{default:(0,l.k6)(()=>[...t[91]||(t[91]=[(0,l.eW)("应用",-1)])]),_:1},8,["onClick"])])]),default:(0,l.k6)(()=>[(0,l.Lk)("div",Ne,[(0,l.Lk)("div",Ee,[(0,l.Lk)("div",Re,[t[78]||(t[78]=(0,l.Lk)("div",{class:"section-title"},"1. 条件组（支持嵌套）",-1)),(0,l.Lk)("div",Ve,[(0,l.bF)(wt,{modelValue:Be.useLocalAdvanced,"onUpdate:modelValue":t[24]||(t[24]=e=>Be.useLocalAdvanced=e),size:"small","active-text":"本地","inactive-text":"服务端","inline-prompt":""},null,8,["modelValue"]),(0,l.bF)(He,{size:"small",type:"danger",text:"",onClick:Be.clearAllConditionsOnly,disabled:!Be.filtersRoot.conditions||0===Be.filtersRoot.conditions.length},{default:(0,l.k6)(()=>[...t[77]||(t[77]=[(0,l.eW)("清空所有条件",-1)])]),_:1},8,["onClick","disabled"])])]),Be.advancedExpression?((0,l.uX)(),(0,l.CE)("div",Te,[t[79]||(t[79]=(0,l.Lk)("span",{class:"label"},"表达式预览：",-1)),(0,l.Lk)("span",ze,(0,r.v_)(Be.advancedExpression),1)],512)):(0,l.Q3)("",!0),Be.templates&&Be.templates.length?((0,l.uX)(),(0,l.CE)("div",Ie,[t[82]||(t[82]=(0,l.Lk)("div",{class:"section-title"},"常用搜索表达式",-1)),(0,l.Lk)("div",Oe,[(0,l.bF)(He,{size:"small",type:"primary",plain:"",onClick:Be.applySelectedTemplate,disabled:!Be.selectedTemplateName},{default:(0,l.k6)(()=>[...t[80]||(t[80]=[(0,l.eW)("应用选择表达式",-1)])]),_:1},8,["onClick","disabled"]),t[81]||(t[81]=(0,l.Lk)("span",{class:"hint"},'选择表达式并应用，条件会自动填充进"添加条件"区域',-1))]),(0,l.Lk)("div",$e,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Be.templates,e=>((0,l.uX)(),(0,l.Wv)(Ct,{key:e.name,checked:Be.selectedTemplateName===e.name,onChange:t=>Be.onTemplateSingleSelect(e.name,t),class:"tpl-tag bordered"},{default:(0,l.k6)(()=>[(0,l.eW)((0,r.v_)(e.name),1)]),_:2},1032,["checked","onChange"]))),128))])])):(0,l.Q3)("",!0),(0,l.Lk)("div",Ke,[(0,l.Lk)("div",We,[t[87]||(t[87]=(0,l.Lk)("span",null,"根组逻辑：",-1)),(0,l.bF)(ct,{modelValue:Be.filtersRoot.logic,"onUpdate:modelValue":t[25]||(t[25]=e=>Be.filtersRoot.logic=e)},{default:(0,l.k6)(()=>[(0,l.bF)(St,{label:"AND"},{default:(0,l.k6)(()=>[...t[83]||(t[83]=[(0,l.eW)("AND",-1)])]),_:1}),(0,l.bF)(St,{label:"OR"},{default:(0,l.k6)(()=>[...t[84]||(t[84]=[(0,l.eW)("OR",-1)])]),_:1})]),_:1},8,["modelValue"]),(0,l.Lk)("div",Me,[(0,l.bF)(He,{size:"small",type:"primary",onClick:t[26]||(t[26]=e=>Be.addConditionToGroup(Be.filtersRoot))},{default:(0,l.k6)(()=>[...t[85]||(t[85]=[(0,l.eW)("添加条件",-1)])]),_:1}),(0,l.bF)(He,{size:"small",onClick:t[27]||(t[27]=e=>Be.addGroupToGroup(Be.filtersRoot))},{default:(0,l.k6)(()=>[...t[86]||(t[86]=[(0,l.eW)("添加子组",-1)])]),_:1})])]),(0,l.bF)(xt,{group:Be.filtersRoot,"get-operator-options":Be.getOperatorOptions,"on-field-change":Be.onFieldChange,"on-operator-change":Be.onOperatorChange,"add-condition-to-group":Be.addConditionToGroup,"add-group-to-group":Be.addGroupToGroup,"remove-node-at":Be.removeNodeAt,"is-root":!0},null,8,["group","get-operator-options","on-field-change","on-operator-change","add-condition-to-group","add-group-to-group","remove-node-at"])])]),(0,l.Lk)("div",Xe,[t[89]||(t[89]=(0,l.Lk)("div",{class:"section-title"},"2. 导入表达式",-1)),(0,l.Lk)("div",Pe,[(0,l.bF)(At,{"show-file-list":!1,accept:"application/json","before-upload":Be.beforeImportTemplates},{default:(0,l.k6)(()=>[(0,l.bF)(He,{size:"small"},{default:(0,l.k6)(()=>[...t[88]||(t[88]=[(0,l.eW)("从文件导入(JSON)",-1)])]),_:1})]),_:1},8,["before-upload"])])])])]),_:1},8,["modelValue"]),(0,l.bF)(Lt,{modelValue:Be.showCompareDialog,"onUpdate:modelValue":t[30]||(t[30]=e=>Be.showCompareDialog=e),"surgery-id":Be.compareData.surgeryId,"existing-data":Be.compareData.existingData,"new-data":Be.compareData.newData,differences:Be.compareData.differences,"surgery-data":Be.compareData.surgeryData,onConfirmed:t[31]||(t[31]=e=>Be.showCompareDialog=!1)},null,8,["modelValue","surgery-id","existing-data","new-data","differences","surgery-data"])])}var Ue=a(953),Je=a(6278),Ge=a(5220),qe=a(163),Qe=a(7918),Ye=a(8548),He=a(8605),Ze=a(3110),et=a(5495),tt=a(540);const at={class:"compare-container"},lt={class:"compare-header"},rt={class:"action-buttons"},ot={class:"differences-section"},nt={class:"value-cell old-value"},st={class:"value-cell new-value"},it={key:0,class:"detailed-compare-section"},ut={class:"compare-grid"},dt={class:"compare-column"},ct={class:"json-display"},pt={class:"compare-column"},mt={class:"json-display"},gt={class:"compare-grid"},vt={class:"compare-column"},ft={class:"json-display"},yt={class:"compare-column"},ht={class:"json-display"},bt={class:"toggle-section"};var kt={__name:"SurgeryDataCompare",props:{modelValue:{type:Boolean,default:!1},surgeryId:{type:String,required:!0},existingData:{type:Object,required:!0},newData:{type:Object,required:!0},differences:{type:Array,required:!0},surgeryData:{type:Object,required:!0}},emits:["update:modelValue","confirmed"],setup(e,{emit:t}){const a=e,o=t,n=(0,l.EW)({get:()=>a.modelValue,set:e=>o("update:modelValue",e)}),s=(0,Ue.KR)(!1),i=(0,Ue.KR)(!1),u=(0,Ue.KR)("basic");(0,l.sV)(async()=>{await(0,tt.Js)()});const d=new Set,c=(e,t,a="old")=>{if(null===e||void 0===e)return"无";if(t&&(t.includes("时间")||t.includes("time"))&&("old"!==a||"开始时间"!==t&&"结束时间"!==t||d.has(t)||(console.log(`🔧 原有数据${t}: ${e}`),d.add(t)),"string"===typeof e&&""!==e.trim())){const l=(0,tt.fU)(e);return"old"!==a||"开始时间"!==t&&"结束时间"!==t||!d.has(t)||(console.log(`🔧 原有数据${t}转换后: ${l}`),d.delete(t)),l}return"object"===typeof e?JSON.stringify(e,null,2):String(e)},p=e=>{if(null===e||void 0===e)return e;if(Array.isArray(e))return e.map(e=>p(e));if("object"===typeof e){const t={};for(const[a,l]of Object.entries(e)){const e=a.toLowerCase().includes("time")||a.toLowerCase().includes("timestamp")||"start_time"===a||"end_time"===a||"on_time"===a||"off_time"===a||"created_at"===a||"updated_at"===a||"last_analyzed_at"===a;t[a]=e&&l?(0,tt.fU)(l):p(l)}return t}return e},m=e=>{if(!e)return"无";const t=JSON.parse(JSON.stringify(e)),a=p(t);return JSON.stringify(a,null,2)},g=e=>{const t={basic:"primary",structured:"success",arms:"warning",stats:"info",usage_count:"danger",fault_count:"danger"};return t[e]||"default"},v=e=>{const t={basic:"基础字段",structured:"结构化数据",arms:"器械数据",stats:"统计数据",usage_count:"使用次数",fault_count:"故障数量"};return t[e]||e},f=async()=>{try{await Qe.s.confirm("确认要覆盖数据库中的手术数据吗？此操作不可撤销。","确认覆盖",{confirmButtonText:"确认覆盖",cancelButtonText:"取消",type:"warning"}),s.value=!0;const e=await et.A.surgeryStatistics.confirmOverrideSurgeryData(a.surgeryData,!0);e.data.success?(qe.nk.success("手术数据已成功覆盖到PostgreSQL数据库"),o("confirmed"),n.value=!1):qe.nk.error(e.data.message||"覆盖失败")}catch(e){"cancel"!==e&&(console.error("覆盖手术数据失败:",e),qe.nk.error("覆盖手术数据失败: "+(e.response?.data?.message||e.message)))}finally{s.value=!1}};return(t,a)=>{const o=(0,l.g2)("el-alert"),d=(0,l.g2)("el-button"),p=(0,l.g2)("el-table-column"),y=(0,l.g2)("el-tag"),h=(0,l.g2)("el-table"),b=(0,l.g2)("el-tab-pane"),k=(0,l.g2)("el-tabs"),_=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.Wv)(_,{modelValue:n.value,"onUpdate:modelValue":a[3]||(a[3]=e=>n.value=e),title:"手术数据比对",width:"1200px","close-on-click-modal":!1,"append-to-body":""},{default:(0,l.k6)(()=>[(0,l.Lk)("div",at,[(0,l.Lk)("div",lt,[(0,l.bF)(o,{type:"warning",title:`数据库中已存在手术ID为 ${e.surgeryId} 的手术数据，检测到 ${e.differences.length} 处差异`,"show-icon":"",closable:!1,style:{"margin-bottom":"20px"}},null,8,["title"]),(0,l.Lk)("div",rt,[(0,l.bF)(d,{onClick:a[0]||(a[0]=e=>n.value=!1)},{default:(0,l.k6)(()=>[...a[4]||(a[4]=[(0,l.eW)("取消",-1)])]),_:1}),(0,l.bF)(d,{type:"primary",onClick:f,loading:s.value},{default:(0,l.k6)(()=>[...a[5]||(a[5]=[(0,l.eW)(" 确认覆盖 ",-1)])]),_:1},8,["loading"])])]),(0,l.Lk)("div",ot,[a[6]||(a[6]=(0,l.Lk)("h3",null,"数据差异详情",-1)),(0,l.bF)(h,{data:e.differences,style:{width:"100%"},"max-height":"500"},{default:(0,l.k6)(()=>[(0,l.bF)(p,{prop:"fieldName",label:"字段名称",width:"200"}),(0,l.bF)(p,{label:"原有数据","min-width":"250"},{default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",nt,[(0,l.Lk)("pre",null,(0,r.v_)(c(e.oldValue,e.fieldName,"old")),1)])]),_:1}),(0,l.bF)(p,{label:"新数据","min-width":"250"},{default:(0,l.k6)(({row:e})=>[(0,l.Lk)("div",st,[(0,l.Lk)("pre",null,(0,r.v_)(c(e.newValue,e.fieldName,"new")),1)])]),_:1}),(0,l.bF)(p,{prop:"type",label:"类型",width:"120"},{default:(0,l.k6)(({row:e})=>[(0,l.bF)(y,{type:g(e.type)},{default:(0,l.k6)(()=>[(0,l.eW)((0,r.v_)(v(e.type)),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),i.value?((0,l.uX)(),(0,l.CE)("div",it,[a[11]||(a[11]=(0,l.Lk)("h3",null,"详细数据比对",-1)),(0,l.bF)(k,{modelValue:u.value,"onUpdate:modelValue":a[1]||(a[1]=e=>u.value=e)},{default:(0,l.k6)(()=>[(0,l.bF)(b,{label:"基础信息",name:"basic"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",ut,[(0,l.Lk)("div",dt,[a[7]||(a[7]=(0,l.Lk)("h4",null,"数据库中的数据",-1)),(0,l.Lk)("pre",ct,(0,r.v_)(m(e.existingData)),1)]),(0,l.Lk)("div",pt,[a[8]||(a[8]=(0,l.Lk)("h4",null,"新分析的数据",-1)),(0,l.Lk)("pre",mt,(0,r.v_)(m(e.newData)),1)])])]),_:1}),(0,l.bF)(b,{label:"结构化数据",name:"structured"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",gt,[(0,l.Lk)("div",vt,[a[9]||(a[9]=(0,l.Lk)("h4",null,"数据库中的结构化数据",-1)),(0,l.Lk)("pre",ft,(0,r.v_)(m(e.existingData.structured_data)),1)]),(0,l.Lk)("div",yt,[a[10]||(a[10]=(0,l.Lk)("h4",null,"新分析的结构化数据",-1)),(0,l.Lk)("pre",ht,(0,r.v_)(m(e.newData.structured_data)),1)])])]),_:1})]),_:1},8,["modelValue"])])):(0,l.Q3)("",!0),(0,l.Lk)("div",bt,[(0,l.bF)(d,{type:"text",onClick:a[2]||(a[2]=e=>i.value=!i.value),icon:i.value?"ArrowUp":"ArrowDown"},{default:(0,l.k6)(()=>[(0,l.eW)((0,r.v_)(i.value?"隐藏":"显示")+"详细比对 ",1)]),_:1},8,["icon"])])])]),_:1},8,["modelValue"])}}},_t=a(6262);const wt=(0,_t.A)(kt,[["__scopeId","data-v-26daaf7f"]]);var Ct=wt,St=a(8762),xt={name:"BatchAnalysis",components:{Search:Ye.Search,Download:Ye.Download,ArrowLeft:Ye.ArrowLeft,DataAnalysis:Ye.DataAnalysis,Warning:Ye.Warning,TimeSeriesChart:Ze.A,SurgeryDataCompare:Ct,ExplanationCell:{name:"ExplanationCell",props:{text:{type:String,default:""}},setup(e){return()=>(0,l.h)("span",{class:"explanation-ellipsis",title:e.text,style:"display:inline-block;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:14px;font-weight:500;color:#606266;"},e.text)}},ConditionGroup:{name:"ConditionGroup",props:{group:{type:Object,required:!0},getOperatorOptions:{type:Function,required:!0},onFieldChange:{type:Function,required:!0},onOperatorChange:{type:Function,required:!0},addConditionToGroup:{type:Function,required:!0},addGroupToGroup:{type:Function,required:!0},removeNodeAt:{type:Function,required:!0},isRoot:{type:Boolean,default:!1}},setup(e){const t=(0,l.g2)("el-select"),a=(0,l.g2)("el-option"),r=(0,l.g2)("el-input"),o=(0,l.g2)("el-button"),n=(0,l.g2)("el-radio-group"),s=(0,l.g2)("el-radio-button"),i=(0,l.g2)("ConditionGroup"),u=(n,s,i)=>(0,l.h)("div",{class:"condition",key:s},[(0,l.h)(t,{modelValue:n.field,style:"width: 140px;",placeholder:"字段","onUpdate:modelValue":t=>{"object"===typeof n&&null!==n?(n.field=t,e.onFieldChange(n)):(Object.assign(n,{field:t}),e.onFieldChange(n))}},{default:()=>[(0,l.h)(a,{label:"时间戳",value:"timestamp"}),(0,l.h)(a,{label:"故障码",value:"error_code"}),(0,l.h)(a,{label:"参数1",value:"param1"}),(0,l.h)(a,{label:"参数2",value:"param2"}),(0,l.h)(a,{label:"参数3",value:"param3"}),(0,l.h)(a,{label:"参数4",value:"param4"}),(0,l.h)(a,{label:"释义",value:"explanation"})]}),(0,l.h)(t,{modelValue:n.operator,style:"width: 150px; margin-left: 8px;",placeholder:"操作符","onUpdate:modelValue":t=>{"object"===typeof n&&null!==n?(n.operator=t,e.onOperatorChange(n)):(Object.assign(n,{operator:t}),e.onOperatorChange(n))}},{default:()=>(e.getOperatorOptions(n.field)||[]).map(e=>(0,l.h)(a,{label:e.label,value:e.value,key:e.value}))}),"between"===n.operator?[(0,l.h)(r,{modelValue:Array.isArray(n.value)?n.value[0]:"",placeholder:"起",style:"width: 140px; margin-left:8px;","onUpdate:modelValue":e=>{const t=Array.isArray(n.value)?n.value.slice(0,2):["",""];t[0]=e,n.value=t}}),(0,l.h)(r,{modelValue:Array.isArray(n.value)?n.value[1]:"",placeholder:"止",style:"width: 140px; margin-left:8px;","onUpdate:modelValue":e=>{const t=Array.isArray(n.value)?n.value.slice(0,2):["",""];t[1]=e,n.value=t}})]:(0,l.h)(r,{modelValue:Array.isArray(n.value)?n.value.join(","):n.value??"",placeholder:"值",style:"width: 300px; margin-left:8px;","onUpdate:modelValue":e=>{"object"===typeof n.value&&null!==n.value?n.value=e:Object.assign(n,{value:e})}}),(0,l.h)(o,{type:"danger",text:!0,style:"margin-left:8px;",onClick:()=>e.removeNodeAt(i,s)},{default:()=>"删除"})]),d=(t,a,r=0)=>{const d=Array.isArray(t.conditions)?t.conditions:[],c=r>0?`margin-left: ${12*r}px;`:"";return(0,l.h)("div",{class:"group-box",style:c},[...d.map((a,d)=>a&&a.field?u(a,d,t):(0,l.h)("div",{class:"group-box",key:d,style:`margin-left: ${12*(r+1)}px;`},[(0,l.h)("div",{class:"group-header nested"},[(0,l.h)("span",null,"组逻辑："),(0,l.h)(n,{modelValue:a.logic||"AND","onUpdate:modelValue":e=>{"object"===typeof a&&null!==a?a.logic=e:Object.assign(a,{logic:e})}},{default:()=>[(0,l.h)(s,{label:"AND"},{default:()=>"AND"}),(0,l.h)(s,{label:"OR"},{default:()=>"OR"})]}),(0,l.h)("div",{class:"group-actions"},[(0,l.h)(o,{size:"small",type:"primary",onClick:()=>e.addConditionToGroup(a)},{default:()=>"添加条件"}),(0,l.h)(o,{size:"small",onClick:()=>e.addGroupToGroup(a)},{default:()=>"添加子组"}),(0,l.h)(o,{size:"small",type:"danger",text:!0,onClick:()=>e.removeNodeAt(t,d)},{default:()=>"删除组"})])]),(0,l.h)(i,{group:a,getOperatorOptions:e.getOperatorOptions,onFieldChange:e.onFieldChange,onOperatorChange:e.onOperatorChange,addConditionToGroup:e.addConditionToGroup,addGroupToGroup:e.addGroupToGroup,removeNodeAt:e.removeNodeAt,depth:r+1})])),(0,l.h)("div",{class:"group-actions"},[(0,l.h)(o,{size:"small",type:"primary",onClick:()=>e.addConditionToGroup(t)},{default:()=>"添加条件"}),(0,l.h)(o,{size:"small",onClick:()=>e.addGroupToGroup(t)},{default:()=>"添加子组"})])])};return()=>d(e.group,e.group,0)}}},setup(){const e=(0,Je.Pj)(),t=(0,Ge.lq)(),a=((0,Ge.rd)(),(0,Ue.KR)(!1)),r=(0,Ue.KR)([]),o=(0,Ue.KR)([]),n=(0,Ue.KR)(""),s=(0,Ue.KR)(null),i=(0,Ue.KR)(1),u=(0,Ue.KR)(50),d=(0,Ue.KR)(0),c=(0,Ue.KR)(0),p=(0,Ue.KR)(null),m=(0,Ue.KR)(null),g=(0,Ue.KR)(!1),v=(0,Ue.KR)(!1),f=(0,Ue.KR)(!1),y=(0,Ue.KR)(null),h=(0,Ue.KR)(5),b=(0,Ue.KR)(5),k=(0,Ue.KR)(0),_=(0,Ue.KR)(0),w=(0,Ue.KR)(!1),C=(0,Ue.KR)([]),S=50,x=(0,Ue.KR)(""),A=(0,Ue.KR)(!1),L=(0,Ue.KR)("logs"),D=(0,l.EW)(()=>C.value.length>0?C.value.length:x.value?x.value.split(/\r?\n/).filter(e=>e.trim().length>0).length:0),F=(0,l.EW)(()=>{const e=D.value,t=e/S*100;return Math.max(0,Math.min(100,Math.round(t)))}),N=(0,Ue.KR)(!1),E=(0,Ue.KR)(null),R=(0,Ue.KR)(null),V=(0,Ue.KR)(null),T=(0,Ue.KR)(null),z=(0,Ue.KR)(null),I=(0,Ue.KR)(!1),O=(0,Ue.KR)([]),$=(0,Ue.KR)([!1,!1,!1,!1]),K=(0,Ue.KR)(["参数1","参数2","参数3","参数4"]),W=(0,Ue.KR)(0),M=(0,Ue.KR)(null),X=(0,Ue.KR)(!1),P=(0,Ue.KR)(""),j=(0,Ue.KR)(null),B=(0,Ue.KR)(null),U=(0,Ue.KR)([]),J=(0,Ue.KR)(null),G=(0,Ue.KR)({}),q=(0,Ue.KR)({}),Q=(0,Ue.KR)({}),Y=(0,Ue.KR)({}),H=(0,Ue.KR)({}),Z=(0,l.EW)(()=>{const e=r.value.map(e=>e.id).join(","),t={log_ids:e};if(g.value&&xe.value>0){const e=Pt();e&&(t.filters=JSON.stringify(e))}s.value&&2===s.value.length&&(t.start_time=s.value[0],t.end_time=s.value[1]),n.value&&(t.search=n.value);try{return JSON.stringify(t)}catch(a){return""}}),ee=(0,Ue.KR)(null),te=async()=>{try{const t={log_ids:r.value.map(e=>e.id).join(",")};console.log("获取全局统计信息，参数:",t);const a=await et.A.logs.getStatistics(t);if(a.data.success){Q.value=a.data.errorCodeCounts||{};try{sessionStorage.setItem("globalErrorCodeCounts",JSON.stringify(Q.value)),sessionStorage.setItem("globalStatisticsTimestamp",Date.now().toString())}catch(e){console.warn("存储全局统计信息失败:",e)}console.log("全局统计信息获取成功:",{globalErrorCodeCounts:Object.keys(Q.value).length,sample:Object.keys(Q.value).slice(0,3)})}else console.warn("全局统计API返回失败:",a.data)}catch(e){console.error("获取全局统计信息失败:",e),Q.value={}}},ae=async()=>{try{const t=r.value.map(e=>e.id).join(","),a={log_ids:t};if(g.value&&xe.value>0){const e=Pt();e&&(a.filters=JSON.stringify(e))}s.value&&2===s.value.length&&(a.start_time=s.value[0],a.end_time=s.value[1]),n.value&&(a.search=n.value);const l=JSON.stringify(a);if(H.value[l])return void(Y.value=H.value[l]);const o=await et.A.logs.getStatistics(a);if(o.data.success){const t=o.data.errorCodeCounts||{};Y.value=t,H.value[l]=t;try{sessionStorage.setItem("filteredErrorCodeCounts",JSON.stringify(t)),sessionStorage.setItem("filteredStatisticsTimestamp",Date.now().toString()),sessionStorage.setItem("statisticsCache",JSON.stringify(H.value)),sessionStorage.setItem("currentStatisticsKey",l)}catch(e){console.warn("存储筛选统计信息失败:",e)}}else console.warn("筛选统计API返回失败:",o.data)}catch(e){console.error("获取筛选统计信息失败:",e),Y.value={}}},le=async()=>{await ae(),q.value=Y.value,G.value=Y.value},re=(e,t=!1)=>{if(t)return Q.value[e]||0;const a=Z.value,l=a&&H.value[a]?H.value[a]:Y.value;return l&&l[e]?l[e]:0},oe=e=>{const t=re(e,!0),a=re(e,!1);return ne.value?a>0?a.toString():"":t>0?t.toString():""},ne=(0,l.EW)(()=>{const e=!!n.value,t=xe.value>0,a=!(!s.value||2!==s.value.length||!Ne.value||s.value[0]===ut(Ne.value[0])&&s.value[1]===ut(Ne.value[1]));return!!(e||a||t)}),se=()=>{try{const e=sessionStorage.getItem("globalErrorCodeCounts");e&&(Q.value=JSON.parse(e));const t=sessionStorage.getItem("statisticsCache");t&&(H.value=JSON.parse(t));const a=sessionStorage.getItem("currentStatisticsKey");if(a&&a===Z.value){const e=sessionStorage.getItem("filteredErrorCodeCounts");e&&(Y.value=JSON.parse(e))}else Y.value={};const l=sessionStorage.getItem("logCounts");l&&(G.value=JSON.parse(l));const r=sessionStorage.getItem("errorCodeCounts");r&&(q.value=JSON.parse(r)),console.log("从sessionStorage加载统计数据成功:",{globalCount:Object.keys(Q.value).length,filteredCount:Object.keys(Y.value).length,cacheCount:Object.keys(H.value).length})}catch(e){console.warn("加载计数数据失败:",e)}},ie=async e=>{ee.value===e?ee.value=null:(ee.value=e,ne.value&&(console.log("有筛选条件，重新获取筛选统计..."),await ae()))},ue=e=>{const t=re(e,!0),a=re(e,!1);let l=`故障码 ${e} 统计信息：\n`;l+=`全局出现次数：${t}\n`,ne.value?l+=`筛选条件下出现次数：${a}`:l+="当前无筛选条件，显示全局统计",qe.nk.info({message:l,duration:3e3,showClose:!0})},de=e=>{const t=re(e,!0),a=re(e,!1);return ne.value?`全局：${t} 次，筛选后：${a} 次`:`全局出现 ${t} 次`},ce=(0,Ue.KR)([{value:"#D7BDE2",label:"红色"},{value:"#D1F2EB",label:"黄色"},{value:"#FCF3CF",label:"蓝色"},{value:"#d6eaf8",label:"绿色"},{value:null,label:"无"}]),pe=(0,Ue.KR)([{prop:"color_mark",label:"标记"},{prop:"file_info",label:"时间戳/文件名"},{prop:"error_code",label:"故障码"},{prop:"explanation",label:"释义"},{prop:"parameters",label:"参数(1~4)"},{prop:"operations",label:"操作"}]),me=(0,Ue.KR)(!1),ge=(0,Ue.KR)({logic:"AND",conditions:[]}),ve=(0,Ue.KR)(!1),fe=(0,Ue.KR)(null),ye=(0,Ue.KR)(!1),he=(0,Ue.KR)([]),be=(0,Ue.KR)(""),ke=(0,Ue.KR)(""),_e=e=>{if(!e)return"";if(e.field&&e.operator){const t=Array.isArray(e.value)?e.value.join(","):e.value??"";return`${e.field} ${e.operator} ${t}`}if(Array.isArray(e.conditions)){const t=e.logic||"AND",a=e.conditions.map(e=>_e(e)).filter(Boolean).join(` ${t} `);return a?(ge.value,`(${a})`):""}return""},we=(0,l.EW)(()=>{const e=[];if(s.value&&2===s.value.length){const[t,a]=s.value;e.push(`时间: ${ut(t)} ~ ${ut(a)}`)}n.value&&e.push(`关键字(全部): ${n.value}`);const t=_e(ge.value);return t&&e.push(`${t}`),e.join(" AND ")}),Ce=(0,l.EW)(()=>{const e=_e(ge.value);return e||""}),Se=e=>e?e.field&&e.operator?1:Array.isArray(e.conditions)?e.conditions.reduce((e,t)=>e+Se(t),0):0:0,xe=(0,l.EW)(()=>Se(ge.value)),Ae=(0,l.EW)(()=>{const e=Array.isArray(o.value)?o.value:[];let t=e;return g.value&&v.value&&xe.value>0&&(t=t.filter(e=>$t(e))),t}),Le=(0,l.EW)(()=>Array.isArray(o.value)?o.value.length:0),De=(0,l.EW)(()=>Array.isArray(r.value)?r.value.length:0),Fe=(0,l.EW)(()=>d.value),Ne=(0,l.EW)(()=>{if(p.value&&m.value){const e=new Date(p.value),t=new Date(m.value);if(!Number.isNaN(e.getTime())&&!Number.isNaN(t.getTime()))return[e,t]}const e=o.value;if(!e||0===e.length)return null;const t=e.map(e=>new Date(e.timestamp)).filter(e=>!isNaN(e));if(0===t.length)return null;const a=new Date(Math.min(...t)),l=new Date(Math.max(...t));return[a,l]}),Ee=(0,l.EW)(()=>Ae.value),Re=async()=>{const a=t.params?.logIds,l=t.query?.logIds,o=t.params?.id,n=t.query?.id;let s=a||l||o||n;if(!s)return;const i=String(s).split(",").map(e=>parseInt(e)).filter(e=>!Number.isNaN(e));if(0!==i.length)try{const t=await e.dispatch("logs/fetchLogs",{page:1,limit:1e3}),a=t.data.logs;r.value=a.filter(e=>i.includes(e.id))}catch(u){qe.nk.error("获取日志信息失败")}},Ve=async(t=1,l=!1,v=null)=>{if(0!==r.value.length)try{a.value=!0,l&&(o.value=[],i.value=t);const f=r.value.map(e=>e.id).join(","),y={log_ids:f,page:t,limit:u.value};if(g.value&&xe.value>0){const e=Pt();e&&(y.filters=JSON.stringify(e))}s.value&&2===s.value.length&&(y.start_time=s.value[0],y.end_time=s.value[1]),n.value&&(y.search=n.value);const h=await e.dispatch("logs/fetchBatchLogEntries",y,v),{entries:b,total:k,totalPages:_,page:w,minTimestamp:C,maxTimestamp:S}=h.data;if(l&&1===t){const e=[];0===Object.keys(Q.value).length&&e.push(te()),e.push(ae()),Promise.all(e).catch(e=>{console.warn("获取统计信息失败:",e)})}const x=new Map(r.value.map(e=>[e.id,e.original_name])),A=b.map(e=>{const t=ut(e.timestamp),a=[e.param1,e.param2,e.param3,e.param4].filter(e=>e);return{...e,log_name:x.get(e.log_id)||"",color_mark:e.color_mark||null,remarks:e.remarks||"",timestamp_text:t,display_params:a}});if(l?o.value=A:o.value.push(...A),Zt(),Pa(),d.value=k,c.value=_,"number"!==typeof w||Number.isNaN(w)||(i.value=w),C&&S){const e=new Date(C),t=new Date(S);if(!Number.isNaN(e.getTime())&&!Number.isNaN(t.getTime())){p.value=e,m.value=t;const a=!s.value||2!==s.value.length,[l,r]=a?[null,null]:s.value,o=l?new Date(l):null,n=r?new Date(r):null,i=!o||!n||o<e||n>t;(a||i)&&(s.value=[ut(e),ut(t)])}}}catch(f){qe.nk.error("批量分析失败: "+(f.response?.data?.message||f.message))}finally{a.value=!1,o.value.length>0&&await le()}},Te=(0,Ue.KR)(!1),ze=()=>{Te.value=!0},Ie=()=>{Te.value=!1,Ke()};let Oe=null,$e=null;const Ke=()=>{if(Te.value)return;$e&&$e.abort(),Oe&&clearTimeout(Oe),$e=new AbortController;const e=We();Oe=setTimeout(async()=>{Te.value||(i.value=1,await Ve(1,!0,$e.signal),await ae())},e)},We=()=>{let e=300;return g.value&&xe.value>0&&(e+=100*xe.value),s.value&&2===s.value.length&&(e+=200),n.value&&n.value.length>10&&(e+=150),Math.min(e,1e3)},Me=()=>{Ke()},Xe=async()=>{$e&&$e.abort(),i.value=1,await Ve(1,!0),await ae()},Pe=async()=>{if(Ne.value&&s.value&&2===s.value.length){const[e,t]=Ne.value;let[a,l]=s.value;const r=new Date(a),o=new Date(l);let n=!1;r<e&&(a=e,n=!0),o>t&&(l=t,n=!0),n&&(s.value=[ut(a),ut(l)])}$e&&$e.abort(),i.value=1,await Ve(1,!0),await ae()},je=async()=>{$e&&$e.abort(),n.value="",s.value=null,ge.value={logic:"AND",conditions:[]},g.value=!1,i.value=1,await Ve(1,!0),await te()},Be=()=>{ge.value={logic:"AND",conditions:[]},Ke()},Ye=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),Ze=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999),at=e=>{if(!Ne.value||!e)return!1;const[t,a]=Ne.value;return e<Ye(new Date(t))||e>Ze(new Date(a))},lt=(0,l.EW)(()=>Ne.value?[Ne.value[0],Ne.value[1]]:null),rt=async()=>{try{const t=e.state.auth?.token;if(!t)return void qe.nk.error("未登录或登录已过期");const a=r.value.map(e=>e.id).join(","),l=new URLSearchParams;if(a&&l.set("log_ids",a),g.value&&xe.value>0){const e=Pt();e&&l.set("filters",JSON.stringify(e))}s.value&&2===s.value.length&&(l.set("start_time",s.value[0]),l.set("end_time",s.value[1])),n.value&&l.set("search",n.value),l.set("token",t);const o="/api/logs/entries/export",i=`${o}?${l.toString()}`;window.open(i,"_blank")}catch(t){qe.nk.error("导出CSV失败: "+(t?.response?.data?.message||t?.message||"未知错误"))}},ot=e=>{u.value=e,i.value=1,Ve(1,!0)},nt=async e=>{i.value=e,await Ve(e,!0)},st=async()=>{allowAutoLoad.value&&i.value<c.value&&!a.value&&(i.value++,await Ve(i.value,!1))},it=()=>{},ut=e=>{if(!e)return"-";const t=new Date(e);if(null!==dt.value){const e=-t.getTimezoneOffset(),a=60*(dt.value-e)*1e3;t.setTime(t.getTime()+a)}const a=t.getFullYear(),l=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),s=String(t.getSeconds()).padStart(2,"0");return`${a}-${l}-${r} ${o}:${n}:${s}`},dt=(0,Ue.KR)(null),ct=async()=>{try{const e=await fetch("/api/timezone"),t=await e.json();"number"===typeof t.offsetMinutes&&(dt.value=t.offsetMinutes)}catch(e){dt.value=null}},pt=e=>{if(!e||e.length<2)return ut;const t=new Date(e[0][0]),a=new Date(e[e.length-1][0]),l=a.getTime()-t.getTime();return l<6e4?e=>{const t=new Date(e),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${a}:${l}:${r}`}:l>864e5?e=>{const t=new Date(e),a=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${a}-${l}`}:l>36e5?e=>{const t=new Date(e),a=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${a}-${l} ${r}:${o}`}:ut},mt=e=>{if(!e||0===e)return"0 B";const t=1024,a=["B","KB","MB","GB"],l=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,l)).toFixed(2))+" "+a[l]},gt=async()=>{if(e.getters["auth/hasPermission"]?.("surgery:analyze"))if(0!==o.value.length)try{ft.value=!0,yt.value=!0;const e=r.value.map(e=>e.id),a=await et.A.surgeryStatistics.analyzeByLogIds(e,!0);if(a.data?.taskId){const e=a.data.taskId;let l=0;const r=30;while(l<r){try{const t=await et.A.surgeryStatistics.getAnalysisTaskStatus(e),a=t.data?.data?.result;if(Array.isArray(a)){ht.value=a;break}}catch(t){}await new Promise(e=>setTimeout(e,1e3)),l++}Array.isArray(ht.value)&&0!==ht.value.length||qe.nk.warning("未获取到手术统计结果，请稍后重试")}else ht.value=a.data?.data||[]}catch(a){qe.nk.error("手术统计失败")}finally{yt.value=!1}else qe.nk.warning("请先加载日志条目数据");else qe.nk.warning("权限不足：需要手术分析权限")},vt=async()=>{try{const e=await et.A.logs.getSearchTemplates();he.value=e.data.templates||[]}catch{}},ft=(0,Ue.KR)(!1),yt=(0,Ue.KR)(!1),ht=(0,Ue.KR)([]),bt=(0,Ue.KR)({}),kt=(0,Ue.KR)(!1),_t=(0,Ue.KR)(""),wt=(0,Ue.KR)(!1),Ct=(0,Ue.KR)({}),xt=(0,l.EW)(()=>e.getters["auth/hasPermission"]?.("surgery:export")),At=e=>{(0,St._C)(e)},Lt=e=>{const t=e?.postgresql_row_preview||e;_t.value=JSON.stringify(t,null,2),kt.value=!0},Dt=async t=>{if(e.getters["auth/hasPermission"]?.("surgery:export"))try{bt.value[t.id]=!0;const e=await et.A.surgeryStatistics.exportSingleSurgeryData(t);e.data.success?qe.nk.success("手术数据已成功导出到PostgreSQL数据库"):e.data.needsConfirmation?(wt.value=!0,Ct.value={surgeryId:e.data.surgery_id,existingData:e.data.existingData,newData:e.data.newData,differences:e.data.differences,surgeryData:t}):qe.nk.warning(e.data.message||"导出完成，但可能未存储到数据库")}catch(a){console.error("导出到PostgreSQL失败:",a),qe.nk.error("导出到PostgreSQL数据库失败: "+(a.response?.data?.message||a.message))}finally{bt.value[t.id]=!1}},Ft=e=>{const t=he.value.find(t=>t.name===e);t&&(ge.value={logic:t.filters?.logic||"AND",conditions:Array.isArray(t.filters?.conditions)?[...t.filters.conditions]:[]})},Nt=async e=>{try{const t=await e.text(),a=JSON.parse(t);let l="AND",r=[];if(a&&(Array.isArray(a.conditions)||Array.isArray(a.filters?.conditions)))l=a.logic||a.filters?.logic||"AND",r=Array.isArray(a.conditions)?a.conditions:a.filters?.conditions||[];else if(Array.isArray(a.templates)&&a.templates.length>0){const e=a.templates[0];l=e?.filters?.logic||"AND",r=Array.isArray(e?.filters?.conditions)?e.filters.conditions:[]}r.length>0?(ge.value={logic:l,conditions:[...r]},qe.nk.success("已从文件填充到高级条件")):qe.nk.warning("未识别到可用的表达式内容")}catch(t){qe.nk.error("解析失败："+t.message)}return!1},Et=(e,t)=>{be.value=t?e:""},Rt=new Set(["param1","param2","param3","param4"]),Vt=(e,t,a)=>{const l=String(t||"").toLowerCase(),r=Rt.has(e);if(void 0===a||null===a||""===a)return null;if("between"===l||"notbetween"===l){const e=Array.isArray(a)?a:String(a).split(",");if(e.length<2)return null;const t=(e[0]??"").toString().trim(),l=(e[1]??"").toString().trim();if(r){const e=Number(t),a=Number(l);return Number.isNaN(e)||Number.isNaN(a)?null:[e,a]}return[t,l]}if("in"===l||"notin"===l){const e=Array.isArray(a)?a:[a],t=e.map(e=>e.toString().trim()).filter(e=>""!==e);return r?t.map(e=>Number(e)).filter(e=>!Number.isNaN(e)):t}if(r){const e=Number(a);return Number.isNaN(e)?a:e}return a},Tt=(e,t)=>"timestamp"===t?new Date(e.timestamp):e[t],zt=e=>{const t=Number(e);return Number.isNaN(t)?null:t},It=(e,t,a,l)=>{const r=String(t||"").toLowerCase(),o=Tt(l,e);if(void 0===o||null===o)return!1;const n=Rt.has(e),s="timestamp"===e;if("between"===r||"notbetween"===r){const e=Array.isArray(a)?a:String(a??"").split(",");if(e.length<2)return!1;if(n){const t=zt(e[0]),a=zt(e[1]);if(null===t||null===a)return!1;const l=zt(o);if(null===l)return!1;const n=l>=Math.min(t,a)&&l<=Math.max(t,a);return"between"===r?n:!n}if(s){const t=new Date(e[0]),a=new Date(e[1]),l=new Date(o),n=l>=(t<a?t:a)&&l<=(t<a?a:t);return"between"===r?n:!n}const t=String(o),l=t>=String(e[0])&&t<=String(e[1]);return"between"===r?l:!l}if("in"===r||"notin"===r){const e=Array.isArray(a)?a:String(a??"").split(",").map(e=>e.trim()).filter(Boolean);if(n){const t=new Set(e.map(zt).filter(e=>null!==e)),a=zt(o),l=null!==a&&t.has(a);return"in"===r?l:!l}const t=new Set(e.map(e=>e.toString())),l=t.has(String(o));return"in"===r?l:!l}if("regex"===r)try{const e=new RegExp(String(a));return e.test(String(o))}catch{return!1}if("contains"===r||"like"===r)return String(o).toLowerCase().includes(String(a??"").toLowerCase());if("notcontains"===r)return!String(o).toLowerCase().includes(String(a??"").toLowerCase());if("startswith"===r)return String(o).startsWith(String(a??""));if("endswith"===r)return String(o).endsWith(String(a??""));if(n){const e=zt(o),t=zt(a);if(null===e||null===t)return!1;switch(r){case"=":return e===t;case"!=":case"<>":return e!==t;case">":return e>t;case">=":return e>=t;case"<":return e<t;case"<=":return e<=t;default:return!1}}if(s){const e=new Date(o).getTime(),t=new Date(a).getTime();switch(r){case"=":return e===t;case"!=":case"<>":return e!==t;case">":return e>t;case">=":return e>=t;case"<":return e<t;case"<=":return e<=t;default:return!1}}const i=String(o),u=String(a??"");switch(r){case"=":return i===u;case"!=":case"<>":return i!==u;case">":return i>u;case">=":return i>=u;case"<":return i<u;case"<=":return i<=u;default:return!1}},Ot=(e,t)=>{if(!e)return!0;if(e.field&&e.operator)return It(e.field,e.operator,e.value,t);if(Array.isArray(e.conditions)){const a=e.logic||"AND",l=e.conditions.map(e=>Ot(e,t));return"OR"===a?l.some(Boolean):l.every(Boolean)}return!0},$t=e=>Ot(ge.value,e),Kt=(0,Ue.KR)(null),Wt=async()=>{if(ke.value)try{const e=JSON.parse(ke.value);if(e&&(Array.isArray(e.conditions)||Array.isArray(e.filters?.conditions))){const t=e.logic||e.filters?.logic||"AND",a=Array.isArray(e.conditions)?e.conditions:e.filters?.conditions;ge.value={logic:t,conditions:Array.isArray(a)?[...a]:[]},qe.nk.success('表达式已填充，请点击"应用"执行搜索'),me.value=!0,await(0,l.dY)(),Kt.value&&Kt.value.scrollIntoView&&Kt.value.scrollIntoView({behavior:"smooth",block:"nearest"})}else qe.nk.error("JSON格式不正确，缺少 conditions")}catch(e){qe.nk.error("解析失败："+e.message)}},Mt=async()=>{if(ke.value)try{const e=JSON.parse(ke.value);if(e&&(Array.isArray(e.conditions)||Array.isArray(e.filters?.conditions))){const t=e.logic||e.filters?.logic||"AND",a=Array.isArray(e.conditions)?e.conditions:e.filters?.conditions;return ge.value={logic:t,conditions:Array.isArray(a)?[...a]:[]},void qe.nk.success('表达式已填充，请点击"应用"执行搜索')}qe.nk.warning("未识别到可用的表达式内容")}catch(e){qe.nk.error("仅支持 JSON 格式的表达式导入")}},Xt=async()=>{ye.value=!0;try{const e=r.value.map(e=>e.id),t=await et.A.surgeryStatistics.analyzeByLogIds(e,!0);t.data.success?qe.nk.success(t.data.message||`成功分析出 ${t.data.data?.length||0} 场手术`):qe.nk.error(t.data.message||"批量分析手术数据失败")}catch(e){qe.nk.error("批量分析手术数据失败: "+(e.response?.data?.message||e.message))}finally{ye.value=!1}},Pt=()=>{const e=t=>{if(!t)return null;if(t.field&&t.operator){if(void 0===t.value||null===t.value||""===t.value)return null;const e=Vt(t.field,t.operator,t.value);return null===e?null:{field:t.field,operator:t.operator,value:e}}if(Array.isArray(t.conditions)){const a=t.conditions.map(e).filter(Boolean);return 0===a.length?null:{logic:t.logic||"AND",conditions:a}}return null},t=e(ge.value);return t},jt={timestamp:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"}],error_code:[{label:"=",value:"="},{label:"!=",value:"!="},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"},{label:"正则",value:"regex"},{label:"前缀",value:"startsWith"},{label:"后缀",value:"endsWith"}],param1:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param2:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param3:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],param4:[{label:"=",value:"="},{label:"!=",value:"!="},{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"Between",value:"between"},{label:"In",value:"in"},{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"}],explanation:[{label:"包含(Like)",value:"contains"},{label:"不包含",value:"notcontains"},{label:"正则",value:"regex"},{label:"前缀",value:"startsWith"},{label:"后缀",value:"endsWith"}]},Bt=[{label:"=",value:"="},{label:"!=",value:"!="}],Ut=e=>e&&jt[e]||Bt,Jt=e=>{if(!e)return;const t=Ut(e.field);t.some(t=>t.value===e.operator)||(e.operator=t[0]?.value),"between"===String(e.operator).toLowerCase()?e.value=Array.isArray(e.value)?e.value.slice(0,2):["",""]:e.value=Array.isArray(e.value)?e.value.join(","):e.value??""},Gt=e=>{e.conditions||(e.conditions=[]),e.conditions.push({field:"error_code",operator:"contains",value:""})},qt=e=>{e.conditions||(e.conditions=[]),e.conditions.push({logic:"AND",conditions:[]})},Qt=(e,t)=>{Array.isArray(e.conditions)&&t>=0&&t<e.conditions.length&&e.conditions.splice(t,1)},Yt=async()=>{me.value=!1,g.value=!0,i.value=1,await Ve(1,!0),await ae()},Ht=()=>{const e={};o.value.forEach(t=>{t.color_mark&&(e[t.id]=t.color_mark)}),sessionStorage.setItem("batchLogColorMarks",JSON.stringify(e))},Zt=()=>{try{const e=sessionStorage.getItem("batchLogColorMarks");if(e){const t=JSON.parse(e);o.value.forEach(e=>{t[e.id]&&(e.color_mark=t[e.id])})}}catch(e){console.error("加载颜色标记失败:",e)}},ea=(e,t)=>{e.color_mark===t?e.color_mark=null:e.color_mark=t,Ht(),(0,l.dY)(()=>{})},ta=({row:e})=>{if(e.color_mark){let t="";switch(e.color_mark){case"#ff0000":t="row-marked-red";break;case"#ffff00":t="row-marked-yellow";break;case"#0000ff":t="row-marked-blue";break;case"#00ff00":t="row-marked-green";break;default:t=""}return console.log("行样式类名:",t,"颜色值:",e.color_mark,"行数据:",e),t}return""},aa=({row:e})=>{if(e.color_mark){const t=(e,t=.2)=>{const a=parseInt(e.slice(1,3),16),l=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return`rgba(${a}, ${l}, ${r}, ${t})`},a=t(e.color_mark,.2);return console.log("行内联样式:",a,"颜色值:",e.color_mark),{backgroundColor:a}}return{}},la=e=>{console.log("上下文分析:",e),y.value=e,f.value=!0},ra=e=>{if(console.log("日志摘取:",e),C.value.length>=S)return void qe.nk.warning(`日志摘取板最多只能存储 ${S} 条日志`);C.value.push({id:e.id,timestamp:e.timestamp,error_code:e.error_code,explanation:e.explanation});const t=ut(e.timestamp),a=`${t} ${e.error_code} ${e.explanation}`.trim();x.value=(x.value?x.value+"\n":"")+a,L.value="logs",w.value=!0,qe.nk.success(`已添加到日志摘取板 (${C.value.length}/${S})`)},oa=()=>{},na=()=>{C.value=[],x.value="",qe.nk.success("日志摘取板已清空")},sa=()=>{if(!x.value)return void qe.nk.warning("剪贴板为空，无法导出");const e=new Blob([x.value],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download=`日志摘取_${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t),qe.nk.success("日志摘取内容已导出")},ia=()=>{try{sessionStorage.setItem("clipboardContent",x.value),qe.nk.success("已保存")}catch(e){console.error("保存剪贴板内容失败:",e),qe.nk.error("保存失败")}},ua=()=>{try{const e=sessionStorage.getItem("clipboardContent");null!==e&&(x.value=e)}catch(e){console.error("加载剪贴板内容失败:",e)}},da=()=>{w.value=!0},ca=async e=>{const t=[e.param1,e.param2,e.param3,e.param4];if($.value=t.map(e=>!(!e||!String(e).trim())),!$.value.some(e=>e))return void qe.nk.warning("该日志条目没有可用的参数进行可视化");O.value=t.map(e=>e&&String(e).trim()?String(e).trim():""),K.value=["参数1","参数2","参数3","参数4"],M.value=e,z.value=null,W.value++,(0,l.dY)(()=>{T.value=e.id});const a=t=>{if(T.value!==e.id)return void document.removeEventListener("click",a,!0);const l=t.target,r=l&&l.closest&&l.closest(".visualization-btn"),o=l&&l.closest&&l.closest(".el-popover");r||o||(T.value=null,document.removeEventListener("click",a,!0))};document.addEventListener("click",a,!0),I.value=!0;try{const t=e.error_code?.toUpperCase?.()||"";let a=t,l=1;if(7===t.length&&/^[1-9A][0-9A-F]{6}$/.test(t)){l=t.charAt(0);const e=t.substring(3);a=`0X${e}`}else t.length>=6&&/^[1-9A]0X[0-9A-F]{3}[ABCDE]$/.test(t)?(l=t.charAt(0),a=t.substring(1)):/^0X[0-9A-F]{3}[ABCDE]$/.test(t)&&(a=t);const r=await et.A.errorCodes.getByCodeAndSubsystem(a,l),o=r?.data?.errorCode;o&&(K.value=[o.param1||"参数1",o.param2||"参数2",o.param3||"参数3",o.param4||"参数4"])}catch(r){console.warn("获取故障码参数名称失败，继续使用默认名称")}finally{T.value===e.id&&(I.value=!1)}},pa=e=>!!$.value[e-1],ma=()=>{z.value?(T.value=null,ga()):qe.nk.warning("请选择一个参数")},ga=async()=>{if(!M.value)return;const e=M.value;X.value=!0,await va(e)},va=async e=>{try{qe.nk.info("正在获取图表数据...");const t=r.value.map(e=>e.id).join(","),a=z.value,l=e.error_code.toUpperCase();let o=1;(7===l.length&&/^[1-9A][0-9A-F]{6}$/.test(l)||l.length>=6&&/^[1-9A]0X[0-9A-F]{3}[ABCDE]$/.test(l))&&(o=l.charAt(0));const i={log_ids:t,error_code:e.error_code,parameter_index:a,subsystem:o};if(g.value&&xe.value>0){const e=Pt();e&&(i.filters=JSON.stringify(e))}s.value&&Array.isArray(s.value)&&(i.start_time=s.value[0],i.end_time=s.value[1]),n.value&&(i.search=n.value);const u=await et.A.logs.getVisualizationData(i),{chartData:d,chartTitle:c,paramName:p}=u.data.data;if(!Array.isArray(d)||0===d.length)return void qe.nk.warning("没有可用的数据生成图表");P.value=c;const m=d;J.value={id:`chart_${Date.now()}`,title:c,timestamp:(new Date).toISOString(),parameter:z.value,parameterValue:p,data:m,errorCode:e.error_code},fa(),qe.nk.success(`已获取 ${d.length} 条数据`)}catch(t){qe.nk.error("获取图表数据失败: "+(t?.response?.data?.message||t.message))}},fa=()=>{if(!J.value)return;if(U.value.length>=5)return void qe.nk.warning("最多只能生成5张可视化图表");U.value.length;const e={...J.value,title:J.value.title};U.value.push(e),L.value="charts",w.value=!0,(0,l.dY)(()=>{(0,l.dY)(()=>{setTimeout(()=>{ya(e)},100)})}),qe.nk.success("图表已添加到剪贴板")},ya=e=>{try{const t=document.getElementById(`chart-thumb-${e.id}`);if(!t)return void console.warn(`缩略图元素未找到: chart-thumb-${e.id}`);if(0===t.offsetWidth||0===t.offsetHeight)return console.warn(`缩略图元素尺寸为0: ${t.offsetWidth}x${t.offsetHeight}`),void setTimeout(()=>ya(e),200);const a=He.FP(t);a&&a.dispose();const l=He.Ts(t),r=Math.min(...e.data.map(e=>e[0])),o=Math.max(...e.data.map(e=>e[0])),n={grid:{left:8,right:8,top:8,bottom:8,containLabel:!1},title:void 0,tooltip:{show:!1},xAxis:{type:"time",boundaryGap:!1,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},min:r,max:o},yAxis:{type:"value",boundaryGap:[0,"5%"],axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},min:"dataMin",max:"dataMax",scale:!0},series:[{name:`${e.parameterValue}`,type:"line",symbol:"none",sampling:!1,lineStyle:{width:1.5,color:"#409EFF"},areaStyle:{color:new He.fA.LinearGradient(0,0,0,1,[{offset:0,color:"rgba(64,158,255,0.22)"},{offset:1,color:"rgba(64,158,255,0.04)"}])},data:e.data}]};l.setOption(n);const s=()=>{l&&!l.isDisposed()&&l.resize()};window.addEventListener("resize",s),t._echartsInstance=l,t._resizeHandler=s}catch(t){console.error("创建缩略图失败:",t)}},ha=e=>{const t=console.error,a=window.onerror;console.error=function(...e){const a=e.join(" ");a.includes("dataSample")||a.includes("Cannot read properties of undefined")||a.includes("reading 'type'")||t.apply(console,e)},window.onerror=function(e,t,l,r,o){return!!(e&&e.includes&&e.includes("Cannot read properties of undefined")&&e.includes("reading 'type'"))||!!a&&a(e,t,l,r,o)},J.value=e,P.value=e.title,X.value=!0,(0,l.dY)(()=>{setTimeout(()=>{B.value&&(B.value.dispose(),B.value=null);const t=document.getElementById("visualizationChart");if(!t)return;if(0===t.offsetWidth||0===t.offsetHeight)return void setTimeout(()=>va(e),50);if(B.value=He.Ts(t),!e.data||!Array.isArray(e.data)||0===e.data.length)return void qe.nk.error("图表数据无效");const a=e.data.filter(e=>Array.isArray(e)&&e.length>=2&&"number"===typeof e[0]&&"number"===typeof e[1]&&!isNaN(e[0])&&!isNaN(e[1])&&isFinite(e[0])&&isFinite(e[1]));if(0===a.length)return void qe.nk.error("没有有效的图表数据");pt(a);const r={title:void 0,tooltip:{trigger:"axis",position:function(e){return[e[0],"10%"]}},legend:void 0,toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},xAxis:{type:"time",boundaryGap:!1,min:Math.min(...a.map(e=>e[0])),max:Math.max(...a.map(e=>e[0]))},yAxis:{type:"value",boundaryGap:[0,"100%"]},dataZoom:[{type:"inside",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,xAxisIndex:0,filterMode:"filter",preventDefaultMouseMove:!0},{type:"slider",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,showDetail:!0,showDataShadow:!0,xAxisIndex:0,bottom:10,filterMode:"filter",moveHandleSize:8,preventDefaultMouseMove:!0,dataBackground:{lineStyle:{color:"#ddd"},areaStyle:{color:"#f0f0f0"}},selectedDataBackground:{lineStyle:{color:"#409EFF"},areaStyle:{color:"#E6F7FF"}}}],series:[{name:e.parameterValue||"数据",type:"line",symbol:"none",sampling:!1,itemStyle:{color:"rgb(255, 70, 131)"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgb(255, 158, 68)"},{offset:1,color:"rgb(255, 70, 131)"}],global:!1}},data:a}]},o=window.onerror;window.onerror=function(e,t,a,l,r){return!!(e&&e.includes&&e.includes("Cannot read properties of undefined")&&e.includes("reading 'type'"))||!!o&&o(e,t,a,l,r)};try{(0,l.dY)(()=>{try{if(!B.value||B.value.isDisposed())return void console.error("图表实例无效");B.value.clear(),B.value.setOption(r,!0),setTimeout(()=>{try{if(B.value&&!B.value.isDisposed()){const e=B.value.getModel();e&&e.getComponent("series",0)?(B.value.resize(),setTimeout(()=>{B.value&&!B.value.isDisposed()&&B.value.dispatchAction({type:"dataZoom",start:0,end:100})},50)):console.warn("图表详情组件初始化不完整")}}catch(e){console.warn("图表详情调整大小失败:",e)}},100)}catch(e){console.warn("图表详情初始化警告:",e);try{const e={xAxis:{type:"time"},yAxis:{type:"value"},series:[{name:"数据",type:"line",data:a,sampling:!1}],animation:!1};B.value.clear(),B.value.setOption(e,!0)}catch(t){console.error("图表详情初始化失败:",t),qe.nk.error("图表详情初始化失败，请重试")}}})}finally{setTimeout(()=>{window.onerror=o},1e3)}},50)}),setTimeout(()=>{console.error=t,window.onerror=a},2e3)},ba=e=>{const t=U.value.findIndex(t=>t.id===e);if(t>-1){const a=document.getElementById(`chart-thumb-${e}`);a&&(a._resizeHandler&&window.removeEventListener("resize",a._resizeHandler),a._echartsInstance&&a._echartsInstance.dispose()),U.value.splice(t,1),U.value.forEach(e=>{e.title=e.title.replace(/^\d+\.\s*/,"")}),qe.nk.success("图表已删除")}},ka=()=>{J.value&&(ba(J.value.id),X.value=!1,B.value&&(B.value.dispose(),B.value=null))},_a=()=>{(0,l.dY)(()=>{const e=document.getElementById("visualizationChart");if(e)if(0!==e.offsetWidth&&0!==e.offsetHeight){if(B.value&&(B.value.dispose(),B.value=null),B.value=He.Ts(e),J.value&&Array.isArray(J.value.data)){const e=J.value.data.filter(e=>Array.isArray(e)&&e.length>=2&&"number"===typeof e[0]&&"number"===typeof e[1]);if(0===e.length)return;const t={title:void 0,tooltip:{trigger:"axis",position:e=>[e[0],"10%"]},legend:void 0,toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},xAxis:{type:"time",boundaryGap:!1,min:Math.min(...e.map(e=>e[0])),max:Math.max(...e.map(e=>e[0]))},yAxis:{type:"value",boundaryGap:[0,"100%"]},dataZoom:[{type:"inside",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,xAxisIndex:0,filterMode:"filter",preventDefaultMouseMove:!0},{type:"slider",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,showDetail:!0,showDataShadow:!0,xAxisIndex:0,bottom:10,filterMode:"filter",moveHandleSize:8,preventDefaultMouseMove:!0}],series:[{name:"数据",type:"line",symbol:"none",sampling:!1,data:e}]};B.value.setOption(t,!0),setTimeout(()=>{try{if(B.value&&!B.value.isDisposed()){const e=B.value.getModel&&B.value.getModel();e&&e.getComponent&&e.getComponent("dataZoom",0)&&B.value.dispatchAction({type:"dataZoom",start:0,end:100})}}catch(e){console.warn("图表详情 dataZoom 动作失败:",e)}},50)}}else setTimeout(_a,50)})},wa=()=>{if(B.value)try{const e=B.value.getDataURL({type:"png",pixelRatio:2,backgroundColor:"#fff"}),t=document.createElement("a");t.download=`chart_${(new Date).getTime()}.png`,t.href=e,t.click(),qe.nk.success("图表已导出为图片")}catch(e){console.error("导出图表失败:",e),qe.nk.error("导出图表失败")}else qe.nk.error("图表实例未找到")},Ca=(0,Ue.KR)({}),Sa=(0,Ue.KR)(""),xa=(0,Ue.KR)(null),Aa=(0,Ue.KR)(""),La=(0,l.EW)(()=>e.getters["auth/isAuthenticated"]),Da=e=>"admin"===e?"管理员":"expert"===e?"专家":"普通用户",Fa=e=>e.id,Na=e=>Ca.value[Fa(e)]||{items:[],total:0,page:1,pageSize:10,loading:!1},Ea=async e=>{R.value=e.id,await Va(e);const t=a=>{if(R.value!==e.id)return void document.removeEventListener("click",t,!0);const l=a.target,r=l&&l.closest&&l.closest(".operation-btn"),o=l&&l.closest&&l.closest(".el-popover");r||o||(R.value=null,document.removeEventListener("click",t,!0))};document.addEventListener("click",t,!0)},Ra=e=>{E.value=E.value===e.id?null:e.id;const t=e.id,a=e=>{if(E.value!==t)return void document.removeEventListener("click",a,!0);const l=e.target,r=l&&l.closest&&l.closest(".color-indicator"),o=l&&l.closest&&l.closest(".el-popover");r||o||(E.value=null,document.removeEventListener("click",a,!0))};document.addEventListener("click",a,!0)},Va=async e=>{const t=Fa(e),a=Ca.value[t]||{items:[],total:0,page:1,pageSize:10,loading:!1};a.loading=!0,Ca.value[t]=a;try{const{data:l}=await et.A.notes.list(e.id,{page:a.page,pageSize:a.pageSize});Ca.value[t]={...a,items:l.items||[],total:l.total||0,page:l.page||1,pageSize:l.pageSize||10,loading:!1}}catch(l){a.loading=!1}},Ta=async(e,t)=>{const a=Fa(e),l=Ca.value[a]||{items:[],total:0,page:1,pageSize:10,loading:!1};l.page=t,Ca.value[a]=l,await Va(e)},za=async e=>{if(Sa.value.trim())try{await et.A.notes.create(e.id,Sa.value.trim()),Sa.value="",await Va(e)}catch(t){}else qe.nk.warning("请输入备注内容")},Ia=t=>{const a=e.getters["auth/currentUser"];return!!a&&(!!e.getters["auth/hasPermission"]("user:update")||t.user_id===a.id)},Oa=Ia,$a=e=>{xa.value=e.id,Aa.value=e.content},Ka=()=>{xa.value=null,Aa.value=""},Wa=async e=>{if(Aa.value.trim())try{await et.A.notes.update(e.id,Aa.value.trim()),xa.value=null,Aa.value="";const t={id:e.log_entry_id};await Va(t)}catch(t){}else qe.nk.warning("请输入备注内容")},Ma=e=>{Qe.s.confirm("确定删除这条备注吗？","提示",{type:"warning"}).then(async()=>{await et.A.notes.remove(e.id);const t={id:e.log_entry_id};await Va(t)}).catch(()=>{})},Xa=(e,t=!0)=>{try{return(0,tt.fU)(e,!0,t)}catch{return e}},Pa=()=>{try{const e=sessionStorage.getItem("batchLogRemarks");if(e){const t=JSON.parse(e);o.value.forEach(e=>{t[e.id]&&(e.remarks=t[e.id])})}}catch(e){console.error("加载备注失败:",e)}},ja=async()=>{if(y.value)try{const e=new Date(y.value.timestamp),t=1e3*(60*h.value+k.value),a=1e3*(60*b.value+_.value);if(0===t&&0===a)return void qe.nk.warning("时间范围不能为 0，请输入分钟或秒");const l=new Date(e.getTime()-t),r=new Date(e.getTime()+a);console.log("上下文分析参数:",{baseRow:y.value,beforeMinutes:h.value,beforeSeconds:k.value,afterMinutes:b.value,afterSeconds:_.value,timeRange:{before:l.toISOString(),after:r.toISOString()}});const o={field:"timestamp",operator:"between",value:[ut(l),ut(r)]};ge.value={logic:"AND",conditions:[o]},g.value=!0,i.value=1,await Ve(1,!0),f.value=!1;const n=`${h.value}分${k.value}秒`,s=`${b.value}分${_.value}秒`;qe.nk.success(`已筛选出 ${n}前到${s}后的日志`)}catch(e){console.error("上下文分析失败:",e),qe.nk.error("上下文分析失败，请重试")}},Ba=()=>{if(!be.value)return;const e=he.value.find(e=>e.name===be.value);e&&(ge.value={logic:e.filters?.logic||"AND",conditions:Array.isArray(e.filters?.conditions)?[...e.filters.conditions]:[]})},Ua=e=>{if(!e)return;const t=String(e.operator||"").toLowerCase();"between"===t?Array.isArray(e.value)?e.value.length<2&&(e.value=[e.value[0]||"",e.value[1]||""]):e.value=["",""]:Array.isArray(e.value)&&(e.value=e.value.join(","))};return(0,l.sV)(async()=>{await ct(),await Re(),await vt(),se(),r.value.length>0&&await te(),Ne.value&&(s.value=[ut(Ne.value[0]),ut(Ne.value[1])]),await Ve(1,!0),ua()}),(0,l.xo)(()=>{B.value&&(B.value.dispose(),B.value=null),U.value.forEach(e=>{const t=document.getElementById(`chart-thumb-${e.id}`);t&&(t._resizeHandler&&window.removeEventListener("resize",t._resizeHandler),t._echartsInstance&&t._echartsInstance.dispose())})}),(0,l.wB)(x,e=>{try{sessionStorage.setItem("clipboardContent",e||"")}catch(t){}}),{activeColorPopoverRowId:E,activeNotesPopoverRowId:R,hoveredNameRowId:V,toggleColorPopover:Ra,loading:a,selectedLogs:r,batchLogEntries:o,searchKeyword:n,timeRange:s,currentPage:i,pageSize:u,totalCount:d,totalPages:c,advancedMode:g,useLocalAdvanced:v,tableColumns:pe,showAdvancedFilter:me,filtersRoot:ge,filteredEntries:Ae,paginatedEntries:Ee,searchExpression:we,advancedExpression:Ce,batchCount:Le,selectedLogsCount:De,filteredCount:Fe,leafConditionCount:xe,loadSelectedLogs:Re,loadBatchLogEntries:Ve,handleSearch:Me,handleQuery:Xe,handleTimeRangeChange:Pe,clearFilters:je,exportToCSV:rt,handleSizeChange:ot,handleCurrentChange:nt,handleLoadMore:st,forceRelayout:it,formatTimestamp:ut,formatFileSize:mt,getSmartTimeFormatter:pt,showSurgeryStatistics:gt,showSurgeryStatsDialog:ft,surgeryStatsLoading:yt,surgeryStats:ht,exportingRow:bt,surgeryJsonDialogVisible:kt,surgeryJsonText:_t,hasExportPermission:xt,visualizeSurgeryStat:At,previewSurgeryData:Lt,exportSurgeryRow:Dt,analyzeSurgeryData:Xt,surgeryStatisticsVisible:ve,surgeryData:fe,analyzing:ye,timeRangeLimit:Ne,defaultPickerRange:lt,disableOutOfRangeDates:at,templates:he,applyTemplateByName:Ft,beforeImportTemplates:Nt,selectedTemplateName:be,onTemplateSingleSelect:Et,applySelectedTemplate:Ba,importExpressionText:ke,applyExpressionJSON:Wt,applyExpressionSmart:Mt,addConditionToGroup:Gt,addGroupToGroup:qt,removeNodeAt:Qt,exprPreviewRef:Kt,applyAdvancedFilters:Yt,clearAllConditionsOnly:Be,getOperatorOptions:Ut,onFieldChange:Jt,onOperatorChange:Ua,colorOptions:ce,selectColor:ea,getRowClassName:ta,getRowStyle:aa,saveColorMarksToStorage:Ht,loadColorMarksFromStorage:Zt,handleContextAnalysis:la,handleLogCapture:ra,openNotes:Ea,reloadNotes:Va,getNotes:Na,changeNotesPage:Ta,submitNewNote:za,canEditNote:Ia,canDeleteNote:Oa,startEditNote:$a,cancelEditNote:Ka,submitEditNote:Wa,confirmDeleteNote:Ma,notesState:Ca,newNoteContent:Sa,editingNoteId:xa,editingNoteContent:Aa,roleLabel:Da,formatTimeForDisplay:Xa,canCreateNote:La,contextAnalysisVisible:f,contextAnalysisRow:y,beforeMinutes:h,afterMinutes:b,beforeSeconds:k,afterSeconds:_,executeContextAnalysis:ja,clipboardVisible:w,clipboardEntries:C,clipboardContent:x,updateClipboardContent:oa,clearClipboard:na,exportClipboardToTxt:sa,saveClipboardContent:ia,loadClipboardContent:ua,showClipboard:da,clipboardDetailVisible:A,clipboardCount:D,fillPercent:F,maxClipboardEntries:S,parameterSelectVisible:N,sidebarActiveTab:L,selectedParameter:z,availableParameters:O,paramNames:K,selectKey:W,isParameterAvailable:pa,onCompositionStart:ze,onCompositionEnd:Ie,activeParamPopoverRowId:T,paramNamesLoading:I,chartDetailVisible:X,chartTitle:P,chartContainer:j,chartInstance:B,chartThumbnails:U,currentChartData:J,handleVisualization:ca,confirmVisualization:ma,exportChartAsImage:wa,showChartDetail:ha,deleteChartThumbnail:ba,deleteCurrentChart:ka,onChartDialogOpened:_a,logCounts:G,errorCodeCounts:q,globalErrorCodeCounts:Q,filteredErrorCodeCounts:Y,statisticsCache:H,getErrorCodeCount:re,getErrorCodeCountDisplay:oe,getErrorCodeStatisticsTooltip:de,hasActiveFilters:ne,showStatisticsForErrorCode:ee,toggleErrorCodeStatistics:ie,fetchStatisticsFromBackend:le,fetchGlobalStatistics:te,fetchFilteredStatistics:ae,loadCountsFromStorage:se,showErrorCodeStatistics:ue,showCompareDialog:wt,compareData:Ct}}};const At=(0,_t.A)(xt,[["render",Be],["__scopeId","data-v-b026608e"]]);var Lt=At},7662:function(e,t,a){function l(e){if(!e)return null;try{if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e)){const t=e.replace(" ","T")+"Z",a=new Date(t);return isNaN(a.getTime())?(console.warn("⚠️ 无效的时间格式:",e),e):a.toISOString()}return e}catch(t){return console.warn("⚠️ 时间转换失败:",e,t),e}}function r(e){if(!e)return console.warn("⚠️ 手术数据为空"),null;console.log("🔧 开始适配手术数据:",e);let t=null,a={};if(e.postgresql_row_preview?.structured_data?(t=e.postgresql_row_preview.structured_data,a={surgery_id:e.surgery_id||e.postgresql_row_preview.surgery_id,start_time:l(e.surgery_start_time||e.postgresql_row_preview.start_time),end_time:l(e.surgery_end_time||e.postgresql_row_preview.end_time),is_remote:e.is_remote_surgery||e.postgresql_row_preview.is_remote,has_fault:e.has_error||e.postgresql_row_preview.has_fault,device_ids:e.postgresql_row_preview.device_ids||[],source_log_ids:e.postgresql_row_preview.source_log_ids||[]}):e.structured_data?(t=e.structured_data,a={surgery_id:e.surgery_id,start_time:l(e.start_time),end_time:l(e.end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):e.arms||e.surgery_stats||e.power_cycles?(t=e,a={surgery_id:e.surgery_id,start_time:l(e.start_time||e.surgery_start_time),end_time:l(e.end_time||e.surgery_end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):(e.arm1_usage||e.state_machine_changes||e.alarm_details)&&(t=o(e),a={surgery_id:e.surgery_id,start_time:l(e.surgery_start_time),end_time:l(e.surgery_end_time),is_remote:e.is_remote_surgery,has_fault:e.has_error,device_ids:[],source_log_ids:e.log_id?[e.log_id]:[]}),!t)return console.warn("⚠️ 无法识别的数据格式:",e),null;const r=n(t),s={...r,...a};return console.log("✅ 手术数据适配完成:",s),s}function o(e){const t={power_cycles:[],arms:[],surgery_stats:{success:!e.has_error,network_latency_ms:[],faults:[],state_machine:[],arm_switch_count:0,left_hand_clutch:0,right_hand_clutch:0,foot_clutch:0,endoscope_pedal:0}};for(let a=1;a<=4;a++){const r=e[`arm${a}_usage`]||[],o=r.map(e=>({tool_type:e.instrumentName||e.tool_type||"未知器械",udi:e.udi||"无UDI",start_time:l(e.startTime||e.start_time),end_time:l(e.endTime||e.end_time),energy_activation:[]}));t.arms.push({arm_id:a,instrument_usage:o})}if(e.state_machine_changes&&Array.isArray(e.state_machine_changes)&&(t.surgery_stats.state_machine=e.state_machine_changes.map(e=>({time:l(e.time),state:e.stateName||String(e.state)}))),e.network_latency_data&&Array.isArray(e.network_latency_data)&&(t.surgery_stats.network_latency_ms=e.network_latency_data.map(e=>({time:l(e.timestamp),latency:e.latency}))),e.alarm_details&&Array.isArray(e.alarm_details)&&(t.surgery_stats.faults=e.alarm_details.map(t=>({timestamp:l(t.time),error_code:t.code,param1:"",param2:"",param3:"",param4:"",explanation:t.message,log_id:e.log_id}))),e.power_on_times&&e.shutdown_times){const a=e.power_on_times,r=e.shutdown_times;let o=0,n=0;while(o<a.length||n<r.length){const e=o<a.length?a[o]:null,s=n<r.length?r[n]:null;t.power_cycles.push({on_time:l(e),off_time:l(s)}),e&&s?(o++,n++):e?o++:n++}}return t}function n(e){const t={arms:e.arms||[],power_cycles:e.power_cycles||[],surgery_stats:{success:e.surgery_stats?.success??!0,network_latency_ms:e.surgery_stats?.network_latency_ms||[],faults:e.surgery_stats?.faults||[],state_machine:e.surgery_stats?.state_machine||[],arm_switch_count:e.surgery_stats?.arm_switch_count||0,left_hand_clutch:e.surgery_stats?.left_hand_clutch||0,right_hand_clutch:e.surgery_stats?.right_hand_clutch||0,foot_clutch:e.surgery_stats?.foot_clutch||0,endoscope_pedal:e.surgery_stats?.endoscope_pedal||0}};Array.isArray(t.arms)||(t.arms=[]);for(let a=0;a<t.arms.length;a++)t.arms[a].arm_id||(t.arms[a].arm_id=a+1),t.arms[a].instrument_usage?t.arms[a].instrument_usage=t.arms[a].instrument_usage.map(e=>({...e,start_time:l(e.start_time),end_time:l(e.end_time)})):t.arms[a].instrument_usage=[];return t.surgery_stats.state_machine&&(t.surgery_stats.state_machine=t.surgery_stats.state_machine.map(e=>({...e,time:l(e.time)}))),t.surgery_stats.network_latency_ms&&(t.surgery_stats.network_latency_ms=t.surgery_stats.network_latency_ms.map(e=>({...e,time:l(e.time)}))),t.surgery_stats.faults&&(t.surgery_stats.faults=t.surgery_stats.faults.map(e=>({...e,timestamp:l(e.timestamp)}))),t.power_cycles&&(t.power_cycles=t.power_cycles.map(e=>({on_time:l(e.on_time),off_time:l(e.off_time)}))),t}function s(e){if(!e)return!1;const t=!!(e.surgery_id&&e.start_time&&e.arms&&e.surgery_stats),a=Array.isArray(e.arms)&&e.arms.length>0;return console.log("🔍 数据验证结果:",{hasRequiredFields:t,hasValidArms:a,armsCount:e.arms?.length||0,stateMachineCount:e.surgery_stats?.state_machine?.length||0,networkLatencyCount:e.surgery_stats?.network_latency_ms?.length||0}),t&&a}function i(e){return e?e.postgresql_row_preview?.structured_data?"surgery_statistics":e.structured_data?"database_record":e.arms||e.surgery_stats||e.power_cycles?"structured_data":e.arm1_usage||e.state_machine_changes||e.alarm_details?"analysis_data":"unknown":"unknown"}a.d(t,{adaptSurgeryData:function(){return r},q:function(){return i},validateAdaptedData:function(){return s}})},8762:function(e,t,a){a.d(t,{_C:function(){return o}});var l=a(4432),r=a(7662);function o(e,t={}){const{openInNewTab:a=!0,queryId:o=null}=t;try{if(!e)throw new Error("手术数据不能为空");console.log("🔧 开始处理手术数据可视化:",e);const t=(0,r.q)(e);console.log("📊 数据来源类型:",t);const n=(0,r.adaptSurgeryData)(e);if(!n)throw new Error("数据适配失败，无法识别的数据格式");if(!(0,r.validateAdaptedData)(n))throw new Error("数据验证失败，缺少必要字段");n._dataSource=t,n._originalData=e,console.log("✅ 数据适配成功:",n),sessionStorage.setItem("surgeryVizData",JSON.stringify(n));const s={path:"/surgery-visualization"};o&&(s.query={id:o});const i=l.A.resolve(s);a?window.open(i.href,"_blank"):l.A.push(s)}catch(n){console.error("❌ 可视化手术数据失败:",n),window.ElMessage&&window.ElMessage.error("可视化手术数据失败: "+n.message)}}}}]);
//# sourceMappingURL=865.de2578a9.js.map