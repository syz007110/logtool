"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[276,662],{5276:function(e,t,a){a.r(t),a.d(t,{default:function(){return ue}});var s=a(641),l=a(33),i=a(3751);const o={class:"logs-container"},r={class:"card-header"},n={class:"header-actions"},c={class:"header-section reset-section"},d={class:"header-section refresh-section"},u={class:"header-section upload-section"},g={class:"col-header"},p={class:"filter-panel"},v={class:"filter-actions"},h={class:"pagination-wrapper"},_={class:"device-detail-content"},m={class:"device-header"},f={class:"device-info"},y={class:"device-actions"},w={class:"detail-logs-section"},k={class:"detail-header"},b={class:"detail-actions"},F={key:0,class:"batch-section"},D={class:"batch-actions"},C={class:"only-own-section"},S={class:"reset-section"},L={class:"refresh-section"},W={class:"col-header"},R={class:"filter-panel"},E={class:"filter-actions"},z={class:"pagination-wrapper"},A={key:0,class:"device-header",style:{"margin-bottom":"12px"}},K={class:"device-info"},I={class:"pagination-wrapper"},x={class:"el-upload__tip"},U={key:0},T={key:1,class:"parsing-tip"},B={key:0,class:"custom-file-list"},N={class:"file-list-header"},$={class:"file-items"},P={class:"file-name"},V={class:"file-size"},M={class:"key-input-section"},O={class:"key-input-row"},Y={key:0,class:"key-file-info"},q={key:1,class:"key-error"},X={class:"device-input-section"},H={class:"device-input-row"},j={key:0,class:"device-error"},Q={class:"upload-actions"};function G(e,t,a,G,J,Z){const ee=(0,s.g2)("el-button"),te=(0,s.g2)("Refresh"),ae=(0,s.g2)("el-icon"),se=(0,s.g2)("UploadFilled"),le=(0,s.g2)("Search"),ie=(0,s.g2)("el-input"),oe=(0,s.g2)("Filter"),re=(0,s.g2)("el-popover"),ne=(0,s.g2)("el-table-column"),ce=(0,s.g2)("el-tag"),de=(0,s.g2)("el-table"),ue=(0,s.g2)("el-pagination"),ge=(0,s.g2)("el-card"),pe=(0,s.g2)("Monitor"),ve=(0,s.g2)("Download"),he=(0,s.g2)("Delete"),_e=(0,s.g2)("InfoFilled"),me=(0,s.g2)("el-tooltip"),fe=(0,s.g2)("el-checkbox"),ye=(0,s.g2)("el-drawer"),we=(0,s.g2)("el-popconfirm"),ke=(0,s.g2)("upload-filled"),be=(0,s.g2)("el-upload"),Fe=(0,s.g2)("Document"),De=(0,s.g2)("Key"),Ce=(0,s.g2)("Upload"),Se=(0,s.g2)("el-dialog"),Le=(0,s.gN)("loading");return(0,s.uX)(),(0,s.CE)("div",o,[(0,s.bF)(ge,{class:"list-card"},{header:(0,s.k6)(()=>[(0,s.Lk)("div",r,[t[18]||(t[18]=(0,s.Lk)("span",null,"日志列表",-1)),(0,s.Lk)("div",n,[(0,s.Lk)("div",c,[(0,s.bF)(ee,{plain:"",onClick:G.resetAllFilters},{default:(0,s.k6)(()=>[...t[15]||(t[15]=[(0,s.eW)("重置",-1)])]),_:1},8,["onClick"])]),(0,s.Lk)("div",d,[(0,s.bF)(ee,{plain:"",onClick:G.loadDeviceGroups},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(te)]),_:1}),t[16]||(t[16]=(0,s.eW)(" 刷新 ",-1))]),_:1},8,["onClick"])]),(0,s.Lk)("div",u,[(0,s.bF)(ee,{type:"primary",onClick:G.showNormalUpload},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(se)]),_:1}),t[17]||(t[17]=(0,s.eW)(" 日志上传 ",-1))]),_:1},8,["onClick"])])])])]),default:(0,s.k6)(()=>[(0,s.bo)(((0,s.uX)(),(0,s.Wv)(de,{data:G.deviceGroups,loading:G.loading,style:{width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(ne,{prop:"device_id",label:"设备编号",width:"200"},{header:(0,s.k6)(()=>[(0,s.Lk)("div",g,[t[22]||(t[22]=(0,s.Lk)("span",null,"设备编号",-1)),(0,s.bF)(re,{placement:"bottom-start",width:"260",visible:G.showDeviceFilterPanel,"onUpdate:visible":t[1]||(t[1]=e=>G.showDeviceFilterPanel=e),"popper-class":"custom-filter-panel"},{reference:(0,s.k6)(()=>[(0,s.bF)(ae,{class:(0,l.C4)(["filter-trigger",{active:!!G.deviceFilterValue}])},{default:(0,s.k6)(()=>[(0,s.bF)(oe)]),_:1},8,["class"])]),default:(0,s.k6)(()=>[(0,s.Lk)("div",p,[t[21]||(t[21]=(0,s.Lk)("div",{class:"filter-title"},"设备编号筛选",-1)),(0,s.bF)(ie,{modelValue:G.deviceFilterValue,"onUpdate:modelValue":t[0]||(t[0]=e=>G.deviceFilterValue=e),placeholder:"输入设备编号进行筛选",clearable:"",onKeyup:(0,i.jR)(G.applyDeviceFilter,["enter"])},{prefix:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(le)]),_:1})]),_:1},8,["modelValue","onKeyup"]),(0,s.Lk)("div",v,[(0,s.bF)(ee,{size:"small",type:"primary",onClick:G.applyDeviceFilter},{default:(0,s.k6)(()=>[...t[19]||(t[19]=[(0,s.eW)("搜索",-1)])]),_:1},8,["onClick"]),(0,s.bF)(ee,{size:"small",onClick:G.resetDeviceFilter},{default:(0,s.k6)(()=>[...t[20]||(t[20]=[(0,s.eW)("重置",-1)])]),_:1},8,["onClick"])])])]),_:1},8,["visible"])])]),default:(0,s.k6)(({row:e})=>[(0,s.bF)(ee,{type:"text",onClick:t=>G.showDeviceDetail(e),style:{padding:"0","font-weight":"500",color:"#409eff"}},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(e.device_id),1)]),_:2},1032,["onClick"])]),_:1}),(0,s.bF)(ne,{prop:"hospital_name",label:"医院名称",width:"200"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(e.hospital_name||"-"),1)]),_:1}),(0,s.bF)(ne,{prop:"log_count",label:"日志数量",width:"120",align:"center"},{default:(0,s.k6)(({row:e})=>[(0,s.bF)(ce,{type:"info",size:"small"},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(e.log_count),1)]),_:2},1024)]),_:1}),(0,s.bF)(ne,{prop:"latest_update_time",label:"更新时间",width:"180"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(G.formatDate(e.latest_update_time)),1)]),_:1}),(0,s.bF)(ne,{label:"操作",width:"300",fixed:"right"},{default:(0,s.k6)(({row:e})=>[(0,s.bF)(ee,{size:"small",type:"primary",onClick:t=>G.showDeviceDetail(e)},{default:(0,s.k6)(()=>[...t[23]||(t[23]=[(0,s.eW)(" 详情 ",-1)])]),_:2},1032,["onClick"]),(0,s.Q3)("",!0),(0,s.bF)(ee,{size:"small",type:"info",onClick:t=>G.openSurgeryDrawerForDevice(e)},{default:(0,s.k6)(()=>[...t[25]||(t[25]=[(0,s.eW)(" 手术数据 ",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","loading"])),[[Le,G.loading]]),(0,s.Lk)("div",h,[(0,s.bF)(ue,{"current-page":G.currentPage,"page-size":G.pageSize,"page-sizes":[10,20,50,100],total:G.deviceTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G.handleDeviceSizeChange,onCurrentChange:G.handleDeviceCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),_:1}),(0,s.bF)(ye,{modelValue:G.showDeviceDetailDrawer,"onUpdate:modelValue":t[6]||(t[6]=e=>G.showDeviceDetailDrawer=e),title:` ${G.selectedDevice?.device_id} 详细日志`,direction:"rtl",size:"1200px","before-close":G.handleDrawerClose},{default:(0,s.k6)(()=>[(0,s.Lk)("div",_,[(0,s.Lk)("div",m,[(0,s.Lk)("div",f,[(0,s.Lk)("h3",null,"设备编号："+(0,l.v_)(G.selectedDevice?.device_id),1),(0,s.Lk)("p",null,"医院名称："+(0,l.v_)(G.selectedDevice?.hospital_name||"暂无"),1),(0,s.Lk)("p",null,"日志总数："+(0,l.v_)(G.selectedDevice?.log_count||0),1)]),(0,s.Lk)("div",y,[(0,s.bF)(ee,{type:"primary",onClick:t[2]||(t[2]=e=>G.uploadLogForDevice(G.selectedDevice))},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(se)]),_:1}),t[26]||(t[26]=(0,s.eW)(" 日志上传 ",-1))]),_:1})])]),(0,s.Lk)("div",w,[(0,s.Lk)("div",k,[t[30]||(t[30]=(0,s.Lk)("h4",null,"日志列表",-1)),(0,s.Lk)("div",b,[G.selectedDetailLogs&&G.selectedDetailLogs.length>0?((0,s.uX)(),(0,s.CE)("div",F,[(0,s.Lk)("div",D,[(0,s.bF)(ee,{type:"primary",size:"small",onClick:G.handleBatchAnalyze,disabled:!G.canBatchView||!G.isSameDevice||G.selectedDetailLogs.length>20,title:G.getBatchViewTitle()},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(pe)]),_:1}),(0,s.eW)(" 批量查看 ("+(0,l.v_)(G.selectedDetailLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),(0,s.bF)(ee,{type:"success",size:"small",onClick:G.handleBatchDownload,disabled:!G.canBatchDownload,title:G.incompleteLogsMessage},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(ve)]),_:1}),(0,s.eW)(" 批量下载 ("+(0,l.v_)(G.selectedDetailLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),(0,s.bF)(ee,{type:"danger",size:"small",onClick:G.handleBatchDelete,disabled:!G.canBatchDelete,title:G.incompleteLogsMessage},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(he)]),_:1}),(0,s.eW)(" 批量删除 ("+(0,l.v_)(G.selectedDetailLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),1===G.userRole?((0,s.uX)(),(0,s.Wv)(ee,{key:0,type:"warning",size:"small",onClick:G.handleBatchReparse,disabled:0===G.selectedDetailLogs.length||1!==G.userRole||!G.canBatchReparse||G.selectedDetailLogs.length>20,title:G.getBatchReparseTitle()},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(te)]),_:1}),(0,s.eW)(" 批量重新解析 ("+(0,l.v_)(G.selectedDetailLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"])):(0,s.Q3)("",!0),3===G.userRole?((0,s.uX)(),(0,s.Wv)(me,{key:1,content:"普通用户只能删除自己上传的日志",placement:"top"},{default:(0,s.k6)(()=>[(0,s.bF)(ae,{class:"info-icon"},{default:(0,s.k6)(()=>[(0,s.bF)(_e)]),_:1})]),_:1})):(0,s.Q3)("",!0),(0,s.bF)(ee,{type:"info",size:"small",onClick:G.clearDetailSelection},{default:(0,s.k6)(()=>[...t[27]||(t[27]=[(0,s.eW)(" 取消选择 ",-1)])]),_:1},8,["onClick"])])])):(0,s.Q3)("",!0),(0,s.Lk)("div",C,[(0,s.bF)(fe,{modelValue:G.detailOnlyOwn,"onUpdate:modelValue":t[3]||(t[3]=e=>G.detailOnlyOwn=e),onChange:G.applyDetailOnlyOwn,label:"仅看自己"},null,8,["modelValue","onChange"])]),(0,s.Lk)("div",S,[(0,s.bF)(ee,{plain:"",size:"small",onClick:G.resetDetailFilters},{default:(0,s.k6)(()=>[...t[28]||(t[28]=[(0,s.eW)("重置",-1)])]),_:1},8,["onClick"])]),(0,s.Lk)("div",L,[(0,s.bF)(ee,{plain:"",size:"small",onClick:G.loadDetailLogs},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(te)]),_:1}),t[29]||(t[29]=(0,s.eW)(" 刷新 ",-1))]),_:1},8,["onClick"])])])]),(0,s.bo)(((0,s.uX)(),(0,s.Wv)(de,{data:G.detailLogs,loading:G.detailLoading,style:{width:"100%"},onSelectionChange:G.handleDetailSelectionChange,"row-key":"id"},{default:(0,s.k6)(()=>[(0,s.bF)(ne,{type:"selection",width:"55"}),(0,s.bF)(ne,{prop:"original_name",label:"日志文件名",width:"240"},{header:(0,s.k6)(()=>[(0,s.Lk)("div",W,[t[34]||(t[34]=(0,s.Lk)("span",null,"日志文件名",-1)),(0,s.bF)(re,{placement:"bottom-start",width:"260",visible:G.showDetailNameFilterPanel,"onUpdate:visible":t[5]||(t[5]=e=>G.showDetailNameFilterPanel=e),"popper-class":"custom-filter-panel"},{reference:(0,s.k6)(()=>[(0,s.bF)(ae,{class:(0,l.C4)(["filter-trigger",{active:!!G.detailNameTimePrefix}])},{default:(0,s.k6)(()=>[(0,s.bF)(oe)]),_:1},8,["class"])]),default:(0,s.k6)(()=>[(0,s.Lk)("div",R,[t[33]||(t[33]=(0,s.Lk)("div",{class:"filter-title"},"时间前缀 (YYYY / YYYYMM / YYYYMMDD / YYYYMMDDHH)",-1)),(0,s.bF)(ie,{modelValue:G.detailNameTimePrefix,"onUpdate:modelValue":t[4]||(t[4]=e=>G.detailNameTimePrefix=e),placeholder:"例如 2025081611",clearable:"",onKeyup:(0,i.jR)(G.applyDetailNameFilter,["enter"])},{prefix:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(le)]),_:1})]),_:1},8,["modelValue","onKeyup"]),(0,s.Lk)("div",E,[(0,s.bF)(ee,{size:"small",type:"primary",onClick:G.applyDetailNameFilter},{default:(0,s.k6)(()=>[...t[31]||(t[31]=[(0,s.eW)("搜索",-1)])]),_:1},8,["onClick"]),(0,s.bF)(ee,{size:"small",onClick:G.resetDetailNameFilter},{default:(0,s.k6)(()=>[...t[32]||(t[32]=[(0,s.eW)("重置",-1)])]),_:1},8,["onClick"])])])]),_:1},8,["visible"])])]),_:1}),(0,s.bF)(ne,{prop:"uploader_id",label:"上传用户ID",width:"120"}),(0,s.bF)(ne,{prop:"upload_time",label:"上传时间",width:"150"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(G.formatDate(e.upload_time)),1)]),_:1}),(0,s.bF)(ne,{label:"状态",width:"120",align:"center"},{default:(0,s.k6)(({row:e})=>[(0,s.bF)(ce,{type:G.getRowStatusType(e),size:"small"},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(G.getRowStatusText(e)),1)]),_:2},1032,["type"])]),_:1}),(0,s.bF)(ne,{label:"操作",width:"300",fixed:"right"},{default:(0,s.k6)(({row:e})=>[(0,s.bF)(ee,{size:"small",type:"primary",onClick:t=>G.goToLogAnalysis(e),disabled:!G.canView(e)},{default:(0,s.k6)(()=>[...t[35]||(t[35]=[(0,s.eW)(" 查看 ",-1)])]),_:2},1032,["onClick","disabled"]),(0,s.bF)(ee,{size:"small",type:"success",onClick:t=>G.handleDownload(e),disabled:!G.canDownload(e)},{default:(0,s.k6)(()=>[...t[36]||(t[36]=[(0,s.eW)(" 下载 ",-1)])]),_:2},1032,["onClick","disabled"]),G.canDeleteLog(e)?((0,s.uX)(),(0,s.Wv)(ee,{key:0,size:"small",type:"danger",onClick:t=>G.handleDelete(e),disabled:!("parsed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"failed"===e.status||"queue_failed"===e.status||"upload_failed"===e.status||"delete_failed"===e.status)},{default:(0,s.k6)(()=>[...t[37]||(t[37]=[(0,s.eW)(" 删除 ",-1)])]),_:2},1032,["onClick","disabled"])):(0,s.Q3)("",!0),G.canReparse?((0,s.uX)(),(0,s.Wv)(ee,{key:1,size:"small",type:"warning",onClick:t=>G.handleReparse(e),disabled:!G.canReparseLog(e)||e.parsing},{default:(0,s.k6)(()=>[...t[38]||(t[38]=[(0,s.eW)(" 重新解析 ",-1)])]),_:2},1032,["onClick","disabled"])):(0,s.Q3)("",!0)]),_:1})]),_:1},8,["data","loading","onSelectionChange"])),[[Le,G.detailLoading]]),(0,s.Lk)("div",z,[(0,s.bF)(ue,{"current-page":G.detailCurrentPage,"page-size":G.detailPageSize,"page-sizes":[10,20,50,100],total:G.detailTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G.handleDetailSizeChange,onCurrentChange:G.handleDetailCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])])])]),_:1},8,["modelValue","title","before-close"]),(0,s.bF)(ye,{modelValue:G.showSurgeryDrawer,"onUpdate:modelValue":t[9]||(t[9]=e=>G.showSurgeryDrawer=e),title:"手术数据",direction:"rtl",size:"1200px"},{default:(0,s.k6)(()=>[G.selectedDevice?((0,s.uX)(),(0,s.CE)("div",A,[(0,s.Lk)("div",K,[(0,s.Lk)("h3",null,"医院："+(0,l.v_)(G.selectedDevice.hospital_name||"-"),1),(0,s.Lk)("p",null,"设备编号："+(0,l.v_)(G.selectedDevice.device_id),1)])])):(0,s.Q3)("",!0),(0,s.bF)(de,{data:G.surgeryList,loading:G.surgeryLoading,style:{width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(ne,{prop:"surgery_id",label:"手术id",width:"220"}),(0,s.bF)(ne,{prop:"structured_data.surgery_stats.procedure",label:"手术术式","min-width":"200"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(e.structured_data?.surgery_stats?.procedure||"-"),1)]),_:1}),(0,s.bF)(ne,{prop:"start_time",label:"手术开始时间",width:"180"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(G.formatDate(e.start_time)),1)]),_:1}),(0,s.bF)(ne,{prop:"end_time",label:"手术结束时间",width:"180"},{default:(0,s.k6)(({row:e})=>[(0,s.eW)((0,l.v_)(G.formatDate(e.end_time)),1)]),_:1}),(0,s.bF)(ne,{label:"操作",width:"260",fixed:"right"},{default:(0,s.k6)(({row:a})=>[(0,s.bF)(ee,{size:"small",type:"primary",onClick:e=>G.viewLogsBySurgery(a)},{default:(0,s.k6)(()=>[...t[39]||(t[39]=[(0,s.eW)("查看日志",-1)])]),_:2},1032,["onClick"]),(0,s.bF)(ee,{size:"small",type:"success",onClick:e=>G.visualizeSurgery(a)},{default:(0,s.k6)(()=>[...t[40]||(t[40]=[(0,s.eW)("可视化",-1)])]),_:2},1032,["onClick"]),e.$store.getters["auth/hasPermission"]("surgery:delete")?((0,s.uX)(),(0,s.Wv)(we,{key:0,title:"确定删除该手术记录？",onConfirm:e=>G.deleteSurgery(a)},{reference:(0,s.k6)(()=>[(0,s.bF)(ee,{size:"small",type:"danger"},{default:(0,s.k6)(()=>[...t[41]||(t[41]=[(0,s.eW)("删除",-1)])]),_:1})]),_:2},1032,["onConfirm"])):(0,s.Q3)("",!0)]),_:1})]),_:1},8,["data","loading"]),(0,s.Lk)("div",I,[(0,s.bF)(ue,{"current-page":G.surgeryPage,"page-size":G.surgeryPageSize,"page-sizes":[10,20,50],total:G.surgeryTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:t[7]||(t[7]=e=>{G.surgeryPageSize=e,G.surgeryPage=1,G.loadSurgeries()}),onCurrentChange:t[8]||(t[8]=e=>{G.surgeryPage=e,G.loadSurgeries()})},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"]),(0,s.bF)(Se,{modelValue:G.showUploadDialog,"onUpdate:modelValue":t[13]||(t[13]=e=>G.showUploadDialog=e),title:"上传日志",width:"700px","append-to-body":""},{footer:(0,s.k6)(()=>[(0,s.Lk)("div",Q,[(0,s.bF)(ee,{onClick:t[12]||(t[12]=e=>G.showUploadDialog=!1),disabled:G.uploading},{default:(0,s.k6)(()=>[...t[49]||(t[49]=[(0,s.eW)("取消",-1)])]),_:1},8,["disabled"]),(0,s.bF)(ee,{type:"primary",onClick:G.submitUpload,loading:G.uploading,disabled:G.uploading||!G.canSubmitUpload||0===G.uploadFileList.length},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(G.uploading?"上传中...":"上传并解析"),1)]),_:1},8,["onClick","loading","disabled"])])]),default:(0,s.k6)(()=>[(0,s.bF)(be,{ref:"uploadRef",action:G.uploadUrl,headers:G.uploadHeaders,"before-upload":G.beforeUpload,"on-success":G.onUploadSuccess,"on-error":G.onUploadError,"on-exceed":G.onExceed,"on-change":G.onFileChange,"on-remove":G.onFileRemove,"on-progress":e.onUploadProgress,"auto-upload":!1,"show-file-list":!1,multiple:!0,limit:50,accept:".medbot",name:"file",disabled:G.uploading},{tip:(0,s.k6)(()=>[(0,s.Lk)("div",x,[G.uploading?((0,s.uX)(),(0,s.CE)("div",T,[(0,s.bF)(ae,{class:"is-loading"},{default:(0,s.k6)(()=>[(0,s.bF)(te)]),_:1}),t[43]||(t[43]=(0,s.eW)(" 文件上传中，上传完成后才能进行下一次上传操作 ",-1))])):((0,s.uX)(),(0,s.CE)("div",U," 支持上传 .medbot 文件，最多50个文件，总大小不超过200MB，上传后将自动解密并解析 "))])]),default:(0,s.k6)(()=>[(0,s.bF)(ee,{type:"primary",disabled:G.uploading},{default:(0,s.k6)(()=>[(0,s.bF)(ae,{class:"el-icon--upload"},{default:(0,s.k6)(()=>[(0,s.bF)(ke)]),_:1}),t[42]||(t[42]=(0,s.eW)(" 选择文件 ",-1))]),_:1},8,["disabled"])]),_:1},8,["action","headers","before-upload","on-success","on-error","on-exceed","on-change","on-remove","on-progress","disabled"]),G.uploadFileList&&G.uploadFileList.length>0?((0,s.uX)(),(0,s.CE)("div",B,[(0,s.Lk)("div",N,[(0,s.Lk)("span",null,"已选择的文件 ("+(0,l.v_)(G.uploadFileList.length)+")",1),(0,s.bF)(ee,{type:"text",size:"small",onClick:G.clearUpload,disabled:G.uploading},{default:(0,s.k6)(()=>[...t[44]||(t[44]=[(0,s.eW)(" 清空 ",-1)])]),_:1},8,["onClick","disabled"])]),(0,s.Lk)("div",$,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(G.uploadFileList,(e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"file-item"},[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(Fe)]),_:1}),(0,s.Lk)("span",P,(0,l.v_)(e.name||e.originalname),1),(0,s.Lk)("span",V,(0,l.v_)(e.sizeText),1),(0,s.bF)(ee,{type:"text",size:"small",onClick:e=>G.removeFile(t),disabled:G.uploading},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(he)]),_:1})]),_:2},1032,["onClick","disabled"])]))),128))])])):(0,s.Q3)("",!0),(0,s.Lk)("div",M,[(0,s.Lk)("div",O,[(0,s.bF)(ie,{modelValue:G.decryptKey,"onUpdate:modelValue":t[10]||(t[10]=e=>G.decryptKey=e),placeholder:"请输入解密密钥（MAC地址格式，如：00-01-05-77-6a-09）",style:{width:"300px"},clearable:"",onBlur:G.validateKeyFormat},{prefix:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(De)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,s.bF)(ee,{type:"primary",plain:"",onClick:G.autoFillDeviceId,disabled:!G.decryptKey.trim()},{default:(0,s.k6)(()=>[...t[45]||(t[45]=[(0,s.eW)(" 自动填充设备编号 ",-1)])]),_:1},8,["onClick","disabled"]),t[47]||(t[47]=(0,s.Lk)("span",{class:"key-separator"},"或",-1)),(0,s.bF)(be,{ref:"keyUploadRef","auto-upload":!1,"show-file-list":!1,accept:".txt","before-upload":G.beforeKeyUpload,"on-change":G.onKeyFileChange},{default:(0,s.k6)(()=>[(0,s.bF)(ee,{type:"primary",plain:""},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(Ce)]),_:1}),t[46]||(t[46]=(0,s.eW)(" 上传密钥文件 ",-1))]),_:1})]),_:1},8,["before-upload","on-change"])]),G.keyFileName?((0,s.uX)(),(0,s.CE)("div",Y,[(0,s.bF)(ce,{type:"success",size:"small"},{default:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(Fe)]),_:1}),(0,s.eW)(" "+(0,l.v_)(G.keyFileName),1)]),_:1})])):(0,s.Q3)("",!0),G.keyError?((0,s.uX)(),(0,s.CE)("div",q,[(0,s.bF)(ce,{type:"danger",size:"small"},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(G.keyError),1)]),_:1})])):(0,s.Q3)("",!0)]),(0,s.Lk)("div",X,[(0,s.Lk)("div",H,[(0,s.bF)(ie,{modelValue:G.deviceId,"onUpdate:modelValue":t[11]||(t[11]=e=>G.deviceId=e),placeholder:"设备编号（格式：数字或字母组合，例：4371-01、ABC-12，默认为0000-00）",style:{width:"300px"},clearable:"",onBlur:G.validateDeviceIdFormat},{prefix:(0,s.k6)(()=>[(0,s.bF)(ae,null,{default:(0,s.k6)(()=>[(0,s.bF)(pe)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,s.bF)(ee,{type:"primary",plain:"",onClick:G.autoFillKey,disabled:!G.deviceId.trim()},{default:(0,s.k6)(()=>[...t[48]||(t[48]=[(0,s.eW)(" 自动填充密钥 ",-1)])]),_:1},8,["onClick","disabled"])]),G.deviceIdError?((0,s.uX)(),(0,s.CE)("div",j,[(0,s.bF)(ce,{type:"danger",size:"small"},{default:(0,s.k6)(()=>[(0,s.eW)((0,l.v_)(G.deviceIdError),1)]),_:1})])):(0,s.Q3)("",!0)])]),_:1},8,["modelValue"]),(0,s.bF)(Se,{modelValue:e.showEntriesDialog,"onUpdate:modelValue":t[14]||(t[14]=t=>e.showEntriesDialog=t),title:"日志查看",width:"900px"},{default:(0,s.k6)(()=>[(0,s.bF)(de,{data:e.logEntries,style:{width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(ne,{prop:"timestamp",label:"时间戳",width:"180"}),(0,s.bF)(ne,{prop:"error_code",label:"故障码",width:"100"}),(0,s.bF)(ne,{prop:"param1",label:"参数1",width:"100"}),(0,s.bF)(ne,{prop:"param2",label:"参数2",width:"100"}),(0,s.bF)(ne,{prop:"param3",label:"参数3",width:"100"}),(0,s.bF)(ne,{prop:"param4",label:"参数4",width:"100"}),(0,s.bF)(ne,{prop:"explanation",label:"日志解释"})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}var J=a(953),Z=a(6278),ee=a(5220),te=a(163),ae=a(7918);class se{constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.maxReconnectDelay=3e4,this.isConnecting=!1,this.subscriptions=new Map,this.messageHandlers=new Map,this.connectionStatus="disconnected",this.handleMessage=this.handleMessage.bind(this),this.handleClose=this.handleClose.bind(this),this.handleError=this.handleError.bind(this),this.handleOpen=this.handleOpen.bind(this)}connect(){if(this.ws&&this.ws.readyState===WebSocket.OPEN)console.log("WebSocket 已连接");else if(this.isConnecting)console.log("WebSocket 正在连接中...");else{this.isConnecting=!0,this.connectionStatus="connecting";try{const e="https:"===window.location.protocol?"wss:":"ws:";let t;t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"localhost":window.location.hostname;const a={NODE_ENV:"production",VUE_APP_WS_URL:"ws://localhost:3000/ws",BASE_URL:""}.VUE_APP_BACKEND_PORT||"3000",s={NODE_ENV:"production",VUE_APP_WS_URL:"ws://localhost:3000/ws",BASE_URL:""}.VUE_APP_WS_PATH??"/ws",l="ws://localhost:3000/ws",i=l||`${e}//${t}:${a}${s}`;console.log(`🔌 正在连接 WebSocket: ${i}`),console.log(`📍 当前页面地址: ${window.location.href}`),console.log(`🌐 协议: ${e}`),console.log(`🏠 前端主机: ${window.location.host}`),console.log(`🔌 后端地址: ${t}:${a}`),console.log("🔍 网络环境: "+("localhost"===window.location.hostname?"本地开发":"网络环境")),console.log(`🔍 建议连接: ws://${t}:${a}`),this.ws=new WebSocket(i),this.ws.addEventListener("open",e=>{console.log("🔌 WebSocket 连接事件触发: open",e),clearTimeout(o)}),this.ws.addEventListener("error",e=>{console.log("🔌 WebSocket 错误事件触发: error",e)}),this.ws.addEventListener("close",e=>{console.log("🔌 WebSocket 关闭事件触发: close",e)}),this.ws.onopen=this.handleOpen,this.ws.onmessage=this.handleMessage,this.ws.onclose=this.handleClose,this.ws.onerror=this.handleError;const o=setTimeout(()=>{console.log("⏰ WebSocket 连接超时检查，当前状态:",this.ws.readyState),this.ws.readyState===WebSocket.CONNECTING&&(console.error("WebSocket 连接超时，当前状态:",this.ws.readyState),this.ws.close(),this.handleConnectionTimeout())},1e4)}catch(e){console.error("WebSocket 连接失败:",e),this.isConnecting=!1,this.connectionStatus="disconnected",this.scheduleReconnect()}}}handleOpen(e){console.log("🔌 WebSocket 连接成功"),this.isConnecting=!1,this.connectionStatus="connected",this.reconnectAttempts=0,this.reconnectDelay=1e3,this.resubscribeAll(),this.startHeartbeat(),this.triggerEvent("connection",{status:"connected",timestamp:Date.now()})}handleMessage(e){try{const t=JSON.parse(e.data);switch(console.log("📨 收到 WebSocket 消息:",t),t.type){case"connection":console.log("✅ WebSocket 连接确认:",t.message);break;case"subscription_confirmed":console.log("✅ 设备订阅确认:",t.deviceId,t.message);break;case"log_status_change":this.handleLogStatusChange(t);break;case"batch_status_change":this.handleBatchStatusChange(t);break;case"pong":break;default:console.log("未知消息类型:",t.type)}}catch(t){console.error("解析 WebSocket 消息失败:",t)}}handleLogStatusChange(e){const{deviceId:t,logId:a,oldStatus:s,newStatus:l,timestamp:i}=e;console.log(`🔄 日志状态变化: 设备 ${t}, 日志 ${a}, ${s} → ${l} @ ${i}`),this.triggerEvent("logStatusChange",{deviceId:t,logId:a,oldStatus:s,newStatus:l,timestamp:i})}handleBatchStatusChange(e){const{deviceId:t,changes:a,timestamp:s}=e;console.log(`🔄 批量状态变化: 设备 ${t}, ${a?.length||0} 个变化 @ ${s}`),this.triggerEvent("batchStatusChange",{deviceId:t,changes:a||[],timestamp:s})}handleClose(e){console.log("🔌 WebSocket 连接关闭:",e.code,e.reason),this.connectionStatus="disconnected",this.isConnecting=!1,this.stopHeartbeat(),this.triggerEvent("disconnection",{status:"disconnected",code:e.code,reason:e.reason,timestamp:Date.now()}),1e3!==e.code&&this.scheduleReconnect()}handleError(e){console.error("❌ WebSocket 连接错误:",e),this.connectionStatus="disconnected",this.isConnecting=!1}handleConnectionTimeout(){console.error("⏰ WebSocket 连接超时"),this.connectionStatus="disconnected",this.isConnecting=!1,this.scheduleReconnect()}subscribeToDevice(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return console.warn("WebSocket 未连接，无法订阅设备"),!1;if(this.subscriptions.has(e))return console.log(`设备 ${e} 已订阅`),!0;try{const t={type:"subscribe_device",deviceId:e};return this.ws.send(JSON.stringify(t)),this.subscriptions.set(e,!0),console.log(`📡 订阅设备 ${e} 状态更新`),!0}catch(t){return console.error(`订阅设备 ${e} 失败:`,t),!1}}unsubscribeFromDevice(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return!1;if(!this.subscriptions.has(e))return!0;try{const t={type:"unsubscribe_device",deviceId:e};return this.ws.send(JSON.stringify(t)),this.subscriptions.delete(e),console.log(`📡 取消订阅设备 ${e} 状态更新`),!0}catch(t){return console.error(`取消订阅设备 ${e} 失败:`,t),!1}}resubscribeAll(){for(const e of this.subscriptions.keys())this.subscribeToDevice(e)}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(JSON.stringify({type:"ping"}))}catch(e){console.error("发送心跳失败:",e)}},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return void console.error("WebSocket 重连次数已达上限，停止重连");this.reconnectAttempts++;const e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),this.maxReconnectDelay);console.log(`🔄 ${e}ms 后尝试重连 WebSocket (第 ${this.reconnectAttempts} 次)`),setTimeout(()=>{this.connect()},e)}disconnect(){this.ws&&this.ws.close(1e3,"用户主动断开"),this.stopHeartbeat(),this.connectionStatus="disconnected",this.isConnecting=!1}on(e,t){this.messageHandlers.has(e)||this.messageHandlers.set(e,[]),this.messageHandlers.get(e).push(t)}off(e,t){if(this.messageHandlers.has(e)){const a=this.messageHandlers.get(e),s=a.indexOf(t);s>-1&&a.splice(s,1)}}triggerEvent(e,t){this.messageHandlers.has(e)&&this.messageHandlers.get(e).forEach(a=>{try{a(t)}catch(s){console.error(`事件处理器 ${e} 执行失败:`,s)}})}getConnectionStatus(){return this.connectionStatus}isConnected(){return"connected"===this.connectionStatus}getSubscribedDevices(){return Array.from(this.subscriptions.keys())}}const le=new se;String({NODE_ENV:"production",VUE_APP_WS_URL:"ws://localhost:3000/ws",BASE_URL:""}.VUE_APP_WS_AUTO_CONNECT||"").toLowerCase();var ie=le,oe=a(5495),re=a(8762),ne={name:"Logs",components:{},setup(){const e=(0,Z.Pj)(),t=(0,ee.rd)(),a=(0,J.KR)(!1),l=(0,J.KR)(!1),i=(0,J.KR)(!1),o=(0,J.KR)(0),r=(0,J.KR)(""),n=(0,J.KR)(null),c=(0,J.KR)(null),d=(0,J.KR)(1),u=(0,J.KR)(20),g=(0,J.KR)(!1),p=(0,J.KR)(!1),v=(0,J.KR)(""),h=(0,J.KR)(""),_=(0,J.KR)([]),m=(0,J.KR)(0),f=(0,J.KR)(!1),y=(0,J.KR)(null),w=(0,J.KR)([]),k=(0,J.KR)(!1),b=(0,J.KR)(0);let F=null;const D=(0,J.KR)(1),C=(0,J.KR)(20),S=(0,J.KR)(0),L=(0,J.KR)([]),W=(0,J.KR)(!1),R=(0,J.KR)(""),E=(0,J.KR)(!1),z=(0,J.KR)([{text:"本年",value:()=>{const e=new Date((new Date).getFullYear(),0,1,0,0,0),t=new Date((new Date).getFullYear(),11,31,23,59,59);return[e,t]}},{text:"本月",value:()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1,0,0,0),a=new Date(e.getFullYear(),e.getMonth()+1,0,23,59,59);return[t,a]}},{text:"今天",value:()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),a=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);return[t,a]}}]),A=(0,J.KR)(""),K=(0,J.KR)(""),I=(0,J.KR)(""),x=(0,J.KR)(""),U=(0,J.KR)([]),T=(0,J.KR)(""),B=(0,J.KR)(""),N=(0,J.KR)(""),$=(0,J.KR)(!1),P=(0,J.KR)(""),V=(0,s.EW)(()=>Array.isArray(e.getters["logs/logsList"])?e.getters["logs/logsList"]:[]),M=(0,s.EW)(()=>e.getters["logs/totalCount"]),O=(0,s.EW)(()=>{const e=ie.getConnectionStatus();return"connected"===e?"实时状态监控已启用":"connecting"===e?"正在连接实时监控...":"实时状态监控未连接"}),Y=(0,s.EW)(()=>{const e=ie.getConnectionStatus();return"connected"===e?"success":"connecting"===e?"warning":"error"}),q=(0,s.EW)(()=>{const e=ie.getConnectionStatus();if("connected"===e){const e=y.value?.device_id;return e&&ie.getSubscribedDevices().includes(e)?`已订阅设备 ${e} 的状态更新，日志状态变化时将自动刷新`:"WebSocket 连接正常，等待订阅设备"}return"connecting"===e?"正在尝试连接 WebSocket 服务器，请稍候...":"无法连接到 WebSocket 服务器，将无法接收实时状态更新"}),X=(0,s.EW)(()=>"/api/logs/upload"),H=(0,s.EW)(()=>({Authorization:`Bearer ${e.state.auth.token}`,"X-Decrypt-Key":A.value,"X-Device-ID":N.value||I.value})),j=(0,s.EW)(()=>!(!$.value||!N.value)||!$.value&&(A.value.trim()&&I.value.trim())),Q=(0,s.EW)(()=>L.value.length>0&&L.value.every(e=>$t(e))&&L.value.every(e=>"parsed"===e.status)),G=(0,s.EW)(()=>L.value.length>0&&L.value.every(e=>Pt(e))&&L.value.every(e=>"parsed"===e.status)),se=(0,s.EW)(()=>L.value.length>0&&L.value.every(e=>Vt(e))&&L.value.every(e=>"parsed"===e.status||"parse_failed"===e.status)),le=(0,s.EW)(()=>L.value.length>0&&L.value.every(e=>ve(e))&&L.value.every(e=>"parsed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"failed"===e.status||"queue_failed"===e.status||"upload_failed"===e.status||"delete_failed"===e.status)),ne=(0,s.EW)(()=>{if(0===L.value.length)return!0;const e=L.value[0].device_id;return L.value.every(t=>t.device_id===e)}),ce=(0,s.EW)(()=>{if(0===L.value.length)return"";if(!ne.value){const e=[...new Set(L.value.map(e=>e.device_id))];return`选中日志包含不同的设备: ${e.join(", ")}`}return""}),de=(0,s.EW)(()=>L.value.some(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status&&"queue_failed"!==e.status&&"upload_failed"!==e.status&&"delete_failed"!==e.status)),ue=(0,s.EW)(()=>{if(0===L.value.length)return"";if(de.value){const e=L.value.filter(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status&&"queue_failed"!==e.status&&"upload_failed"!==e.status&&"delete_failed"!==e.status).length;return`选中的日志中有 ${e} 个未完成解析，请等待解析完成后再操作`}return""}),ge=(0,s.EW)(()=>e.state.auth.user?.role_id),pe=(0,s.EW)(()=>e.state.auth.user?.id),ve=e=>1===ge.value||(2===ge.value||3===ge.value&&e.uploader_id===pe.value),he=(0,J.KR)(!1),_e=(0,J.KR)(0),me=async(t={})=>{const a=t&&!0===t.silent,s=t&&!0===t.force,i=Date.now();if(!s&&i-_e.value<2e3)console.log("跳过设备分组加载（节流）");else if(s||!he.value)try{he.value=!0,_e.value=i;const t=Qe(),a=await e.dispatch("logs/fetchLogsByDevice",{...t,page:d.value,limit:u.value,device_filter:h.value.trim()});_.value=a.data.device_groups||[],m.value=a.data.pagination?.total||0}catch(o){a||l.value?console.warn("加载设备分组失败(已静默):",o?.message||o):te.nk.error("加载设备分组失败")}finally{he.value=!1}else console.log("跳过设备分组加载（去重）")},fe=async()=>{try{a.value=!0;const t=Qe();await e.dispatch("logs/fetchLogs",{page:d.value,limit:u.value,device_id:x.value||void 0,...t})}catch(t){te.nk.error("加载日志失败")}finally{a.value=!1}},ye=e=>{if(y.value=e,f.value=!0,e&&e.device_id){console.log("准备订阅设备状态更新:",e.device_id);const t=ie.subscribeToDevice(e.device_id);t?console.log("✅ 设备订阅成功:",e.device_id):console.warn("⚠️ 设备订阅失败:",e.device_id)}we({force:!0})},we=async(t={})=>{if(!y.value)return;const a=t&&!0===t.silent,s=t&&!0===t.force,l=Date.now();if(!s&&l-b.value<800)F||(F=setTimeout(()=>{F=null,we({force:!0,silent:!0})},300));else if(s||!k.value)try{k.value=!0,b.value=l;const t=ke();await e.dispatch("logs/fetchLogs",{page:D.value,limit:C.value,device_id:y.value.device_id,...t}),w.value=V.value,S.value=M.value}catch(i){a||te.nk.error("加载设备详细日志失败")}finally{k.value=!1}else F||(F=setTimeout(()=>{F=null,we({force:!0,silent:!0})},300))},ke=()=>{const e=(R.value||"").trim();return e&&/^[0-9]{4}(?:[0-9]{2}){0,3}$/.test(e)?{time_prefix:e,only_own:E.value||void 0}:{only_own:E.value||void 0}},be=()=>{f.value=!1,y.value&&y.value.device_id&&ie.unsubscribeFromDevice(y.value.device_id),y.value=null,L.value=[],window.smartStatusMonitorCleanup&&(window.smartStatusMonitorCleanup(),window.smartStatusMonitorCleanup=null)},Fe=async t=>{$.value=!0,N.value=t.device_id,console.log("设置设备编号:",N.value),I.value=t.device_id;try{const a=await e.dispatch("logs/autoFillKey",t.device_id);a.data.key?(A.value=a.data.key,console.log("自动填充密钥:",A.value)):console.log("未找到设备对应的密钥，需要用户手动输入")}catch(a){console.warn("自动获取设备密钥失败:",a.message)}i.value=!0},De=()=>{$.value=!1,N.value="",I.value="",A.value="",K.value="",T.value="",B.value="",U.value=[],i.value=!0},Ce=e=>{te.nk.info("数据上传功能暂未实现")},Se=e=>{te.nk.info("查看手术数据功能暂未实现")},Le=e=>{e.focused=!e.focused,te.nk.success(e.focused?"已关注设备":"已取消关注")},We=(0,J.KR)(!1),Re=(0,J.KR)(!1),Ee=(0,J.KR)([]),ze=(0,J.KR)(1),Ae=(0,J.KR)(20),Ke=(0,J.KR)(0),Ie=()=>{We.value=!0,Ue()},xe=e=>{y.value=e,We.value=!0,ze.value=1,Ue()},Ue=async()=>{try{Re.value=!0;const e={device_id:y.value?.device_id,page:ze.value,limit:Ae.value},t=await oe.A.surgeries.list(e);Ee.value=t.data?.data||[],Ke.value=t.data?.total||0}catch(e){te.nk.error("加载手术数据失败")}finally{Re.value=!1}},Te=async e=>{try{const a=await oe.A.surgeries.getLogEntriesByRange(e.id),s=a.data?.entries||[];if(!s.length)return void te.nk.warning("未找到相关日志条目");const l=Array.from(new Set(s.map(e=>e.log_id))).filter(Boolean);if(!l.length)return void te.nk.warning("未找到相关日志文件");const i=t.resolve(`/batch-analysis/${l.join(",")}`);window.open(i.href,"_blank")}catch(a){te.nk.error("获取手术相关日志失败")}},Be=e=>{(0,re._C)(e,{queryId:e.id})},Ne=async e=>{try{await oe.A.surgeries.remove(e.id),te.nk.success("删除成功"),Ue()}catch(t){te.nk.error("删除失败")}},$e=e=>{if(e.length>20){const t=e.slice(0,20);L.value=t,te.nk.warning("批量操作一次最多只能选择20个文件，已自动限制选择数量"),(0,s.dY)(()=>{const e=document.querySelector(".detail-logs-section .el-table");if(e){const a=e.querySelectorAll(".el-table__row .el-checkbox__input");a.forEach((e,a)=>{const s=w.value[a];s&&t.some(e=>e.id===s.id)?(e.classList.add("is-checked"),e.setAttribute("aria-checked","true")):(e.classList.remove("is-checked"),e.setAttribute("aria-checked","false"))})}})}else L.value=e},Pe=()=>{L.value=[]},Ve=e=>{C.value=e,D.value=1,we()},Me=e=>{D.value=e,we()},Oe=()=>{D.value=1,we()},Ye=()=>{R.value="",E.value=!1,D.value=1,we()},qe=()=>{D.value=1,W.value=!1,we()},Xe=()=>{R.value="",qe()},He=e=>{u.value=e,d.value=1,fe()},je=e=>{d.value=e,fe()},Qe=()=>{const e=(v.value||"").trim();return e&&/^[0-9]{4}(?:[0-9]{2}){0,3}$/.test(e)?{time_prefix:e}:{}},Ge=()=>{d.value=1,g.value=!1,fe()},Je=()=>{v.value="",Ge()},Ze=()=>{d.value=1,p.value=!1,me({force:!0})},et=()=>{h.value="",d.value=1,me({force:!0})},tt=e=>{u.value=e,d.value=1,me({force:!0})},at=e=>{d.value=e,me({force:!0})},st=()=>{v.value="",h.value="",p.value=!1,d.value=1,me({force:!0})},lt=()=>{if(!n.value)return void te.nk.error("上传组件未初始化");if(0===U.value.length)return void te.nk.error("请选择要上传的文件");if(U.value.length>50)return void te.nk.error("最多只能上传50个文件");const e=U.value.reduce((e,t)=>e+(t.size||t.raw?.size||0),0);if(e/1024/1024>200)te.nk.error("总文件大小不能超过200MB");else{if($.value){if(!N.value)return void te.nk.error("设备编号不能为空")}else{if(!A.value.trim())return void te.nk.error("请输入解密密钥或上传密钥文件");const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;if(!e.test(A.value))return void te.nk.error("密钥格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）");if(!I.value.trim())return void te.nk.warning("请输入设备编号，或使用默认值0000-00");if(I.value&&"0000-00"!==I.value){const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;if(!e.test(I.value))return void te.nk.error("设备编号格式不正确，应为数字或字母组合格式（如：4371-01、ABC-12、123-XY）")}}$.value||(P.value=I.value),n.value.submit(),i.value=!1,me(),vt()}},it=e=>{const t=e.name.endsWith(".medbot"),a=e.size/1024/1024<200;return t?!!a||(te.nk.error("单个文件大小不能超过200MB!"),!1):(te.nk.error("只能上传 .medbot 文件!"),!1)},ot=e=>{const t=e.name.endsWith(".txt"),a="systemInfo.txt"===e.name,s=e.size/1024/1024<1;return t?a?(s||te.nk.error("密钥文件大小不能超过1MB!"),!1):(te.nk.error("密钥文件名必须是 systemInfo.txt!"),!1):(te.nk.error("密钥文件必须是 .txt 格式!"),!1)},rt=e=>{const t=new FileReader;t.onload=t=>{kt(()=>{const a=(t.target.result||"").trim(),s=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;s.test(a)?(A.value=a,K.value=e.name,T.value="",te.nk.success("密钥文件读取成功")):te.nk.error("密钥文件内容格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）")})},t.readAsText(e.raw)},nt=()=>{n.value&&n.value.clearFiles(),c.value&&c.value.clearFiles(),U.value=[],$.value?(T.value="",B.value=""):(A.value="",K.value="",I.value="",N.value="",T.value="",B.value="",P.value=""),l.value=!1,o.value=0},ct=e=>e<30?`文件上传中 ${e}%`:e<60?`解密处理中 ${e}%`:e<90?`解析处理中 ${e}%`:e<100?`删除处理中 ${e}%`:`处理完成 ${e}%`,dt=()=>{if(l.value)return"解析正在进行中，刷新页面可能导致解析失败。确定要离开吗？"};(0,s.sV)(()=>{try{ie.connect()}catch(a){}window.addEventListener("beforeunload",dt),me(),ie.on("logStatusChange",e=>{console.log("收到日志状态变化:",e),"deleted"===e.newStatus&&(Lt.value.delete(e.logId),console.log("清除删除中状态，日志ID:",e.logId));const t=w.value.findIndex(t=>Number(t.id)===Number(e.logId));-1!==t&&(w.value[t]={...w.value[t],status:e.newStatus}),y.value&&f.value&&y.value.device_id===e.deviceId&&(console.log("WebSocket 状态变化，准备自动刷新详细日志列表"),we({silent:!0}))}),ie.on("batchStatusChange",e=>{console.log("收到批量状态变化:",e),e.changes&&Array.isArray(e.changes)&&e.changes.forEach(e=>{"deleted"===e.newStatus&&(Lt.value.delete(e.logId),console.log("批量状态变化：清除删除中状态，日志ID:",e.logId));const t=w.value.findIndex(t=>Number(t.id)===Number(e.logId));-1!==t&&(w.value[t]={...w.value[t],status:e.newStatus})}),y.value&&f.value&&y.value.device_id===e.deviceId&&(console.log("WebSocket 批量状态变化，准备自动刷新详细日志列表"),we({silent:!0}))});const e=()=>{(0,s.dY)(()=>{})};ie.on("connection",e),ie.on("disconnection",e);const t=setInterval(()=>{(0,s.dY)(()=>{})},1e3);(0,s.hi)(()=>{t&&clearInterval(t)})});const ut=(e,t,a)=>{console.log("上传成功:",e),bt(a);const s=a.length>0&&a.every(e=>"success"===e.status);if(s){l.value=!1,o.value=30,r.value="文件已上传，等待处理...",!$.value&&P.value&&"0000-00"!==P.value&&setTimeout(async()=>{try{await me({silent:!0});const e=_.value.find(e=>e.device_id===P.value);e&&(console.log("自动展开设备详细日志列表:",e.device_id),ye(e))}catch(e){console.warn("自动展开设备详细日志列表失败:",e)}},1e3),vt(),ht();try{n.value&&n.value.clearFiles&&n.value.clearFiles()}catch(i){}U.value=[]}},gt=async()=>{if(y.value&&f.value)try{const e=w.value.map(e=>({id:e.id,status:e.status,updated_at:e.updated_at}));await we();const t=w.value.some((t,a)=>{const s=e[a];return s&&(s.status!==t.status||s.updated_at!==t.updated_at)});return t&&console.log("检测到日志状态变化，已自动刷新详细日志列表"),t}catch(e){return console.error("检查日志状态变化失败:",e),!1}},pt=()=>()=>{},vt=()=>{if(y.value&&f.value&&(window.smartStatusMonitorCleanup&&window.smartStatusMonitorCleanup(),window.smartStatusMonitorCleanup=pt(),console.log("已启动智能状态监控"),y.value.device_id)){console.log("准备订阅设备状态更新:",y.value.device_id);const e=ie.subscribeToDevice(y.value.device_id);console.log("设备订阅结果:",e?"成功":"失败")}},ht=()=>{},_t=e=>{l.value=!1,o.value=0,te.nk.error("上传失败: "+(e.message||"未知错误"))},mt=(e,t)=>{te.nk.error("最多只能上传50个文件!")},ft=(e,t)=>{bt(t)},yt=(e,t)=>{bt(t)},wt=e=>{U.value.splice(e,1)},kt=e=>{const t=window.requestIdleCallback||(e=>setTimeout(()=>e({timeRemaining:()=>0}),1));t(()=>e())},bt=e=>{const t=(e||[]).map(e=>{const t=e.size||e.raw?.size||0,a=zt(t);return{...e,sizeText:a}});kt(()=>{U.value=t})},Ft=async t=>{try{t.parsing=!0,await e.dispatch("logs/parseLog",t.id),te.nk.success("解析成功"),fe(),vt()}catch(a){te.nk.error("解析失败")}finally{t.parsing=!1}},Dt=(0,s.EW)(()=>e.getters["auth/hasPermission"]?.("log:reparse")),Ct=async t=>{try{if(!Dt.value)return void te.nk.error("仅管理员可重新解析");t.parsing=!0,t.status="parsing",await e.dispatch("logs/reparseLog",t.id),te.nk.success("重新解析完成"),await fe(),vt()}catch(a){const e=a.response?.data?.message||a.message||"重新解析失败";te.nk.error(e)}finally{t.parsing=!1}},St=async t=>{try{const a=await e.dispatch("logs/downloadLog",t.id),s=new Blob([a.data]),l=window.URL.createObjectURL(s),i=document.createElement("a");i.href=l,i.download=t.filename,i.click(),window.URL.revokeObjectURL(l),te.nk.success("下载成功")}catch(a){te.nk.error("下载失败")}},Lt=(0,J.KR)(new Set),Wt=e=>Lt.value.has(e),Rt=async t=>{try{await ae.s.confirm("确定要删除这个日志文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),Lt.value.add(t.id),await(0,s.dY)();try{await e.dispatch("logs/deleteLog",t.id),te.nk.success("删除任务已加入队列，正在处理中..."),await we(),vt()}catch(a){console.error("删除API调用失败:",a);const e=a.response?.data?.message||a.message||"删除失败";te.nk.error(e),Lt.value.delete(t.id)}}catch(l){"cancel"!==l&&(console.error("删除确认错误:",l),te.nk.error("删除操作被取消"))}},Et=e=>{const a=t.resolve(`/batch-analysis/${e.id}`);window.open(a.href,"_blank")},zt=e=>{if(0===e)return"0 B";const t=1024,a=["B","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+a[s]},At=e=>e?new Date(e).toLocaleString("zh-CN"):"-",Kt=e=>{if(Lt.value.has(e.id))return"warning";const t={uploading:"warning",queued:"info",decrypting:"warning",parsing:"warning",parsed:"success",failed:"danger",decrypt_failed:"danger",parse_failed:"danger",file_error:"danger",deleting:"warning"};return t[e.status]||"info"},It=e=>{if(Lt.value.has(e.id))return"删除中";const t={uploading:"日志上传中",queued:"等待处理中",decrypting:"解密中",parsing:"解析中",parsed:"完成",decrypt_failed:"解密失败",parse_failed:"解析失败",file_error:"文件错误",failed:"处理失败",deleting:"删除中"};return t[e.status]||e.status||"-"},xt=()=>{const e=L.value.map(e=>e.id).join(","),a=t.resolve(`/batch-analysis/${e}`);window.open(a.href,"_blank")},Ut=async()=>{try{te.nk.info("正在打包文件，请稍候...");const t=L.value.map(e=>e.id),a=await e.dispatch("logs/batchDownloadLogs",t),s=new Blob([a.data]),l=window.URL.createObjectURL(s),i=document.createElement("a");i.href=l;const o=(new Date).toISOString().replace(/[:.]/g,"-");i.download=`logs_batch_${o}.zip`,i.click(),window.URL.revokeObjectURL(l),te.nk.success("批量下载完成")}catch(t){console.error("批量下载失败:",t);const e=t.response?.data?.message||t.message||"批量下载失败";te.nk.error(e)}},Tt=async()=>{try{if(de.value)return void te.nk.warning("请等待所有选中的日志解析完成后再进行删除操作");await ae.s.confirm(`确定要删除选中的 ${L.value.length} 个日志文件吗？此操作不可恢复！`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"});const a=[...L.value],l=a.map(e=>parseInt(e.id)).filter(e=>!isNaN(e));if(0===l.length)return void te.nk.error("选中的日志ID格式不正确");l.forEach(e=>Lt.value.add(e)),await(0,s.dY)();try{await e.dispatch("logs/batchDeleteLogs",l),te.nk.success("批量删除任务已加入队列，正在处理中..."),l.forEach(e=>Lt.value.delete(e)),await we(),vt(),Pe()}catch(t){console.error("批量删除失败:",t);const e=t.response?.data?.message||t.message||"批量删除失败";te.nk.error(e),l.forEach(e=>Lt.value.delete(e))}}catch(a){if("cancel"!==a){console.error("批量删除错误:",a),console.error("错误详情:",{name:a.name,message:a.message,code:a.code,response:a.response?.data,status:a.response?.status,statusText:a.response?.statusText,config:{url:a.config?.url,method:a.config?.method,data:a.config?.data}});let e="批量删除失败";a.response?.data?.message?e=a.response.data.message:a.message&&(e=a.message),te.nk.error(e)}}},Bt=async()=>{try{if(!Dt.value)return void te.nk.error("仅管理员可批量重新解析");if(!L.value.length)return void te.nk.warning("请先选择要重新解析的日志");if(de.value)return void te.nk.warning("请等待所有选中的日志解析完成后再进行重新解析操作");await ae.s.confirm(`确定对选中的 ${L.value.length} 个日志重新解析释义吗？`,"批量重新解析确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=L.value.map(e=>e.id),a=Array.from(new Set(L.value.map(e=>e.device_id).filter(Boolean)));a.forEach(e=>{try{ie.subscribeToDevice(e)}catch(t){}}),L.value.forEach(e=>{e.status="parsing"}),await e.dispatch("logs/batchReparseLogs",t),await we(),vt()}catch(t){if("cancel"!==t){const e=t.response?.data?.message||t.message||"批量重新解析失败";te.nk.error(e)}}},Nt=e=>"parsed"===e.status||"failed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"queue_failed"===e.status||"upload_failed"===e.status||"delete_failed"===e.status,$t=e=>"parsed"===e.status,Pt=e=>"parsed"===e.status,Vt=e=>"parsed"===e.status||"parse_failed"===e.status,Mt=async()=>{try{const t=await e.dispatch("logs/autoFillKey",I.value);t.data.key?(A.value=t.data.key,te.nk.success("已自动填充密钥")):te.nk.warning("未找到该设备编号对应的密钥")}catch(t){console.error("自动填充密钥错误:",t);const e=t.response?.data?.message||t.message||"自动填充密钥失败";te.nk.error(e)}},Ot=()=>{const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;A.value&&!e.test(A.value)?T.value="请输入有效的MAC地址格式密钥 (如: 00-01-05-77-6a-09)":T.value=""},Yt=async()=>{try{const t=await e.dispatch("logs/autoFillDeviceId",A.value);t.data.device_id?(I.value=t.data.device_id,te.nk.success("已自动填充设备编号")):te.nk.warning("未找到该密钥对应的设备编号")}catch(t){console.error("自动填充设备编号错误:",t);const e=t.response?.data?.message||t.message||"自动填充设备编号失败";te.nk.error(e)}},qt=()=>{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;I.value&&!e.test(I.value)?B.value="请输入有效的设备编号格式 (如: 4371-01、ABC-12、123-XY)":B.value=""},Xt=()=>L.value.length>20?"批量查看一次最多只能选择20个文件":ue.value?ue.value:ce.value?ce.value:"批量查看选中的日志文件",Ht=()=>L.value.length>20?"批量重新解析一次最多只能选择20个文件":ue.value?ue.value:"批量重新解析选中的日志文件";return{loading:a,uploading:l,showUploadDialog:i,overallProgress:o,processingStatus:r,progressFormat:ct,uploadRef:n,currentPage:d,pageSize:u,logs:V,total:M,uploadUrl:X,uploadHeaders:H,canSubmitUpload:j,loadLogs:fe,handleSizeChange:He,handleCurrentChange:je,dateShortcuts:z,beforeUpload:it,submitUpload:lt,clearUpload:nt,onUploadSuccess:ut,onUploadError:_t,onExceed:mt,onFileChange:ft,onFileRemove:yt,removeFile:wt,handleParse:Ft,handleDownload:St,handleDelete:Rt,handleReparse:Ct,canReparse:Dt,formatFileSize:zt,formatDate:At,getRowStatusType:Kt,getRowStatusText:It,goToLogAnalysis:Et,isDeleting:Wt,userRole:ge,decryptKey:A,keyUploadRef:c,keyFileName:K,deviceId:I,filterDeviceId:x,uploadFileList:U,uploadDeviceId:N,currentUploadDeviceId:P,beforeKeyUpload:ot,onKeyFileChange:rt,canDeleteLog:ve,canOperate:Nt,canView:$t,canDownload:Pt,canReparseLog:Vt,keyError:T,deviceIdError:B,autoFillKey:Mt,validateKeyFormat:Ot,autoFillDeviceId:Yt,validateDeviceIdFormat:qt,deviceGroups:_,deviceTotal:m,showDeviceDetailDrawer:f,selectedDevice:y,detailLogs:w,detailLoading:k,detailCurrentPage:D,detailPageSize:C,detailTotal:S,selectedDetailLogs:L,showDetailNameFilterPanel:W,detailNameTimePrefix:R,detailOnlyOwn:E,loadDeviceGroups:me,handleDeviceSizeChange:tt,handleDeviceCurrentChange:at,showDeviceDetail:ye,loadDetailLogs:we,handleDrawerClose:be,uploadLogForDevice:Fe,showNormalUpload:De,uploadDataForDevice:Ce,viewSurgeryData:Se,toggleDeviceFocus:Le,handleDetailSelectionChange:$e,clearDetailSelection:Pe,handleDetailSizeChange:Ve,handleDetailCurrentChange:Me,applyDetailOnlyOwn:Oe,resetDetailFilters:Ye,applyDetailNameFilter:qe,resetDetailNameFilter:Xe,checkAndUpdateDetailLogs:gt,startSmartStatusMonitoring:pt,startMonitoringIfDrawerOpen:vt,websocketStatusTitle:O,websocketStatusType:Y,websocketStatusDescription:q,canBatchView:Q,canBatchDownload:G,canBatchReparse:se,canBatchDelete:le,isSameDevice:ne,deviceCheckMessage:ce,hasIncompleteLogs:de,incompleteLogsMessage:ue,handleBatchAnalyze:xt,handleBatchDownload:Ut,handleBatchDelete:Tt,handleBatchReparse:Bt,showNameFilterPanel:g,showDeviceFilterPanel:p,nameTimePrefix:v,deviceFilterValue:h,applyNameFilter:Ge,resetNameFilter:Je,applyDeviceFilter:Ze,resetDeviceFilter:et,resetAllFilters:st,startStatusMonitoring:ht,getBatchViewTitle:Xt,getBatchReparseTitle:Ht,showSurgeryDrawer:We,surgeryLoading:Re,surgeryList:Ee,surgeryPage:ze,surgeryPageSize:Ae,surgeryTotal:Ke,openSurgeryDrawer:Ie,loadSurgeries:Ue,viewLogsBySurgery:Te,visualizeSurgery:Be,deleteSurgery:Ne,openSurgeryDrawerForDevice:xe}}},ce=a(6262);const de=(0,ce.A)(ne,[["render",G],["__scopeId","data-v-5bbff232"]]);var ue=de},7662:function(e,t,a){function s(e){if(!e)return null;try{if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e)){const t=e.replace(" ","T")+"Z",a=new Date(t);return isNaN(a.getTime())?(console.warn("⚠️ 无效的时间格式:",e),e):a.toISOString()}return e}catch(t){return console.warn("⚠️ 时间转换失败:",e,t),e}}function l(e){if(!e)return console.warn("⚠️ 手术数据为空"),null;console.log("🔧 开始适配手术数据:",e);let t=null,a={};if(e.postgresql_row_preview?.structured_data?(t=e.postgresql_row_preview.structured_data,a={surgery_id:e.surgery_id||e.postgresql_row_preview.surgery_id,start_time:s(e.surgery_start_time||e.postgresql_row_preview.start_time),end_time:s(e.surgery_end_time||e.postgresql_row_preview.end_time),is_remote:e.is_remote_surgery||e.postgresql_row_preview.is_remote,has_fault:e.has_error||e.postgresql_row_preview.has_fault,device_ids:e.postgresql_row_preview.device_ids||[],source_log_ids:e.postgresql_row_preview.source_log_ids||[]}):e.structured_data?(t=e.structured_data,a={surgery_id:e.surgery_id,start_time:s(e.start_time),end_time:s(e.end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):e.arms||e.surgery_stats||e.power_cycles?(t=e,a={surgery_id:e.surgery_id,start_time:s(e.start_time||e.surgery_start_time),end_time:s(e.end_time||e.surgery_end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):(e.arm1_usage||e.state_machine_changes||e.alarm_details)&&(t=i(e),a={surgery_id:e.surgery_id,start_time:s(e.surgery_start_time),end_time:s(e.surgery_end_time),is_remote:e.is_remote_surgery,has_fault:e.has_error,device_ids:[],source_log_ids:e.log_id?[e.log_id]:[]}),!t)return console.warn("⚠️ 无法识别的数据格式:",e),null;const l=o(t),r={...l,...a};return console.log("✅ 手术数据适配完成:",r),r}function i(e){const t={power_cycles:[],arms:[],surgery_stats:{success:!e.has_error,network_latency_ms:[],faults:[],state_machine:[],arm_switch_count:0,left_hand_clutch:0,right_hand_clutch:0,foot_clutch:0,endoscope_pedal:0}};for(let a=1;a<=4;a++){const l=e[`arm${a}_usage`]||[],i=l.map(e=>({tool_type:e.instrumentName||e.tool_type||"未知器械",udi:e.udi||"无UDI",start_time:s(e.startTime||e.start_time),end_time:s(e.endTime||e.end_time),energy_activation:[]}));t.arms.push({arm_id:a,instrument_usage:i})}if(e.state_machine_changes&&Array.isArray(e.state_machine_changes)&&(t.surgery_stats.state_machine=e.state_machine_changes.map(e=>({time:s(e.time),state:e.stateName||String(e.state)}))),e.network_latency_data&&Array.isArray(e.network_latency_data)&&(t.surgery_stats.network_latency_ms=e.network_latency_data.map(e=>({time:s(e.timestamp),latency:e.latency}))),e.alarm_details&&Array.isArray(e.alarm_details)&&(t.surgery_stats.faults=e.alarm_details.map(t=>({timestamp:s(t.time),error_code:t.code,param1:"",param2:"",param3:"",param4:"",explanation:t.message,log_id:e.log_id}))),e.power_on_times&&e.shutdown_times){const a=e.power_on_times,l=e.shutdown_times;let i=0,o=0;while(i<a.length||o<l.length){const e=i<a.length?a[i]:null,r=o<l.length?l[o]:null;t.power_cycles.push({on_time:s(e),off_time:s(r)}),e&&r?(i++,o++):e?i++:o++}}return t}function o(e){const t={arms:e.arms||[],power_cycles:e.power_cycles||[],surgery_stats:{success:e.surgery_stats?.success??!0,network_latency_ms:e.surgery_stats?.network_latency_ms||[],faults:e.surgery_stats?.faults||[],state_machine:e.surgery_stats?.state_machine||[],arm_switch_count:e.surgery_stats?.arm_switch_count||0,left_hand_clutch:e.surgery_stats?.left_hand_clutch||0,right_hand_clutch:e.surgery_stats?.right_hand_clutch||0,foot_clutch:e.surgery_stats?.foot_clutch||0,endoscope_pedal:e.surgery_stats?.endoscope_pedal||0}};Array.isArray(t.arms)||(t.arms=[]);for(let a=0;a<t.arms.length;a++)t.arms[a].arm_id||(t.arms[a].arm_id=a+1),t.arms[a].instrument_usage?t.arms[a].instrument_usage=t.arms[a].instrument_usage.map(e=>({...e,start_time:s(e.start_time),end_time:s(e.end_time)})):t.arms[a].instrument_usage=[];return t.surgery_stats.state_machine&&(t.surgery_stats.state_machine=t.surgery_stats.state_machine.map(e=>({...e,time:s(e.time)}))),t.surgery_stats.network_latency_ms&&(t.surgery_stats.network_latency_ms=t.surgery_stats.network_latency_ms.map(e=>({...e,time:s(e.time)}))),t.surgery_stats.faults&&(t.surgery_stats.faults=t.surgery_stats.faults.map(e=>({...e,timestamp:s(e.timestamp)}))),t.power_cycles&&(t.power_cycles=t.power_cycles.map(e=>({on_time:s(e.on_time),off_time:s(e.off_time)}))),t}function r(e){if(!e)return!1;const t=!!(e.surgery_id&&e.start_time&&e.arms&&e.surgery_stats),a=Array.isArray(e.arms)&&e.arms.length>0;return console.log("🔍 数据验证结果:",{hasRequiredFields:t,hasValidArms:a,armsCount:e.arms?.length||0,stateMachineCount:e.surgery_stats?.state_machine?.length||0,networkLatencyCount:e.surgery_stats?.network_latency_ms?.length||0}),t&&a}function n(e){return e?e.postgresql_row_preview?.structured_data?"surgery_statistics":e.structured_data?"database_record":e.arms||e.surgery_stats||e.power_cycles?"structured_data":e.arm1_usage||e.state_machine_changes||e.alarm_details?"analysis_data":"unknown":"unknown"}a.d(t,{adaptSurgeryData:function(){return l},q:function(){return n},validateAdaptedData:function(){return r}})},8762:function(e,t,a){a.d(t,{_C:function(){return i}});var s=a(4432),l=a(7662);function i(e,t={}){const{openInNewTab:a=!0,queryId:i=null}=t;try{if(!e)throw new Error("手术数据不能为空");console.log("🔧 开始处理手术数据可视化:",e);const t=(0,l.q)(e);console.log("📊 数据来源类型:",t);const o=(0,l.adaptSurgeryData)(e);if(!o)throw new Error("数据适配失败，无法识别的数据格式");if(!(0,l.validateAdaptedData)(o))throw new Error("数据验证失败，缺少必要字段");o._dataSource=t,o._originalData=e,console.log("✅ 数据适配成功:",o),sessionStorage.setItem("surgeryVizData",JSON.stringify(o));const r={path:"/surgery-visualization"};i&&(r.query={id:i});const n=s.A.resolve(r);a?window.open(n.href,"_blank"):s.A.push(r)}catch(o){console.error("❌ 可视化手术数据失败:",o),window.ElMessage&&window.ElMessage.error("可视化手术数据失败: "+o.message)}}}}]);
//# sourceMappingURL=276.10fdb0df.js.map