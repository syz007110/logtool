"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[780],{4780:function(e,a,t){t.r(a),t.d(a,{default:function(){return W}});var l=t(641),n=t(33);const s={class:"batch-analysis-container"},i={class:"card-header"},r={class:"header-left"},o={class:"header-right"},u={key:0,class:"log-info"},c={class:"logs-list"},g={class:"logs-list"},d={class:"logs-list"},p={class:"search-section"},m={class:"entries-section"},h={class:"section-header"},v={key:0,class:"loading-section"},f={key:1,class:"table-container"},k={key:2,class:"pagination-wrapper"};function y(e,a,t,y,b,_){const w=(0,l.g2)("el-tag"),L=(0,l.g2)("Download"),C=(0,l.g2)("el-icon"),F=(0,l.g2)("el-button"),S=(0,l.g2)("DataAnalysis"),z=(0,l.g2)("el-descriptions-item"),R=(0,l.g2)("el-descriptions"),W=(0,l.g2)("Search"),E=(0,l.g2)("el-input"),D=(0,l.g2)("el-date-picker"),x=(0,l.g2)("el-empty"),K=(0,l.g2)("el-table-column"),X=(0,l.g2)("el-table"),I=(0,l.g2)("el-pagination"),M=(0,l.g2)("el-card"),V=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",s,[(0,l.bF)(M,{class:"analysis-card"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",i,[(0,l.Lk)("div",r,[a[2]||(a[2]=(0,l.Lk)("span",{class:"title"},"批量日志分析",-1)),(0,l.bF)(w,{type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 已选择 "+(0,n.v_)(y.selectedLogs.length)+" 个日志文件 ",1)]),_:1}),y.batchLogEntries.length>0?((0,l.uX)(),(0,l.Wv)(w,{key:0,type:"success",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)(" 共 "+(0,n.v_)(y.batchLogEntries.length)+" 条记录 ",1)]),_:1})):(0,l.Q3)("",!0)]),(0,l.Lk)("div",o,[!y.loading&&y.batchLogEntries.length>0?((0,l.uX)(),(0,l.Wv)(F,{key:0,onClick:y.exportToCSV,type:"success",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(C,null,{default:(0,l.k6)(()=>[(0,l.bF)(L)]),_:1}),a[3]||(a[3]=(0,l.eW)(" 导出CSV "))]),_:1,__:[3]},8,["onClick"])):(0,l.Q3)("",!0),!y.loading&&y.selectedLogs.length>0&&y.batchLogEntries.length>0?((0,l.uX)(),(0,l.Wv)(F,{key:1,onClick:y.showSurgeryStatistics,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.bF)(C,null,{default:(0,l.k6)(()=>[(0,l.bF)(S)]),_:1}),a[4]||(a[4]=(0,l.eW)(" 手术分析 "))]),_:1,__:[4]},8,["onClick"])):(0,l.Q3)("",!0)])]),y.selectedLogs.length>0?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.bF)(R,{column:4,border:"",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(z,{label:"文件名",span:4},{default:(0,l.k6)(()=>[(0,l.Lk)("div",c,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(y.selectedLogs,e=>((0,l.uX)(),(0,l.Wv)(w,{key:e.id,size:"small",style:{"margin-right":"4px"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(e.original_name),1)]),_:2},1024))),128))])]),_:1}),(0,l.bF)(z,{label:"设备编号",span:1},{default:(0,l.k6)(()=>[(0,l.bF)(w,{size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(y.selectedLogs[0]?.device_id||"未知"),1)]),_:1})]),_:1}),(0,l.bF)(z,{label:"文件大小",span:1},{default:(0,l.k6)(()=>[(0,l.Lk)("div",g,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(y.selectedLogs,e=>((0,l.uX)(),(0,l.Wv)(w,{key:e.id,size:"small",style:{"margin-right":"4px"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(y.formatFileSize(e.size)),1)]),_:2},1024))),128))])]),_:1}),(0,l.bF)(z,{label:"上传用户ID",span:1},{default:(0,l.k6)(()=>[(0,l.Lk)("div",d,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(y.selectedLogs,e=>((0,l.uX)(),(0,l.Wv)(w,{key:e.id,size:"small",style:{"margin-right":"4px"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(e.uploader_id||"未知"),1)]),_:2},1024))),128))])]),_:1})]),_:1})])):(0,l.Q3)("",!0),(0,l.Lk)("div",p,[(0,l.bF)(E,{modelValue:y.searchKeyword,"onUpdate:modelValue":a[0]||(a[0]=e=>y.searchKeyword=e),placeholder:"搜索释义内容或故障码",style:{width:"250px","margin-right":"15px"},clearable:"",onInput:y.handleSearch},{prefix:(0,l.k6)(()=>[(0,l.bF)(C,null,{default:(0,l.k6)(()=>[(0,l.bF)(W)]),_:1})]),_:1},8,["modelValue","onInput"]),(0,l.bF)(D,{modelValue:y.timeRange,"onUpdate:modelValue":a[1]||(a[1]=e=>y.timeRange=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"300px","margin-right":"15px"},onChange:y.handleTimeRangeChange},null,8,["modelValue","onChange"]),y.timeRangeLimit?((0,l.uX)(),(0,l.Wv)(w,{key:0,type:"info",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.eW)(" 可选范围: "+(0,n.v_)(y.formatTimestamp(y.timeRangeLimit[0]))+" 至 "+(0,n.v_)(y.formatTimestamp(y.timeRangeLimit[1])),1)]),_:1})):(0,l.Q3)("",!0),y.timeRangeLimit?((0,l.uX)(),(0,l.Wv)(F,{key:1,onClick:y.setFullTimeRange,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>a[5]||(a[5]=[(0,l.eW)(" 选择全部时间 ")])),_:1,__:[5]},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(F,{onClick:y.clearFilters,type:"info",size:"small"},{default:(0,l.k6)(()=>a[6]||(a[6]=[(0,l.eW)(" 清除筛选 ")])),_:1,__:[6]},8,["onClick"])]),(0,l.Lk)("div",m,[(0,l.Lk)("div",h,[(0,l.Lk)("h3",null,"日志条目 ("+(0,n.v_)(y.filteredEntries.length)+")",1)]),y.loading?((0,l.uX)(),(0,l.CE)("div",v,[(0,l.bF)(x,{description:"正在加载日志数据..."})])):((0,l.uX)(),(0,l.CE)("div",f,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(X,{data:y.paginatedEntries,style:{width:"100%"},height:"calc(100vh - 350px)",stripe:""},{default:(0,l.k6)(()=>[(0,l.bF)(K,{prop:"log_name",label:"日志文件",width:"150"}),(0,l.bF)(K,{prop:"timestamp",label:"时间戳",width:"180",sortable:""},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,n.v_)(y.formatTimestamp(e.timestamp)),1)]),_:1}),(0,l.bF)(K,{prop:"error_code",label:"故障码",width:"120",sortable:""}),(0,l.bF)(K,{prop:"param1",label:"参数1",width:"100"}),(0,l.bF)(K,{prop:"param2",label:"参数2",width:"100"}),(0,l.bF)(K,{prop:"param3",label:"参数3",width:"100"}),(0,l.bF)(K,{prop:"param4",label:"参数4",width:"100"}),(0,l.bF)(K,{prop:"explanation",label:"释义","min-width":"300","show-overflow-tooltip":""})]),_:1},8,["data"])),[[V,y.loading]])])),y.filteredEntries.length>0?((0,l.uX)(),(0,l.CE)("div",k,[(0,l.bF)(I,{"current-page":y.currentPage,"page-size":y.pageSize,"page-sizes":[50,100,200,500],total:y.filteredEntries.length,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:y.handleSizeChange,onCurrentChange:y.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):(0,l.Q3)("",!0)])]),_:1})])}var b=t(953),_=t(6278),w=t(5220),L=t(163),C=t(8548),F=t(5495),S={name:"BatchAnalysis",components:{Search:C.Search,Download:C.Download,ArrowLeft:C.ArrowLeft,DataAnalysis:C.DataAnalysis,Warning:C.Warning},setup(){const e=(0,_.Pj)(),a=(0,w.lq)(),t=(0,w.rd)(),n=(0,b.KR)(!1),s=(0,b.KR)([]),i=(0,b.KR)([]),r=(0,b.KR)(""),o=(0,b.KR)(null),u=(0,b.KR)(1),c=(0,b.KR)(100),g=(0,b.KR)(!1),d=(0,b.KR)(null),p=(0,b.KR)(!1),m=(0,l.EW)(()=>{if(0===i.value.length)return null;const e=i.value.map(e=>new Date(e.timestamp)),a=new Date(Math.min(...e)),t=new Date(Math.max(...e));return[a,t]}),h=(0,l.EW)(()=>{let e=i.value;if(r.value&&(e=e.filter(e=>e.explanation.toLowerCase().includes(r.value.toLowerCase())||e.error_code.toLowerCase().includes(r.value.toLowerCase()))),o.value&&2===o.value.length){const[a,t]=o.value;e=e.filter(e=>{const l=new Date(e.timestamp),n=new Date(a),s=new Date(t);return l>=n&&l<=s})}return e}),v=(0,l.EW)(()=>{const e=(u.value-1)*c.value,a=e+c.value;return h.value.slice(e,a)}),f=async()=>{const t=a.params.logIds;if(t){const a=t.split(",").map(e=>parseInt(e));try{const t=await e.dispatch("logs/fetchLogs",{page:1,limit:1e3}),l=t.data.logs;s.value=l.filter(e=>a.includes(e.id))}catch(l){L.nk.error("获取日志信息失败")}}},k=async()=>{if(0!==s.value.length)try{n.value=!0,i.value=[];const t=[];for(const l of s.value)try{const a=await e.dispatch("logs/fetchLogEntries",l.id),n=a.data?.entries||a.entries||[],s=n.map(e=>({...e,log_name:l.original_name}));t.push(...s)}catch(a){L.nk.warning(`获取日志 ${l.original_name} 条目失败`)}i.value=t.sort((e,a)=>new Date(e.timestamp)-new Date(a.timestamp)),L.nk.success(`批量分析完成，共 ${i.value.length} 条记录`)}catch(a){L.nk.error("批量分析失败")}finally{n.value=!1}},y=()=>{u.value=1},C=()=>{u.value=1},S=()=>{r.value="",o.value=null,u.value=1},z=()=>{const e=["日志文件","时间戳","故障码","参数1","参数2","参数3","参数4","释义"],a=[e.join(","),...h.value.map(e=>[e.log_name,E(e.timestamp),e.error_code,e.param1,e.param2,e.param3,e.param4,`"${e.explanation.replace(/"/g,'""')}"`].join(","))].join("\n"),t=new Blob(["\ufeff"+a],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");l.href=URL.createObjectURL(t),l.download=`batch_logs_analysis_${(new Date).toISOString().slice(0,10)}.csv`,l.click(),URL.revokeObjectURL(l.href),L.nk.success("批量CSV文件导出成功")},R=e=>{c.value=e,u.value=1},W=e=>{u.value=e},E=e=>{if(!e)return"-";const a=new Date(e),t=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),s=String(a.getHours()).padStart(2,"0"),i=String(a.getMinutes()).padStart(2,"0"),r=String(a.getSeconds()).padStart(2,"0");return`${t}-${l}-${n} ${s}:${i}:${r}`},D=e=>{if(!e||0===e)return"0 B";const a=1024,t=["B","KB","MB","GB"],l=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,l)).toFixed(2))+" "+t[l]},x=()=>{m.value&&(o.value=[m.value[0],m.value[1]])},K=async()=>{if(0===i.value.length)return void L.nk.warning("请先加载日志条目数据");const e=s.value.map(e=>e.id);sessionStorage.setItem("autoAnalyze","true");const a=t.resolve({path:"/surgery-statistics",query:{logIds:e.join(",")}});window.open(a.href,"_blank")},X=async()=>{p.value=!0;try{const e=s.value.map(e=>e.id),a=await F.A.surgeryStatistics.analyzeByLogIds(e);a.data.success?L.nk.success(a.data.message||`成功分析出 ${a.data.data?.length||0} 场手术`):L.nk.error(a.data.message||"批量分析手术数据失败")}catch(e){L.nk.error("批量分析手术数据失败: "+(e.response?.data?.message||e.message))}finally{p.value=!1}};return(0,l.sV)(async()=>{await f(),await k()}),{loading:n,selectedLogs:s,batchLogEntries:i,searchKeyword:r,timeRange:o,currentPage:u,pageSize:c,filteredEntries:h,paginatedEntries:v,timeRangeLimit:m,loadSelectedLogs:f,loadBatchLogEntries:k,handleSearch:y,handleTimeRangeChange:C,clearFilters:S,exportToCSV:z,handleSizeChange:R,handleCurrentChange:W,formatTimestamp:E,formatFileSize:D,setFullTimeRange:x,showSurgeryStatistics:K,analyzeSurgeryData:X,surgeryStatisticsVisible:g,surgeryData:d,analyzing:p}}},z=t(6262);const R=(0,z.A)(S,[["render",y],["__scopeId","data-v-6c2e2c2d"]]);var W=R}}]);
//# sourceMappingURL=780.4bc4038a.js.map