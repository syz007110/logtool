"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[662,886],{1088:function(e,t,a){a.d(t,{G8:function(){return n},d3:function(){return r},e$:function(){return s}});const r={ROW_GAP_PX:2,BAR_MAX_PX:40,BAR_RATIO:.8},s={TOOL_TYPE_COLORS:{"无器械":"#EBBA66","持针钳":"#D9EB66","电钩":"#96EB66","双极鸭嘴电凝钳":"#66EB77","直剪":"#FFB366","单极弧剪":"#FF9966","双极弧形电凝钳":"#FF6666","波茨剪":"#FF6666","无损伤镊":"#66CCFF","-30度内窥镜":"#3399FF","0度内窥镜":"#0066FF","30度内窥镜":"#6699FF","大持针钳":"#99CC66","鸭嘴抓钳":"#33CC99","鼠齿抓钳":"#00CC99"},ARM_BASE_COLORS:["#E28A6A","#E2C66A","#C2E26A","#86E26A"]};function n(e){if(null===e||void 0===e||""===e)return NaN;if("number"===typeof e&&Number.isFinite(e))return e;const t=new Date(e).getTime();return Number.isFinite(t)?t:NaN}},6886:function(e,t,a){a.r(t),a.d(t,{default:function(){return c}});var r=a(641),s=a(33);function n(e,t,a,n,l,_){const i=(0,r.g2)("a-page-header"),o=(0,r.g2)("a-input"),u=(0,r.g2)("a-form-item"),m=(0,r.g2)("a-col"),d=(0,r.g2)("a-row"),c=(0,r.g2)("a-button"),g=(0,r.g2)("a-space"),p=(0,r.g2)("a-form"),f=(0,r.g2)("a-card"),y=(0,r.g2)("a-descriptions-item"),w=(0,r.g2)("a-descriptions"),h=(0,r.g2)("a-tab-pane"),b=(0,r.g2)("a-textarea"),v=(0,r.g2)("a-tabs");return(0,r.uX)(),(0,r.CE)("div",null,[(0,r.bF)(i,{title:"测试","sub-title":"仅管理员可用"}),(0,r.bF)(v,{style:{"margin-top":"16px"}},{default:(0,r.k6)(()=>[(0,r.bF)(h,{key:"explanation",tab:"释义测试"},{default:(0,r.k6)(()=>[(0,r.bF)(f,null,{default:(0,r.k6)(()=>[(0,r.bF)(p,{layout:"vertical"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{gutter:16},{default:(0,r.k6)(()=>[(0,r.bF)(m,{span:8},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"故障码 (code)"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.code,"onUpdate:value":t[0]||(t[0]=e=>n.form.code=e),placeholder:"可填日志中的完整故障码如 1010A，或 0X010A"},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(m,{span:8},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"子系统 (可选)"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.subsystem,"onUpdate:value":t[1]||(t[1]=e=>n.form.subsystem=e),placeholder:"如 1-9 或 A"},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(m,{span:8},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"自定义模板 (可选，优先使用)"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.template,"onUpdate:value":t[2]||(t[2]=e=>n.form.template=e),placeholder:"如: 轴{0:d} 错误码 {1:x}"},null,8,["value"])]),_:1})]),_:1})]),_:1}),(0,r.bF)(d,{gutter:16},{default:(0,r.k6)(()=>[(0,r.bF)(m,{span:6},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"参数1"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.param1,"onUpdate:value":t[3]||(t[3]=e=>n.form.param1=e)},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(m,{span:6},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"参数2"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.param2,"onUpdate:value":t[4]||(t[4]=e=>n.form.param2=e)},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(m,{span:6},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"参数3"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.param3,"onUpdate:value":t[5]||(t[5]=e=>n.form.param3=e)},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(m,{span:6},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"参数4"},{default:(0,r.k6)(()=>[(0,r.bF)(o,{value:n.form.param4,"onUpdate:value":t[6]||(t[6]=e=>n.form.param4=e)},null,8,["value"])]),_:1})]),_:1})]),_:1}),(0,r.bF)(g,null,{default:(0,r.k6)(()=>[(0,r.bF)(c,{type:"primary",loading:n.loading,onClick:n.handleParse},{default:(0,r.k6)(()=>[...t[8]||(t[8]=[(0,r.eW)("解析",-1)])]),_:1},8,["loading","onClick"]),(0,r.bF)(c,{onClick:n.handleReset},{default:(0,r.k6)(()=>[...t[9]||(t[9]=[(0,r.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),n.result?((0,r.uX)(),(0,r.Wv)(f,{key:0,style:{"margin-top":"16px"}},{default:(0,r.k6)(()=>[(0,r.bF)(w,{bordered:"",title:"解析结果",column:1},{default:(0,r.k6)(()=>[(0,r.bF)(y,{label:"子系统"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(n.result.subsystem),1)]),_:1}),(0,r.bF)(y,{label:"臂号"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(n.result.arm),1)]),_:1}),(0,r.bF)(y,{label:"关节号"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(n.result.joint),1)]),_:1}),(0,r.bF)(y,{label:"模板"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(n.result.template),1)]),_:1}),(0,r.bF)(y,{label:"参数"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(JSON.stringify(n.result.params)),1)]),_:1}),(0,r.bF)(y,{label:"释义"},{default:(0,r.k6)(()=>[(0,r.eW)((0,s.v_)(n.result.explanation),1)]),_:1})]),_:1})]),_:1})):(0,r.Q3)("",!0)]),_:1}),(0,r.bF)(h,{key:"viz",tab:"可视化测试"},{default:(0,r.k6)(()=>[(0,r.bF)(f,{title:"输入手术结构化数据 (JSON)"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{value:n.vizJsonText,"onUpdate:value":t[7]||(t[7]=e=>n.vizJsonText=e),"auto-size":{minRows:14},placeholder:"粘贴手术结构化数据，或点击填充示例"},null,8,["value"]),(0,r.bF)(g,{style:{"margin-top":"12px"}},{default:(0,r.k6)(()=>[(0,r.bF)(c,{type:"primary",onClick:n.handleRenderViz},{default:(0,r.k6)(()=>[...t[10]||(t[10]=[(0,r.eW)("跳转可视化页面",-1)])]),_:1},8,["onClick"]),(0,r.bF)(c,{onClick:n.fillVizExample},{default:(0,r.k6)(()=>[...t[11]||(t[11]=[(0,r.eW)("填充示例",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1}),(0,r.bF)(f,{style:{"margin-top":"16px"},title:"说明"},{default:(0,r.k6)(()=>[...t[12]||(t[12]=[(0,r.Lk)("div",{style:{color:"#666","line-height":"1.6"}},[(0,r.Lk)("p",null,"• 输入手术结构化数据JSON格式"),(0,r.Lk)("p",null,'• 点击"跳转可视化页面"将在新标签页打开手术可视化'),(0,r.Lk)("p",null,'• 点击"填充示例"可加载测试数据'),(0,r.Lk)("p",null,"• 可视化页面将显示甘特图、状态机变化、网络延时等图表")],-1)])]),_:1})]),_:1})]),_:1})])}var l=a(953),_=a(5495),i=a(8787),o=(a(8605),a(1088),a(8762)),u={name:"ExplanationTester",setup(){const e=(0,l.Kh)({code:"",subsystem:"",template:"",param1:"",param2:"",param3:"",param4:""}),t=(0,l.KR)(!1),a=(0,l.KR)(null),s=(0,l.KR)(""),n=(0,l.KR)(null);let u=null;const m=async()=>{if(e.code){t.value=!0;try{const t={code:e.code,param1:e.param1,param2:e.param2,param3:e.param3,param4:e.param4};e.subsystem&&(t.subsystem=e.subsystem),e.template&&(t.template=e.template);const r=await _.A.explanations.preview(t);a.value=r.data}catch(r){a.value=null}finally{t.value=!1}}else i.Ay.warning("请填写故障码 code")},d=()=>{e.code="",e.subsystem="",e.template="",e.param1="",e.param2="",e.param3="",e.param4="",a.value=null},c=()=>{u&&(u.dispose(),u=null)},g=()=>{if(s.value)try{const e=JSON.parse(s.value);(0,o._C)(e)}catch(e){i.Ay.error("JSON 解析失败，请检查格式")}else i.Ay.warning("请粘贴手术结构化数据 JSON")},p=()=>{const e=Date.now(),t={surgery_id:"TEST-001",start_time:new Date(e+3e5).toISOString(),end_time:new Date(e+3e6).toISOString(),is_remote:!1,structured_data:{power_cycles:[{on_time:new Date(e).toISOString(),off_time:new Date(e+33e5).toISOString()}],arms:[{name:"1号臂",arm_id:1,instrument_usage:[{start_time:new Date(e+36e4).toISOString(),end_time:new Date(e+6e5).toISOString(),udi:"UDI-AAA-001",tool_type:"持针钳"},{start_time:new Date(e+9e5).toISOString(),end_time:new Date(e+132e4).toISOString(),udi:"UDI-AAB-002",tool_type:"电钩"}]},{name:"2号臂",arm_id:2,instrument_usage:[{start_time:new Date(e+48e4).toISOString(),end_time:new Date(e+72e4).toISOString(),udi:"UDI-BAA-003",tool_type:"直剪"},{start_time:new Date(e+18e5).toISOString(),end_time:new Date(e+24e5).toISOString(),udi:"UDI-BAB-004",tool_type:"双极鸭嘴电凝钳"}]},{name:"3号臂",arm_id:3,instrument_usage:[{start_time:new Date(e+12e5).toISOString(),end_time:new Date(e+21e5).toISOString(),udi:"UDI-CCC-005",tool_type:"0度内窥镜"}]}],state_machine_changes:[{time:new Date(e+3e5).toISOString(),stateName:"手术开始"},{time:new Date(e+15e5).toISOString(),stateName:"器械切换"},{time:new Date(e+3e6).toISOString(),stateName:"手术结束"}],previous_end_time:new Date(e-18e5).toISOString()}};s.value=JSON.stringify(t,null,2)};return(0,r.sV)(()=>{const e=()=>{u&&u.resize()};window.addEventListener("resize",e)}),(0,r.xo)(()=>{c()}),{form:e,loading:t,result:a,handleParse:m,handleReset:d,vizJsonText:s,vizChartRef:n,handleRenderViz:g,fillVizExample:p}}},m=a(6262);const d=(0,m.A)(u,[["render",n]]);var c=d},7662:function(e,t,a){function r(e){if(!e)return null;try{if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e)){const t=e.replace(" ","T")+"Z",a=new Date(t);return isNaN(a.getTime())?(console.warn("⚠️ 无效的时间格式:",e),e):a.toISOString()}return e}catch(t){return console.warn("⚠️ 时间转换失败:",e,t),e}}function s(e){if(!e)return console.warn("⚠️ 手术数据为空"),null;console.log("🔧 开始适配手术数据:",e);let t=null,a={};if(e.postgresql_row_preview?.structured_data?(t=e.postgresql_row_preview.structured_data,a={surgery_id:e.surgery_id||e.postgresql_row_preview.surgery_id,start_time:r(e.surgery_start_time||e.postgresql_row_preview.start_time),end_time:r(e.surgery_end_time||e.postgresql_row_preview.end_time),is_remote:e.is_remote_surgery||e.postgresql_row_preview.is_remote,has_fault:e.has_error||e.postgresql_row_preview.has_fault,device_ids:e.postgresql_row_preview.device_ids||[],source_log_ids:e.postgresql_row_preview.source_log_ids||[]}):e.structured_data?(t=e.structured_data,a={surgery_id:e.surgery_id,start_time:r(e.start_time),end_time:r(e.end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):e.arms||e.surgery_stats||e.power_cycles?(t=e,a={surgery_id:e.surgery_id,start_time:r(e.start_time||e.surgery_start_time),end_time:r(e.end_time||e.surgery_end_time),is_remote:e.is_remote,has_fault:e.has_fault,device_ids:e.device_ids||[],source_log_ids:e.source_log_ids||[]}):(e.arm1_usage||e.state_machine_changes||e.alarm_details)&&(t=n(e),a={surgery_id:e.surgery_id,start_time:r(e.surgery_start_time),end_time:r(e.surgery_end_time),is_remote:e.is_remote_surgery,has_fault:e.has_error,device_ids:[],source_log_ids:e.log_id?[e.log_id]:[]}),!t)return console.warn("⚠️ 无法识别的数据格式:",e),null;const s=l(t),_={...s,...a};return console.log("✅ 手术数据适配完成:",_),_}function n(e){const t={power_cycles:[],arms:[],surgery_stats:{success:!e.has_error,network_latency_ms:[],faults:[],state_machine:[],arm_switch_count:0,left_hand_clutch:0,right_hand_clutch:0,foot_clutch:0,endoscope_pedal:0}};for(let a=1;a<=4;a++){const s=e[`arm${a}_usage`]||[],n=s.map(e=>({tool_type:e.instrumentName||e.tool_type||"未知器械",udi:e.udi||"无UDI",start_time:r(e.startTime||e.start_time),end_time:r(e.endTime||e.end_time),energy_activation:[]}));t.arms.push({arm_id:a,instrument_usage:n})}if(e.state_machine_changes&&Array.isArray(e.state_machine_changes)&&(t.surgery_stats.state_machine=e.state_machine_changes.map(e=>({time:r(e.time),state:e.stateName||String(e.state)}))),e.network_latency_data&&Array.isArray(e.network_latency_data)&&(t.surgery_stats.network_latency_ms=e.network_latency_data.map(e=>({time:r(e.timestamp),latency:e.latency}))),e.alarm_details&&Array.isArray(e.alarm_details)&&(t.surgery_stats.faults=e.alarm_details.map(t=>({timestamp:r(t.time),error_code:t.code,param1:"",param2:"",param3:"",param4:"",explanation:t.message,log_id:e.log_id}))),e.power_on_times&&e.shutdown_times){const a=e.power_on_times,s=e.shutdown_times;let n=0,l=0;while(n<a.length||l<s.length){const e=n<a.length?a[n]:null,_=l<s.length?s[l]:null;t.power_cycles.push({on_time:r(e),off_time:r(_)}),e&&_?(n++,l++):e?n++:l++}}return t}function l(e){const t={arms:e.arms||[],power_cycles:e.power_cycles||[],surgery_stats:{success:e.surgery_stats?.success??!0,network_latency_ms:e.surgery_stats?.network_latency_ms||[],faults:e.surgery_stats?.faults||[],state_machine:e.surgery_stats?.state_machine||[],arm_switch_count:e.surgery_stats?.arm_switch_count||0,left_hand_clutch:e.surgery_stats?.left_hand_clutch||0,right_hand_clutch:e.surgery_stats?.right_hand_clutch||0,foot_clutch:e.surgery_stats?.foot_clutch||0,endoscope_pedal:e.surgery_stats?.endoscope_pedal||0}};Array.isArray(t.arms)||(t.arms=[]);for(let a=0;a<t.arms.length;a++)t.arms[a].arm_id||(t.arms[a].arm_id=a+1),t.arms[a].instrument_usage?t.arms[a].instrument_usage=t.arms[a].instrument_usage.map(e=>({...e,start_time:r(e.start_time),end_time:r(e.end_time)})):t.arms[a].instrument_usage=[];return t.surgery_stats.state_machine&&(t.surgery_stats.state_machine=t.surgery_stats.state_machine.map(e=>({...e,time:r(e.time)}))),t.surgery_stats.network_latency_ms&&(t.surgery_stats.network_latency_ms=t.surgery_stats.network_latency_ms.map(e=>({...e,time:r(e.time)}))),t.surgery_stats.faults&&(t.surgery_stats.faults=t.surgery_stats.faults.map(e=>({...e,timestamp:r(e.timestamp)}))),t.power_cycles&&(t.power_cycles=t.power_cycles.map(e=>({on_time:r(e.on_time),off_time:r(e.off_time)}))),t}function _(e){if(!e)return!1;const t=!!(e.surgery_id&&e.start_time&&e.arms&&e.surgery_stats),a=Array.isArray(e.arms)&&e.arms.length>0;return console.log("🔍 数据验证结果:",{hasRequiredFields:t,hasValidArms:a,armsCount:e.arms?.length||0,stateMachineCount:e.surgery_stats?.state_machine?.length||0,networkLatencyCount:e.surgery_stats?.network_latency_ms?.length||0}),t&&a}function i(e){return e?e.postgresql_row_preview?.structured_data?"surgery_statistics":e.structured_data?"database_record":e.arms||e.surgery_stats||e.power_cycles?"structured_data":e.arm1_usage||e.state_machine_changes||e.alarm_details?"analysis_data":"unknown":"unknown"}a.d(t,{adaptSurgeryData:function(){return s},q:function(){return i},validateAdaptedData:function(){return _}})},8762:function(e,t,a){a.d(t,{_C:function(){return n}});var r=a(4432),s=a(7662);function n(e,t={}){const{openInNewTab:a=!0,queryId:n=null}=t;try{if(!e)throw new Error("手术数据不能为空");console.log("🔧 开始处理手术数据可视化:",e);const t=(0,s.q)(e);console.log("📊 数据来源类型:",t);const l=(0,s.adaptSurgeryData)(e);if(!l)throw new Error("数据适配失败，无法识别的数据格式");if(!(0,s.validateAdaptedData)(l))throw new Error("数据验证失败，缺少必要字段");l._dataSource=t,l._originalData=e,console.log("✅ 数据适配成功:",l),sessionStorage.setItem("surgeryVizData",JSON.stringify(l));const _={path:"/surgery-visualization"};n&&(_.query={id:n});const i=r.A.resolve(_);a?window.open(i.href,"_blank"):r.A.push(_)}catch(l){console.error("❌ 可视化手术数据失败:",l),window.ElMessage&&window.ElMessage.error("可视化手术数据失败: "+l.message)}}}}]);
//# sourceMappingURL=886.4ef57536.js.map