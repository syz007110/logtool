"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[475],{3475:function(e,a,l){l.r(a),l.d(a,{default:function(){return G}});var t=l(641),s=l(33),n=l(3751);const o={class:"logs-container"},i={class:"upload-actions"},r={class:"card-header"},d={class:"header-actions"},c={key:0,class:"header-section batch-section"},u={class:"batch-actions"},p={key:0,class:"device-check-tip"},g={class:"device-message"},v={class:"header-section only-own-section"},k={class:"header-section reset-section"},h={class:"header-section refresh-section"},f={class:"col-header"},m={class:"filter-panel"},b={class:"filter-actions"},F={class:"col-header"},y={class:"filter-panel"},_={class:"filter-actions"},w={key:0,class:"status-tip"},C={class:"pagination-wrapper"},L={key:0,class:"overall-progress"},D={class:"progress-stages"},R={class:"el-upload__tip"},z={key:0},W={key:1,class:"parsing-tip"},x={key:1,class:"custom-file-list"},K={class:"file-list-header"},E={class:"file-items"},U={class:"file-name"},B={class:"file-size"},I={class:"key-input-section"},S={class:"key-input-row"},A={key:0,class:"key-file-info"},M={key:1,class:"key-error"},P={class:"device-input-section"},Y={class:"device-input-row"},T={key:0,class:"device-error"},V={class:"upload-actions"};function O(e,a,l,O,X,$){const N=(0,t.g2)("UploadFilled"),Q=(0,t.g2)("el-icon"),j=(0,t.g2)("el-button"),H=(0,t.g2)("el-card"),Z=(0,t.g2)("Monitor"),q=(0,t.g2)("Download"),G=(0,t.g2)("Delete"),J=(0,t.g2)("Refresh"),ee=(0,t.g2)("InfoFilled"),ae=(0,t.g2)("el-tooltip"),le=(0,t.g2)("Warning"),te=(0,t.g2)("el-tag"),se=(0,t.g2)("el-checkbox"),ne=(0,t.g2)("el-table-column"),oe=(0,t.g2)("Search"),ie=(0,t.g2)("el-input"),re=(0,t.g2)("Filter"),de=(0,t.g2)("el-popover"),ce=(0,t.g2)("el-table"),ue=(0,t.g2)("el-pagination"),pe=(0,t.g2)("el-progress"),ge=(0,t.g2)("upload-filled"),ve=(0,t.g2)("el-upload"),ke=(0,t.g2)("Document"),he=(0,t.g2)("Key"),fe=(0,t.g2)("Upload"),me=(0,t.g2)("el-dialog"),be=(0,t.gN)("loading");return(0,t.uX)(),(0,t.CE)("div",o,[(0,t.bF)(H,{class:"upload-card"},{header:(0,t.k6)(()=>a[11]||(a[11]=[(0,t.Lk)("div",{class:"card-header"},[(0,t.Lk)("span",null,"日志上传")],-1)])),default:(0,t.k6)(()=>[(0,t.Lk)("div",i,[(0,t.bF)(j,{type:"primary",onClick:a[0]||(a[0]=e=>O.showUploadDialog=!0)},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(N)]),_:1}),a[12]||(a[12]=(0,t.eW)(" 上传日志 "))]),_:1,__:[12]})])]),_:1}),(0,t.bF)(H,{class:"list-card"},{header:(0,t.k6)(()=>[(0,t.Lk)("div",r,[a[16]||(a[16]=(0,t.Lk)("span",null,"日志列表",-1)),(0,t.Lk)("div",d,[O.selectedLogs&&O.selectedLogs.length>0?((0,t.uX)(),(0,t.CE)("div",c,[(0,t.Lk)("div",u,[(0,t.bF)(j,{type:"primary",size:"small",onClick:O.handleBatchAnalyze,disabled:!O.canBatchOperate||!O.isSameDevice,title:O.deviceCheckMessage},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(Z)]),_:1}),(0,t.eW)(" 批量分析 ("+(0,s.v_)(O.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),(0,t.bF)(j,{type:"success",size:"small",onClick:O.handleBatchDownload,disabled:!O.canBatchOperate},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(q)]),_:1}),(0,t.eW)(" 批量下载 ("+(0,s.v_)(O.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled"]),(0,t.bF)(j,{type:"danger",size:"small",onClick:O.handleBatchDelete,disabled:!O.canBatchDelete},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(G)]),_:1}),(0,t.eW)(" 批量删除 ("+(0,s.v_)(O.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled"]),1===O.userRole?((0,t.uX)(),(0,t.Wv)(j,{key:0,type:"warning",size:"small",onClick:O.handleBatchReparse,disabled:0===O.selectedLogs.length||1!==O.userRole},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(J)]),_:1}),(0,t.eW)(" 批量重新解析 ("+(0,s.v_)(O.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled"])):(0,t.Q3)("",!0),3===O.userRole?((0,t.uX)(),(0,t.Wv)(ae,{key:1,content:"普通用户只能删除自己上传的日志",placement:"top"},{default:(0,t.k6)(()=>[(0,t.bF)(Q,{class:"info-icon"},{default:(0,t.k6)(()=>[(0,t.bF)(ee)]),_:1})]),_:1})):(0,t.Q3)("",!0),(0,t.bF)(j,{type:"info",size:"small",onClick:O.clearSelection},{default:(0,t.k6)(()=>a[13]||(a[13]=[(0,t.eW)(" 取消选择 ")])),_:1,__:[13]},8,["onClick"])]),O.deviceCheckMessage?((0,t.uX)(),(0,t.CE)("div",p,[(0,t.bF)(te,{type:"warning",size:"small"},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(le)]),_:1}),(0,t.Lk)("span",g,(0,s.v_)(O.deviceCheckMessage),1)]),_:1})])):(0,t.Q3)("",!0)])):(0,t.Q3)("",!0),(0,t.Lk)("div",v,[(0,t.bF)(se,{modelValue:O.onlyOwn,"onUpdate:modelValue":a[1]||(a[1]=e=>O.onlyOwn=e),onChange:O.applyOnlyOwn,label:"仅看自己"},null,8,["modelValue","onChange"])]),(0,t.Lk)("div",k,[(0,t.bF)(j,{plain:"",size:"small",onClick:O.resetAllFilters},{default:(0,t.k6)(()=>a[14]||(a[14]=[(0,t.eW)("重置")])),_:1,__:[14]},8,["onClick"])]),(0,t.Lk)("div",h,[(0,t.bF)(j,{plain:"",size:"small",onClick:O.loadLogs},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(J)]),_:1}),a[15]||(a[15]=(0,t.eW)(" 刷新 "))]),_:1,__:[15]},8,["onClick"])])])])]),default:(0,t.k6)(()=>[(0,t.bo)(((0,t.uX)(),(0,t.Wv)(ce,{data:O.logs,loading:O.loading,style:{width:"100%"},onSelectionChange:O.handleSelectionChange},{default:(0,t.k6)(()=>[(0,t.bF)(ne,{type:"selection",width:"55"}),(0,t.bF)(ne,{prop:"original_name",label:"原始文件名",width:"240"},{header:(0,t.k6)(()=>[(0,t.Lk)("div",f,[a[20]||(a[20]=(0,t.Lk)("span",null,"原始文件名",-1)),(0,t.bF)(de,{placement:"bottom-start",width:"260",visible:O.showNameFilterPanel,"onUpdate:visible":a[3]||(a[3]=e=>O.showNameFilterPanel=e),"popper-class":"custom-filter-panel"},{reference:(0,t.k6)(()=>[(0,t.bF)(Q,{class:(0,s.C4)(["filter-trigger",{active:!!O.nameTimePrefix}])},{default:(0,t.k6)(()=>[(0,t.bF)(re)]),_:1},8,["class"])]),default:(0,t.k6)(()=>[(0,t.Lk)("div",m,[a[19]||(a[19]=(0,t.Lk)("div",{class:"filter-title"},"时间前缀 (YYYY / YYYYMM / YYYYMMDD / YYYYMMDDHH)",-1)),(0,t.bF)(ie,{modelValue:O.nameTimePrefix,"onUpdate:modelValue":a[2]||(a[2]=e=>O.nameTimePrefix=e),placeholder:"例如 2025081611",clearable:"",onKeyup:(0,n.jR)(O.applyNameFilter,["enter"])},{prefix:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(oe)]),_:1})]),_:1},8,["modelValue","onKeyup"]),(0,t.Lk)("div",b,[(0,t.bF)(j,{size:"small",type:"primary",onClick:O.applyNameFilter},{default:(0,t.k6)(()=>a[17]||(a[17]=[(0,t.eW)("搜索")])),_:1,__:[17]},8,["onClick"]),(0,t.bF)(j,{size:"small",onClick:O.resetNameFilter},{default:(0,t.k6)(()=>a[18]||(a[18]=[(0,t.eW)("重置")])),_:1,__:[18]},8,["onClick"])])])]),_:1},8,["visible"])])]),_:1}),(0,t.bF)(ne,{prop:"device_id",label:"设备编号",width:"160"},{header:(0,t.k6)(()=>[(0,t.Lk)("div",F,[a[24]||(a[24]=(0,t.Lk)("span",null,"设备编号",-1)),(0,t.bF)(de,{placement:"bottom-start",width:"260",visible:O.showDeviceFilterPanel,"onUpdate:visible":a[5]||(a[5]=e=>O.showDeviceFilterPanel=e),"popper-class":"custom-filter-panel"},{reference:(0,t.k6)(()=>[(0,t.bF)(Q,{class:(0,s.C4)(["filter-trigger",{active:!!O.filterDeviceId}])},{default:(0,t.k6)(()=>[(0,t.bF)(re)]),_:1},8,["class"])]),default:(0,t.k6)(()=>[(0,t.Lk)("div",y,[a[23]||(a[23]=(0,t.Lk)("div",{class:"filter-title"},"设备编号",-1)),(0,t.bF)(ie,{modelValue:O.filterDeviceId,"onUpdate:modelValue":a[4]||(a[4]=e=>O.filterDeviceId=e),placeholder:"例如 4371-01",clearable:"",onKeyup:(0,n.jR)(O.applyDeviceFilter,["enter"])},{prefix:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(oe)]),_:1})]),_:1},8,["modelValue","onKeyup"]),(0,t.Lk)("div",_,[(0,t.bF)(j,{size:"small",type:"primary",onClick:O.applyDeviceFilter},{default:(0,t.k6)(()=>a[21]||(a[21]=[(0,t.eW)("搜索")])),_:1,__:[21]},8,["onClick"]),(0,t.bF)(j,{size:"small",onClick:O.resetDeviceFilter},{default:(0,t.k6)(()=>a[22]||(a[22]=[(0,t.eW)("重置")])),_:1,__:[22]},8,["onClick"])])])]),_:1},8,["visible"])])]),_:1}),(0,t.bF)(ne,{prop:"uploader_id",label:"用户ID",width:"80"}),(0,t.bF)(ne,{prop:"upload_time",label:"上传时间",width:"150"},{default:(0,t.k6)(({row:e})=>[(0,t.eW)((0,s.v_)(O.formatDate(e.upload_time)),1)]),_:1}),(0,t.bF)(ne,{label:"状态",width:"120",align:"center"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(te,{type:O.getRowStatusType(e),size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(O.getRowStatusText(e)),1)]),_:2},1032,["type"]),O.canOperate(e)?(0,t.Q3)("",!0):((0,t.uX)(),(0,t.CE)("div",w,[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(le)]),_:1}),(0,t.Lk)("span",null,(0,s.v_)(O.isDeleting(e.id)?"删除中，请稍候":"处理中，请稍候"),1)]))]),_:1}),(0,t.bF)(ne,{label:"操作",width:"300",fixed:"right"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(j,{size:"small",type:"primary",onClick:a=>O.goToLogAnalysis(e),disabled:!O.canOperate(e)},{default:(0,t.k6)(()=>a[25]||(a[25]=[(0,t.eW)(" 分析 ")])),_:2,__:[25]},1032,["onClick","disabled"]),(0,t.bF)(j,{size:"small",type:"success",onClick:a=>O.handleDownload(e),disabled:!O.canOperate(e)},{default:(0,t.k6)(()=>a[26]||(a[26]=[(0,t.eW)(" 下载 ")])),_:2,__:[26]},1032,["onClick","disabled"]),O.canDeleteLog(e)?((0,t.uX)(),(0,t.Wv)(j,{key:0,size:"small",type:"danger",onClick:a=>O.handleDelete(e),disabled:!O.canOperate(e)},{default:(0,t.k6)(()=>a[27]||(a[27]=[(0,t.eW)(" 删除 ")])),_:2,__:[27]},1032,["onClick","disabled"])):(0,t.Q3)("",!0),O.canReparse?((0,t.uX)(),(0,t.Wv)(j,{key:1,size:"small",type:"warning",onClick:a=>O.handleReparse(e),disabled:!O.canOperate(e)||e.parsing},{default:(0,t.k6)(()=>a[28]||(a[28]=[(0,t.eW)(" 重新解析 ")])),_:2,__:[28]},1032,["onClick","disabled"])):(0,t.Q3)("",!0)]),_:1})]),_:1},8,["data","loading","onSelectionChange"])),[[be,O.loading]]),(0,t.Lk)("div",C,[(0,t.bF)(ue,{"current-page":O.currentPage,"page-size":O.pageSize,"page-sizes":[10,20,50,100],total:O.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:O.handleSizeChange,onCurrentChange:O.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),_:1}),(0,t.bF)(me,{modelValue:O.showUploadDialog,"onUpdate:modelValue":a[9]||(a[9]=e=>O.showUploadDialog=e),title:"上传日志",width:"700px","append-to-body":""},{footer:(0,t.k6)(()=>[(0,t.Lk)("div",V,[(0,t.bF)(j,{onClick:a[8]||(a[8]=e=>O.showUploadDialog=!1),disabled:O.uploading},{default:(0,t.k6)(()=>a[36]||(a[36]=[(0,t.eW)("取消")])),_:1,__:[36]},8,["disabled"]),(0,t.bF)(j,{type:"primary",onClick:O.submitUpload,loading:O.uploading,disabled:O.uploading||!O.decryptKey.trim()||0===O.uploadFileList.length},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(O.uploading?"解析中...":"上传并解析"),1)]),_:1},8,["onClick","loading","disabled"])])]),default:(0,t.k6)(()=>[O.uploading?((0,t.uX)(),(0,t.CE)("div",L,[(0,t.bF)(pe,{percentage:O.overallProgress,status:O.overallProgress>=100?"success":"","stroke-width":12,"show-text":!0,format:O.progressFormat},null,8,["percentage","status","format"]),(0,t.Lk)("div",D,[(0,t.Lk)("span",{class:(0,s.C4)(["stage",{active:O.overallProgress>=0,completed:O.overallProgress>=30}])}," 文件上传 ",2),(0,t.Lk)("span",{class:(0,s.C4)(["stage",{active:O.overallProgress>=30,completed:O.overallProgress>=60}])}," 解密处理 ",2),(0,t.Lk)("span",{class:(0,s.C4)(["stage",{active:O.overallProgress>=60,completed:O.overallProgress>=100}])}," 解析完成 ",2)])])):(0,t.Q3)("",!0),(0,t.bF)(ve,{ref:"uploadRef",action:O.uploadUrl,headers:O.uploadHeaders,"before-upload":O.beforeUpload,"on-success":O.onUploadSuccess,"on-error":O.onUploadError,"on-exceed":O.onExceed,"on-change":O.onFileChange,"on-remove":O.onFileRemove,"on-progress":e.onUploadProgress,"auto-upload":!1,"show-file-list":!1,multiple:!0,limit:50,accept:".medbot",name:"file",disabled:O.uploading},{tip:(0,t.k6)(()=>[(0,t.Lk)("div",R,[O.uploading?((0,t.uX)(),(0,t.CE)("div",W,[(0,t.bF)(Q,{class:"is-loading"},{default:(0,t.k6)(()=>[(0,t.bF)(J)]),_:1}),a[30]||(a[30]=(0,t.eW)(" 正在解析中，请勿刷新页面... "))])):((0,t.uX)(),(0,t.CE)("div",z," 支持上传 .medbot 文件，最多50个文件，总大小不超过200MB，上传后将自动解密并解析 "))])]),default:(0,t.k6)(()=>[(0,t.bF)(j,{type:"primary",disabled:O.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(Q,{class:"el-icon--upload"},{default:(0,t.k6)(()=>[(0,t.bF)(ge)]),_:1}),a[29]||(a[29]=(0,t.eW)(" 选择文件 "))]),_:1,__:[29]},8,["disabled"])]),_:1},8,["action","headers","before-upload","on-success","on-error","on-exceed","on-change","on-remove","on-progress","disabled"]),O.uploadFileList&&O.uploadFileList.length>0?((0,t.uX)(),(0,t.CE)("div",x,[(0,t.Lk)("div",K,[(0,t.Lk)("span",null,"已选择的文件 ("+(0,s.v_)(O.uploadFileList.length)+")",1),(0,t.bF)(j,{type:"text",size:"small",onClick:O.clearUpload,disabled:O.uploading},{default:(0,t.k6)(()=>a[31]||(a[31]=[(0,t.eW)(" 清空 ")])),_:1,__:[31]},8,["onClick","disabled"])]),(0,t.Lk)("div",E,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(O.uploadFileList,(e,a)=>((0,t.uX)(),(0,t.CE)("div",{key:a,class:"file-item"},[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(ke)]),_:1}),(0,t.Lk)("span",U,(0,s.v_)(e.name||e.originalname),1),(0,t.Lk)("span",B,(0,s.v_)(e.sizeText),1),(0,t.bF)(j,{type:"text",size:"small",onClick:e=>O.removeFile(a),disabled:O.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(G)]),_:1})]),_:2},1032,["onClick","disabled"])]))),128))])])):(0,t.Q3)("",!0),(0,t.Lk)("div",I,[(0,t.Lk)("div",S,[(0,t.bF)(ie,{modelValue:O.decryptKey,"onUpdate:modelValue":a[6]||(a[6]=e=>O.decryptKey=e),placeholder:"请输入解密密钥（MAC地址格式，如：00-01-05-77-6a-09）",style:{width:"300px"},clearable:"",onBlur:O.validateKeyFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(he)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,t.bF)(j,{type:"primary",plain:"",onClick:O.autoFillDeviceId,disabled:!O.decryptKey.trim()},{default:(0,t.k6)(()=>a[32]||(a[32]=[(0,t.eW)(" 自动填充设备编号 ")])),_:1,__:[32]},8,["onClick","disabled"]),a[34]||(a[34]=(0,t.Lk)("span",{class:"key-separator"},"或",-1)),(0,t.bF)(ve,{ref:"keyUploadRef","auto-upload":!1,"show-file-list":!1,accept:".txt","before-upload":O.beforeKeyUpload,"on-change":O.onKeyFileChange},{default:(0,t.k6)(()=>[(0,t.bF)(j,{type:"primary",plain:""},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(fe)]),_:1}),a[33]||(a[33]=(0,t.eW)(" 上传密钥文件 "))]),_:1,__:[33]})]),_:1},8,["before-upload","on-change"])]),O.keyFileName?((0,t.uX)(),(0,t.CE)("div",A,[(0,t.bF)(te,{type:"success",size:"small"},{default:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(ke)]),_:1}),(0,t.eW)(" "+(0,s.v_)(O.keyFileName),1)]),_:1})])):(0,t.Q3)("",!0),O.keyError?((0,t.uX)(),(0,t.CE)("div",M,[(0,t.bF)(te,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(O.keyError),1)]),_:1})])):(0,t.Q3)("",!0)]),(0,t.Lk)("div",P,[(0,t.Lk)("div",Y,[(0,t.bF)(ie,{modelValue:O.deviceId,"onUpdate:modelValue":a[7]||(a[7]=e=>O.deviceId=e),placeholder:"设备编号（格式：数字或字母组合，例：4371-01、ABC-12，默认为0000-00）",style:{width:"300px"},clearable:"",onBlur:O.validateDeviceIdFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(Q,null,{default:(0,t.k6)(()=>[(0,t.bF)(Z)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,t.bF)(j,{type:"primary",plain:"",onClick:O.autoFillKey,disabled:!O.deviceId.trim()},{default:(0,t.k6)(()=>a[35]||(a[35]=[(0,t.eW)(" 自动填充密钥 ")])),_:1,__:[35]},8,["onClick","disabled"])]),O.deviceIdError?((0,t.uX)(),(0,t.CE)("div",T,[(0,t.bF)(te,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(O.deviceIdError),1)]),_:1})])):(0,t.Q3)("",!0)])]),_:1},8,["modelValue"]),(0,t.bF)(me,{modelValue:e.showEntriesDialog,"onUpdate:modelValue":a[10]||(a[10]=a=>e.showEntriesDialog=a),title:"日志分析",width:"900px"},{default:(0,t.k6)(()=>[(0,t.bF)(ce,{data:e.logEntries,style:{width:"100%"}},{default:(0,t.k6)(()=>[(0,t.bF)(ne,{prop:"timestamp",label:"时间戳",width:"180"}),(0,t.bF)(ne,{prop:"error_code",label:"故障码",width:"100"}),(0,t.bF)(ne,{prop:"param1",label:"参数1",width:"100"}),(0,t.bF)(ne,{prop:"param2",label:"参数2",width:"100"}),(0,t.bF)(ne,{prop:"param3",label:"参数3",width:"100"}),(0,t.bF)(ne,{prop:"param4",label:"参数4",width:"100"}),(0,t.bF)(ne,{prop:"explanation",label:"日志解释"})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}var X=l(953),$=l(6278),N=l(5220),Q=l(163),j=l(7918),H={name:"Logs",setup(){const e=(0,$.Pj)(),a=(0,N.rd)(),l=(0,X.KR)(!1),s=(0,X.KR)(!1),n=(0,X.KR)(!1),o=(0,X.KR)(0),i=(0,X.KR)(null),r=(0,X.KR)(null),d=(0,X.KR)(1),c=(0,X.KR)(20),u=(0,X.KR)(!1),p=(0,X.KR)(!1),g=(0,X.KR)(""),v=(0,X.KR)(!1),k=(0,X.KR)([{text:"本年",value:()=>{const e=new Date((new Date).getFullYear(),0,1,0,0,0),a=new Date((new Date).getFullYear(),11,31,23,59,59);return[e,a]}},{text:"本月",value:()=>{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1,0,0,0),l=new Date(e.getFullYear(),e.getMonth()+1,0,23,59,59);return[a,l]}},{text:"今天",value:()=>{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),l=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);return[a,l]}}]),h=(0,X.KR)(""),f=(0,X.KR)(""),m=(0,X.KR)(""),b=(0,X.KR)(""),F=(0,X.KR)([]),y=(0,X.KR)(""),_=(0,X.KR)(""),w=(0,X.KR)([]),C=(0,t.EW)(()=>Array.isArray(e.getters["logs/logsList"])?e.getters["logs/logsList"]:[]),L=(0,t.EW)(()=>e.getters["logs/totalCount"]),D=(0,t.EW)(()=>"/api/logs/upload"),R=(0,t.EW)(()=>({Authorization:`Bearer ${e.state.auth.token}`,"X-Decrypt-Key":h.value,"X-Device-ID":m.value})),z=(0,t.EW)(()=>e.state.auth.user?.role_id),W=(0,t.EW)(()=>e.state.auth.user?.id),x=(0,t.EW)(()=>w.value.length>0&&w.value.every(e=>We(e))),K=(0,t.EW)(()=>{if(0===w.value.length)return!0;const e=w.value[0].device_id;return w.value.every(a=>a.device_id===e)}),E=(0,t.EW)(()=>{if(0===w.value.length)return"";if(!K.value){const e=[...new Set(w.value.map(e=>e.device_id))];return`选中日志包含不同的设备: ${e.join(", ")}`}return""}),U=(0,t.EW)(()=>w.value.length>0&&w.value.every(e=>B(e))),B=e=>1===z.value||(2===z.value||3===z.value&&e.uploader_id===W.value),I=async()=>{try{l.value=!0;const a=M();await e.dispatch("logs/fetchLogs",{page:d.value,limit:c.value,device_id:b.value||void 0,...a})}catch(a){Q.nk.error("加载日志失败")}finally{l.value=!1}},S=e=>{c.value=e,d.value=1,I()},A=e=>{d.value=e,I()},M=()=>{const e=(g.value||"").trim();return e&&/^[0-9]{4}(?:[0-9]{2}){0,3}$/.test(e)?{time_prefix:e,only_own:v.value||void 0}:{only_own:v.value||void 0}},P=()=>{d.value=1,u.value=!1,I()},Y=()=>{g.value="",P()},T=()=>{d.value=1,p.value=!1,I()},V=()=>{b.value="",T()},O=()=>{d.value=1,I()},H=()=>{g.value="",b.value="",v.value=!1,d.value=1,I()},Z=()=>{if(!h.value.trim())return void Q.nk.error("请输入解密密钥或上传密钥文件");const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;if(!e.test(h.value))return void Q.nk.error("密钥格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）");if(!m.value.trim())return void Q.nk.warning("请输入设备编号，或使用默认值0000-00");if(!m.value||"0000-00"===m.value)return void Q.nk.warning("请输入设备编号，或使用默认值0000-00");{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;if(!e.test(m.value))return void Q.nk.error("设备编号格式不正确，应为数字或字母组合格式（如：4371-01、ABC-12、123-XY）")}if(!i.value)return void Q.nk.error("上传组件未初始化");if(0===F.value.length)return void Q.nk.error("请选择要上传的文件");if(F.value.length>50)return void Q.nk.error("最多只能上传50个文件");const a=F.value.reduce((e,a)=>e+(a.size||a.raw?.size||0),0);a/1024/1024>200?Q.nk.error("总文件大小不能超过200MB"):(i.value.submit(),n.value=!1,I())},q=e=>{const a=e.name.endsWith(".medbot"),l=e.size/1024/1024<200;return a?l?!!h.value.trim()||(Q.nk.error("请输入解密密钥或上传密钥文件!"),!1):(Q.nk.error("单个文件大小不能超过200MB!"),!1):(Q.nk.error("只能上传 .medbot 文件!"),!1)},G=e=>{const a=e.name.endsWith(".txt"),l="systemInfo.txt"===e.name,t=e.size/1024/1024<1;return a?l?(t||Q.nk.error("密钥文件大小不能超过1MB!"),!1):(Q.nk.error("密钥文件名必须是 systemInfo.txt!"),!1):(Q.nk.error("密钥文件必须是 .txt 格式!"),!1)},J=e=>{const a=new FileReader;a.onload=a=>{de(()=>{const l=(a.target.result||"").trim(),t=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;t.test(l)?(h.value=l,f.value=e.name,y.value="",Q.nk.success("密钥文件读取成功")):Q.nk.error("密钥文件内容格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）")})},a.readAsText(e.raw)},ee=()=>{i.value&&i.value.clearFiles(),r.value&&r.value.clearFiles(),F.value=[],h.value="",f.value="",m.value="",y.value="",_.value="",s.value=!1,o.value=0},ae=e=>e<30?`文件上传中 ${e}%`:e<60?`解密处理中 ${e}%`:e<100?`解析处理中 ${e}%`:`处理完成 ${e}%`,le=()=>{if(s.value)return"解析正在进行中，刷新页面可能导致解析失败。确定要离开吗？"};(0,t.sV)(()=>{window.addEventListener("beforeunload",le)});const te=(e,a,l)=>{ce(l);const t=l.length>0&&l.every(e=>"success"===e.status);if(t){s.value=!0;let e=30,a=0;const l=setInterval(()=>{e<60?(e+=2,o.value=e):(clearInterval(l),t())},100),t=()=>{const e=setInterval(()=>{a<40?(a+=1,o.value=60+a):(clearInterval(e),i())},200)},i=async()=>{try{await I();const e=C.value.every(e=>"parsed"===e.status);if(e){o.value=100,s.value=!1;const e=F.value.map(e=>e.name||e.originalname).join(", ");Q.nk.success(`${e} 上传成功，解析完成`),n.value=!1,ee()}else setTimeout(i,1e3)}catch(e){s.value=!1,o.value=0,Q.nk.error("检查解析状态失败"),ee()}};setTimeout(()=>{},500)}},se=e=>{Q.nk.error("上传失败: "+(e.message||"未知错误"))},ne=(e,a)=>{Q.nk.error("最多只能上传50个文件!")},oe=(e,a)=>{ce(a)},ie=(e,a)=>{ce(a)},re=e=>{F.value.splice(e,1)},de=e=>{const a=window.requestIdleCallback||(e=>setTimeout(()=>e({timeRemaining:()=>0}),1));a(()=>e())},ce=e=>{const a=(e||[]).map(e=>{const a=e.size||e.raw?.size||0,l=be(a);return{...e,sizeText:l}});de(()=>{F.value=a})},ue=async a=>{try{a.parsing=!0,await e.dispatch("logs/parseLog",a.id),Q.nk.success("解析成功"),I()}catch(l){Q.nk.error("解析失败")}finally{a.parsing=!1}},pe=(0,t.EW)(()=>e.getters["auth/hasPermission"]?.("log:reparse")),ge=async a=>{try{if(!pe.value)return void Q.nk.error("仅管理员可重新解析");a.parsing=!0,a.status="parsing",await e.dispatch("logs/reparseLog",a.id),Q.nk.success("重新解析完成"),await I()}catch(l){const e=l.response?.data?.message||l.message||"重新解析失败";Q.nk.error(e)}finally{a.parsing=!1}},ve=async a=>{try{const l=await e.dispatch("logs/downloadLog",a.id),t=new Blob([l.data]),s=window.URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=a.filename,n.click(),window.URL.revokeObjectURL(s),Q.nk.success("下载成功")}catch(l){Q.nk.error("下载失败")}},ke=(0,X.KR)(new Set),he=e=>ke.value.has(e),fe=async a=>{try{await j.s.confirm("确定要删除这个日志文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),ke.value.add(a.id),await(0,t.dY)(),await e.dispatch("logs/deleteLog",a.id),Q.nk.success("删除成功"),await I()}catch(l){"cancel"!==l&&Q.nk.error("删除失败")}finally{ke.value.delete(a.id)}},me=e=>{const l=a.resolve(`/analysis/${e.id}`);window.open(l.href,"_blank")},be=e=>{if(0===e)return"0 B";const a=1024,l=["B","KB","MB","GB"],t=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,t)).toFixed(2))+" "+l[t]},Fe=e=>e?new Date(e).toLocaleString("zh-CN"):"-",ye=e=>{if(ke.value.has(e.id))return"warning";const a={uploading:"warning",decrypting:"warning",parsing:"warning",parsed:"success",failed:"danger"};return a[e.status]||"info"},_e=e=>{if(ke.value.has(e.id))return"删除中";const a={uploading:"日志上传中",decrypting:"日志解密中",parsing:"解析中",parsed:"完成",failed:"解析失败"};return a[e.status]||e.status||"-"},we=e=>{w.value=e;try{sessionStorage.setItem("selectedLogs",JSON.stringify(e))}catch(a){console.warn("保存选中日志到sessionStorage失败:",a)}},Ce=()=>{w.value=[]},Le=()=>{const e=w.value.map(e=>e.id).join(","),l=a.resolve(`/batch-analysis/${e}`);window.open(l.href,"_blank")},De=async()=>{try{Q.nk.info("正在打包文件，请稍候...");const a=w.value.map(e=>e.id),l=await e.dispatch("logs/batchDownloadLogs",a),t=new Blob([l.data]),s=window.URL.createObjectURL(t),n=document.createElement("a");n.href=s;const o=(new Date).toISOString().replace(/[:.]/g,"-");n.download=`logs_batch_${o}.zip`,n.click(),window.URL.revokeObjectURL(s),Q.nk.success("批量下载完成")}catch(a){console.error("批量下载失败:",a);const e=a.response?.data?.message||a.message||"批量下载失败";Q.nk.error(e)}},Re=async()=>{try{await j.s.confirm(`确定要删除选中的 ${w.value.length} 个日志文件吗？此操作不可恢复！`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),Q.nk.info("开始批量删除...");const l=[...w.value],t=l.map(e=>parseInt(e.id)).filter(e=>!isNaN(e));if(0===t.length)return void Q.nk.error("选中的日志ID格式不正确");let s;try{s=await e.dispatch("logs/batchDeleteLogs",t)}catch(a){console.error("批量删除失败:",a);const e=a.response?.data?.message||a.message||"批量删除失败";return void Q.nk.error(e)}s.data.failCount>0?(Q.nk.warning(`批量删除完成，成功 ${s.data.successCount} 个，失败 ${s.data.failCount} 个`),s.data.failedLogs&&s.data.failedLogs.length>0&&console.error("删除失败的日志:",s.data.failedLogs)):Q.nk.success(s.data.message),I(),Ce()}catch(l){if("cancel"!==l){console.error("批量删除错误:",l),console.error("错误详情:",{name:l.name,message:l.message,code:l.code,response:l.response?.data,status:l.response?.status,statusText:l.response?.statusText,config:{url:l.config?.url,method:l.config?.method,data:l.config?.data}});let e="批量删除失败";l.response?.data?.message?e=l.response.data.message:l.message&&(e=l.message),Q.nk.error(e)}}},ze=async()=>{try{if(!pe.value)return void Q.nk.error("仅管理员可批量重新解析");if(!w.value.length)return void Q.nk.warning("请先选择要重新解析的日志");await j.s.confirm(`确定对选中的 ${w.value.length} 个日志重新解析释义吗？`,"批量重新解析确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=w.value.map(e=>e.id);w.value.forEach(e=>{e.status="parsing"});const l=await e.dispatch("logs/batchReparseLogs",a),{success:t=0,fail:s=0}=l.data||{};Q.nk.success(`批量重新解析完成：成功 ${t}，失败 ${s}`),await I()}catch(a){if("cancel"!==a){const e=a.response?.data?.message||a.message||"批量重新解析失败";Q.nk.error(e)}}},We=e=>"parsed"===e.status,xe=async()=>{try{const a=await e.dispatch("logs/autoFillKey",m.value);a.data.key?(h.value=a.data.key,Q.nk.success("已自动填充密钥")):Q.nk.warning("未找到该设备编号对应的密钥")}catch(a){console.error("自动填充密钥错误:",a);const e=a.response?.data?.message||a.message||"自动填充密钥失败";Q.nk.error(e)}},Ke=()=>{const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;h.value&&!e.test(h.value)?y.value="请输入有效的MAC地址格式密钥 (如: 00-01-05-77-6a-09)":y.value=""},Ee=async()=>{try{const a=await e.dispatch("logs/autoFillDeviceId",h.value);a.data.device_id?(m.value=a.data.device_id,Q.nk.success("已自动填充设备编号")):Q.nk.warning("未找到该密钥对应的设备编号")}catch(a){console.error("自动填充设备编号错误:",a);const e=a.response?.data?.message||a.message||"自动填充设备编号失败";Q.nk.error(e)}},Ue=()=>{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;m.value&&!e.test(m.value)?_.value="请输入有效的设备编号格式 (如: 4371-01、ABC-12、123-XY)":_.value=""};return(0,t.sV)(()=>{I()}),{loading:l,uploading:s,showUploadDialog:n,overallProgress:o,progressFormat:ae,uploadRef:i,currentPage:d,pageSize:c,logs:C,total:L,uploadUrl:D,uploadHeaders:R,loadLogs:I,handleSizeChange:S,handleCurrentChange:A,dateShortcuts:k,beforeUpload:q,submitUpload:Z,clearUpload:ee,onUploadSuccess:te,onUploadError:se,onExceed:ne,onFileChange:oe,onFileRemove:ie,removeFile:re,handleParse:ue,handleDownload:ve,handleDelete:fe,handleReparse:ge,canReparse:pe,formatFileSize:be,formatDate:Fe,getRowStatusType:ye,getRowStatusText:_e,goToLogAnalysis:me,isDeleting:he,userRole:z,decryptKey:h,keyUploadRef:r,keyFileName:f,deviceId:m,filterDeviceId:b,uploadFileList:F,beforeKeyUpload:G,onKeyFileChange:J,canDeleteLog:B,canOperate:We,keyError:y,deviceIdError:_,autoFillKey:xe,validateKeyFormat:Ke,autoFillDeviceId:Ee,validateDeviceIdFormat:Ue,selectedLogs:w,canBatchOperate:x,canBatchDelete:U,isSameDevice:K,deviceCheckMessage:E,handleSelectionChange:we,clearSelection:Ce,handleBatchAnalyze:Le,handleBatchDownload:De,handleBatchDelete:Re,handleBatchReparse:ze,showNameFilterPanel:u,showDeviceFilterPanel:p,nameTimePrefix:g,onlyOwn:v,applyNameFilter:P,resetNameFilter:Y,applyDeviceFilter:T,resetDeviceFilter:V,applyOnlyOwn:O,resetAllFilters:H}}},Z=l(6262);const q=(0,Z.A)(H,[["render",O],["__scopeId","data-v-4e44128a"]]);var G=q}}]);
//# sourceMappingURL=475.243ebca1.js.map