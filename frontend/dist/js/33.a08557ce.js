"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[33],{9033:function(e,a,t){t.r(a),t.d(a,{default:function(){return I}});var l=t(641),n=t(33);const i={class:"analysis-container"},r={class:"card-header"},s={class:"header-left"},o={class:"header-right"},u={key:0,class:"log-info"},d={class:"search-section"},c={class:"entries-section"},g={class:"section-header"},p={key:0,class:"loading-section"},m={key:1,class:"error-section"},h={key:2,class:"table-container"},f={key:3,class:"pagination-wrapper"},y={class:"surgery-statistics-content"},k={key:0,class:"analysis-section"},v={class:"analysis-content"},_={key:1},b={key:0},w={key:1};function C(e,a,t,C,S,F){const L=(0,l.g2)("el-tag"),z=(0,l.g2)("Download"),E=(0,l.g2)("el-icon"),W=(0,l.g2)("el-button"),D=(0,l.g2)("DataAnalysis"),R=(0,l.g2)("el-descriptions-item"),x=(0,l.g2)("el-descriptions"),I=(0,l.g2)("Search"),X=(0,l.g2)("el-input"),V=(0,l.g2)("el-date-picker"),K=(0,l.g2)("el-empty"),M=(0,l.g2)("el-table-column"),Q=(0,l.g2)("el-table"),A=(0,l.g2)("el-pagination"),T=(0,l.g2)("el-card"),Y=(0,l.g2)("el-result"),$=(0,l.g2)("el-dialog"),j=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",i,[(0,l.bF)(T,{class:"analysis-card"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",r,[(0,l.Lk)("div",s,[a[4]||(a[4]=(0,l.Lk)("span",{class:"title"},"日志分析",-1)),C.logInfo.original_name?((0,l.uX)(),(0,l.Wv)(L,{key:0,type:"info",size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(C.logInfo.original_name),1)]),_:1})):(0,l.Q3)("",!0)]),(0,l.Lk)("div",o,[!C.loading&&C.logEntries.length>0?((0,l.uX)(),(0,l.Wv)(W,{key:0,onClick:C.exportToCSV,type:"success",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(E,null,{default:(0,l.k6)(()=>[(0,l.bF)(z)]),_:1}),a[5]||(a[5]=(0,l.eW)(" 导出CSV "))]),_:1,__:[5]},8,["onClick"])):(0,l.Q3)("",!0),!C.loading&&C.logEntries.length>0?((0,l.uX)(),(0,l.Wv)(W,{key:1,onClick:C.showSurgeryStatistics,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.bF)(E,null,{default:(0,l.k6)(()=>[(0,l.bF)(D)]),_:1}),a[6]||(a[6]=(0,l.eW)(" 手术分析 "))]),_:1,__:[6]},8,["onClick"])):(0,l.Q3)("",!0)])]),C.logInfo.id?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.bF)(x,{column:4,border:"",size:"small"},{default:(0,l.k6)(()=>[(0,l.bF)(R,{label:"文件名","label-style":{width:"100px"},"content-style":{width:"100px"}},{default:(0,l.k6)(()=>[C.logInfo.original_name?((0,l.uX)(),(0,l.Wv)(L,{key:0,size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(C.logInfo.original_name),1)]),_:1})):(0,l.Q3)("",!0)]),_:1}),(0,l.bF)(R,{label:"设备编号"},{default:(0,l.k6)(()=>[C.logInfo.device_id?((0,l.uX)(),(0,l.Wv)(L,{key:0,size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(C.logInfo.device_id),1)]),_:1})):(0,l.Q3)("",!0)]),_:1}),(0,l.bF)(R,{label:"文件大小"},{default:(0,l.k6)(()=>[C.logInfo.size?((0,l.uX)(),(0,l.Wv)(L,{key:0,size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(C.formatFileSize(C.logInfo.size)),1)]),_:1})):(0,l.Q3)("",!0)]),_:1}),(0,l.bF)(R,{label:"上传用户ID"},{default:(0,l.k6)(()=>[C.logInfo.uploader_id?((0,l.uX)(),(0,l.Wv)(L,{key:0,size:"small"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(C.logInfo.uploader_id),1)]),_:1})):(0,l.Q3)("",!0)]),_:1})]),_:1})])):(0,l.Q3)("",!0),(0,l.Lk)("div",d,[(0,l.bF)(X,{modelValue:C.searchKeyword,"onUpdate:modelValue":a[0]||(a[0]=e=>C.searchKeyword=e),placeholder:"搜索释义内容或故障码",style:{width:"250px","margin-right":"15px"},clearable:"",onInput:C.handleSearch},{prefix:(0,l.k6)(()=>[(0,l.bF)(E,null,{default:(0,l.k6)(()=>[(0,l.bF)(I)]),_:1})]),_:1},8,["modelValue","onInput"]),(0,l.bF)(V,{modelValue:C.timeRange,"onUpdate:modelValue":a[1]||(a[1]=e=>C.timeRange=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"300px","margin-right":"15px"},onChange:C.handleTimeRangeChange},null,8,["modelValue","onChange"]),C.timeRangeLimit?((0,l.uX)(),(0,l.Wv)(L,{key:0,type:"info",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>[(0,l.eW)(" 可选范围: "+(0,n.v_)(C.formatTimestamp(C.timeRangeLimit[0]))+" 至 "+(0,n.v_)(C.formatTimestamp(C.timeRangeLimit[1])),1)]),_:1})):(0,l.Q3)("",!0),C.timeRangeLimit?((0,l.uX)(),(0,l.Wv)(W,{key:1,onClick:C.setFullTimeRange,type:"primary",size:"small",style:{"margin-left":"10px"}},{default:(0,l.k6)(()=>a[7]||(a[7]=[(0,l.eW)(" 选择全部时间 ")])),_:1,__:[7]},8,["onClick"])):(0,l.Q3)("",!0),(0,l.bF)(W,{onClick:C.clearFilters,type:"info",size:"small"},{default:(0,l.k6)(()=>a[8]||(a[8]=[(0,l.eW)(" 清除筛选 ")])),_:1,__:[8]},8,["onClick"])]),(0,l.Lk)("div",c,[(0,l.Lk)("div",g,[(0,l.Lk)("h3",null,"日志条目 ("+(0,n.v_)(C.filteredEntries.length)+")",1)]),C.loading?((0,l.uX)(),(0,l.CE)("div",p,[(0,l.bF)(K,{description:"正在加载日志数据..."})])):0===C.logEntries.length?((0,l.uX)(),(0,l.CE)("div",m,[(0,l.bF)(K,{description:"未找到日志条目"})])):((0,l.uX)(),(0,l.CE)("div",h,[(0,l.bo)(((0,l.uX)(),(0,l.Wv)(Q,{data:C.paginatedEntries,style:{width:"100%"},height:"calc(100vh - 350px)",stripe:""},{default:(0,l.k6)(()=>[(0,l.bF)(M,{prop:"timestamp",label:"时间戳",width:"180",sortable:""},{default:(0,l.k6)(({row:e})=>[(0,l.eW)((0,n.v_)(C.formatTimestamp(e.timestamp)),1)]),_:1}),(0,l.bF)(M,{prop:"error_code",label:"故障码",width:"120",sortable:""}),(0,l.bF)(M,{prop:"param1",label:"参数1",width:"100"}),(0,l.bF)(M,{prop:"param2",label:"参数2",width:"100"}),(0,l.bF)(M,{prop:"param3",label:"参数3",width:"100"}),(0,l.bF)(M,{prop:"param4",label:"参数4",width:"100"}),(0,l.bF)(M,{prop:"explanation",label:"释义","min-width":"300","show-overflow-tooltip":""})]),_:1},8,["data"])),[[j,C.loading]])])),C.filteredEntries.length>0?((0,l.uX)(),(0,l.CE)("div",f,[(0,l.bF)(A,{"current-page":C.currentPage,"page-size":C.pageSize,"page-sizes":[50,100,200,500],total:C.filteredEntries.length,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:C.handleSizeChange,onCurrentChange:C.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):(0,l.Q3)("",!0)])]),_:1}),(0,l.bF)($,{title:"手术统计分析",modelValue:C.surgeryStatisticsVisible,"onUpdate:modelValue":a[3]||(a[3]=e=>C.surgeryStatisticsVisible=e),width:"90%","close-on-click-modal":!1,"close-on-press-escape":!1},{default:(0,l.k6)(()=>[(0,l.Lk)("div",y,[C.surgeryData?((0,l.uX)(),(0,l.CE)("div",_,[C.surgeryData?((0,l.uX)(),(0,l.CE)("div",b,[(0,l.bF)(Y,{icon:"success",title:"手术数据分析完成","sub-title":"已成功分析出手术数据，详细统计信息请查看手术统计页面"},{extra:(0,l.k6)(()=>[(0,l.bF)(W,{type:"primary",onClick:C.showSurgeryStatistics},{default:(0,l.k6)(()=>a[12]||(a[12]=[(0,l.eW)(" 查看详细统计 ")])),_:1,__:[12]},8,["onClick"]),(0,l.bF)(W,{onClick:a[2]||(a[2]=e=>C.surgeryStatisticsVisible=!1)},{default:(0,l.k6)(()=>a[13]||(a[13]=[(0,l.eW)(" 关闭 ")])),_:1,__:[13]})]),_:1})])):((0,l.uX)(),(0,l.CE)("div",w,[(0,l.bF)(K,{description:"未分析出手术数据，请检查日志内容"})]))])):((0,l.uX)(),(0,l.CE)("div",k,[(0,l.bF)(T,null,{default:(0,l.k6)(()=>[(0,l.Lk)("div",v,[(0,l.bF)(E,null,{default:(0,l.k6)(()=>[(0,l.bF)(D)]),_:1}),a[10]||(a[10]=(0,l.Lk)("h3",null,"分析当前日志的手术数据",-1)),a[11]||(a[11]=(0,l.Lk)("p",null,"将对当前日志文件进行手术统计分析",-1)),(0,l.bF)(W,{type:"primary",onClick:C.analyzeSurgeryData,loading:C.analyzing},{default:(0,l.k6)(()=>a[9]||(a[9]=[(0,l.eW)(" 开始分析 ")])),_:1,__:[9]},8,["onClick","loading"])])]),_:1})]))])]),_:1},8,["modelValue"])])}var S=t(953),F=t(6278),L=t(5220),z=t(163),E=t(8548),W=t(5495),D={name:"Analysis",components:{Search:E.Search,Download:E.Download,ArrowLeft:E.ArrowLeft,DataAnalysis:E.DataAnalysis},setup(){const e=(0,F.Pj)(),a=(0,L.lq)(),t=(0,L.rd)(),n=a.params.id,i=(0,S.KR)(!1),r=(0,S.KR)({}),s=(0,S.KR)([]),o=(0,S.KR)(""),u=(0,S.KR)(null),d=(0,S.KR)(1),c=(0,S.KR)(100),g=(0,S.KR)(!1),p=(0,S.KR)(null),m=(0,S.KR)(!1),h=(0,l.EW)(()=>{if(0===s.value.length)return null;const e=s.value.map(e=>new Date(e.timestamp)),a=new Date(Math.min(...e)),t=new Date(Math.max(...e));return[a,t]}),f=(0,l.EW)(()=>{let e=s.value;if(o.value&&(e=e.filter(e=>e.explanation.toLowerCase().includes(o.value.toLowerCase())||e.error_code.toLowerCase().includes(o.value.toLowerCase()))),u.value&&2===u.value.length){const[a,t]=u.value;e=e.filter(e=>{const l=new Date(e.timestamp),n=new Date(a),i=new Date(t);return l>=n&&l<=i})}return e}),y=(0,l.EW)(()=>{const e=(d.value-1)*c.value,a=e+c.value;return f.value.slice(e,a)}),k=async()=>{try{const a=await e.dispatch("logs/fetchLogs",{page:1,limit:1e3}),l=a.data.logs.find(e=>e.id==n);l?r.value=l:(z.nk.error("日志不存在"),t.go(-1))}catch(a){z.nk.error("加载日志信息失败")}},v=async()=>{try{const t=await e.dispatch("logs/fetchLogEntries",n);s.value=t.data?.entries||t.entries||[];try{sessionStorage.setItem("batchLogEntries",JSON.stringify(s.value))}catch(a){}}catch(a){z.nk.error("加载日志条目失败")}},_=()=>{d.value=1},b=()=>{d.value=1},w=()=>{o.value="",u.value=null,d.value=1},C=()=>{const e=["时间戳","故障码","参数1","参数2","参数3","参数4","释义"],a=[e.join(","),...f.value.map(e=>[I(e.timestamp),e.error_code,e.param1,e.param2,e.param3,e.param4,`"${e.explanation.replace(/"/g,'""')}"`].join(","))].join("\n"),t=new Blob(["\ufeff"+a],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");l.href=URL.createObjectURL(t),l.download=`${r.value.original_name}_analysis.csv`,l.click(),URL.revokeObjectURL(l.href),z.nk.success("CSV文件导出成功")},E=e=>{c.value=e,d.value=1},D=e=>{d.value=e},R=e=>{if(0===e)return"0 B";const a=1024,t=["B","KB","MB","GB"],l=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,l)).toFixed(2))+" "+t[l]},x=e=>e?new Date(e).toLocaleString("zh-CN"):"-",I=e=>{if(!e)return"-";const a=new Date(e),t=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0"),s=String(a.getSeconds()).padStart(2,"0");return`${t}-${l}-${n} ${i}:${r}:${s}`},X=()=>{h.value&&(u.value=[h.value[0],h.value[1]])},V=()=>{t.push({path:"/surgery-statistics",query:{logIds:n}})},K=async()=>{m.value=!0;try{const e=await W.A.surgeryStatistics.analyzeByLogIds([n]);e.data.success?(Array.isArray(e.data.data)?p.value=e.data.data[0]||null:p.value=e.data.data,z.nk.success("手术数据分析完成")):z.nk.error(e.data.message||"分析手术数据失败")}catch(e){z.nk.error("分析手术数据失败: "+(e.response?.data?.message||e.message))}finally{m.value=!1}};return(0,l.sV)(async()=>{i.value=!0;try{await k(),await v()}finally{i.value=!1}}),{loading:i,logInfo:r,logEntries:s,searchKeyword:o,timeRange:u,currentPage:d,pageSize:c,filteredEntries:f,paginatedEntries:y,loadLogInfo:k,loadLogEntries:v,handleSearch:_,handleTimeRangeChange:b,clearFilters:w,exportToCSV:C,handleSizeChange:E,handleCurrentChange:D,formatFileSize:R,formatDate:x,formatTimestamp:I,timeRangeLimit:h,setFullTimeRange:X,showSurgeryStatistics:V,analyzeSurgeryData:K,surgeryStatisticsVisible:g,surgeryData:p,analyzing:m}}},R=t(6262);const x=(0,R.A)(D,[["render",C],["__scopeId","data-v-0776f753"]]);var I=x}}]);
//# sourceMappingURL=33.a08557ce.js.map