"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[613],{613:function(e,t,r){r.r(t),r.d(t,{default:function(){return ve}});var a=r(641),i=r(33),n=r(3751);const s={class:"surgery-statistics-container"},o={key:0,class:"analysis-section"},l={class:"empty-content"},m={key:0},g={key:1},u={key:1,class:"analysis-section"},d={class:"empty-content"},c={key:2},_={class:"export-section"},T={class:"surgery-info-layout"},h={class:"timeline-section"},w={class:"info-header"},y={class:"badges"},p={class:"postgresql-preview-section"},f={class:"preview-header"},S={key:0,class:"preview-content"},v={class:"preview-actions"},D={class:"state-chart-section"},k={class:"state-chart-container"},b=["id"],x={class:"card-header"},L={class:"unified-timeline-view"},I={class:"surgery-progress-container"},C={class:"surgery-duration-info"},F={class:"duration-text"},$={class:"time-range"},M={class:"surgery-timeline-wrapper"},A={class:"surgery-timeline-container"},O={class:"surgery-timeline-bar"},E={class:"progress-labels"},N={class:"time-label"},P={class:"time-label"},z={class:"arm-timeline"},W={class:"arm-header"},R={class:"arm-actions"},X={class:"arm-timeline-container"},V={class:"arm-label"},B={class:"arm-name"},q={class:"arm-timeline-bar"},K={class:"arm-details"},Q={class:"usage-group-header"},U={class:"usage-group-info"},Y={class:"usage-group-name"},J={class:"usage-group-udi"},G={class:"usage-group-duration"},Z={class:"arm-timeline-container"},j={class:"arm-timeline-bar"},H={class:"segment-content"},ee={class:"segment-text"},te={class:"energy-time"},re={class:"instruments-inside"},ae={key:0,class:"alarm-toggle"},ie={class:"alarm-summary"},ne={key:0,class:"network-stats"},se={class:"network-summary"},oe={class:"network-chart-container"},le=["id"],me={key:1,class:"network-no-data"};function ge(e,t,r,ge,ue,de){const ce=(0,a.g2)("Calendar"),_e=(0,a.g2)("el-icon"),Te=(0,a.g2)("DataAnalysis"),he=(0,a.g2)("el-button"),we=(0,a.g2)("el-card"),ye=(0,a.g2)("Loading"),pe=(0,a.g2)("Download"),fe=(0,a.g2)("el-tag"),Se=(0,a.g2)("el-input"),ve=(0,a.g2)("Document"),De=(0,a.g2)("Refresh"),ke=(0,a.g2)("a-step"),be=(0,a.g2)("a-steps"),xe=(0,a.g2)("ArrowDown"),Le=(0,a.g2)("el-tooltip"),Ie=(0,a.g2)("Lightning"),Ce=(0,a.g2)("el-collapse-transition"),Fe=(0,a.g2)("el-table-column"),$e=(0,a.g2)("el-table"),Me=(0,a.g2)("ArrowUp"),Ae=(0,a.g2)("el-empty"),Oe=(0,a.g2)("el-tab-pane"),Ee=(0,a.g2)("el-tabs");return(0,a.uX)(),(0,a.CE)("div",s,[t[21]||(t[21]=(0,a.Lk)("div",{class:"action-bar"},[(0,a.Lk)("div",{class:"title-section"},[(0,a.Lk)("h2",{class:"page-title"},"手术统计"),(0,a.Lk)("p",{class:"page-subtitle"},"查看各场手术的详细统计数据")])],-1)),ge.surgeries.length||ge.analyzing?(0,a.Q3)("",!0):((0,a.uX)(),(0,a.CE)("div",o,[(0,a.bF)(we,{class:"empty-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",l,[(0,a.bF)(_e,{class:"empty-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(ce)]),_:1}),t[1]||(t[1]=(0,a.Lk)("h3",null,"手术数据统计",-1)),ge.logEntriesCount>0?((0,a.uX)(),(0,a.CE)("p",m," 检测到 "+(0,i.v_)(ge.logEntriesCount)+" 条日志数据，点击按钮开始统计 ",1)):((0,a.uX)(),(0,a.CE)("p",g," 暂无日志数据，请先在批量查看或日志查看页面加载日志数据 ")),(0,a.bF)(he,{type:"primary",onClick:ge.analyzeLogs,loading:ge.analyzing,disabled:0===ge.logEntriesCount},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[(0,a.bF)(Te)]),_:1}),(0,a.eW)(" "+(0,i.v_)(ge.getAnalysisButtonText()),1)]),_:1},8,["onClick","loading","disabled"])])]),_:1})])),!ge.surgeries.length&&ge.analyzing?((0,a.uX)(),(0,a.CE)("div",u,[(0,a.bF)(we,{class:"empty-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",d,[(0,a.bF)(_e,{class:"empty-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(ye)]),_:1}),t[2]||(t[2]=(0,a.Lk)("h3",null,"正在统计手术数据...",-1)),t[3]||(t[3]=(0,a.Lk)("p",null,"请稍候，系统正在处理日志数据",-1))])]),_:1})])):((0,a.uX)(),(0,a.CE)("div",c,[(0,a.bF)(we,{class:"tab-card"},{default:(0,a.k6)(()=>[(0,a.bF)(Ee,{modelValue:ge.activeTab,"onUpdate:modelValue":t[0]||(t[0]=e=>ge.activeTab=e),type:"card",onTabClick:ge.handleTabClick,lazy:!0,"before-leave":ge.handleBeforeTabLeave,stretch:!1,closable:!1,addable:!1},{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(ge.surgeries,e=>((0,a.uX)(),(0,a.Wv)(Oe,{key:e.id,label:e.surgery_id,name:e.id.toString(),"data-surgery-id":e.id},{default:(0,a.k6)(()=>[(0,a.Lk)("div",_,[(0,a.bF)(he,{type:"primary",onClick:t=>ge.exportSurgeryData(e.id)},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[(0,a.bF)(pe)]),_:1}),t[4]||(t[4]=(0,a.eW)(" 导出手术数据（手术结构化数据） "))]),_:2,__:[4]},1032,["onClick"])]),(0,a.Lk)("div",T,[(0,a.Lk)("div",h,[(0,a.bF)(we,{class:"info-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",w,[t[7]||(t[7]=(0,a.Lk)("div",{class:"time"},"手术时间线",-1)),(0,a.Lk)("div",y,[e.alarm_count>0?((0,a.uX)(),(0,a.Wv)(fe,{key:0,type:"danger",size:"small",class:"alarm-tag",onClick:t=>ge.scrollToAlarmCard(e.id),style:{cursor:"pointer"}},{default:(0,a.k6)(()=>t[5]||(t[5]=[(0,a.eW)(" 查看手术故障 ")])),_:2,__:[5]},1032,["onClick"])):(0,a.Q3)("",!0),e.is_remote_surgery?((0,a.uX)(),(0,a.Wv)(fe,{key:1,type:"info",size:"small",class:"network-tag",onClick:t=>ge.scrollToNetworkCard(e.id),style:{cursor:"pointer","margin-left":"8px"}},{default:(0,a.k6)(()=>t[6]||(t[6]=[(0,a.eW)(" 查看网络延时 ")])),_:2,__:[6]},1032,["onClick"])):(0,a.Q3)("",!0)])]),(0,a.Lk)("div",p,[(0,a.Lk)("div",f,[t[8]||(t[8]=(0,a.Lk)("span",{class:"preview-title"},"PostgreSQL结构化数据预览",-1)),(0,a.bF)(he,{type:"text",size:"small",onClick:t=>ge.togglePostgreSQLPreview(e.id),style:{padding:"0","margin-left":"8px"}},{default:(0,a.k6)(()=>[(0,a.eW)((0,i.v_)(ge.postgresqlPreviewVisible[e.id]?"收起":"展开"),1)]),_:2},1032,["onClick"])]),ge.postgresqlPreviewVisible[e.id]?((0,a.uX)(),(0,a.CE)("div",S,[(0,a.bF)(Se,{modelValue:ge.postgresqlDataText[e.id],"onUpdate:modelValue":t=>ge.postgresqlDataText[e.id]=t,type:"textarea",rows:8,readonly:"",placeholder:"正在生成PostgreSQL结构化数据...",class:"postgresql-textarea"},null,8,["modelValue","onUpdate:modelValue"]),(0,a.Lk)("div",v,[(0,a.bF)(he,{type:"primary",size:"small",onClick:t=>ge.copyPostgreSQLData(e.id),loading:ge.copyingData[e.id]},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[(0,a.bF)(ve)]),_:1}),t[9]||(t[9]=(0,a.eW)(" 复制数据 "))]),_:2,__:[9]},1032,["onClick","loading"]),(0,a.bF)(he,{type:"success",size:"small",onClick:t=>ge.refreshPostgreSQLData(e.id),loading:ge.refreshingData[e.id]},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[(0,a.bF)(De)]),_:1}),t[10]||(t[10]=(0,a.eW)(" 刷新数据 "))]),_:2,__:[10]},1032,["onClick","loading"])])])):(0,a.Q3)("",!0)]),(0,a.bF)(be,{direction:"vertical",current:ge.getSortedTimelineEvents(e).length-1,"progress-dot":!0,class:"surgery-steps"},{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(ge.getSortedTimelineEvents(e),(e,t)=>((0,a.uX)(),(0,a.Wv)(ke,{key:`event-${t}`,title:e.label,description:ge.formatTime(e.time)},null,8,["title","description"]))),128))]),_:2},1032,["current"])]),_:2},1024)]),(0,a.Lk)("div",D,[(0,a.bF)(we,{class:"state-chart-card"},{default:(0,a.k6)(()=>[t[11]||(t[11]=(0,a.Lk)("div",{class:"chart-header"},[(0,a.Lk)("div",{class:"chart-title"},"手术状态机变化图")],-1)),(0,a.Lk)("div",k,[(0,a.Lk)("div",{id:`stateMachineChart_${e.id}`,style:{width:"100%",height:"100%"}},null,8,b)])]),_:2,__:[11]},1024)])]),(0,a.bF)(we,{class:"arm-usage-card"},{header:(0,a.k6)(()=>[(0,a.Lk)("div",x,[t[12]||(t[12]=(0,a.Lk)("span",null,"手术统计",-1)),(0,a.bF)(fe,{type:"info"},{default:(0,a.k6)(()=>[(0,a.eW)("总手术时长: "+(0,i.v_)(e.total_duration)+" 分钟",1)]),_:2},1024)])]),default:(0,a.k6)(()=>[(0,a.Lk)("div",L,[(0,a.Lk)("div",I,[(0,a.Lk)("div",C,[(0,a.Lk)("span",F,"手术时长："+(0,i.v_)(e.total_duration)+" 分钟",1),(0,a.Lk)("span",$,"手术时间："+(0,i.v_)(ge.formatTime(e.surgery_start_time))+" - "+(0,i.v_)(ge.formatTime(e.surgery_end_time)),1)]),(0,a.Lk)("div",M,[t[14]||(t[14]=(0,a.Lk)("div",{class:"surgery-label"},[(0,a.Lk)("div",{class:"surgery-color"}),(0,a.Lk)("span",{class:"surgery-name"},"手术时间段")],-1)),(0,a.Lk)("div",A,[(0,a.Lk)("div",O,[(0,a.Lk)("div",{class:"surgery-timeline-segment",style:(0,i.Tr)(ge.getSurgeryTimelineStyle(e))},t[13]||(t[13]=[(0,a.Lk)("span",{class:"surgery-segment-text"},"手术时间段",-1)]),4)])])]),(0,a.Lk)("div",E,[(0,a.Lk)("span",N,(0,i.v_)(ge.formatTimeShort(ge.getProgressTimelineRange(e).start)),1),(0,a.Lk)("span",P,(0,i.v_)(ge.formatTimeShort(ge.getProgressTimelineRange(e).end)),1)])]),(0,a.Lk)("div",z,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(ge.getArmUsages(e),(r,s)=>((0,a.uX)(),(0,a.CE)("div",{key:s,class:"arm-item"},[(0,a.Lk)("div",W,[(0,a.Lk)("div",R,[(0,a.bF)(he,{size:"small",type:"primary",plain:"",onClick:t=>ge.toggleArmDetails(e.id,s)},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[(0,a.bF)(xe)]),_:1}),t[15]||(t[15]=(0,a.eW)(" 详情 "))]),_:2,__:[15]},1032,["onClick"])])]),(0,a.Lk)("div",X,[(0,a.Lk)("div",V,[(0,a.Lk)("div",{class:(0,i.C4)(["arm-color",`arm-${s+1}`])},null,2),(0,a.Lk)("span",B,"工具臂 "+(0,i.v_)(s+1),1)]),(0,a.Lk)("div",q,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(ge.getArmTimelineSegments(r,e),(n,o)=>((0,a.uX)(),(0,a.CE)("div",{key:o,class:(0,i.C4)(["timeline-segment",`arm-${s+1}`]),style:(0,i.Tr)(n)},[(0,a.bF)(Le,{content:`${ge.getSegmentInstrumentName(n,r,e)}`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,a.k6)(()=>t[16]||(t[16]=[(0,a.Lk)("div",{class:"segment-content"},[(0,a.Lk)("span",{class:"segment-text"})],-1)])),_:2,__:[16]},1032,["content"])],6))),128))])]),(0,a.bF)(Ce,null,{default:(0,a.k6)(()=>[(0,a.bo)((0,a.Lk)("div",K,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(ge.getGroupedUsagesByUdi(r),(t,r)=>((0,a.uX)(),(0,a.CE)("div",{key:r,class:"usage-group"},[(0,a.Lk)("div",Q,[(0,a.Lk)("div",U,[(0,a.Lk)("div",Y,(0,i.v_)(t.instrumentName),1),(0,a.Lk)("div",J,"UDI: "+(0,i.v_)(r),1),(0,a.Lk)("div",G,"总使用时长: "+(0,i.v_)(ge.getGroupedUsageDuration(t)),1)])]),(0,a.Lk)("div",Z,[(0,a.Lk)("div",j,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t.usages,(t,r)=>((0,a.uX)(),(0,a.CE)("div",{key:r,class:(0,i.C4)(["timeline-segment",`arm-${s+1}`]),style:(0,i.Tr)(ge.getUsageTimelineStyle(t,e))},[(0,a.bF)(Le,{content:`器械：${t.instrumentName}\n时间：${ge.formatTime(t.startTime)} - ${ge.formatTime(t.endTime)}\n时长：${Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60)}分钟`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",H,[(0,a.Lk)("span",ee,(0,i.v_)(ge.getSegmentText(t,e)),1)])]),_:2},1032,["content"])],6))),128))])])]))),128)),(0,a.Lk)("div",te,[(0,a.bF)(_e,{class:"energy-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(Ie)]),_:1}),(0,a.eW)(" 器械总使用时间: "+(0,i.v_)(ge.getEnergyTime(r)),1)])],512),[[n.aG,ge.armDetailsVisible[e.id+"_"+s]]])]),_:2},1024)]))),128))])]),(0,a.Lk)("div",re,[t[17]||(t[17]=(0,a.Lk)("div",{class:"card-header",style:{"margin-top":"12px","margin-bottom":"8px"}},[(0,a.Lk)("span",null,"手术器械")],-1)),(0,a.bF)($e,{data:ge.getInstrumentRows(e),size:"small",style:{width:"100%"}},{default:(0,a.k6)(()=>[(0,a.bF)(Fe,{prop:"instrumentName",label:"器械名称","min-width":"180"}),(0,a.bF)(Fe,{prop:"udi",label:"UDI码","min-width":"220"})]),_:2},1032,["data"])])]),_:2},1024),(0,a.bF)(we,{class:"alarm-card"},{header:(0,a.k6)(()=>t[18]||(t[18]=[(0,a.Lk)("span",null,"安全报警记录",-1)])),default:(0,a.k6)(()=>[(0,a.bF)($e,{data:ge.getAlarmDetails(e).slice(0,ge.showAllAlarms[e.id]?void 0:5),style:{width:"100%"}},{default:(0,a.k6)(()=>[(0,a.bF)(Fe,{prop:"time",label:"时间",width:"180"},{default:(0,a.k6)(({row:e})=>[(0,a.eW)((0,i.v_)(ge.formatTime(e.time)),1)]),_:1}),(0,a.bF)(Fe,{prop:"code",label:"故障码",width:"120"},{default:(0,a.k6)(({row:e})=>[(0,a.eW)((0,i.v_)(e.code||e.error_code||"无"),1)]),_:1}),(0,a.bF)(Fe,{prop:"message",label:"报警信息"}),(0,a.bF)(Fe,{prop:"status",label:"处理状态",width:"120"},{default:(0,a.k6)(({row:e})=>[(0,a.bF)(fe,{type:"已恢复"===e.status?"success":"未处理"===e.status?"danger":"warning"},{default:(0,a.k6)(()=>[(0,a.eW)((0,i.v_)(e.status),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]),ge.getAlarmDetails(e).length>5?((0,a.uX)(),(0,a.CE)("div",ae,[(0,a.bF)(he,{type:"text",onClick:t=>ge.toggleAlarms(e.id),size:"small"},{default:(0,a.k6)(()=>[(0,a.bF)(_e,null,{default:(0,a.k6)(()=>[ge.showAllAlarms[e.id]?((0,a.uX)(),(0,a.Wv)(Me,{key:1})):((0,a.uX)(),(0,a.Wv)(xe,{key:0}))]),_:2},1024),(0,a.eW)(" "+(0,i.v_)(ge.showAllAlarms[e.id]?"收起":`展开更多 (${ge.getAlarmDetails(e).length-5}条)`),1)]),_:2},1032,["onClick"])])):(0,a.Q3)("",!0),(0,a.Lk)("div",ie,[(0,a.bF)(fe,{type:"danger"},{default:(0,a.k6)(()=>[(0,a.eW)("报警总数: "+(0,i.v_)(e.alarm_count||0),1)]),_:2},1024),(0,a.bF)(fe,{type:"info",style:{"margin-left":"8px"}},{default:(0,a.k6)(()=>[(0,a.eW)("未处理: "+(0,i.v_)(ge.getDeduplicatedAlarmStats(e).activeCount),1)]),_:2},1024),t[19]||(t[19]=(0,a.Lk)("div",{style:{"margin-top":"8px","font-size":"12px",color:"#909399"}},[(0,a.Lk)("span",null,"说明：相同故障码在解除恢复前只统计一次")],-1))])]),_:2},1024),e.is_remote_surgery?((0,a.uX)(),(0,a.Wv)(we,{key:0,class:"network-card"},{header:(0,a.k6)(()=>t[20]||(t[20]=[(0,a.Lk)("span",null,"网络延时统计",-1)])),default:(0,a.k6)(()=>[e.network_stats?((0,a.uX)(),(0,a.CE)("div",ne,[(0,a.Lk)("div",se,[(0,a.bF)(fe,{type:"info"},{default:(0,a.k6)(()=>[(0,a.eW)("数据点: "+(0,i.v_)(e.network_stats.count),1)]),_:2},1024),(0,a.bF)(fe,{type:"success",style:{"margin-left":"8px"}},{default:(0,a.k6)(()=>[(0,a.eW)("平均延时: "+(0,i.v_)(e.network_stats.avg)+"ms",1)]),_:2},1024),(0,a.bF)(fe,{type:"warning",style:{"margin-left":"8px"}},{default:(0,a.k6)(()=>[(0,a.eW)("范围: "+(0,i.v_)(e.network_stats.min)+"-"+(0,i.v_)(e.network_stats.max)+"ms",1)]),_:2},1024)]),(0,a.Lk)("div",oe,[(0,a.Lk)("div",{id:`networkChart_${e.id}`,style:{width:"100%",height:"300px"}},null,8,le)])])):((0,a.uX)(),(0,a.CE)("div",me,[(0,a.bF)(Ae,{description:"暂无网络延时数据","image-size":60})]))]),_:2},1024)):(0,a.Q3)("",!0)]),_:2},1032,["label","name","data-surgery-id"]))),128))]),_:1},8,["modelValue","onTabClick","before-leave"])]),_:1})]))])}var ue=r(953),de=r(6278),ce=r(5220),_e=r(163),Te=r(8548),he=r(3611),we=r(6532),ye=r(5495),pe={name:"SurgeryStatistics",components:{DataAnalysis:Te.DataAnalysis,Download:Te.Download,SwitchButton:Te.SwitchButton,Close:Te.Close,VideoPlay:Te.VideoPlay,VideoPause:Te.VideoPause,ArrowUp:Te.ArrowUp,ArrowDown:Te.ArrowDown,ArrowLeft:Te.ArrowLeft,ArrowRight:Te.ArrowRight,Calendar:Te.Calendar,Lightning:Te.Lightning,Loading:Te.Loading,Document:Te.Document,Refresh:Te.Refresh},setup(){(0,de.Pj)(),(0,ce.rd)();const e=(0,ce.lq)(),t=(0,ue.KR)([]),r=(0,ue.KR)(""),i=(0,ue.Kh)({}),n=(0,ue.Kh)({}),s=(0,ue.KR)(!1),o=(0,ue.Kh)({}),l=(0,ue.Kh)({}),m=(0,ue.Kh)({}),g=(0,ue.Kh)({}),u=new Map,d=(0,ue.KR)(5),c=(0,ue.KR)(null),_=()=>({0:0,1:5,2:10,10:20,12:25,13:30,14:35,20:45,21:50,30:60,31:65}),T=(0,a.EW)(()=>{const t=e.query.logIds;if(t)return[];try{const e=sessionStorage.getItem("surgeryAnalysisData");if(e){const t=JSON.parse(e);if(t&&t.entries&&t.entries.length>0){const e=Date.now()-(t.timestamp||0);if(e>36e5)return console.log("手术分析数据已过期，清除缓存"),sessionStorage.removeItem("surgeryAnalysisData"),[];if(t.compressed){const e=t.entries.map(e=>({timestamp:e.t,error_code:e.e,param1:e.p1,param2:e.p2,param3:e.p3,param4:e.p4,explanation:e.exp,log_name:e.ln}));return e}return t.entries}}}catch(r){console.error("解析手术分析数据失败:",r),sessionStorage.removeItem("surgeryAnalysisData")}return[]}),h=(0,a.EW)(()=>T.value.length),w=async()=>{try{const a=e.query.logIds;if(!a)return;const m=a.split(",").map(e=>parseInt(e));if(!m||0===m.length)return;s.value=!0;const g=await ye.A.surgeryStatistics.analyzeByLogIds(m);g.data.success&&g.data.taskId?await y(g.data.taskId):g.data.success&&g.data.data?(t.value=g.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{i[e.id]=!1,n[e.id]=!1,o[e.id]=!1,l[e.id]=""})),_e.nk.success(g.data.message||`成功统计出 ${t.value.length} 场手术`)):_e.nk.error(g.data.message||"统计失败")}catch(a){_e.nk.error("分析批量日志数据失败: "+(a.response?.data?.message||a.message))}finally{s.value=!1}},y=async e=>{const a=60;let s=0;const m=async()=>{try{const g=await ye.A.surgeryStatistics.getAnalysisTaskStatus(e);if(g.data.success){const e=g.data.data;if("completed"===e.status)return t.value=e.result||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{i[e.id]=!1,n[e.id]=!1,o[e.id]=!1,l[e.id]=""})),void _e.nk.success(`成功分析出 ${t.value.length} 场手术`);if("failed"===e.status)return void _e.nk.error(e.error||"分析任务失败");"processing"===e.status&&(s++,s<a?(await new Promise(e=>setTimeout(e,5e3)),await m()):_e.nk.error("分析任务超时，请稍后查看结果"))}else _e.nk.error("查询任务状态失败")}catch(g){_e.nk.error("查询任务状态失败: "+g.message)}};await m()},p=()=>{if(0===T.value.length)return"无数据";const e=T.value.map(e=>new Date(e.timestamp)),t=new Date(Math.min(...e)),r=new Date(Math.max(...e));return`${R(t)} 至 ${R(r)}`},f=()=>0===h.value?"请先加载日志条目数据":`统计日志条目 (${h.value})`,S=async()=>{if(0!==T.value.length){s.value=!0;try{const e=JSON.stringify(T.value).length,a=10485760;let s=T.value;if(e>a){_e.nk.warning(`数据量较大(${(e/1024/1024).toFixed(1)}MB)，将进行数据采样以提高统计速度`);const t=Math.floor(a/(e/T.value.length)),r=Math.floor(T.value.length/t);s=[];for(let e=0;e<T.value.length;e+=r)if(s.push(T.value[e]),s.length>=t)break}const m=await ye.A.surgeryStatistics.analyzeSortedEntries({logEntries:s,includePostgreSQLStructure:!0});m.data.success?(t.value=m.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{i[e.id]=!1,n[e.id]=!1,o[e.id]=!1,l[e.id]=""})),_e.nk.success(`手术数据统计完成，共发现 ${t.value.length} 场手术`)):_e.nk.error(m.data.message||"统计失败")}catch(e){_e.nk.error("统计日志数据失败: "+(e.response?.data?.message||e.message))}finally{s.value=!1}}else _e.nk.warning("暂无日志数据，请先在批量查看或日志查看页面加载日志数据")},v=async e=>{try{const t=await ye.A.surgeryStatistics.exportSingleSurgeryData(e);t.data.success?(_e.nk.success("手术结构化数据导出成功"),console.log("导出的结构化数据:",t.data.data)):_e.nk.error(t.data.message||"导出失败")}catch(t){_e.nk.error("导出手术数据失败: "+(t.response?.data?.message||t.message))}},D=e=>{o[e]=!o[e],o[e]&&!l[e]&&k(e)},k=r=>{const a=t.value.find(e=>e.id===r);if(a)try{let t=a.log_id;if(!t){const r=e.query.logIds;if(r){const e=r.split(",").map(e=>parseInt(e.trim()));t=e[0]}}const i={surgery_id:a.surgery_id,device_ids:t?[t]:[1],start_time:a.surgery_start_time,end_time:a.surgery_end_time,is_remote:a.is_remote_surgery||!1,structured_data:a.postgresql_structure||b(a),last_analyzed_at:(new Date).toISOString(),created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};l[r]=JSON.stringify(i,null,2)}catch(i){console.error("生成PostgreSQL数据失败:",i),l[r]="生成PostgreSQL数据失败: "+i.message}else l[r]="未找到手术数据"},b=e=>{const t=[];if(e.power_on_times&&e.shutdown_times){const r=e.power_on_times,a=e.shutdown_times;for(let e=0;e<Math.max(r.length,a.length);e++)(r[e]||a[e])&&t.push({on_time:r[e]?new Date(r[e]).toISOString():null,off_time:a[e]?new Date(a[e]).toISOString():null})}if(0===t.length)for(let i=1;i<=4;i++){const r=e[`power${i}_on_time`],a=e[`power${i}_off_time`];r&&a&&t.push({on_time:new Date(r).toISOString(),off_time:new Date(a).toISOString()})}const r=[];for(let i=1;i<=4;i++){const t=e[`arm${i}_usage`]||[];r.push({arm_id:i,instrument_usage:t.map(e=>({tool_type:e.instrumentName||e.tool_type||"未知器械",udi:e.udi||"",start_time:e.startTime||e.start_time,end_time:e.endTime||e.end_time,energy_activation:e.energy_activation||[]}))})}const a={has_fault:e.has_error||!1,success:!e.has_error,is_remote:e.is_remote_surgery||!1,network_latency_ms:e.network_stats?e.network_stats.data.map(e=>e.latency):[],faults:e.alarm_details?e.alarm_details.map(t=>({timestamp:t.time,error_code:t.code,param1:"",param2:"",param3:"",param4:"",explanation:t.message,log_id:e.log_id||1})):[],arm_switch_count:0,left_hand_clutch:e.hand_clutch_stats?.arm1||0,right_hand_clutch:e.hand_clutch_stats?.arm2||0,foot_clutch:e.foot_pedal_stats?.clutch||0,endoscope_pedal:e.foot_pedal_stats?.camera||0};return{power_cycles:t,arms:r,surgery_stats:a}},x=async e=>{m[e]=!0;try{const t=l[e];t?(await navigator.clipboard.writeText(t),_e.nk.success("PostgreSQL数据已复制到剪贴板")):_e.nk.warning("没有可复制的数据")}catch(t){console.error("复制失败:",t),_e.nk.error("复制失败: "+t.message)}finally{m[e]=!1}},L=async e=>{g[e]=!0;try{k(e),_e.nk.success("PostgreSQL数据已刷新")}catch(t){console.error("刷新失败:",t),_e.nk.error("刷新失败: "+t.message)}finally{g[e]=!1}},I=(e,t)=>{const r=`${e}_${t}`;i[r]=!i[r]},C=e=>{n[e]=!n[e]},F=e=>{r.value!==e.toString()&&(r.value=e.toString()),(0,a.dY)(()=>{const t=document.querySelector(`[data-surgery-id="${e}"] .alarm-card`);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),t.style.boxShadow="0 0 0 2px #F56C6C, 0 4px 12px rgba(245, 108, 108, 0.3)",t.style.transition="box-shadow 0.3s ease",setTimeout(()=>{t.style.boxShadow=""},3e3))})},$=e=>{r.value!==e.toString()&&(r.value=e.toString()),(0,a.dY)(()=>{const t=document.querySelector(`[data-surgery-id="${e}"] .network-card`);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),t.style.boxShadow="0 0 0 2px #409EFF, 0 4px 12px rgba(64, 158, 255, 0.3)",t.style.transition="box-shadow 0.3s ease",setTimeout(()=>{t.style.boxShadow=""},3e3))})},M=e=>[e.arm1_usage||[],e.arm2_usage||[],e.arm3_usage||[],e.arm4_usage||[]],A=e=>{if(!e)return[];const t=new Map,r=M(e);r.forEach(e=>{(e||[]).forEach(e=>{if(!e)return;if(!e.startTime||!e.endTime)return;const r=e.udi||"未知",a=`${r}__${e.instrumentName||"未知器械"}`;t.has(a)||t.set(a,{instrumentName:e.instrumentName||"未知器械",udi:r,segments:[]}),t.get(a).segments.push({startTime:e.startTime,endTime:e.endTime})})});const a=Array.from(t.values()).map(e=>{e.segments.sort((e,t)=>new Date(e.startTime)-new Date(t.startTime));const t=[];for(const i of e.segments){if(0===t.length){t.push({...i});continue}const e=t[t.length-1],r=new Date(e.endTime).getTime(),a=new Date(i.startTime).getTime(),n=new Date(i.endTime).getTime();a<=r?n>r&&(e.endTime=i.endTime):t.push({...i})}const r=t.length?t[0].startTime:null,a=t.length?t[t.length-1].endTime:null;return{...e,segments:t,startTime:r,endTime:a}});return a.sort((e,t)=>new Date(e.startTime)-new Date(t.startTime)),a},O=e=>{if(!e||0===e.length)return"0分钟";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},E=e=>{switch(e){case"错误":return"danger";case"警告":return"warning";case"网络":return"info";default:return"info"}},N=e=>{if(!e||!e.alarm_details)return[];let t=[];if("string"===typeof e.alarm_details)try{t=JSON.parse(e.alarm_details)}catch(r){return console.error("解析alarm_details字符串失败:",r),[]}else t=e.alarm_details||[];return t},P=e=>{const t=N(e);if(!t||0===t.length)return{uniqueCount:0,totalCount:0,activeCount:0};const r=new Set(t.map(e=>e.code)),a=r.size,i=t.length,n=t.filter(e=>"未处理"===e.status&&!0===e.isActive).length;return{uniqueCount:a,totalCount:i,activeCount:n}},z=e=>{if(!e)return"-";const t=new Date(e),r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${r}-${a}-${i} ${n}:${s}:${o}`},W=e=>{if(!e.surgery_start_time||!e.surgery_end_time)return"手术时间未确定";const t=new Date(e.surgery_start_time).toLocaleString(),r=new Date(e.surgery_end_time).toLocaleString();return`${t} ~ ${r}`},R=e=>{if(!e)return"-";const t=new Date(e),r=String(t.getHours()).padStart(2,"0"),a=String(t.getMinutes()).padStart(2,"0");return`${r}:${a}`},X=e=>{if(!e)return{start:null,end:null};const t=e.surgery_start_time,r=e.surgery_end_time;if(t&&r){const a=new Date(t).getTime(),i=new Date(r).getTime();if(a>=i)return console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{surgery_id:e.surgery_id,start:t,end:r,startTime:a,endTime:i}),{start:null,end:null}}return console.log("时间轴范围 (重新设计):",e.surgery_id,{start:t,end:r,duration:t&&r?(new Date(r).getTime()-new Date(t).getTime())/6e4:"N/A"}),{start:t,end:r}},V=e=>{try{const t=re(e);if(!t||0===t.length)return B(e);const r=t[0].time,a=t[t.length-1].time;return{start:r,end:a}}catch(t){return B(e)}},B=e=>{if(!e)return{start:null,end:null};const t=j(e),r=H(e),a=r||e.surgery_end_time;let i=t;!i&&e.surgery_start_time&&(i=e.surgery_start_time);let n=a;if(!n&&e.surgery_end_time&&(n=e.surgery_end_time),i&&n){const t=new Date(i).getTime(),r=new Date(n).getTime();if(t>=r)return console.warn("进度条时间轴范围异常：开始时间晚于或等于结束时间",{surgery_id:e.surgery_id,start:i,end:n,startTime:t,endTime:r}),{start:null,end:null}}return console.log("进度条时间轴范围:",e.surgery_id,{start:i,end:n,powerOnTime:t,powerOffTime:r,surgeryEndTime:e.surgery_end_time,duration:i&&n?(new Date(n).getTime()-new Date(i).getTime())/6e4:"N/A"}),{start:i,end:n}},q=(e,t,r)=>{if(!e||!t||!r)return 0;try{const a=new Date(t).getTime(),i=new Date(r).getTime(),n=new Date(e).getTime();if(isNaN(a)||isNaN(i)||isNaN(n))return console.warn("时间计算异常：无效的时间值",{time:e,startTime:t,endTime:r}),0;if(a>=i)return console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{startTime:t,endTime:r}),0;const s=(n-a)/(i-a)*100;return Math.max(0,Math.min(100,s))}catch(a){return console.error("时间位置计算失败:",a,{time:e,startTime:t,endTime:r}),0}},K=(e,t)=>{if(!e||!t)return[];const r=new Date(e),a=new Date(t),i=a.getTime()-r.getTime();let n;n=i<=18e5?3e5:i<=72e5?9e5:18e5;const s=[];let o=r.getTime()+n;while(o<a.getTime()){const r=q(o,e,t);s.push({time:new Date(o),position:r}),o+=n}return s},Q=e=>{if(!e||0===e.length)return[];const t=e.map(e=>({startTime:new Date(e.startTime).getTime(),endTime:new Date(e.endTime).getTime()}));t.sort((e,t)=>e.startTime-t.startTime);const r=[];let a=t[0];for(let i=1;i<t.length;i++){const e=t[i];a.endTime>=e.startTime?a.endTime=Math.max(a.endTime,e.endTime):(r.push(a),a=e)}return a&&r.push(a),r},U=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return{left:"0%",width:"0%"};const a=Q(r);if(0===a.length)return{left:"0%",width:"0%"};let i=0;const n=[],s=V(t);return s.start&&s.end?(a.forEach(e=>{const t=q(e.startTime,s.start,s.end),r=q(e.endTime,s.start,s.end),a=Math.max(0,r-t);n.push({left:`${t}%`,width:`${a}%`}),i+=a}),n.length>0?n[0]:{left:"0%",width:"0%"}):{left:"0%",width:"0%"}},Y=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return[];const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return[];const a=Q(r);if(0===a.length)return[];const i=[],n=V(t);return n.start&&n.end?(a.forEach((e,t)=>{const r=q(e.startTime,n.start,n.end),a=q(e.endTime,n.start,n.end),s=Math.max(0,a-r);s>0&&i.push({left:`${r}%`,width:`${s}%`})}),i):[]},J=e=>{if(!e||!e.surgery_start_time||!e.surgery_end_time)return{left:"0%",width:"0%"};const t=V(e);if(!t.start||!t.end)return{left:"0%",width:"0%"};const r=q(e.surgery_start_time,t.start,t.end),a=q(e.surgery_end_time,t.start,t.end),i=Math.max(0,a-r);return console.log("手术进度条计算:",e.surgery_id,{surgeryStartTime:e.surgery_start_time,surgeryEndTime:e.surgery_end_time,timelineStart:t.start,timelineEnd:t.end,startPosition:r.toFixed(2)+"%",endPosition:a.toFixed(2)+"%",width:i.toFixed(2)+"%"}),{left:`${r}%`,width:`${i}%`}},G=(e,t)=>{if(!e||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};if(!e.startTime||!e.endTime)return{left:"0%",width:"0%"};const r=V(t);if(!r.start||!r.end)return{left:"0%",width:"0%"};const a=new Date(e.startTime).getTime(),i=new Date(e.endTime).getTime(),n=q(a,r.start,r.end),s=q(i,r.start,r.end),o=Math.max(0,s-n),l=Math.max(0,Math.min(100-o,n));return{left:`${l}%`,width:`${o}%`}},Z=e=>{if(!e||0===e.length)return"0分0秒";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3);return e+r},0),r=Math.floor(t/60),a=t%60;return`${r}分${a}秒`},j=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times[0]:e.power_on_time?e.power_on_time:e.surgery_start_time:null,H=e=>e?e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times[e.shutdown_times.length-1]:e.power_off_time?e.power_off_time:null:null,ee=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times:e.power_on_time?[e.power_on_time]:[]:[],te=e=>e?e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times:e.power_off_time?[e.power_off_time]:[]:[],re=e=>{if(!e)return[];const t=[],r=ee(e);e.is_consecutive_surgery&&console.log("连台手术调试信息:",{surgery_id:e.surgery_id,is_consecutive_surgery:e.is_consecutive_surgery,previous_surgery_end_time:e.previous_surgery_end_time,power_on_times:e.power_on_times,powerOnTimes:r}),r.forEach((a,i)=>{let n="开机",s=a;e.is_consecutive_surgery&&0===i&&e.previous_surgery_end_time?(n="上一场手术结束时间",s=e.previous_surgery_end_time):r.length>1&&(n=`开机 ${i+1}`),t.push({time:new Date(s),type:"powerOn",label:n,color:"green",icon:"PowerOff"})}),e.surgery_start_time&&t.push({time:new Date(e.surgery_start_time),type:"surgeryStart",label:"手术开始",color:"blue",icon:"VideoPlay"}),e.surgery_end_time&&t.push({time:new Date(e.surgery_end_time),type:"surgeryEnd",label:"手术结束",color:"orange",icon:"VideoPause"});const a=te(e);return a.forEach((e,r)=>{t.push({time:new Date(e),type:"powerOff",label:a.length>1?`关机 ${r+1}`:"关机",color:"red",icon:"PowerOff"})}),t.sort((e,t)=>e.time.getTime()-t.time.getTime())},ae=e=>{if(!e)return[];let t=[];if(e.state_machine_changes)if("string"===typeof e.state_machine_changes)try{t=JSON.parse(e.state_machine_changes)}catch(a){console.error("解析state_machine_changes字符串失败:",a),t=[]}else t=e.state_machine_changes||[];if(console.log("手术状态机变化数据:",e.surgery_id,t),0===t.length)return console.log("没有状态机变化数据"),[];const r=[];for(let i=0;i<t.length;i++){const a=t[i],n=t[i+1],s=parseInt(a.state),o=new Date(a.time),l=n?new Date(n.time):e.surgery_end_time?new Date(e.surgery_end_time):new Date,m=l.getTime()-o.getTime();console.log(`状态变化 ${i}: currentState=${s}, startTime=${o}, endTime=${l}, duration=${m}ms`);let g="none";if(s<=0)g="none";else if(s>0&&s<30)g="surgery";else if(30===s){const e=n?parseInt(n.state):null;g=null===e||e<10?"error":"surgery"}else g="none";console.log(`状态分类: currentState=${s}, nextState=${n?n.state:"null"} -> stateCategory=${g}`),"none"!==g&&r.push({state:g,startTime:o,endTime:l,duration:m,originalState:s,stateName:a.stateName||`状态${s}`})}return console.log("生成的柱状图数据:",r),r},ie=e=>{const t={surgery:"正常阶段",error:"故障阶段",idle:"空闲",active:"激活",standby:"待机",offline:"离线"};return t[e]||e},ne=e=>{const t={surgery:60,error:100},r=t[e]||60;return console.log(`柱状图高度: state=${e}, height=${r}px`),r},se=(e,t)=>{if(!e||!t)return 0;const r=B(t);if(!r.start||!r.end)return 0;const a=q(e,r.start,r.end);console.log(`柱状图位置计算: startTime=${e}, timelineStart=${r.start}, timelineEnd=${r.end}, position=${a}%`);const i=Math.max(0,Math.min(95,a));return i},oe=e=>{const t={};return e.forEach((e,r)=>{const a=e.udi||`${e.instrumentName}_${r}`;t[a]||(t[a]={instrumentName:e.instrumentName,usages:[]}),t[a].usages.push(e)}),t},le=e=>{if(!e||0===e.usages.length)return"0分钟";const t=e.usages.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},me=(e,t)=>{try{const r=G(e,t),a=r.width,i=parseFloat(a),n=e.instrumentName||"器械",s=1.5,o=2,l=Math.min(n.length*s+o,20);if(i>=l){if(i>=n.length*s+o)return n;{const e=Math.floor((i-o)/s);return n.substring(0,e)+"..."}}return""}catch(r){return console.error("计算进度条文本失败:",r),""}},ge=(e,t,r)=>{if(!e||!t||!r)return"未知器械";const a=B(r);if(!a.start||!a.end)return"未知器械";const i=parseFloat(e.left),n=i+parseFloat(e.width),s=new Date(a.start).getTime()+i/100*(new Date(a.end).getTime()-new Date(a.start).getTime()),o=new Date(a.start).getTime()+n/100*(new Date(a.end).getTime()-new Date(a.start).getTime()),l=t.filter(e=>{if(!e.startTime||!e.endTime)return!1;const t=new Date(e.startTime).getTime(),r=new Date(e.endTime).getTime();return t<o&&r>s});return 0===l.length?"无器械使用":l[0].instrumentName||"未知器械"},Te=(0,he.sg)(e=>{(0,he.wx)(()=>{r.value=e.name})},50),pe=(e,t)=>(0,he.wx)().then(()=>!0),fe=()=>{u.forEach((e,t)=>{console.log("销毁图表实例:",t);try{e.dispose&&e.dispose()}catch(r){console.warn("图表实例释放失败",t,r)}}),u.clear(),Object.keys(Ie).forEach(e=>{delete Ie[e]}),Le.clear(),c.value=null},Se=e=>{if(!e)return null;let t=[];if(e.state_machine_changes)if("string"===typeof e.state_machine_changes)try{t=JSON.parse(e.state_machine_changes)}catch(u){return console.error("解析state_machine_changes失败",u),null}else t=e.state_machine_changes||[];const r=re(e);let a=null,i=null;if(r.length>0&&(a=new Date(r[0].time).getTime(),i=new Date(r[r.length-1].time).getTime()),0===t.length)return a&&i?{points:[],rawData:[],xMin:a,xMax:i}:null;t.sort((e,t)=>new Date(e.time).getTime()-new Date(t.time).getTime()),a&&i||(a=new Date(t[0].time).getTime(),i=new Date(t[t.length-1].time).getTime());const n=_(),s=[];let o=null;for(const d of t){const e=new Date(d.time).getTime();e<=a&&(o=d),e>a&&e<=i&&s.push(d)}const l=[];let m=o?o.state:t.length>0?t[0].state:"0";l.push([a,n[parseInt(m)]??parseInt(m),m]);for(const d of s){const e=new Date(d.time).getTime(),t=n[parseInt(d.state)]??parseInt(d.state);l.push([e,t,d.state])}const g=s.length>0?s[s.length-1].state:m;return l.push([i,n[parseInt(g)]??parseInt(g),g]),{points:l,rawData:s,xMin:a,xMax:i}},ve=e=>{const t=e.surgery_start_time?new Date(e.surgery_start_time):null;if(!t)return{};let r=Ie[e.id];r||(r={currentTime:t,viewRange:d.value},Ie[e.id]=r);const a=new Date(r.currentTime.getTime()-30*r.viewRange*1e3),i=new Date(r.currentTime.getTime()+30*r.viewRange*1e3);return{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){const t=e[0].dataIndex,r=e[0].chart.data.rawData;if(r&&r[t]){const e=new Date(r[t].time),n=a.getDate()!==i.getDate()||a.getMonth()!==i.getMonth()||a.getFullYear()!==i.getFullYear();return n?e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN"):e.toLocaleTimeString("zh-CN")}return e[0].label},label:function(e){const t=e.dataIndex,r=e.chart.data.rawData;if(r&&r[t]){const e=parseInt(r[t].state),a=ke(e.toString());return`状态: ${e} (${a})`}return`状态: ${e.parsed.y}`}}}},scales:{x:{title:{display:!0,text:"时间"},ticks:{maxTicksLimit:10,callback:function(e,t,r){const n=this.chart.data.rawData;if(n&&n[t]){const e=new Date(n[t].time),r=a.getDate()!==i.getDate()||a.getMonth()!==i.getMonth()||a.getFullYear()!==i.getFullYear();return r?e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}return e}}},y:{beginAtZero:!0,min:0,max:30,title:{display:!0,text:"状态机状态"},ticks:{stepSize:1,maxTicksLimit:15}}},animation:{duration:300}}},De=e=>{if(!e)return;const t=document.getElementById(`stateMachineChart_${e.id}`);if(!t)return void setTimeout(()=>De(e),50);const r=Se(e),a=u.get(e.id);if(a){try{a.dispose&&a.dispose()}catch(m){}u.delete(e.id)}if(!r)return void(t.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#909399;">暂无状态机数据</div>');const i=we.Ts(t);u.set(e.id,i);const n=_(),s={};Object.keys(n).forEach(e=>{s[n[e]]=e});const o=3e5,l=Math.min(r.xMin+o,r.xMax);i.setOption({grid:{left:60,right:20,top:70,bottom:80,containLabel:!0},toolbox:{right:10,top:10,feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:e=>{if(!e||!e[0])return"";const t=e[0],r=new Date(t.value[0]),a=t.value[1],i=t.value[2]??s[a]??a,n=ke(String(i));return`${r.toLocaleString("zh-CN")}<br/>状态: ${i}（${n}）`}},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none",zoomOnMouseWheel:!0,moveOnMouseWheel:!0,moveOnMouseMove:!0,startValue:r.xMin,endValue:l},{type:"slider",xAxisIndex:0,filterMode:"none",height:40,bottom:20,showDataShadow:!0,brushSelect:!0,startValue:r.xMin,endValue:l}],xAxis:{type:"time",min:r.xMin,max:r.xMax,axisLabel:{formatter:e=>new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}},yAxis:{type:"value",min:0,max:65,axisLabel:{formatter:e=>{const t=s[e];return t?String(t):""}},axisTick:{show:!1},splitNumber:8},series:[{type:"line",step:"end",showSymbol:!1,lineStyle:{width:2,color:"#409EFF"},areaStyle:{color:new we.fA.W4(0,0,0,1,[{offset:0,color:"rgba(64,158,255,0.25)"},{offset:1,color:"rgba(64,158,255,0.05)"}])},data:r.points}]})},ke=e=>{const t={0:"初始化（S00）",1:"使能（S01）",2:"自检（S02）",10:"待机（S10）",12:"从手调整（S12）",13:"主手跟随（S13）",14:"断开主从/离合（S14）",15:"初始化（S00）",20:"主从控制（S20）",21:"内窥镜控制（S21）",30:"错误（S30）",31:"关机（S31）"};return t[e]||`状态${e}`},be=new Map,xe=e=>{if(!e||!e.is_remote_surgery||!e.network_stats)return;const t=document.getElementById(`networkChart_${e.id}`);if(!t)return void setTimeout(()=>xe(e),50);const r=be.get(e.id);if(r){try{r.dispose&&r.dispose()}catch(o){}be.delete(e.id)}const a=we.Ts(t);be.set(e.id,a);const i=new Date(e.surgery_start_time).getTime(),n=new Date(e.surgery_end_time).getTime(),s=e.network_stats.data.filter(e=>{const t=new Date(e.timestamp).getTime();return t>=i&&t<=n}).map(e=>[new Date(e.timestamp).getTime(),e.latency]);s.sort((e,t)=>e[0]-t[0]),a.setOption({grid:{left:60,right:20,top:70,bottom:80,containLabel:!0},toolbox:{right:10,top:10,feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:e=>{if(!e||!e[0])return"";const t=e[0],r=new Date(t.value[0]),a=t.value[1];return`${r.toLocaleString("zh-CN")}<br/>网络延时: ${a}ms`}},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none",zoomOnMouseWheel:!0,moveOnMouseWheel:!0,moveOnMouseMove:!0},{type:"slider",xAxisIndex:0,filterMode:"none",height:40,bottom:20,showDataShadow:!0,brushSelect:!0}],xAxis:{type:"time",min:i,max:n,axisLabel:{formatter:e=>new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}},yAxis:{type:"value",name:"延时 (ms)",axisLabel:{formatter:"{value}ms"},scale:!0},series:[{type:"line",name:"网络延时",showSymbol:!1,lineStyle:{width:2,color:"#409EFF"},itemStyle:{color:"#409EFF"},areaStyle:{color:new we.fA.W4(0,0,0,1,[{offset:0,color:"rgba(64,158,255,0.25)"},{offset:1,color:"rgba(64,158,255,0.05)"}])},data:s}]})},Le=new Map,Ie=(0,ue.Kh)({}),Ce=(0,ue.KR)(0),Fe=(e,t)=>{if(!e||!e.state_machine_changes)return{};const r=new Date(e.surgery_start_time),a=new Date(e.surgery_end_time),i=a.getTime()-r.getTime();if(i<=0)return{};const n=Se(e);let s,o;if(n&&n.startTime&&n.endTime)s=new Date(n.startTime),o=new Date(n.endTime);else{let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const n=60*d.value*1e3;let l=t.currentTime;const m=new Date(r.getTime()+n/2),g=new Date(a.getTime()-n/2);if(i<=n){const e=new Date(Math.max(r.getTime(),Math.min(a.getTime(),l.getTime())));l=e}else l.getTime()<m.getTime()?l=m:l.getTime()>g.getTime()&&(l=g);s=new Date(l.getTime()-n/2),o=new Date(l.getTime()+n/2),s.getTime()<r.getTime()&&(s=r,o=new Date(r.getTime()+n)),o.getTime()>a.getTime()&&(o=a,s=new Date(a.getTime()-n),s.getTime()<r.getTime()&&(s=r,o=new Date(r.getTime()+n)))}const l=o.getTime()-s.getTime(),m=(s.getTime()-r.getTime())/i*100,g=l/i*100,u=Math.max(0,Math.min(100-g,m)),c=Math.max(5,Math.min(100,g));return console.log("滚动条计算 (重新设计):",{surgeryId:e.surgery_id,totalStartTime:r.toISOString(),totalEndTime:a.toISOString(),totalDuration:i/6e4,viewStartTime:s.toISOString(),viewEndTime:o.toISOString(),viewDuration:l/6e4,thumbPosition:m.toFixed(2),thumbWidth:g.toFixed(2),clampedPosition:u.toFixed(2),clampedWidth:c.toFixed(2),isAtEnd:o.getTime()===a.getTime(),isAtStart:s.getTime()===r.getTime()}),{left:`${u}%`,width:`${c}%`}},$e=(e,t)=>{if(!t)return;const r=e.currentTarget,a=r.getBoundingClientRect(),i=e.clientX-a.left,n=a.width,s=i/n,o=new Date(t.surgery_start_time),l=new Date(t.surgery_end_time),m=l.getTime()-o.getTime(),g=new Date(o.getTime()+s*m),u=60*d.value*1e3,c=new Date(o.getTime()+u/2),_=new Date(l.getTime()-u/2);let T=Ie[t.id];if(T||(T={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:d.value},Ie[t.id]=T),m<=u){const e=new Date(Math.max(o.getTime(),Math.min(l.getTime(),g.getTime())));T.currentTime=e}else g.getTime()<c.getTime()?T.currentTime=c:g.getTime()>_.getTime()?T.currentTime=_:T.currentTime=g;console.log("滚动条点击 (重新设计):",{surgeryId:t.surgery_id,clickPercentage:s.toFixed(2),targetTime:g.toISOString(),newCurrentTime:T.currentTime.toISOString(),totalStartTime:o.toISOString(),totalEndTime:l.toISOString(),totalDuration:m/6e4}),Ce.value++,De(t)},Me=(e,t)=>{if(!t)return;e.preventDefault(),e.stopPropagation();let r=Le.get(t.id);r||(r={isDragging:!1,dragStartX:0,dragStartTime:null},Le.set(t.id,r)),r.isDragging=!0,r.dragStartX=e.clientX;let a=Ie[t.id];a||(a={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:d.value},Ie[t.id]=a),r.dragStartTime=a.currentTime?new Date(a.currentTime):null,document.addEventListener("mousemove",e=>Ae(e,t)),document.addEventListener("mouseup",()=>Oe(t))},Ae=(e,t)=>{let r=Le.get(t.id);if(!r||!r.isDragging||!r.dragStartTime)return;const a=e.clientX-r.dragStartX,i=document.querySelector(`[data-surgery-id="${t.id}"] .chart-scrollbar-container`),n=i?.querySelector(".scrollbar-track");if(!n)return void console.warn("找不到滚动条轨道:",t.id);const s=n.offsetWidth,o=new Date(t.surgery_start_time),l=new Date(t.surgery_end_time),m=l.getTime()-o.getTime(),g=a/s*m,u=new Date(r.dragStartTime.getTime()+g),c=60*d.value*1e3,_=new Date(o.getTime()+c/2),T=new Date(l.getTime()-c/2);let h=Ie[t.id];if(h||(h={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:d.value},Ie[t.id]=h),m<=c){const e=new Date(Math.max(o.getTime(),Math.min(l.getTime(),u.getTime())));h.currentTime=e}else u.getTime()<_.getTime()?h.currentTime=_:u.getTime()>T.getTime()?h.currentTime=T:h.currentTime=u;console.log("滚动条拖拽 (重新设计):",{surgeryId:t.surgery_id,deltaX:a.toFixed(2),dragTimeChange:g/6e4,newCenterTime:u.toISOString(),newCurrentTime:h.currentTime.toISOString(),totalStartTime:o.toISOString(),totalEndTime:l.toISOString(),totalDuration:m/6e4}),Ce.value++,De(t)},Oe=e=>{if(!e)return;let t=Le.get(e.id);t&&(t.isDragging=!1,t.dragStartX=0,t.dragStartTime=null),document.removeEventListener("mousemove",t=>Ae(t,e)),document.removeEventListener("mouseup",()=>Oe(e))},Ee=e=>{if(!e)return;let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const r=6e4,a=new Date(t.currentTime.getTime()-r),i=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),s=n.getTime()-i.getTime(),o=60*d.value*1e3;if(s<=o){const e=new Date(Math.max(i.getTime(),Math.min(n.getTime(),a.getTime())));t.currentTime=e}else{const e=new Date(i.getTime()+o/2);a.getTime()>=e.getTime()?t.currentTime=a:t.currentTime=e}console.log("向左滚动 (重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:a.toISOString(),totalStartTime:i.toISOString(),totalEndTime:n.toISOString(),totalDuration:s/6e4}),Ce.value++,De(e)},Ne=e=>{if(!e)return;let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const r=6e4,a=new Date(t.currentTime.getTime()+r),i=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),s=n.getTime()-i.getTime(),o=60*d.value*1e3;if(s<=o){const r=new Date(Math.max(i.getTime(),Math.min(n.getTime(),a.getTime())));t.currentTime=r,console.log("向右滚动 (短手术 - 重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:a.toISOString(),clampedTime:r.toISOString(),totalStartTime:i.toISOString(),totalEndTime:n.toISOString(),totalDuration:s/6e4})}else{const r=new Date(n.getTime()-o/2);a.getTime()<=r.getTime()?t.currentTime=a:t.currentTime=r,console.log("向右滚动 (长手术 - 重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:a.toISOString(),maxTime:r.toISOString(),totalStartTime:i.toISOString(),totalEndTime:n.toISOString(),totalDuration:s/6e4})}Ce.value++,De(e)},Pe=e=>{if(!e)return!1;let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const r=new Date(e.surgery_start_time),a=new Date(e.surgery_end_time),i=a.getTime()-r.getTime(),n=60*d.value*1e3;if(i<=n)return!1;const s=new Date(r.getTime()+n/2);return t.currentTime.getTime()>s.getTime()},ze=e=>{if(!e)return!1;let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const r=new Date(e.surgery_start_time),a=new Date(e.surgery_end_time),i=a.getTime()-r.getTime(),n=60*d.value*1e3;if(i<=n)return!1;const s=new Date(a.getTime()-n/2);return console.log("向右滚动检查 (重新设计):",{surgeryId:e.surgery_id,currentTime:t.currentTime.toISOString(),maxCenterTime:s.toISOString(),totalStartTime:r.toISOString(),totalEndTime:a.toISOString(),totalDuration:i/6e4,viewWindowDuration:(n/6e4).toFixed(1)+"分钟",canScroll:t.currentTime.getTime()<s.getTime()}),t.currentTime.getTime()<s.getTime()},We=e=>{if(!e)return;const t=Se(e),r=Fe(e,Ce.value),a=Re(e,Ce.value),i=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),s=n.getTime()-i.getTime(),o=60*d.value*1e3,l=new Date(i.getTime()+o/2),m=new Date(n.getTime()-o/2);console.log("同步状态检查 (重新设计):",{surgeryId:e.surgery_id,totalStartTime:i.toISOString(),totalEndTime:n.toISOString(),totalDuration:(s/6e4).toFixed(1)+"分钟",viewWindowDuration:(o/6e4).toFixed(1)+"分钟",isShortSurgery:s<=o,minCenterTime:l.toISOString(),maxCenterTime:m.toISOString(),chartDataExists:!!t,chartLabels:t?.labels?.length||0,chartDataPoints:t?.data?.length||0,chartStartTime:t?.startTime?.toISOString()||"N/A",chartEndTime:t?.endTime?.toISOString()||"N/A",scrollbarLeft:r.left,scrollbarWidth:r.width,scrollbarInfo:a,canScrollLeft:Pe(e),canScrollRight:ze(e),surgeryStartTime:e.surgery_start_time,surgeryEndTime:e.surgery_end_time,timelineRange:X(e),powerOnTime:j(e),powerOffTime:H(e)})},Re=(e,t)=>{if(!e)return"";const r=Se(e);if(!r||!r.startTime||!r.endTime){let t=Ie[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:d.value},Ie[e.id]=t);const r=new Date(e.surgery_start_time),a=new Date(e.surgery_end_time),i=a.getTime()-r.getTime(),n=60*d.value*1e3;let s=t.currentTime;const o=new Date(r.getTime()+n/2),l=new Date(a.getTime()-n/2);if(i<=n){const e=new Date(Math.max(r.getTime(),Math.min(a.getTime(),s.getTime())));s=e}else s.getTime()<o.getTime()?s=o:s.getTime()>l.getTime()&&(s=l);const m=new Date(s.getTime()-n/2),g=new Date(s.getTime()+n/2);let u=m,c=g;u.getTime()<r.getTime()&&(u=r,c=new Date(r.getTime()+n)),c.getTime()>a.getTime()&&(c=a,u=new Date(a.getTime()-n),u.getTime()<r.getTime()&&(u=r,c=new Date(r.getTime()+n)));const _=u.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),T=c.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),h=(c.getTime()-u.getTime())/6e4;return`${_} - ${T} (${h.toFixed(1)}分钟)`}const a=new Date(r.startTime),i=new Date(r.endTime),n=a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),s=i.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),o=(i.getTime()-a.getTime())/6e4;return console.log("滚动条时间范围 (重新设计):",e.surgery_id,{startTime:a.toISOString(),endTime:i.toISOString(),duration:o.toFixed(1)+"分钟",totalStartTime:new Date(e.surgery_start_time).toISOString(),totalEndTime:new Date(e.surgery_end_time).toISOString()}),`${n} - ${s} (${o.toFixed(1)}分钟)`};return(0,a.wB)(t,e=>{if(e.length>0&&r.value){const t=e.find(e=>e.id.toString()===r.value);t&&(0,a.dY)(()=>{const e=`stateMachineChart_${t.id}`,r=document.getElementById(e);r?De(t):(console.warn("Canvas元素不存在，等待DOM渲染:",e),setTimeout(()=>{De(t)},100)),t.is_remote_surgery&&t.network_stats&&xe(t)})}},{deep:!0}),(0,a.wB)(r,e=>{if(e&&t.value.length>0){const r=t.value.find(t=>t.id.toString()===e);r&&(0,a.dY)(()=>{const e=`stateMachineChart_${r.id}`,t=document.getElementById(e);t?(console.log("切换到手术标签页:",r.surgery_id),"4371-17"===r.surgery_id&&(console.log("=== 第四场手术调试信息 ==="),console.log("手术开始时间:",r.surgery_start_time),console.log("手术结束时间:",r.surgery_end_time),console.log("时间轴范围:",X(r)),console.log("开机时间:",j(r)),console.log("关机时间:",H(r)),console.log("状态机变化数据:",r.state_machine_changes),console.log("========================")),De(r)):(console.warn("Canvas元素不存在，等待DOM渲染:",e),setTimeout(()=>{De(r)},100)),r.is_remote_surgery&&r.network_stats&&xe(r)})}}),(0,a.sV)(async()=>{const t=e.query.logIds;if(t)await w();else if(T.value.length>0){const e=sessionStorage.getItem("autoAnalyze");"true"===e&&(sessionStorage.removeItem("autoAnalyze"),await S())}}),{surgeries:t,activeTab:r,armDetailsVisible:i,showAllAlarms:n,analyzing:s,logEntriesCount:h,analyzeLogs:S,exportSurgeryData:v,toggleArmDetails:I,toggleAlarms:C,scrollToAlarmCard:F,scrollToNetworkCard:$,getArmUsages:M,getInstrumentRows:A,getArmTotalTime:O,getArmTimelineStyle:U,getArmTimelineSegments:Y,getSurgeryTimelineStyle:J,getUsageTimelineStyle:G,getEnergyTime:Z,getAlarmTypeTag:E,getAlarmDetails:N,getDeduplicatedAlarmStats:P,formatTime:z,formatSurgeryTime:W,formatTimeShort:R,getTimePosition:q,getTimelineTicks:K,handleTabClick:Te,getAnalysisButtonText:f,getTimeRange:p,loadBatchLogEntriesByIds:w,pollTaskResult:y,getPowerOnTime:j,getPowerOffTime:H,getAllPowerOnTimes:ee,getAllPowerOffTimes:te,getSurgeryTimelineStyle:J,getGroupedUsagesByUdi:oe,getGroupedUsageDuration:le,getSegmentText:me,getTimelineRange:X,getProgressTimelineRange:B,getSegmentInstrumentName:ge,getSortedTimelineEvents:re,getStateChanges:ae,getStateName:ie,getStateBarHeight:ne,getStateBarPosition:se,handleBeforeTabLeave:pe,resetChartView:fe,updateStateMachineChart:De,getStateMachineChartData:Se,getStateMachineChartOptions:ve,updateNetworkChart:xe,getScrollbarThumbStyle:Fe,handleTrackClick:$e,startScrollbarDrag:Me,scrollChartLeft:Ee,scrollChartRight:Ne,canScrollLeft:Pe,canScrollRight:ze,getScrollbarInfo:Re,checkSynchronization:We,postgresqlPreviewVisible:o,postgresqlDataText:l,copyingData:m,refreshingData:g,togglePostgreSQLPreview:D,copyPostgreSQLData:x,refreshPostgreSQLData:L}}},fe=r(6262);const Se=(0,fe.A)(pe,[["render",ge],["__scopeId","data-v-eff525c6"]]);var ve=Se}}]);
//# sourceMappingURL=613.3c41c5b1.js.map