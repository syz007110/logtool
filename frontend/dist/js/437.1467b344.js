"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[437],{7437:function(e,t,r){r.r(t),r.d(t,{default:function(){return de}});var n=r(641),a=r(33),i=r(3751);const s={class:"surgery-statistics-container"},o={key:0,class:"analysis-section"},l={class:"empty-content"},m={key:0},g={key:1},u={key:1,class:"analysis-section"},c={class:"empty-content"},d={key:2},T={class:"export-section"},h={class:"surgery-info-layout"},_={class:"timeline-section"},w={class:"info-header"},y={class:"badges"},f={class:"state-chart-section"},p={class:"state-chart-container"},S=["id"],v={class:"card-header"},D={class:"unified-timeline-view"},k={class:"surgery-progress-container"},b={class:"surgery-duration-info"},x={class:"duration-text"},L={class:"time-range"},I={class:"surgery-timeline-wrapper"},C={class:"surgery-timeline-container"},$={class:"surgery-timeline-bar"},M={class:"progress-labels"},F={class:"time-label"},E={class:"time-label"},A={class:"arm-timeline"},O={class:"arm-header"},N={class:"arm-actions"},R={class:"arm-timeline-container"},z={class:"arm-label"},P={class:"arm-name"},X={class:"arm-timeline-bar"},W={class:"arm-details"},B={class:"usage-group-header"},V={class:"usage-group-info"},U={class:"usage-group-name"},K={class:"usage-group-udi"},Y={class:"usage-group-duration"},q={class:"arm-timeline-container"},G={class:"arm-timeline-bar"},J={class:"segment-content"},j={class:"segment-text"},H={class:"energy-time"},Q={class:"instruments-inside"},Z={key:0,class:"alarm-toggle"},ee={class:"alarm-summary"};function te(e,t,r,te,re,ne){const ae=(0,n.g2)("Calendar"),ie=(0,n.g2)("el-icon"),se=(0,n.g2)("DataAnalysis"),oe=(0,n.g2)("el-button"),le=(0,n.g2)("el-card"),me=(0,n.g2)("Loading"),ge=(0,n.g2)("Download"),ue=(0,n.g2)("el-tag"),ce=(0,n.g2)("a-step"),de=(0,n.g2)("a-steps"),Te=(0,n.g2)("ArrowDown"),he=(0,n.g2)("el-tooltip"),_e=(0,n.g2)("Lightning"),we=(0,n.g2)("el-collapse-transition"),ye=(0,n.g2)("el-table-column"),fe=(0,n.g2)("el-table"),pe=(0,n.g2)("ArrowUp"),Se=(0,n.g2)("el-tab-pane"),ve=(0,n.g2)("el-tabs");return(0,n.uX)(),(0,n.CE)("div",s,[t[15]||(t[15]=(0,n.Lk)("div",{class:"action-bar"},[(0,n.Lk)("div",{class:"title-section"},[(0,n.Lk)("h2",{class:"page-title"},"手术统计"),(0,n.Lk)("p",{class:"page-subtitle"},"查看和分析各场手术的详细统计数据")])],-1)),te.surgeries.length||te.analyzing?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",o,[(0,n.bF)(le,{class:"empty-card"},{default:(0,n.k6)(()=>[(0,n.Lk)("div",l,[(0,n.bF)(ie,{class:"empty-icon"},{default:(0,n.k6)(()=>[(0,n.bF)(ae)]),_:1}),t[1]||(t[1]=(0,n.Lk)("h3",null,"手术数据分析",-1)),te.logEntriesCount>0?((0,n.uX)(),(0,n.CE)("p",m," 检测到 "+(0,a.v_)(te.logEntriesCount)+" 条日志条目数据，点击按钮开始分析 ",1)):((0,n.uX)(),(0,n.CE)("p",g," 暂无日志条目数据，请先在批量分析或日志分析页面加载日志数据 ")),(0,n.bF)(oe,{type:"primary",onClick:te.analyzeLogs,loading:te.analyzing,disabled:0===te.logEntriesCount},{default:(0,n.k6)(()=>[(0,n.bF)(ie,null,{default:(0,n.k6)(()=>[(0,n.bF)(se)]),_:1}),(0,n.eW)(" "+(0,a.v_)(te.getAnalysisButtonText()),1)]),_:1},8,["onClick","loading","disabled"])])]),_:1})])),!te.surgeries.length&&te.analyzing?((0,n.uX)(),(0,n.CE)("div",u,[(0,n.bF)(le,{class:"empty-card"},{default:(0,n.k6)(()=>[(0,n.Lk)("div",c,[(0,n.bF)(ie,{class:"empty-icon"},{default:(0,n.k6)(()=>[(0,n.bF)(me)]),_:1}),t[2]||(t[2]=(0,n.Lk)("h3",null,"正在分析手术数据...",-1)),t[3]||(t[3]=(0,n.Lk)("p",null,"请稍候，系统正在处理日志条目数据",-1))])]),_:1})])):((0,n.uX)(),(0,n.CE)("div",d,[(0,n.bF)(le,{class:"tab-card"},{default:(0,n.k6)(()=>[(0,n.bF)(ve,{modelValue:te.activeTab,"onUpdate:modelValue":t[0]||(t[0]=e=>te.activeTab=e),type:"card",onTabClick:te.handleTabClick,lazy:!0,"before-leave":te.handleBeforeTabLeave,stretch:!1,closable:!1,addable:!1},{default:(0,n.k6)(()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(te.surgeries,e=>((0,n.uX)(),(0,n.Wv)(Se,{key:e.id,label:e.surgery_id,name:e.id.toString(),"data-surgery-id":e.id},{default:(0,n.k6)(()=>[(0,n.Lk)("div",T,[(0,n.bF)(oe,{type:"primary",onClick:t=>te.exportReport(e.id)},{default:(0,n.k6)(()=>[(0,n.bF)(ie,null,{default:(0,n.k6)(()=>[(0,n.bF)(ge)]),_:1}),t[4]||(t[4]=(0,n.eW)(" 导出手术报告 PDF "))]),_:2,__:[4]},1032,["onClick"])]),(0,n.Lk)("div",h,[(0,n.Lk)("div",_,[(0,n.bF)(le,{class:"info-card"},{default:(0,n.k6)(()=>[(0,n.Lk)("div",w,[t[6]||(t[6]=(0,n.Lk)("div",{class:"time"},"手术时间线",-1)),(0,n.Lk)("div",y,[e.alarm_count>0?((0,n.uX)(),(0,n.Wv)(ue,{key:0,type:"danger",size:"small",class:"alarm-tag",onClick:t=>te.scrollToAlarmCard(e.id),style:{cursor:"pointer"}},{default:(0,n.k6)(()=>t[5]||(t[5]=[(0,n.eW)(" 查看手术故障 ")])),_:2,__:[5]},1032,["onClick"])):(0,n.Q3)("",!0)])]),(0,n.bF)(de,{direction:"vertical",current:te.getSortedTimelineEvents(e).length-1,"progress-dot":!0,class:"surgery-steps"},{default:(0,n.k6)(()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(te.getSortedTimelineEvents(e),(e,t)=>((0,n.uX)(),(0,n.Wv)(ce,{key:`event-${t}`,title:e.label,description:te.formatTime(e.time)},null,8,["title","description"]))),128))]),_:2},1032,["current"])]),_:2},1024)]),(0,n.Lk)("div",f,[(0,n.bF)(le,{class:"state-chart-card"},{default:(0,n.k6)(()=>[t[7]||(t[7]=(0,n.Lk)("div",{class:"chart-header"},[(0,n.Lk)("div",{class:"chart-title"},"手术状态机变化图")],-1)),(0,n.Lk)("div",p,[(0,n.Lk)("div",{id:`stateMachineChart_${e.id}`,style:{width:"100%",height:"100%"}},null,8,S)])]),_:2,__:[7]},1024)])]),(0,n.bF)(le,{class:"arm-usage-card"},{header:(0,n.k6)(()=>[(0,n.Lk)("div",v,[t[8]||(t[8]=(0,n.Lk)("span",null,"手术统计",-1)),(0,n.bF)(ue,{type:"info"},{default:(0,n.k6)(()=>[(0,n.eW)("总手术时长: "+(0,a.v_)(e.total_duration)+" 分钟",1)]),_:2},1024)])]),default:(0,n.k6)(()=>[(0,n.Lk)("div",D,[(0,n.Lk)("div",k,[(0,n.Lk)("div",b,[(0,n.Lk)("span",x,"手术时长："+(0,a.v_)(e.total_duration)+" 分钟",1),(0,n.Lk)("span",L,"手术时间："+(0,a.v_)(te.formatTime(e.surgery_start_time))+" - "+(0,a.v_)(te.formatTime(e.surgery_end_time)),1)]),(0,n.Lk)("div",I,[t[10]||(t[10]=(0,n.Lk)("div",{class:"surgery-label"},[(0,n.Lk)("div",{class:"surgery-color"}),(0,n.Lk)("span",{class:"surgery-name"},"手术时间段")],-1)),(0,n.Lk)("div",C,[(0,n.Lk)("div",$,[(0,n.Lk)("div",{class:"surgery-timeline-segment",style:(0,a.Tr)(te.getSurgeryTimelineStyle(e))},t[9]||(t[9]=[(0,n.Lk)("span",{class:"surgery-segment-text"},"手术时间段",-1)]),4)])])]),(0,n.Lk)("div",M,[(0,n.Lk)("span",F,(0,a.v_)(te.formatTimeShort(te.getProgressTimelineRange(e).start)),1),(0,n.Lk)("span",E,(0,a.v_)(te.formatTimeShort(te.getProgressTimelineRange(e).end)),1)])]),(0,n.Lk)("div",A,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(te.getArmUsages(e),(r,s)=>((0,n.uX)(),(0,n.CE)("div",{key:s,class:"arm-item"},[(0,n.Lk)("div",O,[(0,n.Lk)("div",N,[(0,n.bF)(oe,{size:"small",type:"primary",plain:"",onClick:t=>te.toggleArmDetails(e.id,s)},{default:(0,n.k6)(()=>[(0,n.bF)(ie,null,{default:(0,n.k6)(()=>[(0,n.bF)(Te)]),_:1}),t[11]||(t[11]=(0,n.eW)(" 详情 "))]),_:2,__:[11]},1032,["onClick"])])]),(0,n.Lk)("div",R,[(0,n.Lk)("div",z,[(0,n.Lk)("div",{class:(0,a.C4)(["arm-color",`arm-${s+1}`])},null,2),(0,n.Lk)("span",P,"工具臂 "+(0,a.v_)(s+1),1)]),(0,n.Lk)("div",X,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(te.getArmTimelineSegments(r,e),(i,o)=>((0,n.uX)(),(0,n.CE)("div",{key:o,class:(0,a.C4)(["timeline-segment",`arm-${s+1}`]),style:(0,a.Tr)(i)},[(0,n.bF)(he,{content:`${te.getSegmentInstrumentName(i,r,e)}`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,n.k6)(()=>t[12]||(t[12]=[(0,n.Lk)("div",{class:"segment-content"},[(0,n.Lk)("span",{class:"segment-text"})],-1)])),_:2,__:[12]},1032,["content"])],6))),128))])]),(0,n.bF)(we,null,{default:(0,n.k6)(()=>[(0,n.bo)((0,n.Lk)("div",W,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(te.getGroupedUsagesByUdi(r),(t,r)=>((0,n.uX)(),(0,n.CE)("div",{key:r,class:"usage-group"},[(0,n.Lk)("div",B,[(0,n.Lk)("div",V,[(0,n.Lk)("div",U,(0,a.v_)(t.instrumentName),1),(0,n.Lk)("div",K,"UDI: "+(0,a.v_)(r),1),(0,n.Lk)("div",Y,"总使用时长: "+(0,a.v_)(te.getGroupedUsageDuration(t)),1)])]),(0,n.Lk)("div",q,[(0,n.Lk)("div",G,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.usages,(t,r)=>((0,n.uX)(),(0,n.CE)("div",{key:r,class:(0,a.C4)(["timeline-segment",`arm-${s+1}`]),style:(0,a.Tr)(te.getUsageTimelineStyle(t,e))},[(0,n.bF)(he,{content:`器械：${t.instrumentName}\n时间：${te.formatTime(t.startTime)} - ${te.formatTime(t.endTime)}\n时长：${Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60)}分钟`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,n.k6)(()=>[(0,n.Lk)("div",J,[(0,n.Lk)("span",j,(0,a.v_)(te.getSegmentText(t,e)),1)])]),_:2},1032,["content"])],6))),128))])])]))),128)),(0,n.Lk)("div",H,[(0,n.bF)(ie,{class:"energy-icon"},{default:(0,n.k6)(()=>[(0,n.bF)(_e)]),_:1}),(0,n.eW)(" 器械总使用时间: "+(0,a.v_)(te.getEnergyTime(r)),1)])],512),[[i.aG,te.armDetailsVisible[e.id+"_"+s]]])]),_:2},1024)]))),128))])]),(0,n.Lk)("div",Q,[t[13]||(t[13]=(0,n.Lk)("div",{class:"card-header",style:{"margin-top":"12px","margin-bottom":"8px"}},[(0,n.Lk)("span",null,"手术器械")],-1)),(0,n.bF)(fe,{data:te.getInstrumentRows(e),size:"small",style:{width:"100%"}},{default:(0,n.k6)(()=>[(0,n.bF)(ye,{prop:"instrumentName",label:"器械名称","min-width":"180"}),(0,n.bF)(ye,{prop:"udi",label:"UDI码","min-width":"220"})]),_:2},1032,["data"])])]),_:2},1024),(0,n.bF)(le,{class:"alarm-card"},{header:(0,n.k6)(()=>t[14]||(t[14]=[(0,n.Lk)("span",null,"安全报警记录",-1)])),default:(0,n.k6)(()=>[(0,n.bF)(fe,{data:te.getAlarmDetails(e).slice(0,te.showAllAlarms[e.id]?void 0:5),style:{width:"100%"}},{default:(0,n.k6)(()=>[(0,n.bF)(ye,{prop:"time",label:"时间",width:"180"},{default:(0,n.k6)(({row:e})=>[(0,n.eW)((0,a.v_)(te.formatTime(e.time)),1)]),_:1}),(0,n.bF)(ye,{prop:"code",label:"故障码",width:"120"},{default:(0,n.k6)(({row:e})=>[(0,n.eW)((0,a.v_)(e.code||e.error_code||"无"),1)]),_:1}),(0,n.bF)(ye,{prop:"message",label:"报警信息"}),(0,n.bF)(ye,{prop:"status",label:"处理状态",width:"120"},{default:(0,n.k6)(({row:e})=>[(0,n.bF)(ue,{type:"已恢复"===e.status?"success":"未处理"===e.status?"danger":"warning"},{default:(0,n.k6)(()=>[(0,n.eW)((0,a.v_)(e.status),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]),te.getAlarmDetails(e).length>5?((0,n.uX)(),(0,n.CE)("div",Z,[(0,n.bF)(oe,{type:"text",onClick:t=>te.toggleAlarms(e.id),size:"small"},{default:(0,n.k6)(()=>[(0,n.bF)(ie,null,{default:(0,n.k6)(()=>[te.showAllAlarms[e.id]?((0,n.uX)(),(0,n.Wv)(pe,{key:1})):((0,n.uX)(),(0,n.Wv)(Te,{key:0}))]),_:2},1024),(0,n.eW)(" "+(0,a.v_)(te.showAllAlarms[e.id]?"收起":`展开更多 (${te.getAlarmDetails(e).length-5}条)`),1)]),_:2},1032,["onClick"])])):(0,n.Q3)("",!0),(0,n.Lk)("div",ee,[(0,n.bF)(ue,{type:"danger"},{default:(0,n.k6)(()=>[(0,n.eW)("报警总数: "+(0,a.v_)(e.alarm_count||0),1)]),_:2},1024)])]),_:2},1024)]),_:2},1032,["label","name","data-surgery-id"]))),128))]),_:1},8,["modelValue","onTabClick","before-leave"])]),_:1})]))])}var re=r(953),ne=r(6278),ae=r(5220),ie=r(163),se=r(8548),oe=r(3611),le=r(6532),me=r(5495),ge={name:"SurgeryStatistics",components:{DataAnalysis:se.DataAnalysis,Download:se.Download,SwitchButton:se.SwitchButton,Close:se.Close,VideoPlay:se.VideoPlay,VideoPause:se.VideoPause,ArrowUp:se.ArrowUp,ArrowDown:se.ArrowDown,ArrowLeft:se.ArrowLeft,ArrowRight:se.ArrowRight,Calendar:se.Calendar,PowerOff:se.PowerOff,Lightning:se.Lightning,Globe:se.Globe,Loading:se.Loading},setup(){(0,ne.Pj)(),(0,ae.rd)();const e=(0,ae.lq)(),t=(0,re.KR)([]),r=(0,re.KR)(""),a=(0,re.Kh)({}),i=(0,re.Kh)({}),s=(0,re.KR)(!1),o=new Map,l=(0,re.KR)(5),m=(0,re.KR)(null),g=()=>({0:0,1:5,2:10,10:20,13:30,14:35,20:45,21:50,30:60,31:65}),u=(0,n.EW)(()=>{const t=e.query.logIds;if(t)return[];try{const e=sessionStorage.getItem("surgeryAnalysisData");if(e){const t=JSON.parse(e);if(t&&t.entries&&t.entries.length>0){const e=Date.now()-(t.timestamp||0);if(e>36e5)return console.log("手术分析数据已过期，清除缓存"),sessionStorage.removeItem("surgeryAnalysisData"),[];if(t.compressed){const e=t.entries.map(e=>({timestamp:e.t,error_code:e.e,param1:e.p1,param2:e.p2,param3:e.p3,param4:e.p4,explanation:e.exp,log_name:e.ln}));return e}return t.entries}}}catch(r){console.error("解析手术分析数据失败:",r),sessionStorage.removeItem("surgeryAnalysisData")}return[]}),c=(0,n.EW)(()=>u.value.length),d=async()=>{try{const n=e.query.logIds;if(!n)return;const o=n.split(",").map(e=>parseInt(e));if(!o||0===o.length)return;s.value=!0;const l=await me.A.surgeryStatistics.analyzeByLogIds(o);l.data.success&&l.data.taskId?await T(l.data.taskId):l.data.success&&l.data.data?(t.value=l.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{a[e.id]=!1,i[e.id]=!1})),ie.nk.success(l.data.message||`成功分析出 ${t.value.length} 场手术`)):ie.nk.error(l.data.message||"分析失败")}catch(n){ie.nk.error("分析批量日志数据失败: "+(n.response?.data?.message||n.message))}finally{s.value=!1}},T=async e=>{const n=60;let s=0;const o=async()=>{try{const l=await me.A.surgeryStatistics.getAnalysisTaskStatus(e);if(l.data.success){const e=l.data.data;if("completed"===e.status)return t.value=e.result||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{a[e.id]=!1,i[e.id]=!1})),void ie.nk.success(`成功分析出 ${t.value.length} 场手术`);if("failed"===e.status)return void ie.nk.error(e.error||"分析任务失败");"processing"===e.status&&(s++,s<n?(await new Promise(e=>setTimeout(e,5e3)),await o()):ie.nk.error("分析任务超时，请稍后查看结果"))}else ie.nk.error("查询任务状态失败")}catch(l){ie.nk.error("查询任务状态失败: "+l.message)}};await o()},h=()=>{if(0===u.value.length)return"无数据";const e=u.value.map(e=>new Date(e.timestamp)),t=new Date(Math.min(...e)),r=new Date(Math.max(...e));return`${C(t)} 至 ${C(r)}`},_=()=>0===c.value?"请先加载日志条目数据":`分析日志条目 (${c.value})`,w=async()=>{if(0!==u.value.length){s.value=!0;try{const e=JSON.stringify(u.value).length,n=10485760;let s=u.value;if(e>n){ie.nk.warning(`数据量较大(${(e/1024/1024).toFixed(1)}MB)，将进行数据采样以提高分析速度`);const t=Math.floor(n/(e/u.value.length)),r=Math.floor(u.value.length/t);s=[];for(let e=0;e<u.value.length;e+=r)if(s.push(u.value[e]),s.length>=t)break}const o=await me.A.surgeryStatistics.analyzeSortedEntries(s);o.data.success?(t.value=o.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{a[e.id]=!1,i[e.id]=!1})),ie.nk.success(`手术数据分析完成，共发现 ${t.value.length} 场手术`)):ie.nk.error(o.data.message||"分析失败")}catch(e){ie.nk.error("分析日志数据失败: "+(e.response?.data?.message||e.message))}finally{s.value=!1}}else ie.nk.warning("暂无日志条目数据，请先在批量分析或日志分析页面加载日志数据")},y=async e=>{try{await me.A.surgeryStatistics.exportReport(e);ie.nk.success("报告导出功能开发中")}catch(t){ie.nk.error("导出报告失败")}},f=(e,t)=>{const r=`${e}_${t}`;a[r]=!a[r]},p=e=>{i[e]=!i[e]},S=e=>{r.value!==e.toString()&&(r.value=e.toString()),(0,n.dY)(()=>{const t=document.querySelector(`[data-surgery-id="${e}"] .alarm-card`);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),t.style.boxShadow="0 0 0 2px #F56C6C, 0 4px 12px rgba(245, 108, 108, 0.3)",t.style.transition="box-shadow 0.3s ease",setTimeout(()=>{t.style.boxShadow=""},3e3))})},v=e=>[e.arm1_usage||[],e.arm2_usage||[],e.arm3_usage||[],e.arm4_usage||[]],D=e=>{if(!e)return[];const t=new Map,r=v(e);r.forEach(e=>{(e||[]).forEach(e=>{if(!e)return;if(!e.startTime||!e.endTime)return;const r=e.udi||"未知",n=`${r}__${e.instrumentName||"未知器械"}`;t.has(n)||t.set(n,{instrumentName:e.instrumentName||"未知器械",udi:r,segments:[]}),t.get(n).segments.push({startTime:e.startTime,endTime:e.endTime})})});const n=Array.from(t.values()).map(e=>{e.segments.sort((e,t)=>new Date(e.startTime)-new Date(t.startTime));const t=[];for(const a of e.segments){if(0===t.length){t.push({...a});continue}const e=t[t.length-1],r=new Date(e.endTime).getTime(),n=new Date(a.startTime).getTime(),i=new Date(a.endTime).getTime();n<=r?i>r&&(e.endTime=a.endTime):t.push({...a})}const r=t.length?t[0].startTime:null,n=t.length?t[t.length-1].endTime:null;return{...e,segments:t,startTime:r,endTime:n}});return n.sort((e,t)=>new Date(e.startTime)-new Date(t.startTime)),n},k=e=>{if(!e||0===e.length)return"0分钟";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},b=e=>{switch(e){case"错误":return"danger";case"警告":return"warning";case"网络":return"info";default:return"info"}},x=e=>{if(!e||!e.alarm_details)return[];let t=[];if("string"===typeof e.alarm_details)try{t=JSON.parse(e.alarm_details)}catch(r){return console.error("解析alarm_details字符串失败:",r),[]}else t=e.alarm_details||[];return t},L=e=>{if(!e)return"-";const t=new Date(e),r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${r}-${n}-${a} ${i}:${s}:${o}`},I=e=>{if(!e.surgery_start_time||!e.surgery_end_time)return"手术时间未确定";const t=new Date(e.surgery_start_time).toLocaleString(),r=new Date(e.surgery_end_time).toLocaleString();return`${t} ~ ${r}`},C=e=>{if(!e)return"-";const t=new Date(e),r=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");return`${r}:${n}`},$=e=>{if(!e)return{start:null,end:null};const t=e.surgery_start_time,r=e.surgery_end_time;if(t&&r){const n=new Date(t).getTime(),a=new Date(r).getTime();if(n>=a)return console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{surgery_id:e.surgery_id,start:t,end:r,startTime:n,endTime:a}),{start:null,end:null}}return console.log("时间轴范围 (重新设计):",e.surgery_id,{start:t,end:r,duration:t&&r?(new Date(r).getTime()-new Date(t).getTime())/6e4:"N/A"}),{start:t,end:r}},M=e=>{try{const t=K(e);if(!t||0===t.length)return F(e);const r=t[0].time,n=t[t.length-1].time;return{start:r,end:n}}catch(t){return F(e)}},F=e=>{if(!e)return{start:null,end:null};const t=W(e),r=B(e),n=r||e.surgery_end_time;let a=t;!a&&e.surgery_start_time&&(a=e.surgery_start_time);let i=n;if(!i&&e.surgery_end_time&&(i=e.surgery_end_time),a&&i){const t=new Date(a).getTime(),r=new Date(i).getTime();if(t>=r)return console.warn("进度条时间轴范围异常：开始时间晚于或等于结束时间",{surgery_id:e.surgery_id,start:a,end:i,startTime:t,endTime:r}),{start:null,end:null}}return console.log("进度条时间轴范围:",e.surgery_id,{start:a,end:i,powerOnTime:t,powerOffTime:r,surgeryEndTime:e.surgery_end_time,duration:a&&i?(new Date(i).getTime()-new Date(a).getTime())/6e4:"N/A"}),{start:a,end:i}},E=(e,t,r)=>{if(!e||!t||!r)return 0;try{const n=new Date(t).getTime(),a=new Date(r).getTime(),i=new Date(e).getTime();if(isNaN(n)||isNaN(a)||isNaN(i))return console.warn("时间计算异常：无效的时间值",{time:e,startTime:t,endTime:r}),0;if(n>=a)return console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{startTime:t,endTime:r}),0;const s=(i-n)/(a-n)*100;return Math.max(0,Math.min(100,s))}catch(n){return console.error("时间位置计算失败:",n,{time:e,startTime:t,endTime:r}),0}},A=(e,t)=>{if(!e||!t)return[];const r=new Date(e),n=new Date(t),a=n.getTime()-r.getTime();let i;i=a<=18e5?3e5:a<=72e5?9e5:18e5;const s=[];let o=r.getTime()+i;while(o<n.getTime()){const r=E(o,e,t);s.push({time:new Date(o),position:r}),o+=i}return s},O=e=>{if(!e||0===e.length)return[];const t=e.map(e=>({startTime:new Date(e.startTime).getTime(),endTime:new Date(e.endTime).getTime()}));t.sort((e,t)=>e.startTime-t.startTime);const r=[];let n=t[0];for(let a=1;a<t.length;a++){const e=t[a];n.endTime>=e.startTime?n.endTime=Math.max(n.endTime,e.endTime):(r.push(n),n=e)}return n&&r.push(n),r},N=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return{left:"0%",width:"0%"};const n=O(r);if(0===n.length)return{left:"0%",width:"0%"};let a=0;const i=[],s=M(t);return s.start&&s.end?(n.forEach(e=>{const t=E(e.startTime,s.start,s.end),r=E(e.endTime,s.start,s.end),n=Math.max(0,r-t);i.push({left:`${t}%`,width:`${n}%`}),a+=n}),i.length>0?i[0]:{left:"0%",width:"0%"}):{left:"0%",width:"0%"}},R=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return[];const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return[];const n=O(r);if(0===n.length)return[];const a=[],i=M(t);return i.start&&i.end?(n.forEach((e,t)=>{const r=E(e.startTime,i.start,i.end),n=E(e.endTime,i.start,i.end),s=Math.max(0,n-r);s>0&&a.push({left:`${r}%`,width:`${s}%`})}),a):[]},z=e=>{if(!e||!e.surgery_start_time||!e.surgery_end_time)return{left:"0%",width:"0%"};const t=M(e);if(!t.start||!t.end)return{left:"0%",width:"0%"};const r=E(e.surgery_start_time,t.start,t.end),n=E(e.surgery_end_time,t.start,t.end),a=Math.max(0,n-r);return console.log("手术进度条计算:",e.surgery_id,{surgeryStartTime:e.surgery_start_time,surgeryEndTime:e.surgery_end_time,timelineStart:t.start,timelineEnd:t.end,startPosition:r.toFixed(2)+"%",endPosition:n.toFixed(2)+"%",width:a.toFixed(2)+"%"}),{left:`${r}%`,width:`${a}%`}},P=(e,t)=>{if(!e||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};if(!e.startTime||!e.endTime)return{left:"0%",width:"0%"};const r=M(t);if(!r.start||!r.end)return{left:"0%",width:"0%"};const n=new Date(e.startTime).getTime(),a=new Date(e.endTime).getTime(),i=E(n,r.start,r.end),s=E(a,r.start,r.end),o=Math.max(0,s-i),l=Math.max(0,Math.min(100-o,i));return{left:`${l}%`,width:`${o}%`}},X=e=>{if(!e||0===e.length)return"0分0秒";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3);return e+r},0),r=Math.floor(t/60),n=t%60;return`${r}分${n}秒`},W=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times[0]:e.power_on_time?e.power_on_time:e.surgery_start_time:null,B=e=>e?e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times[e.shutdown_times.length-1]:e.power_off_time?e.power_off_time:null:null,V=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times:e.power_on_time?[e.power_on_time]:[]:[],U=e=>e?e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times:e.power_off_time?[e.power_off_time]:[]:[],K=e=>{if(!e)return[];const t=[],r=V(e);e.is_consecutive_surgery&&console.log("连台手术调试信息:",{surgery_id:e.surgery_id,is_consecutive_surgery:e.is_consecutive_surgery,previous_surgery_end_time:e.previous_surgery_end_time,power_on_times:e.power_on_times,powerOnTimes:r}),r.forEach((n,a)=>{let i="开机";e.is_consecutive_surgery&&0===a?i="上一场手术结束时间":r.length>1&&(i=`开机 ${a+1}`),t.push({time:new Date(n),type:"powerOn",label:i,color:"green",icon:"PowerOff"})}),e.surgery_start_time&&t.push({time:new Date(e.surgery_start_time),type:"surgeryStart",label:"手术开始",color:"blue",icon:"VideoPlay"}),e.surgery_end_time&&t.push({time:new Date(e.surgery_end_time),type:"surgeryEnd",label:"手术结束",color:"orange",icon:"VideoPause"});const n=U(e);return n.forEach((e,r)=>{t.push({time:new Date(e),type:"powerOff",label:n.length>1?`关机 ${r+1}`:"关机",color:"red",icon:"PowerOff"})}),t.sort((e,t)=>e.time.getTime()-t.time.getTime())},Y=e=>{if(!e)return[];let t=[];if(e.state_machine_changes)if("string"===typeof e.state_machine_changes)try{t=JSON.parse(e.state_machine_changes)}catch(n){console.error("解析state_machine_changes字符串失败:",n),t=[]}else t=e.state_machine_changes||[];if(console.log("手术状态机变化数据:",e.surgery_id,t),0===t.length)return console.log("没有状态机变化数据"),[];const r=[];for(let a=0;a<t.length;a++){const n=t[a],i=t[a+1],s=parseInt(n.state),o=new Date(n.time),l=i?new Date(i.time):e.surgery_end_time?new Date(e.surgery_end_time):new Date,m=l.getTime()-o.getTime();console.log(`状态变化 ${a}: currentState=${s}, startTime=${o}, endTime=${l}, duration=${m}ms`);let g="none";if(s<=0)g="none";else if(s>0&&s<30)g="surgery";else if(30===s){const e=i?parseInt(i.state):null;g=null===e||e<10?"error":"surgery"}else g="none";console.log(`状态分类: currentState=${s}, nextState=${i?i.state:"null"} -> stateCategory=${g}`),"none"!==g&&r.push({state:g,startTime:o,endTime:l,duration:m,originalState:s,stateName:n.stateName||`状态${s}`})}return console.log("生成的柱状图数据:",r),r},q=e=>{const t={surgery:"正常阶段",error:"故障阶段",idle:"空闲",active:"激活",standby:"待机",offline:"离线"};return t[e]||e},G=e=>{const t={surgery:60,error:100},r=t[e]||60;return console.log(`柱状图高度: state=${e}, height=${r}px`),r},J=(e,t)=>{if(!e||!t)return 0;const r=F(t);if(!r.start||!r.end)return 0;const n=E(e,r.start,r.end);console.log(`柱状图位置计算: startTime=${e}, timelineStart=${r.start}, timelineEnd=${r.end}, position=${n}%`);const a=Math.max(0,Math.min(95,n));return a},j=e=>{const t={};return e.forEach((e,r)=>{const n=e.udi||`${e.instrumentName}_${r}`;t[n]||(t[n]={instrumentName:e.instrumentName,usages:[]}),t[n].usages.push(e)}),t},H=e=>{if(!e||0===e.usages.length)return"0分钟";const t=e.usages.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},Q=(e,t)=>{try{const r=P(e,t),n=r.width,a=parseFloat(n),i=e.instrumentName||"器械",s=1.5,o=2,l=Math.min(i.length*s+o,20);if(a>=l){if(a>=i.length*s+o)return i;{const e=Math.floor((a-o)/s);return i.substring(0,e)+"..."}}return""}catch(r){return console.error("计算进度条文本失败:",r),""}},Z=(e,t,r)=>{if(!e||!t||!r)return"未知器械";const n=F(r);if(!n.start||!n.end)return"未知器械";const a=parseFloat(e.left),i=a+parseFloat(e.width),s=new Date(n.start).getTime()+a/100*(new Date(n.end).getTime()-new Date(n.start).getTime()),o=new Date(n.start).getTime()+i/100*(new Date(n.end).getTime()-new Date(n.start).getTime()),l=t.filter(e=>{if(!e.startTime||!e.endTime)return!1;const t=new Date(e.startTime).getTime(),r=new Date(e.endTime).getTime();return t<o&&r>s});return 0===l.length?"无器械使用":l[0].instrumentName||"未知器械"},ee=(0,oe.sg)(e=>{(0,oe.wx)(()=>{r.value=e.name})},50),te=(e,t)=>(0,oe.wx)().then(()=>!0),se=()=>{o.forEach((e,t)=>{console.log("销毁图表实例:",t);try{e.dispose&&e.dispose()}catch(r){console.warn("图表实例释放失败",t,r)}}),o.clear(),Object.keys(he).forEach(e=>{delete he[e]}),Te.clear(),m.value=null},ge=e=>{if(!e)return null;let t=[];if(e.state_machine_changes)if("string"===typeof e.state_machine_changes)try{t=JSON.parse(e.state_machine_changes)}catch(c){return console.error("解析state_machine_changes失败",c),null}else t=e.state_machine_changes||[];const r=K(e);let n=null,a=null;if(r.length>0&&(n=new Date(r[0].time).getTime(),a=new Date(r[r.length-1].time).getTime()),0===t.length)return n&&a?{points:[],rawData:[],xMin:n,xMax:a}:null;t.sort((e,t)=>new Date(e.time).getTime()-new Date(t.time).getTime()),n&&a||(n=new Date(t[0].time).getTime(),a=new Date(t[t.length-1].time).getTime());const i=g(),s=[];let o=null;for(const g of t){const e=new Date(g.time).getTime();e<=n&&(o=g),e>n&&e<=a&&s.push(g)}const l=[];let m=o?o.state:t.length>0?t[0].state:"0";l.push([n,i[parseInt(m)]??parseInt(m),m]);for(const g of s){const e=new Date(g.time).getTime(),t=i[parseInt(g.state)]??parseInt(g.state);l.push([e,t,g.state])}const u=s.length>0?s[s.length-1].state:m;return l.push([a,i[parseInt(u)]??parseInt(u),u]),{points:l,rawData:s,xMin:n,xMax:a}},ue=e=>{const t=e.surgery_start_time?new Date(e.surgery_start_time):null;if(!t)return{};let r=he[e.id];r||(r={currentTime:t,viewRange:l.value},he[e.id]=r);const n=new Date(r.currentTime.getTime()-30*r.viewRange*1e3),a=new Date(r.currentTime.getTime()+30*r.viewRange*1e3);return{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){const t=e[0].dataIndex,r=e[0].chart.data.rawData;if(r&&r[t]){const e=new Date(r[t].time),i=n.getDate()!==a.getDate()||n.getMonth()!==a.getMonth()||n.getFullYear()!==a.getFullYear();return i?e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN"):e.toLocaleTimeString("zh-CN")}return e[0].label},label:function(e){const t=e.dataIndex,r=e.chart.data.rawData;if(r&&r[t]){const e=parseInt(r[t].state),n=de(e.toString());return`状态: ${e} (${n})`}return`状态: ${e.parsed.y}`}}}},scales:{x:{title:{display:!0,text:"时间"},ticks:{maxTicksLimit:10,callback:function(e,t,r){const i=this.chart.data.rawData;if(i&&i[t]){const e=new Date(i[t].time),r=n.getDate()!==a.getDate()||n.getMonth()!==a.getMonth()||n.getFullYear()!==a.getFullYear();return r?e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}return e}}},y:{beginAtZero:!0,min:0,max:30,title:{display:!0,text:"状态机状态"},ticks:{stepSize:1,maxTicksLimit:15}}},animation:{duration:300}}},ce=e=>{if(!e)return;const t=document.getElementById(`stateMachineChart_${e.id}`);if(!t)return void setTimeout(()=>ce(e),50);const r=ge(e),n=o.get(e.id);if(n){try{n.dispose&&n.dispose()}catch(u){}o.delete(e.id)}if(!r)return void(t.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#909399;">暂无状态机数据</div>');const a=le.Ts(t);o.set(e.id,a);const i=g(),s={};Object.keys(i).forEach(e=>{s[i[e]]=e});const l=3e5,m=Math.min(r.xMin+l,r.xMax);a.setOption({grid:{left:60,right:20,top:70,bottom:80,containLabel:!0},toolbox:{right:10,top:10,feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:e=>{if(!e||!e[0])return"";const t=e[0],r=new Date(t.value[0]),n=t.value[1],a=t.value[2]??s[n]??n,i=de(String(a));return`${r.toLocaleString("zh-CN")}<br/>状态: ${a}（${i}）`}},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none",zoomOnMouseWheel:!0,moveOnMouseWheel:!0,moveOnMouseMove:!0,startValue:r.xMin,endValue:m},{type:"slider",xAxisIndex:0,filterMode:"none",height:40,bottom:20,showDataShadow:!0,brushSelect:!0,startValue:r.xMin,endValue:m}],xAxis:{type:"time",min:r.xMin,max:r.xMax,axisLabel:{formatter:e=>new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}},yAxis:{type:"value",min:0,max:65,axisLabel:{formatter:e=>{const t=s[e];return t?String(t):""}},axisTick:{show:!1},splitNumber:8},series:[{type:"line",step:"end",showSymbol:!1,lineStyle:{width:2,color:"#409EFF"},areaStyle:{color:new le.fA.W4(0,0,0,1,[{offset:0,color:"rgba(64,158,255,0.25)"},{offset:1,color:"rgba(64,158,255,0.05)"}])},data:r.points}]})},de=e=>{const t={0:"初始化（S00）",1:"使能（S01）",2:"自检（S02）",10:"待机（S10）",12:"从手调整（S12）",13:"主手跟随（S13）",14:"断开主从/离合（S14）",15:"初始化（S00）",20:"主从控制（S20）",21:"内窥镜控制（S21）",30:"错误（S30）",31:"关机（S31）"};return t[e]||`状态${e}`},Te=new Map,he=(0,re.Kh)({}),_e=(0,re.KR)(0),we=(e,t)=>{if(!e||!e.state_machine_changes)return{};const r=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),a=n.getTime()-r.getTime();if(a<=0)return{};const i=ge(e);let s,o;if(i&&i.startTime&&i.endTime)s=new Date(i.startTime),o=new Date(i.endTime);else{let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const i=60*l.value*1e3;let m=t.currentTime;const g=new Date(r.getTime()+i/2),u=new Date(n.getTime()-i/2);if(a<=i){const e=new Date(Math.max(r.getTime(),Math.min(n.getTime(),m.getTime())));m=e}else m.getTime()<g.getTime()?m=g:m.getTime()>u.getTime()&&(m=u);s=new Date(m.getTime()-i/2),o=new Date(m.getTime()+i/2),s.getTime()<r.getTime()&&(s=r,o=new Date(r.getTime()+i)),o.getTime()>n.getTime()&&(o=n,s=new Date(n.getTime()-i),s.getTime()<r.getTime()&&(s=r,o=new Date(r.getTime()+i)))}const m=o.getTime()-s.getTime(),g=(s.getTime()-r.getTime())/a*100,u=m/a*100,c=Math.max(0,Math.min(100-u,g)),d=Math.max(5,Math.min(100,u));return console.log("滚动条计算 (重新设计):",{surgeryId:e.surgery_id,totalStartTime:r.toISOString(),totalEndTime:n.toISOString(),totalDuration:a/6e4,viewStartTime:s.toISOString(),viewEndTime:o.toISOString(),viewDuration:m/6e4,thumbPosition:g.toFixed(2),thumbWidth:u.toFixed(2),clampedPosition:c.toFixed(2),clampedWidth:d.toFixed(2),isAtEnd:o.getTime()===n.getTime(),isAtStart:s.getTime()===r.getTime()}),{left:`${c}%`,width:`${d}%`}},ye=(e,t)=>{if(!t)return;const r=e.currentTarget,n=r.getBoundingClientRect(),a=e.clientX-n.left,i=n.width,s=a/i,o=new Date(t.surgery_start_time),m=new Date(t.surgery_end_time),g=m.getTime()-o.getTime(),u=new Date(o.getTime()+s*g),c=60*l.value*1e3,d=new Date(o.getTime()+c/2),T=new Date(m.getTime()-c/2);let h=he[t.id];if(h||(h={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:l.value},he[t.id]=h),g<=c){const e=new Date(Math.max(o.getTime(),Math.min(m.getTime(),u.getTime())));h.currentTime=e}else u.getTime()<d.getTime()?h.currentTime=d:u.getTime()>T.getTime()?h.currentTime=T:h.currentTime=u;console.log("滚动条点击 (重新设计):",{surgeryId:t.surgery_id,clickPercentage:s.toFixed(2),targetTime:u.toISOString(),newCurrentTime:h.currentTime.toISOString(),totalStartTime:o.toISOString(),totalEndTime:m.toISOString(),totalDuration:g/6e4}),_e.value++,ce(t)},fe=(e,t)=>{if(!t)return;e.preventDefault(),e.stopPropagation();let r=Te.get(t.id);r||(r={isDragging:!1,dragStartX:0,dragStartTime:null},Te.set(t.id,r)),r.isDragging=!0,r.dragStartX=e.clientX;let n=he[t.id];n||(n={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:l.value},he[t.id]=n),r.dragStartTime=n.currentTime?new Date(n.currentTime):null,document.addEventListener("mousemove",e=>pe(e,t)),document.addEventListener("mouseup",()=>Se(t))},pe=(e,t)=>{let r=Te.get(t.id);if(!r||!r.isDragging||!r.dragStartTime)return;const n=e.clientX-r.dragStartX,a=document.querySelector(`[data-surgery-id="${t.id}"] .chart-scrollbar-container`),i=a?.querySelector(".scrollbar-track");if(!i)return void console.warn("找不到滚动条轨道:",t.id);const s=i.offsetWidth,o=new Date(t.surgery_start_time),m=new Date(t.surgery_end_time),g=m.getTime()-o.getTime(),u=n/s*g,c=new Date(r.dragStartTime.getTime()+u),d=60*l.value*1e3,T=new Date(o.getTime()+d/2),h=new Date(m.getTime()-d/2);let _=he[t.id];if(_||(_={currentTime:t.surgery_start_time?new Date(t.surgery_start_time):new Date,viewRange:l.value},he[t.id]=_),g<=d){const e=new Date(Math.max(o.getTime(),Math.min(m.getTime(),c.getTime())));_.currentTime=e}else c.getTime()<T.getTime()?_.currentTime=T:c.getTime()>h.getTime()?_.currentTime=h:_.currentTime=c;console.log("滚动条拖拽 (重新设计):",{surgeryId:t.surgery_id,deltaX:n.toFixed(2),dragTimeChange:u/6e4,newCenterTime:c.toISOString(),newCurrentTime:_.currentTime.toISOString(),totalStartTime:o.toISOString(),totalEndTime:m.toISOString(),totalDuration:g/6e4}),_e.value++,ce(t)},Se=e=>{if(!e)return;let t=Te.get(e.id);t&&(t.isDragging=!1,t.dragStartX=0,t.dragStartTime=null),document.removeEventListener("mousemove",t=>pe(t,e)),document.removeEventListener("mouseup",()=>Se(e))},ve=e=>{if(!e)return;let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const r=6e4,n=new Date(t.currentTime.getTime()-r),a=new Date(e.surgery_start_time),i=new Date(e.surgery_end_time),s=i.getTime()-a.getTime(),o=60*l.value*1e3;if(s<=o){const e=new Date(Math.max(a.getTime(),Math.min(i.getTime(),n.getTime())));t.currentTime=e}else{const e=new Date(a.getTime()+o/2);n.getTime()>=e.getTime()?t.currentTime=n:t.currentTime=e}console.log("向左滚动 (重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:n.toISOString(),totalStartTime:a.toISOString(),totalEndTime:i.toISOString(),totalDuration:s/6e4}),_e.value++,ce(e)},De=e=>{if(!e)return;let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const r=6e4,n=new Date(t.currentTime.getTime()+r),a=new Date(e.surgery_start_time),i=new Date(e.surgery_end_time),s=i.getTime()-a.getTime(),o=60*l.value*1e3;if(s<=o){const r=new Date(Math.max(a.getTime(),Math.min(i.getTime(),n.getTime())));t.currentTime=r,console.log("向右滚动 (短手术 - 重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:n.toISOString(),clampedTime:r.toISOString(),totalStartTime:a.toISOString(),totalEndTime:i.toISOString(),totalDuration:s/6e4})}else{const r=new Date(i.getTime()-o/2);n.getTime()<=r.getTime()?t.currentTime=n:t.currentTime=r,console.log("向右滚动 (长手术 - 重新设计):",{surgeryId:e.surgery_id,oldTime:t.currentTime.toISOString(),newTime:n.toISOString(),maxTime:r.toISOString(),totalStartTime:a.toISOString(),totalEndTime:i.toISOString(),totalDuration:s/6e4})}_e.value++,ce(e)},ke=e=>{if(!e)return!1;let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const r=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),a=n.getTime()-r.getTime(),i=60*l.value*1e3;if(a<=i)return!1;const s=new Date(r.getTime()+i/2);return t.currentTime.getTime()>s.getTime()},be=e=>{if(!e)return!1;let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const r=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),a=n.getTime()-r.getTime(),i=60*l.value*1e3;if(a<=i)return!1;const s=new Date(n.getTime()-i/2);return console.log("向右滚动检查 (重新设计):",{surgeryId:e.surgery_id,currentTime:t.currentTime.toISOString(),maxCenterTime:s.toISOString(),totalStartTime:r.toISOString(),totalEndTime:n.toISOString(),totalDuration:a/6e4,viewWindowDuration:(i/6e4).toFixed(1)+"分钟",canScroll:t.currentTime.getTime()<s.getTime()}),t.currentTime.getTime()<s.getTime()},xe=e=>{if(!e)return;const t=ge(e),r=we(e,_e.value),n=Le(e,_e.value),a=new Date(e.surgery_start_time),i=new Date(e.surgery_end_time),s=i.getTime()-a.getTime(),o=60*l.value*1e3,m=new Date(a.getTime()+o/2),g=new Date(i.getTime()-o/2);console.log("同步状态检查 (重新设计):",{surgeryId:e.surgery_id,totalStartTime:a.toISOString(),totalEndTime:i.toISOString(),totalDuration:(s/6e4).toFixed(1)+"分钟",viewWindowDuration:(o/6e4).toFixed(1)+"分钟",isShortSurgery:s<=o,minCenterTime:m.toISOString(),maxCenterTime:g.toISOString(),chartDataExists:!!t,chartLabels:t?.labels?.length||0,chartDataPoints:t?.data?.length||0,chartStartTime:t?.startTime?.toISOString()||"N/A",chartEndTime:t?.endTime?.toISOString()||"N/A",scrollbarLeft:r.left,scrollbarWidth:r.width,scrollbarInfo:n,canScrollLeft:ke(e),canScrollRight:be(e),surgeryStartTime:e.surgery_start_time,surgeryEndTime:e.surgery_end_time,timelineRange:$(e),powerOnTime:W(e),powerOffTime:B(e)})},Le=(e,t)=>{if(!e)return"";const r=ge(e);if(!r||!r.startTime||!r.endTime){let t=he[e.id];t||(t={currentTime:e.surgery_start_time?new Date(e.surgery_start_time):new Date,viewRange:l.value},he[e.id]=t);const r=new Date(e.surgery_start_time),n=new Date(e.surgery_end_time),a=n.getTime()-r.getTime(),i=60*l.value*1e3;let s=t.currentTime;const o=new Date(r.getTime()+i/2),m=new Date(n.getTime()-i/2);if(a<=i){const e=new Date(Math.max(r.getTime(),Math.min(n.getTime(),s.getTime())));s=e}else s.getTime()<o.getTime()?s=o:s.getTime()>m.getTime()&&(s=m);const g=new Date(s.getTime()-i/2),u=new Date(s.getTime()+i/2);let c=g,d=u;c.getTime()<r.getTime()&&(c=r,d=new Date(r.getTime()+i)),d.getTime()>n.getTime()&&(d=n,c=new Date(n.getTime()-i),c.getTime()<r.getTime()&&(c=r,d=new Date(r.getTime()+i)));const T=c.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),h=d.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),_=(d.getTime()-c.getTime())/6e4;return`${T} - ${h} (${_.toFixed(1)}分钟)`}const n=new Date(r.startTime),a=new Date(r.endTime),i=n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),s=a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),o=(a.getTime()-n.getTime())/6e4;return console.log("滚动条时间范围 (重新设计):",e.surgery_id,{startTime:n.toISOString(),endTime:a.toISOString(),duration:o.toFixed(1)+"分钟",totalStartTime:new Date(e.surgery_start_time).toISOString(),totalEndTime:new Date(e.surgery_end_time).toISOString()}),`${i} - ${s} (${o.toFixed(1)}分钟)`};return(0,n.wB)(t,e=>{if(e.length>0&&r.value){const t=e.find(e=>e.id.toString()===r.value);t&&(0,n.dY)(()=>{const e=`stateMachineChart_${t.id}`,r=document.getElementById(e);r?ce(t):(console.warn("Canvas元素不存在，等待DOM渲染:",e),setTimeout(()=>{ce(t)},100))})}},{deep:!0}),(0,n.wB)(r,e=>{if(e&&t.value.length>0){const r=t.value.find(t=>t.id.toString()===e);r&&(0,n.dY)(()=>{const e=`stateMachineChart_${r.id}`,t=document.getElementById(e);t?(console.log("切换到手术标签页:",r.surgery_id),"4371-17"===r.surgery_id&&(console.log("=== 第四场手术调试信息 ==="),console.log("手术开始时间:",r.surgery_start_time),console.log("手术结束时间:",r.surgery_end_time),console.log("时间轴范围:",$(r)),console.log("开机时间:",W(r)),console.log("关机时间:",B(r)),console.log("状态机变化数据:",r.state_machine_changes),console.log("========================")),ce(r)):(console.warn("Canvas元素不存在，等待DOM渲染:",e),setTimeout(()=>{ce(r)},100))})}}),(0,n.sV)(async()=>{const t=e.query.logIds;if(t)await d();else if(u.value.length>0){const e=sessionStorage.getItem("autoAnalyze");"true"===e&&(sessionStorage.removeItem("autoAnalyze"),await w())}}),{surgeries:t,activeTab:r,armDetailsVisible:a,showAllAlarms:i,analyzing:s,logEntriesCount:c,analyzeLogs:w,exportReport:y,toggleArmDetails:f,toggleAlarms:p,scrollToAlarmCard:S,getArmUsages:v,getInstrumentRows:D,getArmTotalTime:k,getArmTimelineStyle:N,getArmTimelineSegments:R,getSurgeryTimelineStyle:z,getUsageTimelineStyle:P,getEnergyTime:X,getAlarmTypeTag:b,getAlarmDetails:x,formatTime:L,formatSurgeryTime:I,formatTimeShort:C,getTimePosition:E,getTimelineTicks:A,handleTabClick:ee,getAnalysisButtonText:_,getTimeRange:h,loadBatchLogEntriesByIds:d,pollTaskResult:T,getPowerOnTime:W,getPowerOffTime:B,getAllPowerOnTimes:V,getAllPowerOffTimes:U,getSurgeryTimelineStyle:z,getGroupedUsagesByUdi:j,getGroupedUsageDuration:H,getSegmentText:Q,getTimelineRange:$,getProgressTimelineRange:F,getSegmentInstrumentName:Z,getSortedTimelineEvents:K,getStateChanges:Y,getStateName:q,getStateBarHeight:G,getStateBarPosition:J,handleBeforeTabLeave:te,resetChartView:se,updateStateMachineChart:ce,getStateMachineChartData:ge,getStateMachineChartOptions:ue,getScrollbarThumbStyle:we,handleTrackClick:ye,startScrollbarDrag:fe,scrollChartLeft:ve,scrollChartRight:De,canScrollLeft:ke,canScrollRight:be,getScrollbarInfo:Le,checkSynchronization:xe}}},ue=r(6262);const ce=(0,ue.A)(ge,[["render",te],["__scopeId","data-v-026ed386"]]);var de=ce}}]);
//# sourceMappingURL=437.1467b344.js.map