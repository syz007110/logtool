"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[208],{540:function(e,t,n){n.d(t,{Js:function(){return a},RD:function(){return s},fU:function(){return i},u4:function(){return l}});let r=null;const a=async()=>{try{const e=await fetch("/api/timezone"),t=await e.json();"number"===typeof t.offsetMinutes&&(r=t.offsetMinutes)}catch(e){console.warn("加载服务器时区信息失败:",e),r=null}},i=(e,t=!0,n=!0)=>{if(!e)return"-";if(!n&&"string"===typeof e&&/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e))return e;let a;if("string"===typeof e)if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(e)){const t=e.replace(" ","T")+"Z";a=new Date(t)}else a=(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/.test(e),new Date(e));else a=new Date(e);if(isNaN(a.getTime()))return"-";if(t&&null!==r){const e=-a.getTimezoneOffset(),t=60*(r-e)*1e3;a.setTime(a.getTime()+t)}const i=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0"),o=String(a.getHours()).padStart(2,"0"),u=String(a.getMinutes()).padStart(2,"0"),m=String(a.getSeconds()).padStart(2,"0"),d=`${i}-${s}-${l} ${o}:${u}:${m}`;return d},s=(e,t=!0,n=!0)=>{if(!e)return"-";const a=new Date(e);if(isNaN(a.getTime()))return"-";if(t&&null!==r){const e=-a.getTimezoneOffset(),t=60*(r-e)*1e3;a.setTime(a.getTime()+t)}const i=String(a.getHours()).padStart(2,"0"),s=String(a.getMinutes()).padStart(2,"0");return`${i}:${s}`},l=(e,t=!0)=>{if(!e.surgery_start_time||!e.surgery_end_time)return"手术时间未确定";const n=i(e.surgery_start_time,t,!0),r=i(e.surgery_end_time,t,!0);return`${n} ~ ${r}`}},1088:function(e,t,n){n.d(t,{G8:function(){return i},d3:function(){return r},e$:function(){return a}});const r={ROW_GAP_PX:2,BAR_MAX_PX:40,BAR_RATIO:.8},a={TOOL_TYPE_COLORS:{"无器械":"#EBBA66","持针钳":"#D9EB66","电钩":"#96EB66","双极鸭嘴电凝钳":"#66EB77","直剪":"#FFB366","单极弧剪":"#FF9966","双极弧形电凝钳":"#FF6666","波茨剪":"#FF6666","无损伤镊":"#66CCFF","-30度内窥镜":"#3399FF","0度内窥镜":"#0066FF","30度内窥镜":"#6699FF","大持针钳":"#99CC66","鸭嘴抓钳":"#33CC99","鼠齿抓钳":"#00CC99"},ARM_BASE_COLORS:["#E28A6A","#E2C66A","#C2E26A","#86E26A"]};function i(e){if(null===e||void 0===e||""===e)return NaN;if("number"===typeof e&&Number.isFinite(e))return e;const t=new Date(e).getTime();return Number.isFinite(t)?t:NaN}},2208:function(e,t,n){n.r(t),n.d(t,{default:function(){return U}});var r=n(641),a=n(33),i=n(3751);const s={class:"viz-page"},l={class:"surgery-info"},o={class:"surgery-id"},u={class:"section-header"},m={class:"zoom-controls"},d={class:"zoom-level"},c={class:"timeline-header"},g=["x","y","width","height","fill","stroke","onClick","onMouseenter","onMouseleave"],v=["x","y","fill","onClick","onMouseenter","onMouseleave"],h={class:"timeline-body"},f={class:"arm-cell"},y=["data-merged","onMouseenter"],p={key:0,class:"circle-shape"},_={key:1,class:"square-shape"},S={class:"event-label"},w={key:0,class:"charts-row"},k={class:"chart-container"},x={class:"chart-container"},E={class:"faults-container"},C={class:"fault-time"},F={class:"fault-explanation"},T={key:0,class:"faults-summary"},M={class:"tooltip-title"},b={class:"tooltip-content"},L={class:"tooltip-title"},D={class:"tooltip-content"},A={key:0},$={class:"event-name"},I={class:"event-time"},N={key:1};function X(e,t,n,X,R,z){const W=(0,r.g2)("el-tag"),O=(0,r.g2)("el-card"),K=(0,r.g2)("TimeSeriesChart"),H=(0,r.g2)("el-table-column"),B=(0,r.g2)("el-table"),Y=(0,r.g2)("el-alert");return(0,r.uX)(),(0,r.CE)("div",s,[(0,r.bF)(O,{class:"title-card"},{default:(0,r.k6)(()=>[(0,r.Lk)("div",l,[(0,r.Lk)("span",o,(0,a.v_)(X.meta.surgery_id||"-"),1),X.meta.is_remote?((0,r.uX)(),(0,r.Wv)(W,{key:0,color:"green",size:"small",class:"surgery-tag remote-tag"},{default:(0,r.k6)(()=>[...t[7]||(t[7]=[(0,r.eW)("远程手术",-1)])]),_:1})):(0,r.Q3)("",!0),X.meta.is_fault?((0,r.uX)(),(0,r.Wv)(W,{key:1,color:"red",size:"small",class:"surgery-tag fault-tag"},{default:(0,r.k6)(()=>[...t[8]||(t[8]=[(0,r.eW)("故障手术",-1)])]),_:1})):(0,r.Q3)("",!0)])]),_:1}),(0,r.bF)(O,{class:"overview-card"},{default:(0,r.k6)(()=>[(0,r.Lk)("div",u,[t[9]||(t[9]=(0,r.eW)(" 手术概况 ",-1)),(0,r.Lk)("div",m,[(0,r.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>X.resetZoom&&X.resetZoom(...e)),class:"zoom-reset-btn"},"重置缩放"),(0,r.Lk)("span",d,(0,a.v_)(Math.round(100*X.zoomLevel))+"%",1)])]),(0,r.Lk)("div",{class:"timeline-container",onWheel:t[6]||(t[6]=(0,i.D$)((...e)=>X.handleWheel&&X.handleWheel(...e),["prevent"]))},[(0,r.Lk)("div",c,[t[10]||(t[10]=(0,r.Lk)("div",{class:"arm-column"},"活动名称",-1)),(0,r.Lk)("div",{class:"time-columns",style:(0,a.Tr)(X.getTimeColumnsStyle())},[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(Array(X.getTotalHours()).fill(0),(e,t)=>((0,r.uX)(),(0,r.CE)("div",{key:t,class:"time-column",style:(0,a.Tr)(X.getTimeColumnStyle())},(0,a.v_)(X.getTimeColumnText(t)),5))),128))],4)]),((0,r.uX)(),(0,r.CE)("svg",{class:"timeline-overlay",style:(0,a.Tr)(X.getOverlayStyle()),onClick:t[3]||(t[3]=(...e)=>X.handleOverlayClick&&X.handleOverlayClick(...e))},[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(X.armsData,e=>((0,r.uX)(),(0,r.CE)("g",{key:`arm-${e.arm_id}`},[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(X.getAllSegmentsForArm(e),n=>((0,r.uX)(),(0,r.CE)("g",{key:`segment-${n.udi}-${n.start}`},[(0,r.Lk)("rect",{x:X.getSegmentX(n),y:X.getSegmentY(e,n),width:X.getSegmentWidth(n),height:X.getSegmentHeight(),fill:X.getArmColor(e.arm_id),stroke:X.getStrokeColor(e.arm_id),"stroke-width":"2",rx:"3",ry:"3",class:"instrument-segment-svg",onClick:e=>X.handleSegmentClick(n,e),onMouseenter:e=>X.handleSegmentHover(n,e),onMousemove:t[1]||(t[1]=e=>X.handleMouseMove(e)),onMouseleave:e=>X.handleSegmentLeave(n,e)},null,40,g),X.shouldShowInstrumentText(n)?((0,r.uX)(),(0,r.CE)("text",{key:0,x:X.getSegmentTextX(n),y:X.getSegmentTextY(e,n),"text-anchor":"middle",class:"instrument-text",fill:X.getTextColor(e.arm_id),onClick:e=>X.handleSegmentClick(n,e),onMouseenter:e=>X.handleSegmentHover(n,e),onMousemove:t[2]||(t[2]=e=>X.handleMouseMove(e)),onMouseleave:e=>X.handleSegmentLeave(n,e)},(0,a.v_)(X.getInstrumentDisplayName(n)),41,v)):(0,r.Q3)("",!0)]))),128))]))),128))],4)),(0,r.Lk)("div",h,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(X.armsData,e=>((0,r.uX)(),(0,r.CE)("div",{key:e.arm_id,class:"timeline-row"},[(0,r.Lk)("div",f,(0,a.v_)(e.name),1),(0,r.Lk)("div",{class:"time-cells",style:(0,a.Tr)(X.getTimeCellsStyle())},[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(Array(X.getTotalHours()).fill(0),(n,i)=>((0,r.uX)(),(0,r.CE)("div",{key:i,class:(0,a.C4)(["time-grid",{"has-instrument":X.hasInstrumentInHour(e,i)}]),style:(0,a.Tr)(X.getTimeGridStyle())},[0===e.arm_id&&X.hasEventInHour(i)?((0,r.uX)(),(0,r.CE)("div",{key:0,class:"timeline-event-container",style:(0,a.Tr)(X.getEventStyle(i))},[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(X.getEventsInHour(i),(e,n)=>((0,r.uX)(),(0,r.CE)("div",{key:`${e.type}-${n}`,class:(0,a.C4)(["timeline-event",X.getEventClass(e.type)]),style:(0,a.Tr)(X.getSingleEventStyle(e,i)),"data-merged":e.isMerged,onMouseenter:t=>X.handleEventHover(e,t),onMousemove:t[4]||(t[4]=e=>X.handleMouseMove(e)),onMouseleave:t[5]||(t[5]=(...e)=>X.handleEventLeave&&X.handleEventLeave(...e))},[(0,r.Lk)("div",{class:(0,a.C4)(["event-symbol",X.getSymbolClass(e.symbol)])},["circle"===e.symbol?((0,r.uX)(),(0,r.CE)("div",p)):((0,r.uX)(),(0,r.CE)("div",_))],2),(0,r.Lk)("div",S,(0,a.v_)(e.name),1)],46,y))),128))],4)):(0,r.Q3)("",!0)],6))),128))],4)]))),128))])],32)]),_:1}),X.showCharts&&(X.hasStateMachineData||X.hasNetworkLatencyData)?((0,r.uX)(),(0,r.CE)("div",w,[X.hasStateMachineData?((0,r.uX)(),(0,r.Wv)(O,{key:0,class:"state-machine-card"},{default:(0,r.k6)(()=>[t[11]||(t[11]=(0,r.Lk)("div",{class:"section-header"}," 手术状态机变化 ",-1)),(0,r.Lk)("div",k,[(0,r.bF)(K,{"series-data":X.stateMachineChartData,"series-name":"状态机",height:300,width:600,"y-axis-format":"integer","show-range-labels":!0},null,8,["series-data"])])]),_:1})):(0,r.Q3)("",!0),X.meta.is_remote&&X.hasNetworkLatencyData?((0,r.uX)(),(0,r.Wv)(O,{key:1,class:"network-latency-card"},{default:(0,r.k6)(()=>[t[12]||(t[12]=(0,r.Lk)("div",{class:"section-header"}," 网络延迟情况 ",-1)),(0,r.Lk)("div",x,[(0,r.bF)(K,{"series-data":X.networkLatencyChartData,"series-name":"网络延迟(ms)",height:300,width:600,"y-axis-format":"decimal","show-range-labels":!0},null,8,["series-data"])])]),_:1})):(0,r.Q3)("",!0)])):(0,r.Q3)("",!0),X.showCharts&&X.meta.is_fault&&X.faultRecords.length>0?((0,r.uX)(),(0,r.Wv)(O,{key:1,class:"faults-card"},{default:(0,r.k6)(()=>[t[13]||(t[13]=(0,r.Lk)("div",{class:"section-header"}," 安全报警记录 ",-1)),(0,r.Lk)("div",E,[(0,r.bF)(B,{data:X.faultRecords,stripe:"",border:"",size:"small","max-height":400,class:"faults-table"},{default:(0,r.k6)(()=>[(0,r.bF)(H,{prop:"timestamp",label:"故障发生时间",width:"180",align:"center"},{default:(0,r.k6)(({row:e})=>[(0,r.Lk)("span",C,(0,a.v_)(X.formatFaultTime(e.timestamp)),1)]),_:1}),(0,r.bF)(H,{prop:"error_code",label:"故障码",width:"120",align:"center"},{default:(0,r.k6)(({row:e})=>[(0,r.bF)(W,{type:X.getFaultType(e.error_code),size:"small"},{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(e.error_code),1)]),_:2},1032,["type"])]),_:1}),(0,r.bF)(H,{prop:"explanation",label:"故障释义","min-width":"200"},{default:(0,r.k6)(({row:e})=>[(0,r.Lk)("span",F,(0,a.v_)(e.explanation||"无详细说明"),1)]),_:1}),(0,r.bF)(H,{prop:"status",label:"状态",width:"100",align:"center"},{default:(0,r.k6)(({row:e})=>[(0,r.bF)(W,{type:"已处理"===e.status?"success":"danger",size:"small",effect:"dark"},{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(e.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"]),X.faultRecords.length>0?((0,r.uX)(),(0,r.CE)("div",T,[(0,r.bF)(Y,{title:`共发现 ${X.faultRecords.length} 个故障，其中 ${X.getProcessedCount()} 个已处理，${X.getUnprocessedCount()} 个未处理`,type:"info",closable:!1,"show-icon":""},null,8,["title"])])):(0,r.Q3)("",!0)])]),_:1})):(0,r.Q3)("",!0),X.hoveredSegment?((0,r.uX)(),(0,r.CE)("div",{key:2,class:"custom-tooltip",style:(0,a.Tr)(X.getTooltipStyle())},[(0,r.Lk)("div",M,(0,a.v_)(X.getSegmentTooltipTitle(X.hoveredSegment)),1),(0,r.Lk)("div",b,[(0,r.Lk)("div",null,"UDI码: "+(0,a.v_)(X.hoveredSegment.udi||"无UDI"),1),(0,r.Lk)("div",null,"使用时长: "+(0,a.v_)(X.getSegmentDuration(X.hoveredSegment))+"分钟",1),(0,r.Lk)("div",null,"安装时刻: "+(0,a.v_)(X.formatSegmentTime(X.hoveredSegment.install_time||X.hoveredSegment.start_time)),1),(0,r.Lk)("div",null,"拔下时刻: "+(0,a.v_)(X.formatSegmentTime(X.hoveredSegment.remove_time||X.hoveredSegment.end_time)),1)])],4)):(0,r.Q3)("",!0),X.hoveredEvent?((0,r.uX)(),(0,r.CE)("div",{key:3,class:"custom-tooltip",style:(0,a.Tr)(X.getTooltipStyle())},[(0,r.Lk)("div",L,(0,a.v_)(X.hoveredEvent.isMerged?`合并事件 (${X.hoveredEvent.allEvents.length}个)`:X.hoveredEvent.name),1),(0,r.Lk)("div",D,[X.hoveredEvent.isMerged&&X.hoveredEvent.allEvents?((0,r.uX)(),(0,r.CE)("div",A,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(X.hoveredEvent.allEvents,e=>((0,r.uX)(),(0,r.CE)("div",{key:e.time,class:"event-item"},[(0,r.Lk)("div",$,(0,a.v_)(e.name),1),(0,r.Lk)("div",I,(0,a.v_)(X.formatEventTime(e)),1)]))),128))])):((0,r.uX)(),(0,r.CE)("div",N,[(0,r.Lk)("div",null,"时间: "+(0,a.v_)(X.formatEventTime(X.hoveredEvent)),1)]))])],4)):(0,r.Q3)("",!0)])}var R=n(953),z=n(5220),W=n(5495),O=(n(1088),n(540)),K=n(3110),H={name:"SurgeryVisualization",components:{TimeSeriesChart:K.A},setup(){const e=(0,R.KR)(!1),t=(0,R.KR)(""),a=(0,z.lq)(),i=(0,R.Kh)({surgery_id:null,start_time:null,end_time:null,is_remote:!1,is_fault:!1}),s=(0,R.KR)([]),l=(0,R.KR)(!1),o=(0,R.KR)(null),u=(0,R.KR)([{name:"手术时间线",arm_id:0,segments:[]},{name:"1号臂",arm_id:1,segments:[]},{name:"2号臂",arm_id:2,segments:[]},{name:"3号臂",arm_id:3,segments:[]},{name:"4号臂",arm_id:4,segments:[]}]),m=(0,R.KR)([]),d=(0,R.KR)(null),c=(0,R.KR)(null),g=(0,R.KR)(null),v=(0,R.KR)({x:0,y:0}),h=(0,R.KR)(1),f=1,y=5,p=(0,R.KR)(!1),_=(0,R.KR)(!1),S=(0,R.KR)(!1),w=(0,R.KR)([]),k=(0,R.KR)([]),x=(0,R.KR)([]),E=()=>{if(0===m.value.length)return 24;let e=1/0,t=-1/0;if(m.value.forEach(n=>{const r=ce(n.time);null!==r&&void 0!==r&&(e=Math.min(e,r),t=Math.max(t,r))}),e===1/0||t===-1/0)return 24;const n=e-1,r=t+1,a=r-n+1;return Math.min(48,a)},C=()=>{if(0===m.value.length)return 0;let e=1/0;return m.value.forEach(t=>{const n=ce(t.time);null!==n&&void 0!==n&&(e=Math.min(e,n))}),e===1/0?0:e-1},F=()=>{if(0===m.value.length)return{start:0,end:23};let e=1/0,t=-1/0;return m.value.forEach(n=>{const r=ce(n.time);null!==r&&void 0!==r&&(e=Math.min(e,r),t=Math.max(t,r))}),e===1/0||t===-1/0?{start:0,end:23}:{start:e-1,end:t+1}},T=(e,t)=>{if(0===e.arm_id)return!1;const n=C(),r=n+t,a=e.segments.some(e=>{const t=ce(e.start_time||e.start||e.install_time),n=ce(e.end_time||e.end||e.remove_time);return r>=t&&r<=n});return a},M=(e,t)=>{if(0===e.arm_id)return[];const n=C(),r=n+t,a=e.segments.filter(e=>{const t=ce(e.start_time||e.start||e.install_time),n=ce(e.end_time||e.end||e.remove_time);return r>=t&&r<=n});return a},b=(e,t)=>{const n=C(),r=n+t,a=60*r,i=60*(r+1),s=ge(e.start_time||e.start||e.install_time),l=ge(e.end_time||e.end||e.remove_time),o=Math.max(0,(s-a)/60*100),u=Math.max(0,(i-l)/60*100);return{left:`${o}%`,right:`${u}%`,backgroundColor:ke(e.tool_type||e.instrument_type||""),zIndex:10}},L=e=>{const t=ve(e.start||e.install_time||e.start_time,e.end||e.remove_time||e.end_time),n=e.tool_type||e.instrument_type||"未知器械",r=e.udi||"无UDI",a=e.install_time||e.start_time,i=e.remove_time||e.end_time,s=e=>{if(!e)return"未知";const t=Ce(e);return t?t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"未知"};return`${n}\n\nUDI码: ${r}\n使用时长: ${t}分钟\n安装时刻: ${s(a)}\n拔下时刻: ${s(i)}`},D=()=>{if(1===h.value)return{position:"absolute",top:"0",left:"120px",width:"calc(100% - 120px)",height:"100%",pointerEvents:"auto",zIndex:"20"};{const e=E(),t=window.innerWidth-120,n=t/e,r=n*h.value,a=r*e;return{position:"absolute",top:"0",left:"120px",width:`${a}px`,height:"100%",pointerEvents:"auto",zIndex:"20"}}},A=e=>0===e.arm_id?[]:e.segments||[],$=e=>{const t=e.start_time||e.start||e.install_time,n=Ce(t);if(!n)return 0;const r=ce(t),a=ge(t),i=C(),s=r-i,l=a/60,o=E(),u=document.querySelector(".timeline-container");let m;if(1===h.value)m=u?u.offsetWidth-120:window.innerWidth-120;else{const e=window.innerWidth-120,t=e/o,n=t*h.value;m=n*o}const d=(s+l)/o,c=100*d,g=c/100*m;return Math.max(0,g)},I=(e,t)=>{const n=u.value.findIndex(t=>t.arm_id===e.arm_id),r=60,a=50;return a+n*r+(r-32)/2},N=e=>{const t=e.start_time||e.start||e.install_time,n=e.end_time||e.end||e.remove_time,r=Ce(t),a=Ce(n);if(!r||!a)return 10;const i=a.getTime()-r.getTime(),s=i/6e4;if(s<1)return Math.max(1,2);const l=E();let o;if(1===h.value){const e=document.querySelector(".timeline-container");o=e?e.offsetWidth-120:window.innerWidth-120}else{const e=window.innerWidth-120,t=e/l,n=t*h.value;o=n*l}const u=o/l,m=u/60,d=s*m;return Math.max(3,d)},X=e=>{const t=e.end_time||e.end||e.remove_time,n=Ce(t);if(!n)return 0;const r=ce(t),a=ge(t),i=C(),s=r-i,l=a/60,o=E(),u=document.querySelector(".timeline-container");let m;if(1===h.value)m=u?u.offsetWidth-120:window.innerWidth-120;else{const e=window.innerWidth-120,t=e/o,n=t*h.value;m=n*o}const d=(s+l)/o,c=100*d,g=c/100*m;return Math.max(0,g)},K=()=>25,H=(e,t)=>{t.stopPropagation()},B=(e,t)=>{c.value=e,v.value={x:t.clientX+5,y:t.clientY-5}},Y=(e,t)=>{c.value=null},U=e=>{v.value={x:e.clientX+5,y:e.clientY-5}},Q=(e,t)=>{g.value=e,v.value={x:t.clientX+5,y:t.clientY-5}},q=()=>{g.value=null},Z=()=>({position:"fixed",left:`${v.value.x}px`,top:`${v.value.y}px`,zIndex:9999}),P=e=>{const t=Ce(e?.time);return t?t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"未知"},G=e=>{const t=Ce(e?.time);return t?t.toLocaleDateString("zh-CN",{weekday:"long"}):""},j=e=>e.tool_type||e.instrument_type||"未知器械",J=e=>ve(e.start||e.install_time||e.start_time,e.end||e.remove_time||e.end_time),V=e=>{if(!e)return"未知";const t=Ce(e);return t?t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"未知"},ee=e=>{},te=e=>{const t=C(),n=t+e;return m.value.some(e=>{const t=ce(e.time);return t===n})},ne=e=>{const t=C(),n=t+e,r=m.value.filter(e=>{const t=ce(e.time);return t===n});return 1===r.length?r[0].name:r.length>1?`${r[0].name}+${r.length-1}`:""},re=e=>"power_on"===e||"power_off"===e?"timeline-event-power":"surgery_start"===e||"surgery_end"===e||"previous_end"===e?"timeline-event-surgery":"",ae=e=>{const t=C(),n=t+e,r=m.value.filter(e=>{const t=ce(e.time);return t===n});return r.length>0?r[0].type:""},ie=e=>{const t=C(),n=t+e,r=m.value.filter(e=>{const t=ce(e.time);return t===n});return 0===r.length?[]:(r.sort((e,t)=>{const n=Ce(e.time)?.getTime()||0,r=Ce(t.time)?.getTime()||0;return n-r}),se(r,e))},se=(e,t)=>{if(e.length<=1)return e;const n=120,r=window.innerWidth-n,a=r*h.value,i=e.map(e=>{const t=Ce(e.time);if(!t)return{event:e,left:50,right:50};const n=t.getMinutes(),r=n/60*100,i=Math.max(0,Math.min(100,r)),s=e.isMerged?`+${e.allEvents.length}`:e.name,l=Math.max(40,8*s.length+16),o=l*h.value,u=i,m=i+o/a*100;return{event:e,left:u,right:m,displayName:s}}),s=[];let l=[i[0]];for(let u=1;u<i.length;u++){const e=i[u],t=l[l.length-1],n=Ce(e.event.time),r=Ce(t.event.time),o=(n.getTime()-r.getTime())/6e4,m=E(),d=a/m,c=d/60,g=o*c;console.log("🔍 事件间距检测:",{event1:t.event.name,event2:e.event.name,timeDiffMinutes:o.toFixed(2)+"分钟",pixelSpacing:g.toFixed(2)+"px",zoomLevel:h.value.toFixed(2),scaledContainerWidth:a.toFixed(2)+"px",hourCellWidth:d.toFixed(2)+"px",minuteWidth:c.toFixed(2)+"px/分钟",shouldMerge:g<30?"是":"否"}),g<20?l.push(e):(s.push(le(l)),l=[e])}l.length>0&&s.push(le(l));const o=s.flat();return console.log(`📊 事件合并结果 (缩放级别: ${h.value.toFixed(2)}):`,{originalEvents:e.length,finalEvents:o.length,mergedEvents:o.filter(e=>e.isMerged).length,mergedDetails:o.filter(e=>e.isMerged).map(e=>({name:e.name,count:e.allEvents.length,events:e.allEvents.map(e=>e.name)}))}),o},le=e=>{if(1===e.length)return[e[0].event];const t=e[0].event;return[{...t,name:`+${e.length}`,isMerged:!0,allEvents:e.map(e=>e.event)}]},oe=e=>{if(!e)return"事件数据不存在";if(e.isMerged&&e.allEvents){const t=e.allEvents.map(e=>{const t=Ce(e.time);if(!t)return e.name;const n=t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});return`${e.name}\n时间: ${n}`}).join("\n\n");return`合并事件 (${e.allEvents.length}个):\n\n${t}`}const t=Ce(e.time);if(!t)return`${e.name}\n时间: 解析失败`;const n=t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),r=t.toLocaleDateString("zh-CN",{weekday:"long"});return`${e.name}\n时间: ${n}\n星期: ${r}`},ue=e=>"circle"===e?"symbol-circle":"symbol-square",me=e=>({position:"relative",height:"100%",width:"100%"}),de=(e,t)=>{const n=C(),r=n+t,a=ce(e.time);if(a!==r)return{display:"none"};const i=Ce(e.time);if(!i)return{left:"50%",transform:"translate(-50%, -50%)"};i.getHours();const s=i.getMinutes(),l=s/60*100,o=Math.max(0,Math.min(100,l));return{position:"absolute",left:`${o}%`,top:"50%",transform:"translate(-50%, -50%)",zIndex:10}},ce=e=>{if(!e)return 0;const t=Ce(e);if(!t)return 0;if(d.value){const e=Ce(d.value);if(e){const n=e.getDate(),r=t.getDate();if(r>n)return t.getHours()+24}}return t.getHours()},ge=e=>{if(!e)return 0;const t=Ce(e);if(!t)return 0;if(d.value){const e=Ce(d.value);if(e){const n=e.getDate(),r=t.getDate();if(r>n)return t.getMinutes()+1440}}return t.getMinutes()},ve=(e,t)=>{const n=Ee(e),r=Ee(t);return Number.isFinite(n)&&Number.isFinite(r)?Math.round((r-n)/1e3/60):0},he=e=>{switch(e){case 1:return"#2752F1E5";case 2:return"#30B33B";case 3:return"#FEBB0F99";case 4:return"#FF6347";default:return"#722ed1"}},fe=e=>{switch(e){case 1:return"#FFFFFF";case 2:return"#FFFFFF";case 3:return"#000000";case 4:return"#FFFFFF";default:return"#FFFFFF"}},ye=e=>{switch(e){case 1:return"#0000001A";case 2:return"#0000001A";case 3:return"#0000001A";case 4:return"#0000001A";default:return"#4A148C"}},pe=e=>{const t=N(e);return t>60},_e=e=>{const t=$(e),n=N(e);return t+n/2},Se=(e,t)=>{const n=I(e,t),r=K();return n+r/2+4},we=e=>{const t=e.tool_type||e.instrument_type||"";return t||"未知器械"},ke=e=>e?e.includes("刀具")||e.includes("剪刀")?"#ff4d4f":e.includes("摄像头")||e.includes("内窥镜")?"#1890ff":e.includes("镊子")||e.includes("钳子")?"#52c41a":e.includes("缝合器")?"#fa8c16":e.includes("持针")?"#13c2c2":e.includes("抓钳")?"#eb2f96":"#722ed1":"#722ed1",xe=e=>{if(!d.value)return"00:00";const t=Ce(d.value);if(!t)return"00:00";const n=new Date(t.getTime()+60*e*60*1e3),r=n.getHours(),a=t.getDate(),i=n.getDate();return i>a?`(${String(r).padStart(2,"0")}:00+1)`:`${String(r).padStart(2,"0")}:00`},Ee=e=>{if(null===e||void 0===e||""===e)return NaN;if("number"===typeof e&&Number.isFinite(e))return e;if("string"===typeof e){let t=e.trim();/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(t)&&(t=t.includes("Z")||t.includes("+")||t.includes("-",10)?t.replace(" ","T"):t.replace(" ","T")+"Z");const n=Date.parse(t);return Number.isFinite(n)?n:NaN}const t=new Date(e).getTime();return Number.isFinite(t)?t:NaN},Ce=e=>{if(!e)return null;const t=Ee(e);if(!Number.isFinite(t))return null;const n=new Date(t);return n},Fe=e=>{const t=Array.isArray(e?.arms)?e.arms:[],n=t.map((e,t)=>{const n=e.arm_id||t+1,r=e.name||`${n}号臂`,a=Array.isArray(e.instrument_usage)?e.instrument_usage:[];return{name:r,arm_id:n,segments:a}}),r=[];for(let u=1;u<=4;u++){const e=n.find(e=>e.arm_id===u);e?r.push(e):r.push({name:`${u}号臂`,arm_id:u,segments:[]})}u.value=[{name:"手术时间线",arm_id:0,segments:[]},...r];const a=[],i=e?.power_cycles||[];i.forEach((e,t)=>{e.on_time&&a.push({time:e.on_time,name:`开机${t+1}`,type:"power_on",symbol:"square"}),e.off_time&&a.push({time:e.off_time,name:`关机${t+1}`,type:"power_off",symbol:"square"})});const s=i.length>0?i[0]?.on_time:null,l=e?.surgeryStart||e?.start_time,o=e?.surgeryEnd||e?.end_time,c=e?.previousSurgeryEnd||e?.timeline?.previousSurgeryEnd;if(s){const e=Ce(s);if(e){const t=new Date(e.getTime()-36e5);d.value=t.toISOString()}}else{const e=l||new Date,t=Ce(e)||new Date(e);d.value=t.toISOString()}c&&a.push({time:c,name:"上一台手术结束",type:"previous_end",symbol:"circle"}),l&&a.push({time:l,name:"手术开始",type:"surgery_start",symbol:"circle"}),o&&a.push({time:o,name:"手术结束",type:"surgery_end",symbol:"circle"}),m.value=a},Te=e=>{i.surgery_id=e.surgery_id||null,i.start_time=e.start_time||null,i.end_time=e.end_time||null,i.is_remote=!0===e.is_remote,i.is_fault=!0===e.has_fault||!1,o.value=e,Fe(e),Pe(e);const t=e.surgery_stats||{};_.value=!!t.state_machine,S.value=!(!t.network_latency_ms||!i.is_remote),p.value=_.value||S.value,p.value&&(0,r.dY)(()=>{De(e)})},Me=()=>{try{const e=sessionStorage.getItem("surgeryVizData");if(!e)return;const t=JSON.parse(e);console.log("🔧 获取到的手术数据:",t),Te(t)}catch(e){}},be=async()=>{if(t.value){e.value=!0;try{const e=await W.A.surgeries.get(t.value),r=e.data?.data||e.data;console.log("🔧 获取到的手术数据:",r);const{adaptSurgeryData:a,validateAdaptedData:i}=await n.e(662).then(n.bind(n,7662)),s=a(r);if(!s||!i(s))throw new Error("数据适配或验证失败");s._dataSource="database_record",s._originalData=r,Te(s)}catch(r){}finally{e.value=!1}}},Le=()=>{},De=e=>{const t=e.surgery_stats||{};t.state_machine&&Array.isArray(t.state_machine)&&(w.value=Ae(t.state_machine)),t.network_latency_ms&&Array.isArray(t.network_latency_ms)&&i.is_remote&&(k.value=Ie(t.network_latency_ms)),t.faults&&Array.isArray(t.faults)&&(x.value=Ne(t.faults))},Ae=e=>{if(!Array.isArray(e))return[];try{const t=e.map(e=>{const t=e.time||e.timestamp;if(!t)return[Date.now(),0];const n=Ce(t);if(!n)return[Date.now(),0];const r=e.state||"",a=$e(r);return[n.getTime(),a]});return t}catch(t){return[]}},$e=e=>{if(!e)return 0;const t=e.match(/\((\d+)\)/);if(t)return parseInt(t[1],10);const n=e.match(/\d+/);return n?parseInt(n[0],10):0},Ie=e=>{if(!Array.isArray(e))return[];try{return e.map(e=>{const t=e.time||e.timestamp;if(!t)return[Date.now(),0];const n=Ce(t);if(!n)return[Date.now(),0];const r=e.latency||e.value||0;return[n.getTime(),r]})}catch(t){return[]}},Ne=e=>{if(!Array.isArray(e))return[];try{const t=new Map;return e.forEach(e=>{const n=e.error_code;n&&(!t.has(n)||new Date(e.timestamp)>new Date(t.get(n).timestamp))&&t.set(n,{timestamp:e.timestamp,error_code:e.error_code,explanation:e.explanation||"无详细说明",status:e.status||"未处理"})}),Array.from(t.values()).sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp))}catch(t){return[]}},Xe=e=>{if(!e)return"未知时间";try{const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch(t){return e}},Re=e=>{if(!e)return"info";const t=e.slice(-1).toUpperCase();switch(t){case"A":return"danger";case"B":return"warning";case"C":return"info";case"D":return"success";case"E":return"";default:return"info"}},ze=()=>x.value.filter(e=>"已处理"===e.status).length,We=()=>x.value.filter(e=>"未处理"===e.status).length,Oe=e=>{const t=e.currentTarget;if(!t||!t.classList.contains("timeline-container"))return;!1!==e.cancelable&&(e.preventDefault(),e.stopPropagation());const n=120,a=t.getBoundingClientRect(),i=e.clientX-a.left,s=Math.max(0,i-n),l=Math.max(1,t.clientWidth-n),o=l,u=o*h.value,d=(t.scrollLeft+s)/Math.max(1,u),c=e.deltaY,g=c>0?.9:1.1,v=Math.max(f,Math.min(y,h.value*g));if(v===h.value)return;h.value=v;const p=o*v;let _=d*p-s;const S=Math.max(0,p-l);_=Math.max(0,Math.min(S,_)),(0,r.dY)(()=>{t.scrollLeft=_;const e=document.querySelector(".timeline-overlay");e&&(e.style.display="none",e.offsetHeight,e.style.display=""),m.value=[...m.value]})},Ke=()=>{h.value=1},He=()=>{if(1===h.value)return{flex:1};{const e=100-120/window.innerWidth*100,t=e*h.value;return{width:`${t}%`}}},Be=()=>{if(1===h.value)return{flex:1};{const e=100-120/window.innerWidth*100,t=e*h.value;return{width:`${t}%`}}},Ye=()=>{if(1===h.value)return{flex:1,flexShrink:0};{const e=E(),t=window.innerWidth,n=120,r=t-n,a=r/e,i=a*h.value;return{width:`${i}px`,flexShrink:0}}},Ue=()=>{if(1===h.value)return{flex:1,flexShrink:0};{const e=E(),t=window.innerWidth,n=120,r=t-n,a=r/e,i=a*h.value;return{width:`${i}px`,flexShrink:0}}},Qe=()=>{const e=sessionStorage.getItem("surgeryVizData");if(e)try{const t=JSON.parse(e);console.log("🔧 获取到的手术数据:",t)}catch(t){}};(0,r.sV)(async()=>{await(0,O.Js)(),window.addEventListener("resize",Le),window.debugSurgeryData=()=>{Qe()},(0,r.dY)(()=>{});const e=a?.query?.id||a?.params?.id;e?(t.value=String(e),be()):Me()}),(0,r.xo)(()=>{window.removeEventListener("resize",Le)});const qe=e=>(0,O.fU)(e),Ze=(0,R.Kh)({powerOn:"-",previousSurgeryEnd:"-",surgeryStart:"-",surgeryEnd:"-",powerOff:"-"}),Pe=e=>{const t=Array.isArray(e?.security_alerts)?e.security_alerts:Array.isArray(e?.error_codes)?e.error_codes:[],n=t.map(e=>({time:qe(e.time||e.timestamp),code:e.code||e.errCode||"-",message:e.message||e.explanation||"-",status:void 0!==e.status&&null!==e.status?String(e.status):!0===e.resolved||!0===e.is_resolved?"已处理":"未处理"}));s.value=n;const r=e?.timeline||{};Ze.powerOn=qe(r.powerOn),Ze.previousSurgeryEnd=qe(r.previousSurgeryEnd),Ze.surgeryStart=qe(r.surgeryStart||i.start_time),Ze.surgeryEnd=qe(r.surgeryEnd||i.end_time),Ze.powerOff=qe(r.powerOff)},Ge=(0,r.EW)(()=>{const e=s.value||[];return l.value?e:e.slice(0,5)}),je=()=>{try{const e=o.value||{},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json;charset=utf-8"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r;const s=i.surgery_id||"unknown";a.download=`surgery_${s}_structured.json`,a.click(),URL.revokeObjectURL(r)}catch(e){}};return{loadFromStorage:Me,loadById:be,loading:e,surgeryIdInput:t,meta:i,exportStructured:je,visibleAlertRows:Ge,showAllAlerts:l,timelineDisplay:Ze,armsData:u,timelineEvents:m,hoveredSegment:c,hoveredEvent:g,hasInstrumentInHour:T,getSegmentsInHour:M,getSegmentStyle:b,getSegmentTooltip:L,hasEventInHour:te,getEventText:ne,getEventClass:re,getEventType:ae,getEventStyle:me,getSingleEventStyle:de,getEventsInHour:ie,getEventTooltip:oe,getSymbolClass:ue,getTimeColumnText:xe,getTotalHours:E,getTableStartHour:C,getHourRange:F,zoomLevel:h,handleWheel:Oe,resetZoom:Ke,getTimeColumnsStyle:He,getTimeCellsStyle:Be,getTimeColumnStyle:Ye,getTimeGridStyle:Ue,getOverlayStyle:D,getAllSegmentsForArm:A,getSegmentX:$,getSegmentY:I,getSegmentWidth:N,getSegmentHeight:K,getSegmentEndX:X,getInstrumentColor:ke,handleSegmentClick:H,handleSegmentHover:B,handleSegmentLeave:Y,handleMouseMove:U,handleEventHover:Q,handleEventLeave:q,handleOverlayClick:ee,getTooltipStyle:Z,getSegmentTooltipTitle:j,formatEventTime:P,getEventWeekday:G,processEventGroup:le,getSegmentDuration:J,formatSegmentTime:V,getArmColor:he,getTextColor:fe,getStrokeColor:ye,shouldShowInstrumentText:pe,getSegmentTextX:_e,getSegmentTextY:Se,getInstrumentDisplayName:we,showCharts:p,hasStateMachineData:_,hasNetworkLatencyData:S,stateMachineChartData:w,networkLatencyChartData:k,faultRecords:x,formatFaultTime:Xe,getFaultType:Re,getProcessedCount:ze,getUnprocessedCount:We}}},B=n(6262);const Y=(0,B.A)(H,[["render",X],["__scopeId","data-v-42c68784"]]);var U=Y},3110:function(e,t,n){n.d(t,{A:function(){return d}});var r=n(641),a=n(33);function i(e,t,n,i,s,l){return(0,r.uX)(),(0,r.CE)("div",{ref:"chartContainer",style:(0,a.Tr)({width:n.width?n.width+"px":"100%",height:n.height+"px"})},null,4)}var s=n(953),l=n(8605),o={name:"TimeSeriesChart",props:{seriesData:{type:Array,default:()=>[]},seriesName:{type:String,default:"数据"},height:{type:Number,default:300},width:{type:Number,default:600},yAxisFormat:{type:String,default:"decimal"},showRangeLabels:{type:Boolean,default:!0}},setup(e){const t=(0,s.KR)(null);let n=null;const a=()=>{if(!t.value||!e.seriesData||0===e.seriesData.length)return;n&&n.dispose(),n=l.Ts(t.value);const r=e.seriesData.filter(e=>Array.isArray(e)&&e.length>=2&&"number"===typeof e[0]&&"number"===typeof e[1]&&!isNaN(e[0])&&!isNaN(e[1])&&isFinite(e[0])&&isFinite(e[1]));if(0===r.length)return n.dispose(),void(n=null);const a={title:void 0,tooltip:{trigger:"axis",position:e=>[e[0],"10%"]},legend:void 0,toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},xAxis:{type:"time",boundaryGap:!1,min:Math.min(...r.map(e=>e[0])),max:Math.max(...r.map(e=>e[0]))},yAxis:{type:"value",boundaryGap:[0,"100%"],axisLabel:{width:40,overflow:"truncate",formatter:t=>"integer"===e.yAxisFormat?Math.round(t).toString():"decimal"===e.yAxisFormat?t.toFixed(1):t.toString()}},dataZoom:[{type:"inside",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,xAxisIndex:0,filterMode:"filter",preventDefaultMouseMove:!0},{type:"slider",start:0,end:100,realtime:!0,throttle:100,zoomLock:!1,showDetail:!0,showDataShadow:!0,xAxisIndex:0,bottom:10,filterMode:"filter",moveHandleSize:8,preventDefaultMouseMove:!0}],series:[{name:e.seriesName,type:"line",symbol:"none",sampling:!1,data:r,lineStyle:{width:2},areaStyle:{opacity:.3}}]};n.setOption(a,!0)},i=()=>{n&&n.resize()};return(0,r.wB)(()=>e.seriesData,()=>{(0,r.dY)(()=>{a()})},{deep:!0}),(0,r.wB)(()=>e.height,()=>{(0,r.dY)(()=>{i()})}),(0,r.wB)(()=>e.width,()=>{(0,r.dY)(()=>{i()})}),(0,r.sV)(()=>{(0,r.dY)(()=>{a()}),window.addEventListener("resize",i)}),(0,r.xo)(()=>{n&&(n.dispose(),n=null),window.removeEventListener("resize",i)}),{chartContainer:t}}},u=n(6262);const m=(0,u.A)(o,[["render",i],["__scopeId","data-v-59aa7af9"]]);var d=m}}]);
//# sourceMappingURL=208.7954d91a.js.map