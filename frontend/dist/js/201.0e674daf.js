"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[201],{1201:function(e,t,r){r.r(t),r.d(t,{default:function(){return me}});var a=r(641),n=r(33),s=r(3751);const i={class:"surgery-statistics-container"},l={key:0,class:"analysis-section"},o={class:"empty-content"},g={key:0},m={key:1},u={key:1,class:"analysis-section"},c={class:"empty-content"},d={key:2},_={class:"export-section"},f={class:"surgery-info-layout"},p={class:"timeline-section"},h={class:"info-header"},y={class:"badges"},w={class:"timeline-text"},k={class:"state-chart-section"},v={class:"card-header"},T={class:"unified-timeline-view"},b={class:"surgery-progress-container"},L={class:"surgery-duration-info"},S={class:"duration-text"},D={class:"time-range"},$={class:"surgery-timeline-wrapper"},F={class:"surgery-timeline-container"},C={class:"surgery-timeline-bar"},E={class:"progress-labels"},A={class:"time-label"},I={class:"time-label"},x={class:"arm-timeline"},M={class:"arm-header"},N={class:"arm-actions"},O={class:"arm-timeline-container"},X={class:"arm-label"},z={class:"arm-name"},W={class:"arm-timeline-bar"},P={class:"arm-details"},U={class:"usage-group-header"},R={class:"usage-group-info"},B={class:"usage-group-name"},V={class:"usage-group-udi"},K={class:"usage-group-duration"},J={class:"arm-timeline-container"},G={class:"arm-timeline-bar"},j={class:"segment-content"},q={class:"segment-text"},H={class:"energy-time"},Q={key:0,class:"alarm-toggle"},Y={class:"alarm-summary"};function Z(e,t,r,Z,ee,te){const re=(0,a.g2)("Calendar"),ae=(0,a.g2)("el-icon"),ne=(0,a.g2)("DataAnalysis"),se=(0,a.g2)("el-button"),ie=(0,a.g2)("el-card"),le=(0,a.g2)("Loading"),oe=(0,a.g2)("Download"),ge=(0,a.g2)("InfoFilled"),me=(0,a.g2)("el-tag"),ue=(0,a.g2)("el-timeline-item"),ce=(0,a.g2)("el-timeline"),de=(0,a.g2)("ArrowDown"),_e=(0,a.g2)("el-tooltip"),fe=(0,a.g2)("Lightning"),pe=(0,a.g2)("el-collapse-transition"),he=(0,a.g2)("el-table-column"),ye=(0,a.g2)("el-table"),we=(0,a.g2)("ArrowUp"),ke=(0,a.g2)("el-tab-pane"),ve=(0,a.g2)("el-tabs");return(0,a.uX)(),(0,a.CE)("div",i,[t[15]||(t[15]=(0,a.Lk)("div",{class:"action-bar"},[(0,a.Lk)("div",{class:"title-section"},[(0,a.Lk)("h2",{class:"page-title"},"手术统计"),(0,a.Lk)("p",{class:"page-subtitle"},"查看和分析各场手术的详细统计数据")])],-1)),Z.surgeries.length||Z.analyzing?(0,a.Q3)("",!0):((0,a.uX)(),(0,a.CE)("div",l,[(0,a.bF)(ie,{class:"empty-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",o,[(0,a.bF)(ae,{class:"empty-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(re)]),_:1}),t[1]||(t[1]=(0,a.Lk)("h3",null,"手术数据分析",-1)),Z.logEntriesCount>0?((0,a.uX)(),(0,a.CE)("p",g," 检测到 "+(0,n.v_)(Z.logEntriesCount)+" 条日志条目数据，点击按钮开始分析 ",1)):((0,a.uX)(),(0,a.CE)("p",m," 暂无日志条目数据，请先在批量分析或日志分析页面加载日志数据 ")),(0,a.bF)(se,{type:"primary",onClick:Z.analyzeLogs,loading:Z.analyzing,disabled:0===Z.logEntriesCount},{default:(0,a.k6)(()=>[(0,a.bF)(ae,null,{default:(0,a.k6)(()=>[(0,a.bF)(ne)]),_:1}),(0,a.eW)(" "+(0,n.v_)(Z.getAnalysisButtonText()),1)]),_:1},8,["onClick","loading","disabled"])])]),_:1})])),!Z.surgeries.length&&Z.analyzing?((0,a.uX)(),(0,a.CE)("div",u,[(0,a.bF)(ie,{class:"empty-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",c,[(0,a.bF)(ae,{class:"empty-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(le)]),_:1}),t[2]||(t[2]=(0,a.Lk)("h3",null,"正在分析手术数据...",-1)),t[3]||(t[3]=(0,a.Lk)("p",null,"请稍候，系统正在处理日志条目数据",-1))])]),_:1})])):((0,a.uX)(),(0,a.CE)("div",d,[(0,a.bF)(ie,{class:"tab-card"},{default:(0,a.k6)(()=>[(0,a.bF)(ve,{modelValue:Z.activeTab,"onUpdate:modelValue":t[0]||(t[0]=e=>Z.activeTab=e),type:"card",onTabClick:Z.handleTabClick,lazy:!0,"before-leave":Z.handleBeforeTabLeave,stretch:!1,closable:!1,addable:!1},{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(Z.surgeries,e=>((0,a.uX)(),(0,a.Wv)(ke,{key:e.id,label:e.surgery_id,name:e.id.toString()},{default:(0,a.k6)(()=>[(0,a.Lk)("div",_,[(0,a.bF)(se,{type:"primary",onClick:t=>Z.exportReport(e.id)},{default:(0,a.k6)(()=>[(0,a.bF)(ae,null,{default:(0,a.k6)(()=>[(0,a.bF)(oe)]),_:1}),t[4]||(t[4]=(0,a.eW)(" 导出手术报告 PDF "))]),_:2,__:[4]},1032,["onClick"]),(0,a.bF)(se,{type:"info",onClick:t=>Z.debugSurgeryTimeData(e),style:{"margin-left":"10px"}},{default:(0,a.k6)(()=>[(0,a.bF)(ae,null,{default:(0,a.k6)(()=>[(0,a.bF)(ge)]),_:1}),t[5]||(t[5]=(0,a.eW)(" 调试时间数据 "))]),_:2,__:[5]},1032,["onClick"])]),(0,a.Lk)("div",f,[(0,a.Lk)("div",p,[(0,a.bF)(ie,{class:"info-card"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",h,[t[7]||(t[7]=(0,a.Lk)("div",{class:"time"},"手术时间线",-1)),(0,a.Lk)("div",y,[e.alarm_count>0?((0,a.uX)(),(0,a.Wv)(me,{key:0,type:"danger",size:"small"},{default:(0,a.k6)(()=>t[6]||(t[6]=[(0,a.eW)("故障手术")])),_:1,__:[6]})):(0,a.Q3)("",!0)])]),(0,a.bF)(ce,null,{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(Z.getSortedTimelineEvents(e),(e,t)=>((0,a.uX)(),(0,a.Wv)(ue,{key:`event-${t}`,timestamp:Z.formatTime(e.time),color:e.color,size:"large"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",{class:(0,n.C4)(["timeline-content",`timeline-${e.type}`])},[(0,a.bF)(ae,{class:"timeline-icon"},{default:(0,a.k6)(()=>[((0,a.uX)(),(0,a.Wv)((0,a.$y)(e.icon)))]),_:2},1024),(0,a.Lk)("span",w,(0,n.v_)(e.label),1)],2)]),_:2},1032,["timestamp","color"]))),128))]),_:2},1024)]),_:2},1024)]),(0,a.Lk)("div",k,[(0,a.bF)(ie,{class:"state-chart-card"},{default:(0,a.k6)(()=>t[8]||(t[8]=[(0,a.Lk)("div",{class:"chart-header"},[(0,a.Lk)("div",{class:"chart-title"},"手术状态机变化图"),(0,a.Lk)("div",{class:"chart-legend"},[(0,a.Lk)("div",{class:"legend-item"},[(0,a.Lk)("div",{class:"legend-color state-normal"}),(0,a.Lk)("span",null,"正常状态")]),(0,a.Lk)("div",{class:"legend-item"},[(0,a.Lk)("div",{class:"legend-color state-error"}),(0,a.Lk)("span",null,"故障状态")]),(0,a.Lk)("div",{class:"legend-item"},[(0,a.Lk)("div",{class:"legend-color state-shutdown"}),(0,a.Lk)("span",null,"关机状态")])])],-1)])),_:1,__:[8]})])]),(0,a.bF)(ie,{class:"arm-usage-card"},{header:(0,a.k6)(()=>[(0,a.Lk)("div",v,[t[9]||(t[9]=(0,a.Lk)("span",null,"手术统计",-1)),(0,a.bF)(me,{type:"info"},{default:(0,a.k6)(()=>[(0,a.eW)("总手术时长: "+(0,n.v_)(e.total_duration)+" 分钟",1)]),_:2},1024)])]),default:(0,a.k6)(()=>[(0,a.Lk)("div",T,[(0,a.Lk)("div",b,[(0,a.Lk)("div",L,[(0,a.Lk)("span",S,"手术时长："+(0,n.v_)(e.total_duration)+" 分钟",1),(0,a.Lk)("span",D,"手术时间："+(0,n.v_)(Z.formatTime(e.surgery_start_time))+" - "+(0,n.v_)(Z.formatTime(e.surgery_end_time)),1)]),(0,a.Lk)("div",$,[t[11]||(t[11]=(0,a.Lk)("div",{class:"surgery-label"},[(0,a.Lk)("div",{class:"surgery-color"}),(0,a.Lk)("span",{class:"surgery-name"},"手术时间段")],-1)),(0,a.Lk)("div",F,[(0,a.Lk)("div",C,[(0,a.Lk)("div",{class:"surgery-timeline-segment",style:(0,n.Tr)(Z.getSurgeryTimelineStyle(e))},t[10]||(t[10]=[(0,a.Lk)("span",{class:"surgery-segment-text"},"手术时间段",-1)]),4)])])]),(0,a.Lk)("div",E,[(0,a.Lk)("span",A,(0,n.v_)(Z.formatTimeShort(Z.getTimelineRange(e).start)),1),(0,a.Lk)("span",I,(0,n.v_)(Z.formatTimeShort(Z.getTimelineRange(e).end)),1)])]),(0,a.Lk)("div",x,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(Z.getArmUsages(e),(r,i)=>((0,a.uX)(),(0,a.CE)("div",{key:i,class:"arm-item"},[(0,a.Lk)("div",M,[(0,a.Lk)("div",N,[(0,a.bF)(se,{size:"small",type:"primary",plain:"",onClick:t=>Z.toggleArmDetails(e.id,i)},{default:(0,a.k6)(()=>[(0,a.bF)(ae,null,{default:(0,a.k6)(()=>[(0,a.bF)(de)]),_:1}),t[12]||(t[12]=(0,a.eW)(" 详情 "))]),_:2,__:[12]},1032,["onClick"])])]),(0,a.Lk)("div",O,[(0,a.Lk)("div",X,[(0,a.Lk)("div",{class:(0,n.C4)(["arm-color",`arm-${i+1}`])},null,2),(0,a.Lk)("span",z,"工具臂 "+(0,n.v_)(i+1),1)]),(0,a.Lk)("div",W,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(Z.getArmTimelineSegments(r,e),(s,l)=>((0,a.uX)(),(0,a.CE)("div",{key:l,class:(0,n.C4)(["timeline-segment",`arm-${i+1}`]),style:(0,n.Tr)(s)},[(0,a.bF)(_e,{content:`${Z.getSegmentInstrumentName(s,r,e)}`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,a.k6)(()=>t[13]||(t[13]=[(0,a.Lk)("div",{class:"segment-content"},[(0,a.Lk)("span",{class:"segment-text"})],-1)])),_:2,__:[13]},1032,["content"])],6))),128))])]),(0,a.bF)(pe,null,{default:(0,a.k6)(()=>[(0,a.bo)((0,a.Lk)("div",P,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(Z.getGroupedUsagesByUdi(r),(t,r)=>((0,a.uX)(),(0,a.CE)("div",{key:r,class:"usage-group"},[(0,a.Lk)("div",U,[(0,a.Lk)("div",R,[(0,a.Lk)("div",B,(0,n.v_)(t.instrumentName),1),(0,a.Lk)("div",V,"UDI: "+(0,n.v_)(r),1),(0,a.Lk)("div",K,"总使用时长: "+(0,n.v_)(Z.getGroupedUsageDuration(t)),1)])]),(0,a.Lk)("div",J,[(0,a.Lk)("div",G,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t.usages,(t,r)=>((0,a.uX)(),(0,a.CE)("div",{key:r,class:(0,n.C4)(["timeline-segment",`arm-${i+1}`]),style:(0,n.Tr)(Z.getUsageTimelineStyle(t,e))},[(0,a.bF)(_e,{content:`器械：${t.instrumentName}\n时间：${Z.formatTime(t.startTime)} - ${Z.formatTime(t.endTime)}\n时长：${Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60)}分钟`,placement:"top","show-arrow":!0,"popper-class":"usage-time-tooltip"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",j,[(0,a.Lk)("span",q,(0,n.v_)(Z.getSegmentText(t,e)),1)])]),_:2},1032,["content"])],6))),128))])])]))),128)),(0,a.Lk)("div",H,[(0,a.bF)(ae,{class:"energy-icon"},{default:(0,a.k6)(()=>[(0,a.bF)(fe)]),_:1}),(0,a.eW)(" 器械总使用时间: "+(0,n.v_)(Z.getEnergyTime(r)),1)])],512),[[s.aG,Z.armDetailsVisible[e.id+"_"+i]]])]),_:2},1024)]))),128))])])]),_:2},1024),(0,a.bF)(ie,{class:"alarm-card"},{header:(0,a.k6)(()=>t[14]||(t[14]=[(0,a.Lk)("span",null,"安全报警记录",-1)])),default:(0,a.k6)(()=>[(0,a.bF)(ye,{data:Z.getAlarmDetails(e).slice(0,Z.showAllAlarms[e.id]?void 0:5),style:{width:"100%"}},{default:(0,a.k6)(()=>[(0,a.bF)(he,{prop:"time",label:"时间",width:"180"},{default:(0,a.k6)(({row:e})=>[(0,a.eW)((0,n.v_)(Z.formatTime(e.time)),1)]),_:1}),(0,a.bF)(he,{prop:"code",label:"故障码",width:"120"},{default:(0,a.k6)(({row:e})=>[(0,a.eW)((0,n.v_)(e.code||e.error_code||"无"),1)]),_:1}),(0,a.bF)(he,{prop:"message",label:"报警信息"}),(0,a.bF)(he,{prop:"status",label:"处理状态",width:"120"},{default:(0,a.k6)(({row:e})=>[(0,a.bF)(me,{type:"已恢复"===e.status?"success":"未处理"===e.status?"danger":"warning"},{default:(0,a.k6)(()=>[(0,a.eW)((0,n.v_)(e.status),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]),Z.getAlarmDetails(e).length>5?((0,a.uX)(),(0,a.CE)("div",Q,[(0,a.bF)(se,{type:"text",onClick:t=>Z.toggleAlarms(e.id),size:"small"},{default:(0,a.k6)(()=>[(0,a.bF)(ae,null,{default:(0,a.k6)(()=>[Z.showAllAlarms[e.id]?((0,a.uX)(),(0,a.Wv)(we,{key:1})):((0,a.uX)(),(0,a.Wv)(de,{key:0}))]),_:2},1024),(0,a.eW)(" "+(0,n.v_)(Z.showAllAlarms[e.id]?"收起":`展开更多 (${Z.getAlarmDetails(e).length-5}条)`),1)]),_:2},1032,["onClick"])])):(0,a.Q3)("",!0),(0,a.Lk)("div",Y,[(0,a.bF)(me,{type:"danger"},{default:(0,a.k6)(()=>[(0,a.eW)("报警总数: "+(0,n.v_)(e.alarm_count||0),1)]),_:2},1024)])]),_:2},1024)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue","onTabClick","before-leave"])]),_:1})]))])}var ee=r(953),te=r(6278),re=r(5220),ae=r(163),ne=r(8548),se=r(3611),ie=r(5495),le={name:"SurgeryStatistics",components:{DataAnalysis:ne.DataAnalysis,Download:ne.Download,SwitchButton:ne.SwitchButton,Close:ne.Close,VideoPlay:ne.VideoPlay,VideoPause:ne.VideoPause,ArrowUp:ne.ArrowUp,ArrowDown:ne.ArrowDown,ArrowLeft:ne.ArrowLeft,Calendar:ne.Calendar,PowerOff:ne.PowerOff,Lightning:ne.Lightning,Globe:ne.Globe,InfoFilled:ne.InfoFilled,Loading:ne.Loading},setup(){(0,te.Pj)(),(0,re.rd)();const e=(0,re.lq)(),t=(0,ee.KR)([]),r=(0,ee.KR)(""),n=(0,ee.Kh)({}),s=(0,ee.Kh)({}),i=(0,ee.KR)(!1),l=(0,a.EW)(()=>{try{const e=sessionStorage.getItem("surgeryAnalysisData");if(e){const t=JSON.parse(e);if(t&&t.entries&&t.entries.length>0){const e=Date.now()-(t.timestamp||0);if(e>36e5)return console.log("手术分析数据已过期，清除缓存"),sessionStorage.removeItem("surgeryAnalysisData"),[];if(t.compressed){const e=t.entries.map(e=>({timestamp:e.t,error_code:e.e,param1:e.p1,param2:e.p2,param3:e.p3,param4:e.p4,explanation:e.exp,log_name:e.ln}));return e}return t.entries}}}catch(e){console.error("解析手术分析数据失败:",e),sessionStorage.removeItem("surgeryAnalysisData")}try{const e=sessionStorage.getItem("batchLogEntries");if(e){const t=JSON.parse(e);if(t&&t.length>0){const e="true"===sessionStorage.getItem("batchLogEntriesCompressed");if(e){const e=t.map(e=>({timestamp:e.t,error_code:e.e,param1:e.p1,param2:e.p2,param3:e.p3,param4:e.p4,explanation:e.exp,log_name:e.ln}));return e}return t}}}catch(e){console.error("解析批量分析数据失败:",e)}try{const e=sessionStorage.getItem("logEntries");if(e){const t=JSON.parse(e);if(t&&t.length>0)return t}}catch(e){console.error("解析单个日志数据失败:",e)}return[]}),o=(0,a.EW)(()=>l.value.length),g=async()=>{try{const a=e.query.logIds;if(!a)return;const l=a.split(",").map(e=>parseInt(e));if(!l||0===l.length)return;i.value=!0;const o=await ie.A.surgeryStatistics.analyzeByLogIds(l);o.data.success?(t.value=o.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{n[e.id]=!1,s[e.id]=!1})),ae.nk.success(o.data.message||`成功分析出 ${t.value.length} 场手术`)):ae.nk.error(o.data.message||"分析失败")}catch(a){ae.nk.error("分析批量日志数据失败: "+(a.response?.data?.message||a.message))}finally{i.value=!1}},m=()=>{if(0===l.value.length)return"无数据";const e=l.value.map(e=>new Date(e.timestamp)),t=new Date(Math.min(...e)),r=new Date(Math.max(...e));return`${T(t)} 至 ${T(r)}`},u=()=>0===o.value?"请先加载日志条目数据":`分析日志条目 (${o.value})`,c=async()=>{if(0!==l.value.length){i.value=!0;try{const e=JSON.stringify(l.value).length,a=10485760;let i=l.value;if(e>a){ae.nk.warning(`数据量较大(${(e/1024/1024).toFixed(1)}MB)，将进行数据采样以提高分析速度`);const t=Math.floor(a/(e/l.value.length)),r=Math.floor(l.value.length/t);i=[];for(let e=0;e<l.value.length;e+=r)if(i.push(l.value[e]),i.length>=t)break}const o=await ie.A.surgeryStatistics.analyzeSortedEntries(i);o.data.success?(t.value=o.data.data||[],t.value.length>0&&(r.value=t.value[0].id.toString(),t.value.forEach(e=>{n[e.id]=!1,s[e.id]=!1})),ae.nk.success(`手术数据分析完成，共发现 ${t.value.length} 场手术`)):ae.nk.error(o.data.message||"分析失败")}catch(e){ae.nk.error("分析日志数据失败: "+(e.response?.data?.message||e.message))}finally{i.value=!1}}else ae.nk.warning("暂无日志条目数据，请先在批量分析或日志分析页面加载日志数据")},d=async e=>{try{await ie.A.surgeryStatistics.exportReport(e);ae.nk.success("报告导出功能开发中")}catch(t){ae.nk.error("导出报告失败")}},_=(e,t)=>{const r=`${e}_${t}`;n[r]=!n[r]},f=e=>{s[e]=!s[e]},p=e=>[e.arm1_usage||[],e.arm2_usage||[],e.arm3_usage||[],e.arm4_usage||[]],h=e=>{if(!e||0===e.length)return"0分钟";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},y=e=>{switch(e){case"错误":return"danger";case"警告":return"warning";case"网络":return"info";default:return"info"}},w=e=>{if(!e||!e.alarm_details)return[];let t=[];if("string"===typeof e.alarm_details)try{t=JSON.parse(e.alarm_details)}catch(r){return console.error("解析alarm_details字符串失败:",r),[]}else t=e.alarm_details||[];return t},k=e=>{if(!e)return"-";const t=new Date(e),r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),l=String(t.getSeconds()).padStart(2,"0");return`${r}-${a}-${n} ${s}:${i}:${l}`},v=e=>{if(!e.surgery_start_time||!e.surgery_end_time)return"手术时间未确定";const t=new Date(e.surgery_start_time).toLocaleString(),r=new Date(e.surgery_end_time).toLocaleString();return`${t} ~ ${r}`},T=e=>{if(!e)return"-";const t=new Date(e),r=String(t.getHours()).padStart(2,"0"),a=String(t.getMinutes()).padStart(2,"0");return`${r}:${a}`},b=e=>{if(!e)return{start:null,end:null};const t=I(e),r=e.surgery_end_time,a=x(e);let n=t;!n&&e.surgery_start_time&&(n=e.surgery_start_time);let s=r;if(!s&&a&&(s=a),!s&&e.last_log_time&&(s=e.last_log_time),n&&s){const t=new Date(n).getTime(),r=new Date(s).getTime();t>=r&&(console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{surgery_id:e.surgery_id,start:n,end:s,startTime:t,endTime:r}),e.surgery_start_time&&e.surgery_end_time&&(n=e.surgery_start_time,s=e.surgery_end_time))}return{start:n,end:s}},L=(e,t,r)=>{if(!e||!t||!r)return 0;try{const a=new Date(t).getTime(),n=new Date(r).getTime(),s=new Date(e).getTime();if(isNaN(a)||isNaN(n)||isNaN(s))return console.warn("时间计算异常：无效的时间值",{time:e,startTime:t,endTime:r}),0;if(a>=n)return console.warn("时间轴范围异常：开始时间晚于或等于结束时间",{startTime:t,endTime:r}),0;const i=(s-a)/(n-a)*100;return Math.max(0,Math.min(100,i))}catch(a){return console.error("时间位置计算失败:",a,{time:e,startTime:t,endTime:r}),0}},S=(e,t)=>{if(!e||!t)return[];const r=new Date(e),a=new Date(t),n=a.getTime()-r.getTime();let s;s=n<=18e5?3e5:n<=72e5?9e5:18e5;const i=[];let l=r.getTime()+s;while(l<a.getTime()){const r=L(l,e,t);i.push({time:new Date(l),position:r}),l+=s}return i},D=e=>{if(!e||0===e.length)return[];const t=e.map(e=>({startTime:new Date(e.startTime).getTime(),endTime:new Date(e.endTime).getTime()}));t.sort((e,t)=>e.startTime-t.startTime);const r=[];let a=t[0];for(let n=1;n<t.length;n++){const e=t[n];a.endTime>=e.startTime?a.endTime=Math.max(a.endTime,e.endTime):(r.push(a),a=e)}return a&&r.push(a),r},$=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return{left:"0%",width:"0%"};const a=D(r);if(0===a.length)return{left:"0%",width:"0%"};let n=0;const s=[],i=b(t);return i.start&&i.end?(a.forEach(e=>{const t=L(e.startTime,i.start,i.end),r=L(e.endTime,i.start,i.end),a=Math.max(0,r-t);s.push({left:`${t}%`,width:`${a}%`}),n+=a}),s.length>0?s[0]:{left:"0%",width:"0%"}):{left:"0%",width:"0%"}},F=(e,t)=>{if(!e||0===e.length||!t.surgery_start_time||!t.surgery_end_time)return[];const r=e.filter(e=>e.startTime&&e.endTime);if(0===r.length)return[];const a=D(r);if(0===a.length)return[];const n=[],s=b(t);return s.start&&s.end?(a.forEach((e,t)=>{const r=L(e.startTime,s.start,s.end),a=L(e.endTime,s.start,s.end),i=Math.max(0,a-r);i>0&&n.push({left:`${r}%`,width:`${i}%`})}),n):[]},C=e=>{if(!e||!e.surgery_start_time||!e.surgery_end_time)return{left:"0%",width:"0%"};const t=b(e);if(!t.start||!t.end)return{left:"0%",width:"0%"};const r=L(e.surgery_start_time,t.start,t.end),a=L(e.surgery_end_time,t.start,t.end),n=Math.max(0,a-r);return{left:`${r}%`,width:`${n}%`}},E=(e,t)=>{if(!e||!t.surgery_start_time||!t.surgery_end_time)return{left:"0%",width:"0%"};if(!e.startTime||!e.endTime)return{left:"0%",width:"0%"};const r=b(t);if(!r.start||!r.end)return{left:"0%",width:"0%"};const a=new Date(e.startTime).getTime(),n=new Date(e.endTime).getTime(),s=L(a,r.start,r.end),i=L(n,r.start,r.end),l=Math.max(0,i-s),o=Math.max(0,Math.min(100-l,s));return{left:`${o}%`,width:`${l}%`}},A=e=>{if(!e||0===e.length)return"0分0秒";const t=e.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3);return e+r},0),r=Math.floor(t/60),a=t%60;return`${r}分${a}秒`},I=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times[0]:e.power_on_time?e.power_on_time:e.surgery_start_time:null,x=e=>e?e.surgery_end_time?e.surgery_end_time:e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times[e.shutdown_times.length-1]:e.power_off_time?e.power_off_time:null:null,M=e=>e?e.power_on_times&&e.power_on_times.length>0?e.power_on_times:e.power_on_time?[e.power_on_time]:[]:[],N=e=>e?e.shutdown_times&&e.shutdown_times.length>0?e.shutdown_times:e.power_off_time?[e.power_off_time]:[]:[],O=e=>{if(!e)return[];const t=[],r=M(e);r.forEach((e,a)=>{t.push({time:new Date(e),type:"powerOn",label:r.length>1?`开机 ${a+1}`:"开机",color:"green",icon:"PowerOff"})}),e.surgery_start_time&&t.push({time:new Date(e.surgery_start_time),type:"surgeryStart",label:"手术开始",color:"blue",icon:"VideoPlay"}),e.surgery_end_time&&t.push({time:new Date(e.surgery_end_time),type:"surgeryEnd",label:"手术结束",color:"orange",icon:"VideoPause"});const a=N(e);return a.forEach((e,r)=>{t.push({time:new Date(e),type:"powerOff",label:a.length>1?`关机 ${r+1}`:"关机",color:"red",icon:"PowerOff"})}),t.sort((e,t)=>e.time.getTime()-t.time.getTime())},X=e=>{if(!e)return[];let t=[];if(e.state_machine_changes)if("string"===typeof e.state_machine_changes)try{t=JSON.parse(e.state_machine_changes)}catch(a){console.error("解析state_machine_changes字符串失败:",a),t=[]}else t=e.state_machine_changes||[];if(console.log("手术状态机变化数据:",e.surgery_id,t),0===t.length)return console.log("没有状态机变化数据"),[];const r=[];for(let n=0;n<t.length;n++){const a=t[n],s=t[n+1],i=parseInt(a.state),l=new Date(a.time),o=s?new Date(s.time):e.surgery_end_time?new Date(e.surgery_end_time):new Date,g=o.getTime()-l.getTime();console.log(`状态变化 ${n}: currentState=${i}, startTime=${l}, endTime=${o}, duration=${g}ms`);let m="none";if(i<=0)m="none";else if(i>0&&i<30)m="surgery";else if(30===i){const e=s?parseInt(s.state):null;m=null===e||e<10?"error":"surgery"}else m="none";console.log(`状态分类: currentState=${i}, nextState=${s?s.state:"null"} -> stateCategory=${m}`),"none"!==m&&r.push({state:m,startTime:l,endTime:o,duration:g,originalState:i,stateName:a.stateName||`状态${i}`})}return console.log("生成的柱状图数据:",r),r},z=e=>{const t={surgery:"正常阶段",error:"故障阶段",idle:"空闲",active:"激活",standby:"待机",offline:"离线"};return t[e]||e},W=e=>{const t={surgery:60,error:100},r=t[e]||60;return console.log(`柱状图高度: state=${e}, height=${r}px`),r},P=(e,t)=>{if(!e||!t)return 0;const r=b(t);if(!r.start||!r.end)return 0;const a=L(e,r.start,r.end);console.log(`柱状图位置计算: startTime=${e}, timelineStart=${r.start}, timelineEnd=${r.end}, position=${a}%`);const n=Math.max(0,Math.min(95,a));return n},U=e=>{const t={};return e.forEach((e,r)=>{const a=e.udi||`${e.instrumentName}_${r}`;t[a]||(t[a]={instrumentName:e.instrumentName,usages:[]}),t[a].usages.push(e)}),t},R=e=>{if(!e||0===e.usages.length)return"0分钟";const t=e.usages.filter(e=>e.startTime&&e.endTime).reduce((e,t)=>{const r=Math.floor((new Date(t.endTime)-new Date(t.startTime))/1e3/60);return e+r},0);return`${t}分钟`},B=(e,t)=>{try{const r=E(e,t),a=r.width,n=parseFloat(a),s=e.instrumentName||"器械",i=1.5,l=2,o=Math.min(s.length*i+l,20);if(n>=o){if(n>=s.length*i+l)return s;{const e=Math.floor((n-l)/i);return s.substring(0,e)+"..."}}return""}catch(r){return console.error("计算进度条文本失败:",r),""}},V=(e,t,r)=>{if(!e||!t||!r)return"未知器械";const a=b(r);if(!a.start||!a.end)return"未知器械";const n=parseFloat(e.left),s=n+parseFloat(e.width),i=new Date(a.start).getTime()+n/100*(new Date(a.end).getTime()-new Date(a.start).getTime()),l=new Date(a.start).getTime()+s/100*(new Date(a.end).getTime()-new Date(a.start).getTime()),o=t.filter(e=>{if(!e.startTime||!e.endTime)return!1;const t=new Date(e.startTime).getTime(),r=new Date(e.endTime).getTime();return t<l&&r>i});return 0===o.length?"无器械使用":o[0].instrumentName||"未知器械"},K=(0,se.sg)(e=>{(0,se.wx)(()=>{r.value=e.name})},50),J=(e,t)=>(0,se.wx)().then(()=>!0);return(0,a.sV)(async()=>{const t=()=>{const e=console.error;if(console.error=(...t)=>{t[0]&&"string"===typeof t[0]&&t[0].includes("ResizeObserver loop completed with undelivered notifications")||e.apply(console,t)},window.handleError){const e=window.handleError;window.handleError=t=>{if(!(t&&t.message&&t.message.includes("ResizeObserver loop completed with undelivered notifications")))return e(t)}}};t();const r=e=>{if(e.message&&e.message.includes("ResizeObserver loop completed with undelivered notifications"))return e.preventDefault(),!1};window.addEventListener("error",r);const a=e=>{if(e.reason&&e.reason.message&&e.reason.message.includes("ResizeObserver loop completed with undelivered notifications"))return e.preventDefault(),!1};window.addEventListener("unhandledrejection",a);try{const t=e.query.logIds;if(t)try{const e=t.split(",").map(e=>parseInt(e));if(e&&e.length>0)return void await g()}catch(n){console.error("解析URL参数中的日志ID失败:",n)}let r=null,a=null;try{const e=sessionStorage.getItem("batchLogEntries");e&&(r=JSON.parse(e))}catch(n){}try{const e=sessionStorage.getItem("logEntries");e&&(a=JSON.parse(e))}catch(n){}const s=sessionStorage.getItem("autoAnalyze"),i=sessionStorage.getItem("autoAnalyzeLogId");"true"===s&&i&&(sessionStorage.removeItem("autoAnalyze"),sessionStorage.removeItem("autoAnalyzeLogId"),setTimeout(()=>{g()},1e3))}catch(n){console.error("页面初始化错误:",n)}return()=>{window.removeEventListener("error",r),window.removeEventListener("unhandledrejection",a)}}),{surgeries:t,activeTab:r,armDetailsVisible:n,showAllAlarms:s,analyzing:i,logEntriesCount:o,analyzeLogs:c,exportReport:d,toggleArmDetails:_,toggleAlarms:f,getArmUsages:p,getArmTotalTime:h,getArmTimelineStyle:$,getArmTimelineSegments:F,getSurgeryTimelineStyle:C,getUsageTimelineStyle:E,getEnergyTime:A,getAlarmTypeTag:y,getAlarmDetails:w,formatTime:k,formatSurgeryTime:v,formatTimeShort:T,getTimePosition:L,getTimelineTicks:S,handleTabClick:K,getAnalysisButtonText:u,getTimeRange:m,loadBatchLogEntriesByIds:g,getPowerOnTime:I,getPowerOffTime:x,getAllPowerOnTimes:M,getAllPowerOffTimes:N,getSurgeryTimelineStyle:C,getGroupedUsagesByUdi:U,getGroupedUsageDuration:R,getSegmentText:B,getTimelineRange:b,getSegmentInstrumentName:V,getSortedTimelineEvents:O,getStateChanges:X,getStateName:z,getStateBarHeight:W,getStateBarPosition:P,handleBeforeTabLeave:J,debugSurgeryTimeData:e=>{if(!e)return;console.log("=== 手术时间数据调试 ==="),console.log("手术ID:",e.surgery_id),console.log("开机时间:",e.power_on_times),console.log("关机时间:",e.shutdown_times),console.log("手术开始时间:",e.surgery_start_time),console.log("手术结束时间:",e.surgery_end_time),console.log("最后日志时间:",e.last_log_time);const t=M(e);console.log("解析的开机时间:",t),console.log("开机时间数量:",t.length);const r=N(e);console.log("解析的关机时间:",r),console.log("关机时间数量:",r.length);const a=O(e);console.log("时间线事件:",a),console.log("时间线事件数量:",a.length);const n=b(e);if(console.log("计算的时间轴范围:",n),n.start&&n.end){const e=new Date(n.start),t=new Date(n.end),r=t.getTime()-e.getTime();console.log("时间轴详细信息:",{start:e.toISOString(),end:t.toISOString(),duration:Math.floor(r/1e3/60)+"分钟",isCrossDay:e.getDate()!==t.getDate()||e.getMonth()!==t.getMonth()||e.getFullYear()!==t.getFullYear()})}console.log("=== 调试结束 ===")}}}},oe=r(6262);const ge=(0,oe.A)(le,[["render",Z],["__scopeId","data-v-cb517a7c"]]);var me=ge}}]);
//# sourceMappingURL=201.0e674daf.js.map