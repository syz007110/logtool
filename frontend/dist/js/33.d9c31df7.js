"use strict";(self["webpackChunklogtool_frontend"]=self["webpackChunklogtool_frontend"]||[]).push([[33],{3033:function(e,a,l){l.r(a),l.d(a,{default:function(){return ue}});var t=l(641),s=l(33);const o={class:"logs-container"},r={class:"upload-actions"},n={class:"card-header"},i={class:"header-actions"},d={class:"header-section only-own-section"},u={class:"header-section reset-section"},c={class:"header-section refresh-section"},p={class:"el-upload__tip"},v={key:0},g={key:1,class:"parsing-tip"},k={key:0,class:"custom-file-list"},f={class:"file-list-header"},h={class:"file-items"},y={class:"file-name"},m={class:"file-size"},b={class:"key-input-section"},_={class:"key-input-row"},w={key:0,class:"key-file-info"},F={key:1,class:"key-error"},C={class:"device-input-section"},L={class:"device-input-row"},D={key:0,class:"device-error"},R={class:"upload-actions"};function W(e,a,l,W,E,z){const B=(0,t.g2)("UploadFilled"),K=(0,t.g2)("el-icon"),U=(0,t.g2)("el-button"),x=(0,t.g2)("el-card"),I=(0,t.g2)("el-checkbox"),A=(0,t.g2)("Refresh"),S=(0,t.g2)("el-table-column"),V=(0,t.g2)("el-table"),M=(0,t.g2)("DeviceLogDrawer"),T=(0,t.g2)("upload-filled"),$=(0,t.g2)("el-upload"),X=(0,t.g2)("Document"),O=(0,t.g2)("Delete"),N=(0,t.g2)("Key"),j=(0,t.g2)("el-input"),P=(0,t.g2)("Upload"),G=(0,t.g2)("el-tag"),Q=(0,t.g2)("Monitor"),Y=(0,t.g2)("el-dialog"),Z=(0,t.gN)("loading");return(0,t.uX)(),(0,t.CE)("div",o,[(0,t.bF)(x,{class:"upload-card"},{header:(0,t.k6)(()=>a[8]||(a[8]=[(0,t.Lk)("div",{class:"card-header"},[(0,t.Lk)("span",null,"日志上传")],-1)])),default:(0,t.k6)(()=>[(0,t.Lk)("div",r,[(0,t.bF)(U,{type:"primary",onClick:a[0]||(a[0]=e=>W.showUploadDialog=!0)},{default:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(B)]),_:1}),a[9]||(a[9]=(0,t.eW)(" 上传日志 "))]),_:1,__:[9]})])]),_:1}),(0,t.bF)(x,{class:"list-card"},{header:(0,t.k6)(()=>[(0,t.Lk)("div",n,[a[12]||(a[12]=(0,t.Lk)("span",null,"日志解析",-1)),(0,t.Lk)("div",i,[(0,t.Lk)("div",d,[(0,t.bF)(I,{modelValue:W.onlyOwn,"onUpdate:modelValue":a[1]||(a[1]=e=>W.onlyOwn=e),onChange:W.applyOnlyOwn,label:"仅看自己"},null,8,["modelValue","onChange"])]),(0,t.Lk)("div",u,[(0,t.bF)(U,{plain:"",size:"small",onClick:W.resetAllFilters},{default:(0,t.k6)(()=>a[10]||(a[10]=[(0,t.eW)("重置")])),_:1,__:[10]},8,["onClick"])]),(0,t.Lk)("div",c,[(0,t.bF)(U,{plain:"",size:"small",onClick:W.loadDeviceGroups},{default:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(A)]),_:1}),a[11]||(a[11]=(0,t.eW)(" 刷新 "))]),_:1,__:[11]},8,["onClick"])])])])]),default:(0,t.k6)(()=>[(0,t.bo)(((0,t.uX)(),(0,t.Wv)(V,{data:W.deviceGroups,loading:W.deviceGroupsLoading,style:{width:"100%"}},{default:(0,t.k6)(()=>[(0,t.bF)(S,{prop:"device_id",label:"设备编号",width:"160"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(U,{type:"text",onClick:a=>W.openDeviceDrawer(e.device_id),style:{color:"#409eff","text-decoration":"underline"}},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(e.device_id),1)]),_:2},1032,["onClick"])]),_:1}),(0,t.bF)(S,{prop:"hospital",label:"医院名称",width:"200"},{default:(0,t.k6)(({row:e})=>[(0,t.eW)((0,s.v_)(e.hospital||"-"),1)]),_:1}),(0,t.bF)(S,{prop:"log_count",label:"日志数量",width:"100",align:"center"}),(0,t.bF)(S,{prop:"latest_upload_time",label:"更新时间",width:"150"},{default:(0,t.k6)(({row:e})=>[(0,t.eW)((0,s.v_)(W.formatDate(e.latest_upload_time)),1)]),_:1}),(0,t.bF)(S,{label:"操作",width:"300",fixed:"right"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(U,{size:"small",type:"primary",onClick:a=>W.openDeviceDrawer(e.device_id)},{default:(0,t.k6)(()=>a[13]||(a[13]=[(0,t.eW)(" 查看手术 ")])),_:2,__:[13]},1032,["onClick"]),(0,t.bF)(U,{size:"small",type:"success",onClick:a=>W.openDeviceDrawer(e.device_id)},{default:(0,t.k6)(()=>a[14]||(a[14]=[(0,t.eW)(" 数据上传 ")])),_:2,__:[14]},1032,["onClick"]),(0,t.bF)(U,{size:"small",type:"warning",onClick:a=>W.openDeviceDrawer(e.device_id)},{default:(0,t.k6)(()=>a[15]||(a[15]=[(0,t.eW)(" 日志上传 ")])),_:2,__:[15]},1032,["onClick"]),(0,t.bF)(U,{size:"small",type:"info",onClick:a=>W.openDeviceDrawer(e.device_id)},{default:(0,t.k6)(()=>a[16]||(a[16]=[(0,t.eW)(" 关注 ")])),_:2,__:[16]},1032,["onClick"])]),_:1})]),_:1},8,["data","loading"])),[[Z,W.deviceGroupsLoading]])]),_:1}),(0,t.bF)(M,{"model-value":W.showDeviceDrawer,"onUpdate:modelValue":a[2]||(a[2]=e=>W.showDeviceDrawer=e),"device-id":W.selectedDeviceId},null,8,["model-value","device-id"]),(0,t.bF)(Y,{modelValue:W.showUploadDialog,"onUpdate:modelValue":a[6]||(a[6]=e=>W.showUploadDialog=e),title:"上传日志",width:"700px","append-to-body":""},{footer:(0,t.k6)(()=>[(0,t.Lk)("div",R,[(0,t.bF)(U,{onClick:a[5]||(a[5]=e=>W.showUploadDialog=!1),disabled:W.uploading},{default:(0,t.k6)(()=>a[24]||(a[24]=[(0,t.eW)("取消")])),_:1,__:[24]},8,["disabled"]),(0,t.bF)(U,{type:"primary",onClick:W.submitUpload,loading:W.uploading,disabled:W.uploading||!W.decryptKey.trim()||0===W.uploadFileList.length},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(W.uploading?"解析中...":"上传并解析"),1)]),_:1},8,["onClick","loading","disabled"])])]),default:(0,t.k6)(()=>[(0,t.bF)($,{ref:"uploadRef",action:W.uploadUrl,headers:W.uploadHeaders,"before-upload":W.beforeUpload,"on-success":W.onUploadSuccess,"on-error":W.onUploadError,"on-exceed":W.onExceed,"on-change":W.onFileChange,"on-remove":W.onFileRemove,"on-progress":e.onUploadProgress,"auto-upload":!1,"show-file-list":!1,multiple:!0,limit:50,accept:".medbot",name:"file",disabled:W.uploading},{tip:(0,t.k6)(()=>[(0,t.Lk)("div",p,[W.uploading?((0,t.uX)(),(0,t.CE)("div",g,[(0,t.bF)(K,{class:"is-loading"},{default:(0,t.k6)(()=>[(0,t.bF)(A)]),_:1}),a[18]||(a[18]=(0,t.eW)(" 文件上传中，上传完成后才能进行下一次上传操作 "))])):((0,t.uX)(),(0,t.CE)("div",v," 支持上传 .medbot 文件，最多50个文件，总大小不超过200MB，上传后将自动解密并解析 "))])]),default:(0,t.k6)(()=>[(0,t.bF)(U,{type:"primary",disabled:W.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(K,{class:"el-icon--upload"},{default:(0,t.k6)(()=>[(0,t.bF)(T)]),_:1}),a[17]||(a[17]=(0,t.eW)(" 选择文件 "))]),_:1,__:[17]},8,["disabled"])]),_:1},8,["action","headers","before-upload","on-success","on-error","on-exceed","on-change","on-remove","on-progress","disabled"]),W.uploadFileList&&W.uploadFileList.length>0?((0,t.uX)(),(0,t.CE)("div",k,[(0,t.Lk)("div",f,[(0,t.Lk)("span",null,"已选择的文件 ("+(0,s.v_)(W.uploadFileList.length)+")",1),(0,t.bF)(U,{type:"text",size:"small",onClick:W.clearUpload,disabled:W.uploading},{default:(0,t.k6)(()=>a[19]||(a[19]=[(0,t.eW)(" 清空 ")])),_:1,__:[19]},8,["onClick","disabled"])]),(0,t.Lk)("div",h,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(W.uploadFileList,(e,a)=>((0,t.uX)(),(0,t.CE)("div",{key:a,class:"file-item"},[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(X)]),_:1}),(0,t.Lk)("span",y,(0,s.v_)(e.name||e.originalname),1),(0,t.Lk)("span",m,(0,s.v_)(e.sizeText),1),(0,t.bF)(U,{type:"text",size:"small",onClick:e=>W.removeFile(a),disabled:W.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(O)]),_:1})]),_:2},1032,["onClick","disabled"])]))),128))])])):(0,t.Q3)("",!0),(0,t.Lk)("div",b,[(0,t.Lk)("div",_,[(0,t.bF)(j,{modelValue:W.decryptKey,"onUpdate:modelValue":a[3]||(a[3]=e=>W.decryptKey=e),placeholder:"请输入解密密钥（MAC地址格式，如：00-01-05-77-6a-09）",style:{width:"300px"},clearable:"",onBlur:W.validateKeyFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(N)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,t.bF)(U,{type:"primary",plain:"",onClick:W.autoFillDeviceId,disabled:!W.decryptKey.trim()},{default:(0,t.k6)(()=>a[20]||(a[20]=[(0,t.eW)(" 自动填充设备编号 ")])),_:1,__:[20]},8,["onClick","disabled"]),a[22]||(a[22]=(0,t.Lk)("span",{class:"key-separator"},"或",-1)),(0,t.bF)($,{ref:"keyUploadRef","auto-upload":!1,"show-file-list":!1,accept:".txt","before-upload":W.beforeKeyUpload,"on-change":W.onKeyFileChange},{default:(0,t.k6)(()=>[(0,t.bF)(U,{type:"primary",plain:""},{default:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(P)]),_:1}),a[21]||(a[21]=(0,t.eW)(" 上传密钥文件 "))]),_:1,__:[21]})]),_:1},8,["before-upload","on-change"])]),W.keyFileName?((0,t.uX)(),(0,t.CE)("div",w,[(0,t.bF)(G,{type:"success",size:"small"},{default:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(X)]),_:1}),(0,t.eW)(" "+(0,s.v_)(W.keyFileName),1)]),_:1})])):(0,t.Q3)("",!0),W.keyError?((0,t.uX)(),(0,t.CE)("div",F,[(0,t.bF)(G,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(W.keyError),1)]),_:1})])):(0,t.Q3)("",!0)]),(0,t.Lk)("div",C,[(0,t.Lk)("div",L,[(0,t.bF)(j,{modelValue:W.deviceId,"onUpdate:modelValue":a[4]||(a[4]=e=>W.deviceId=e),placeholder:"设备编号（格式：数字或字母组合，例：4371-01、ABC-12，默认为0000-00）",style:{width:"300px"},clearable:"",onBlur:W.validateDeviceIdFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(K,null,{default:(0,t.k6)(()=>[(0,t.bF)(Q)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,t.bF)(U,{type:"primary",plain:"",onClick:W.autoFillKey,disabled:!W.deviceId.trim()},{default:(0,t.k6)(()=>a[23]||(a[23]=[(0,t.eW)(" 自动填充密钥 ")])),_:1,__:[23]},8,["onClick","disabled"])]),W.deviceIdError?((0,t.uX)(),(0,t.CE)("div",D,[(0,t.bF)(G,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(W.deviceIdError),1)]),_:1})])):(0,t.Q3)("",!0)])]),_:1},8,["modelValue"]),(0,t.bF)(Y,{modelValue:e.showEntriesDialog,"onUpdate:modelValue":a[7]||(a[7]=a=>e.showEntriesDialog=a),title:"日志查看",width:"900px"},{default:(0,t.k6)(()=>[(0,t.bF)(V,{data:e.logEntries,style:{width:"100%"}},{default:(0,t.k6)(()=>[(0,t.bF)(S,{prop:"timestamp",label:"时间戳",width:"180"}),(0,t.bF)(S,{prop:"error_code",label:"故障码",width:"100"}),(0,t.bF)(S,{prop:"param1",label:"参数1",width:"100"}),(0,t.bF)(S,{prop:"param2",label:"参数2",width:"100"}),(0,t.bF)(S,{prop:"param3",label:"参数3",width:"100"}),(0,t.bF)(S,{prop:"param4",label:"参数4",width:"100"}),(0,t.bF)(S,{prop:"explanation",label:"日志解释"})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}var E=l(953),z=l(6278),B=l(5220),K=l(163),U=l(7918);const x={class:"device-log-drawer"},I={class:"upload-section"},A={class:"log-list-section"},S={class:"filter-section"},V={key:0,class:"batch-actions"},M={class:"filter-controls"},T={class:"pagination-wrapper"},$={class:"el-upload__tip"},X={key:0},O={key:1,class:"parsing-tip"},N={key:0,class:"custom-file-list"},j={class:"file-list-header"},P={class:"file-items"},G={class:"file-name"},Q={class:"file-size"},Y={class:"key-input-section"},Z={class:"key-input-row"},H={key:0,class:"key-file-info"},q={key:1,class:"key-error"},J={class:"device-input-section"},ee={class:"device-input-row"},ae={key:0,class:"device-error"},le={class:"upload-actions"};function te(e,a,l,o,r,n){const i=(0,t.g2)("UploadFilled"),d=(0,t.g2)("el-icon"),u=(0,t.g2)("el-button"),c=(0,t.g2)("Monitor"),p=(0,t.g2)("Download"),v=(0,t.g2)("Delete"),g=(0,t.g2)("Refresh"),k=(0,t.g2)("el-checkbox"),f=(0,t.g2)("el-table-column"),h=(0,t.g2)("el-tag"),y=(0,t.g2)("el-table"),m=(0,t.g2)("el-pagination"),b=(0,t.g2)("upload-filled"),_=(0,t.g2)("el-upload"),w=(0,t.g2)("Document"),F=(0,t.g2)("Key"),C=(0,t.g2)("el-input"),L=(0,t.g2)("Upload"),D=(0,t.g2)("el-dialog"),R=(0,t.g2)("el-drawer"),W=(0,t.gN)("loading");return(0,t.uX)(),(0,t.Wv)(R,{modelValue:e.visible,"onUpdate:modelValue":a[6]||(a[6]=a=>e.visible=a),title:`设备 ${l.deviceId} 详细日志`,direction:"rtl",size:"1200px","before-close":o.handleClose},{default:(0,t.k6)(()=>[(0,t.Lk)("div",x,[(0,t.Lk)("div",I,[(0,t.bF)(u,{type:"primary",onClick:a[0]||(a[0]=e=>o.showUploadDialog=!0)},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(i)]),_:1}),a[7]||(a[7]=(0,t.eW)(" 上传日志 "))]),_:1,__:[7]})]),(0,t.Lk)("div",A,[(0,t.Lk)("div",S,[o.selectedLogs&&o.selectedLogs.length>0?((0,t.uX)(),(0,t.CE)("div",V,[(0,t.bF)(u,{type:"primary",size:"small",onClick:o.handleBatchAnalyze,disabled:!o.canBatchView||!o.isSameDevice,title:e.incompleteLogsMessage||o.deviceCheckMessage},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(c)]),_:1}),(0,t.eW)(" 批量查看 ("+(0,s.v_)(o.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),(0,t.bF)(u,{type:"success",size:"small",onClick:o.handleBatchDownload,disabled:!o.canBatchDownload,title:e.incompleteLogsMessage},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(p)]),_:1}),(0,t.eW)(" 批量下载 ("+(0,s.v_)(o.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),(0,t.bF)(u,{type:"danger",size:"small",onClick:o.handleBatchDelete,disabled:!o.canBatchDelete,title:e.incompleteLogsMessage},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(v)]),_:1}),(0,t.eW)(" 批量删除 ("+(0,s.v_)(o.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"]),1===e.userRole?((0,t.uX)(),(0,t.Wv)(u,{key:0,type:"warning",size:"small",onClick:o.handleBatchReparse,disabled:0===o.selectedLogs.length||1!==e.userRole||!o.canBatchReparse,title:e.incompleteLogsMessage},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(g)]),_:1}),(0,t.eW)(" 批量重新解析 ("+(0,s.v_)(o.selectedLogs.length)+") ",1)]),_:1},8,["onClick","disabled","title"])):(0,t.Q3)("",!0),(0,t.bF)(u,{type:"info",size:"small",onClick:o.clearSelection},{default:(0,t.k6)(()=>a[8]||(a[8]=[(0,t.eW)(" 取消选择 ")])),_:1,__:[8]},8,["onClick"])])):(0,t.Q3)("",!0),(0,t.Lk)("div",M,[(0,t.bF)(k,{modelValue:o.onlyOwn,"onUpdate:modelValue":a[1]||(a[1]=e=>o.onlyOwn=e),onChange:o.applyOnlyOwn,label:"仅看自己"},null,8,["modelValue","onChange"]),(0,t.bF)(u,{plain:"",size:"small",onClick:o.resetAllFilters},{default:(0,t.k6)(()=>a[9]||(a[9]=[(0,t.eW)("重置")])),_:1,__:[9]},8,["onClick"])])]),(0,t.bo)(((0,t.uX)(),(0,t.Wv)(y,{data:o.deviceLogs,loading:o.loading,style:{width:"100%"},onSelectionChange:o.handleSelectionChange},{default:(0,t.k6)(()=>[(0,t.bF)(f,{type:"selection",width:"55"}),(0,t.bF)(f,{prop:"original_name",label:"日志文件名",width:"240"}),(0,t.bF)(f,{prop:"uploader_id",label:"上传用户ID",width:"100"}),(0,t.bF)(f,{prop:"upload_time",label:"上传时间",width:"150"},{default:(0,t.k6)(({row:e})=>[(0,t.eW)((0,s.v_)(o.formatDate(e.upload_time)),1)]),_:1}),(0,t.bF)(f,{label:"状态",width:"120",align:"center"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(h,{type:o.getRowStatusType(e),size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(o.getRowStatusText(e)),1)]),_:2},1032,["type"])]),_:1}),(0,t.bF)(f,{label:"操作",width:"350",fixed:"right"},{default:(0,t.k6)(({row:e})=>[(0,t.bF)(u,{size:"small",type:"primary",onClick:a=>o.goToLogAnalysis(e),disabled:!o.canView(e)},{default:(0,t.k6)(()=>a[10]||(a[10]=[(0,t.eW)(" 查看 ")])),_:2,__:[10]},1032,["onClick","disabled"]),(0,t.bF)(u,{size:"small",type:"info",onClick:a=>o.goToLogAnalysis(e),disabled:!o.canView(e)},{default:(0,t.k6)(()=>a[11]||(a[11]=[(0,t.eW)(" 分析 ")])),_:2,__:[11]},1032,["onClick","disabled"]),(0,t.bF)(u,{size:"small",type:"success",onClick:a=>o.handleDownload(e),disabled:!o.canDownload(e)},{default:(0,t.k6)(()=>a[12]||(a[12]=[(0,t.eW)(" 下载 ")])),_:2,__:[12]},1032,["onClick","disabled"]),o.canDeleteLog(e)?((0,t.uX)(),(0,t.Wv)(u,{key:0,size:"small",type:"danger",onClick:a=>o.handleDelete(e),disabled:!("parsed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"failed"===e.status)},{default:(0,t.k6)(()=>a[13]||(a[13]=[(0,t.eW)(" 删除 ")])),_:2,__:[13]},1032,["onClick","disabled"])):(0,t.Q3)("",!0),o.canReparse?((0,t.uX)(),(0,t.Wv)(u,{key:1,size:"small",type:"warning",onClick:a=>o.handleReparse(e),disabled:!o.canReparseLog(e)||e.parsing},{default:(0,t.k6)(()=>a[14]||(a[14]=[(0,t.eW)(" 重新解析 ")])),_:2,__:[14]},1032,["onClick","disabled"])):(0,t.Q3)("",!0)]),_:1})]),_:1},8,["data","loading","onSelectionChange"])),[[W,o.loading]]),(0,t.Lk)("div",T,[(0,t.bF)(m,{"current-page":o.currentPage,"page-size":o.pageSize,"page-sizes":[10,20,50,100],total:o.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:o.handleSizeChange,onCurrentChange:o.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])])]),(0,t.bF)(D,{modelValue:o.showUploadDialog,"onUpdate:modelValue":a[5]||(a[5]=e=>o.showUploadDialog=e),title:"上传日志",width:"700px","append-to-body":""},{footer:(0,t.k6)(()=>[(0,t.Lk)("div",le,[(0,t.bF)(u,{onClick:a[4]||(a[4]=e=>o.showUploadDialog=!1),disabled:o.uploading},{default:(0,t.k6)(()=>a[22]||(a[22]=[(0,t.eW)("取消")])),_:1,__:[22]},8,["disabled"]),(0,t.bF)(u,{type:"primary",onClick:o.submitUpload,loading:o.uploading,disabled:o.uploading||!o.decryptKey.trim()||0===o.uploadFileList.length},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(o.uploading?"解析中...":"上传并解析"),1)]),_:1},8,["onClick","loading","disabled"])])]),default:(0,t.k6)(()=>[(0,t.bF)(_,{ref:"uploadRef",action:o.uploadUrl,headers:o.uploadHeaders,"before-upload":o.beforeUpload,"on-success":o.onUploadSuccess,"on-error":o.onUploadError,"on-exceed":o.onExceed,"on-change":o.onFileChange,"on-remove":o.onFileRemove,"on-progress":e.onUploadProgress,"auto-upload":!1,"show-file-list":!1,multiple:!0,limit:50,accept:".medbot",name:"file",disabled:o.uploading},{tip:(0,t.k6)(()=>[(0,t.Lk)("div",$,[o.uploading?((0,t.uX)(),(0,t.CE)("div",O,[(0,t.bF)(d,{class:"is-loading"},{default:(0,t.k6)(()=>[(0,t.bF)(g)]),_:1}),a[16]||(a[16]=(0,t.eW)(" 文件上传中，上传完成后才能进行下一次上传操作 "))])):((0,t.uX)(),(0,t.CE)("div",X," 支持上传 .medbot 文件，最多50个文件，总大小不超过200MB，上传后将自动解密并解析 "))])]),default:(0,t.k6)(()=>[(0,t.bF)(u,{type:"primary",disabled:o.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(d,{class:"el-icon--upload"},{default:(0,t.k6)(()=>[(0,t.bF)(b)]),_:1}),a[15]||(a[15]=(0,t.eW)(" 选择文件 "))]),_:1,__:[15]},8,["disabled"])]),_:1},8,["action","headers","before-upload","on-success","on-error","on-exceed","on-change","on-remove","on-progress","disabled"]),o.uploadFileList&&o.uploadFileList.length>0?((0,t.uX)(),(0,t.CE)("div",N,[(0,t.Lk)("div",j,[(0,t.Lk)("span",null,"已选择的文件 ("+(0,s.v_)(o.uploadFileList.length)+")",1),(0,t.bF)(u,{type:"text",size:"small",onClick:o.clearUpload,disabled:o.uploading},{default:(0,t.k6)(()=>a[17]||(a[17]=[(0,t.eW)(" 清空 ")])),_:1,__:[17]},8,["onClick","disabled"])]),(0,t.Lk)("div",P,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(o.uploadFileList,(e,a)=>((0,t.uX)(),(0,t.CE)("div",{key:a,class:"file-item"},[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(w)]),_:1}),(0,t.Lk)("span",G,(0,s.v_)(e.name||e.originalname),1),(0,t.Lk)("span",Q,(0,s.v_)(e.sizeText),1),(0,t.bF)(u,{type:"text",size:"small",onClick:e=>o.removeFile(a),disabled:o.uploading},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(v)]),_:1})]),_:2},1032,["onClick","disabled"])]))),128))])])):(0,t.Q3)("",!0),(0,t.Lk)("div",Y,[(0,t.Lk)("div",Z,[(0,t.bF)(C,{modelValue:o.decryptKey,"onUpdate:modelValue":a[2]||(a[2]=e=>o.decryptKey=e),placeholder:"请输入解密密钥（MAC地址格式，如：00-01-05-77-6a-09）",style:{width:"300px"},clearable:"",onBlur:o.validateKeyFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(F)]),_:1})]),_:1},8,["modelValue","onBlur"]),(0,t.bF)(u,{type:"primary",plain:"",onClick:o.autoFillDeviceId,disabled:!o.decryptKey.trim()},{default:(0,t.k6)(()=>a[18]||(a[18]=[(0,t.eW)(" 自动填充设备编号 ")])),_:1,__:[18]},8,["onClick","disabled"]),a[20]||(a[20]=(0,t.Lk)("span",{class:"key-separator"},"或",-1)),(0,t.bF)(_,{ref:"keyUploadRef","auto-upload":!1,"show-file-list":!1,accept:".txt","before-upload":o.beforeKeyUpload,"on-change":o.onKeyFileChange},{default:(0,t.k6)(()=>[(0,t.bF)(u,{type:"primary",plain:""},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(L)]),_:1}),a[19]||(a[19]=(0,t.eW)(" 上传密钥文件 "))]),_:1,__:[19]})]),_:1},8,["before-upload","on-change"])]),o.keyFileName?((0,t.uX)(),(0,t.CE)("div",H,[(0,t.bF)(h,{type:"success",size:"small"},{default:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(w)]),_:1}),(0,t.eW)(" "+(0,s.v_)(o.keyFileName),1)]),_:1})])):(0,t.Q3)("",!0),o.keyError?((0,t.uX)(),(0,t.CE)("div",q,[(0,t.bF)(h,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(o.keyError),1)]),_:1})])):(0,t.Q3)("",!0)]),(0,t.Lk)("div",J,[(0,t.Lk)("div",ee,[(0,t.bF)(C,{modelValue:o.deviceIdInput,"onUpdate:modelValue":a[3]||(a[3]=e=>o.deviceIdInput=e),placeholder:`设备编号（格式：数字或字母组合，例：${e.props.deviceId}）`,style:{width:"300px"},clearable:"",onBlur:o.validateDeviceIdFormat},{prefix:(0,t.k6)(()=>[(0,t.bF)(d,null,{default:(0,t.k6)(()=>[(0,t.bF)(c)]),_:1})]),_:1},8,["modelValue","placeholder","onBlur"]),(0,t.bF)(u,{type:"primary",plain:"",onClick:o.autoFillKey,disabled:!o.deviceIdInput.trim()},{default:(0,t.k6)(()=>a[21]||(a[21]=[(0,t.eW)(" 自动填充密钥 ")])),_:1,__:[21]},8,["onClick","disabled"])]),o.deviceIdError?((0,t.uX)(),(0,t.CE)("div",ae,[(0,t.bF)(h,{type:"danger",size:"small"},{default:(0,t.k6)(()=>[(0,t.eW)((0,s.v_)(o.deviceIdError),1)]),_:1})])):(0,t.Q3)("",!0)])]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","before-close"])}var se={name:"DeviceLogDrawer",props:{modelValue:{type:Boolean,default:!1},deviceId:{type:String,required:!0}},emits:["update:modelValue"],setup(e,{emit:a}){const l=(0,z.Pj)(),s=(0,B.rd)(),o=(0,E.KR)(!1),r=(0,E.KR)(!1),n=(0,E.KR)(!1),i=(0,E.KR)(null),d=(0,E.KR)(null),u=(0,E.KR)(1),c=(0,E.KR)(20),p=(0,E.KR)(""),v=(0,E.KR)(""),g=(0,E.KR)(""),k=(0,E.KR)([]),f=(0,E.KR)(""),h=(0,E.KR)(""),y=(0,E.KR)([]),m=(0,E.KR)(!1),b=((0,t.EW)({get:()=>e.modelValue,set:e=>a("update:modelValue",e)}),(0,t.EW)(()=>Array.isArray(l.getters["logs/logsList"])?l.getters["logs/logsList"]:[])),_=(0,t.EW)(()=>l.getters["logs/totalCount"]),w=(0,t.EW)(()=>"/api/logs/upload"),F=(0,t.EW)(()=>({Authorization:`Bearer ${l.state.auth.token}`,"X-Decrypt-Key":p.value,"X-Device-ID":g.value})),C=(0,t.EW)(()=>l.state.auth.user?.role_id),L=(0,t.EW)(()=>l.state.auth.user?.id),D=(0,t.EW)(()=>l.getters["auth/hasPermission"]?.("log:reparse")),R=(0,t.EW)(()=>y.value.length>0&&y.value.every(e=>ye(e))&&y.value.every(e=>"parsed"===e.status)),W=(0,t.EW)(()=>y.value.length>0&&y.value.every(e=>me(e))&&y.value.every(e=>"parsed"===e.status)),x=(0,t.EW)(()=>y.value.length>0&&y.value.every(e=>he(e))&&y.value.every(e=>"parsed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"failed"===e.status)),I=(0,t.EW)(()=>y.value.length>0&&y.value.every(e=>be(e))&&y.value.every(e=>"parsed"===e.status||"parse_failed"===e.status)),A=(0,t.EW)(()=>{if(0===y.value.length)return!0;const e=y.value[0].device_id;return y.value.every(a=>a.device_id===e)}),S=(0,t.EW)(()=>{if(0===y.value.length)return"";if(!A.value){const e=[...new Set(y.value.map(e=>e.device_id))];return`选中日志包含不同的设备: ${e.join(", ")}`}return""}),V=(0,t.EW)(()=>y.value.some(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status)),M=((0,t.EW)(()=>{if(0===y.value.length)return"";if(V.value){const e=y.value.filter(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status).length;return`选中的日志中有 ${e} 个未完成解析，请等待解析完成后再操作`}return""}),async()=>{try{o.value=!0,await l.dispatch("logs/fetchLogs",{page:u.value,limit:c.value,device_id:e.deviceId,only_own:m.value||void 0})}catch(a){K.nk.error("加载设备日志失败")}finally{o.value=!1}}),T=()=>{a("update:modelValue",!1)},$=e=>{c.value=e,u.value=1,M()},X=e=>{u.value=e,M()},O=e=>{y.value=e},N=()=>{y.value=[]},j=()=>{const e=y.value.map(e=>e.id).join(","),a=s.resolve(`/batch-analysis/${e}`);window.open(a.href,"_blank")},P=async()=>{try{K.nk.info("正在打包文件，请稍候...");const e=y.value.map(e=>e.id),a=await l.dispatch("logs/batchDownloadLogs",e),t=new Blob([a.data]),s=window.URL.createObjectURL(t),o=document.createElement("a");o.href=s;const r=(new Date).toISOString().replace(/[:.]/g,"-");o.download=`logs_batch_${r}.zip`,o.click(),window.URL.revokeObjectURL(s),K.nk.success("批量下载完成")}catch(e){console.error("批量下载失败:",e);const a=e.response?.data?.message||e.message||"批量下载失败";K.nk.error(a)}},G=async()=>{try{if(V.value)return void K.nk.warning("请等待所有选中的日志解析完成后再进行删除操作");await U.s.confirm(`确定要删除选中的 ${y.value.length} 个日志文件吗？此操作不可恢复！`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"});const a=[...y.value],t=a.map(e=>parseInt(e.id)).filter(e=>!isNaN(e));if(0===t.length)return void K.nk.error("选中的日志ID格式不正确");try{await l.dispatch("logs/batchDeleteLogs",t),M(),N()}catch(e){console.error("批量删除失败:",e);const a=e.response?.data?.message||e.message||"批量删除失败";K.nk.error(a)}}catch(a){if("cancel"!==a){console.error("批量删除错误:",a);let e="批量删除失败";a.response?.data?.message?e=a.response.data.message:a.message&&(e=a.message),K.nk.error(e)}}},Q=async()=>{try{if(!D.value)return void K.nk.error("仅管理员可批量重新解析");if(!y.value.length)return void K.nk.warning("请先选择要重新解析的日志");if(V.value)return void K.nk.warning("请等待所有选中的日志解析完成后再进行重新解析操作");await U.s.confirm(`确定对选中的 ${y.value.length} 个日志重新解析释义吗？`,"批量重新解析确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=y.value.map(e=>e.id);y.value.forEach(e=>{e.status="parsing"}),await l.dispatch("logs/batchReparseLogs",e),await M()}catch(e){if("cancel"!==e){const a=e.response?.data?.message||e.message||"批量重新解析失败";K.nk.error(a)}}},Y=()=>{u.value=1,M()},Z=()=>{m.value=!1,u.value=1,M()},H=()=>{if(!p.value.trim())return void K.nk.error("请输入解密密钥或上传密钥文件");const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;if(!e.test(p.value))return void K.nk.error("密钥格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）");if(!g.value.trim())return void K.nk.warning("请输入设备编号，或使用默认值0000-00");if(!g.value||"0000-00"===g.value)return void K.nk.warning("请输入设备编号，或使用默认值0000-00");{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;if(!e.test(g.value))return void K.nk.error("设备编号格式不正确，应为数字或字母组合格式（如：4371-01、ABC-12、123-XY）")}if(!i.value)return void K.nk.error("上传组件未初始化");if(0===k.value.length)return void K.nk.error("请选择要上传的文件");if(k.value.length>50)return void K.nk.error("最多只能上传50个文件");const a=k.value.reduce((e,a)=>e+(a.size||a.raw?.size||0),0);a/1024/1024>200?K.nk.error("总文件大小不能超过200MB"):(i.value.submit(),n.value=!1,M())},q=e=>{const a=e.name.endsWith(".medbot"),l=e.size/1024/1024<200;return a?l?!!p.value.trim()||(K.nk.error("请输入解密密钥或上传密钥文件!"),!1):(K.nk.error("单个文件大小不能超过200MB!"),!1):(K.nk.error("只能上传 .medbot 文件!"),!1)},J=e=>{const a=e.name.endsWith(".txt"),l="systemInfo.txt"===e.name,t=e.size/1024/1024<1;return a?l?(t||K.nk.error("密钥文件大小不能超过1MB!"),!1):(K.nk.error("密钥文件名必须是 systemInfo.txt!"),!1):(K.nk.error("密钥文件必须是 .txt 格式!"),!1)},ee=e=>{const a=new FileReader;a.onload=a=>{const l=(a.target.result||"").trim(),t=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;t.test(l)?(p.value=l,v.value=e.name,f.value="",K.nk.success("密钥文件读取成功")):K.nk.error("密钥文件内容格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）")},a.readAsText(e.raw)},ae=()=>{i.value&&i.value.clearFiles(),d.value&&d.value.clearFiles(),k.value=[],p.value="",v.value="",g.value="",f.value="",h.value="",r.value=!1},le=(e,a,l)=>{console.log("上传成功:",e),ie(l);const t=l.length>0&&l.every(e=>"success"===e.status);t&&(r.value=!0,K.nk.success("文件上传成功，正在处理..."),M())},te=e=>{K.nk.error("上传失败: "+(e.message||"未知错误"))},se=(e,a)=>{K.nk.error("最多只能上传50个文件!")},oe=(e,a)=>{ie(a)},re=(e,a)=>{ie(a)},ne=e=>{k.value.splice(e,1)},ie=e=>{const a=(e||[]).map(e=>{const a=e.size||e.raw?.size||0,l=Fe(a);return{...e,sizeText:l}});k.value=a},de=async e=>{try{const a=await l.dispatch("logs/downloadLog",e.id),t=new Blob([a.data]),s=window.URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=e.filename,o.click(),window.URL.revokeObjectURL(s),K.nk.success("下载成功")}catch(a){K.nk.error("下载失败")}},ue=async e=>{try{await U.s.confirm("确定要删除这个日志文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await l.dispatch("logs/deleteLog",e.id),K.nk.success("删除成功"),await M()}catch(a){"cancel"!==a&&K.nk.error("删除失败")}},ce=e=>{const a=s.resolve(`/batch-analysis/${e.id}`);window.open(a.href,"_blank")},pe=async e=>{try{if(!D.value)return void K.nk.error("仅管理员可重新解析");e.parsing=!0,e.status="parsing",await l.dispatch("logs/reparseLog",e.id),K.nk.success("重新解析完成"),await M()}catch(a){const e=a.response?.data?.message||a.message||"重新解析失败";K.nk.error(e)}finally{e.parsing=!1}},ve=async()=>{try{const e=await l.dispatch("logs/autoFillKey",g.value);e.data.key?(p.value=e.data.key,K.nk.success("已自动填充密钥")):K.nk.warning("未找到该设备编号对应的密钥")}catch(e){console.error("自动填充密钥错误:",e);const a=e.response?.data?.message||e.message||"自动填充密钥失败";K.nk.error(a)}},ge=()=>{const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;p.value&&!e.test(p.value)?f.value="请输入有效的MAC地址格式密钥 (如: 00-01-05-77-6a-09)":f.value=""},ke=async()=>{try{const e=await l.dispatch("logs/autoFillDeviceId",p.value);e.data.device_id?(g.value=e.data.device_id,K.nk.success("已自动填充设备编号")):K.nk.warning("未找到该密钥对应的设备编号")}catch(e){console.error("自动填充设备编号错误:",e);const a=e.response?.data?.message||e.message||"自动填充设备编号失败";K.nk.error(a)}},fe=()=>{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;g.value&&!e.test(g.value)?h.value="请输入有效的设备编号格式 (如: 4371-01、ABC-12、123-XY)":h.value=""},he=e=>1===C.value||(2===C.value||3===C.value&&e.uploader_id===L.value),ye=e=>"parsed"===e.status,me=e=>"parsed"===e.status,be=e=>"parsed"===e.status||"parse_failed"===e.status,_e=e=>{const a={uploading:"warning",decrypting:"warning",parsing:"warning",parsed:"success",failed:"danger",decrypt_failed:"danger",parse_failed:"danger",file_error:"danger"};return a[e.status]||"info"},we=e=>{const a={uploading:"日志上传中",decrypting:"解密中",parsing:"解析中",parsed:"完成",decrypt_failed:"解密失败",parse_failed:"解析失败",file_error:"文件错误",failed:"处理失败"};return a[e.status]||e.status||"-"},Fe=e=>{if(0===e)return"0 B";const a=1024,l=["B","KB","MB","GB"],t=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,t)).toFixed(2))+" "+l[t]},Ce=e=>e?new Date(e).toLocaleString("zh-CN"):"-";return(0,t.wB)(()=>e.deviceId,e=>{e&&(g.value=e,M())}),(0,t.sV)(()=>{e.deviceId&&(g.value=e.deviceId,M())}),{loading:o,uploading:r,showUploadDialog:n,uploadRef:i,currentPage:u,pageSize:c,deviceLogs:b,total:_,uploadUrl:w,uploadHeaders:F,loadDeviceLogs:M,handleClose:T,handleSizeChange:$,handleCurrentChange:X,submitUpload:H,beforeUpload:q,clearUpload:ae,onUploadSuccess:le,onUploadError:te,onExceed:se,onFileChange:oe,onFileRemove:re,removeFile:ne,handleDownload:de,handleDelete:ue,goToLogAnalysis:ce,handleReparse:pe,canReparse:D,canDeleteLog:he,canView:ye,canDownload:me,canReparseLog:be,getRowStatusType:_e,getRowStatusText:we,formatFileSize:Fe,formatDate:Ce,decryptKey:p,keyUploadRef:d,keyFileName:v,deviceIdInput:g,uploadFileList:k,beforeKeyUpload:J,onKeyFileChange:ee,keyError:f,deviceIdError:h,autoFillKey:ve,validateKeyFormat:ge,autoFillDeviceId:ke,validateDeviceIdFormat:fe,selectedLogs:y,canBatchView:R,canBatchDownload:W,canBatchReparse:I,canBatchDelete:x,isSameDevice:A,deviceCheckMessage:S,handleSelectionChange:O,clearSelection:N,handleBatchAnalyze:j,handleBatchDownload:P,handleBatchDelete:G,handleBatchReparse:Q,onlyOwn:m,applyOnlyOwn:Y,resetAllFilters:Z}}},oe=l(6262);const re=(0,oe.A)(se,[["render",te],["__scopeId","data-v-1d125038"]]);var ne=re,ie={name:"Logs",components:{DeviceLogDrawer:ne},setup(){const e=(0,z.Pj)(),a=(0,B.rd)(),l=(0,E.KR)(!1),s=(0,E.KR)(!1),o=(0,E.KR)(!1),r=(0,E.KR)(0),n=(0,E.KR)(""),i=(0,E.KR)(null),d=(0,E.KR)(null),u=(0,E.KR)(1),c=(0,E.KR)(20),p=(0,E.KR)(!1),v=(0,E.KR)(!1),g=(0,E.KR)(""),k=(0,E.KR)(!1),f=(0,E.KR)(!1),h=(0,E.KR)(""),y=(0,E.KR)([{text:"本年",value:()=>{const e=new Date((new Date).getFullYear(),0,1,0,0,0),a=new Date((new Date).getFullYear(),11,31,23,59,59);return[e,a]}},{text:"本月",value:()=>{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1,0,0,0),l=new Date(e.getFullYear(),e.getMonth()+1,0,23,59,59);return[a,l]}},{text:"今天",value:()=>{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),l=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);return[a,l]}}]),m=(0,E.KR)(""),b=(0,E.KR)(""),_=(0,E.KR)(""),w=(0,E.KR)(""),F=(0,E.KR)([]),C=(0,E.KR)(""),L=(0,E.KR)(""),D=(0,E.KR)([]),R=(0,t.EW)(()=>Array.isArray(e.getters["logs/logsList"])?e.getters["logs/logsList"]:[]),W=(0,t.EW)(()=>e.getters["logs/totalCount"]),x=(0,t.EW)(()=>Array.isArray(e.getters["logs/deviceGroupsList"])?e.getters["logs/deviceGroupsList"]:[]),I=(0,t.EW)(()=>e.getters["logs/isDeviceGroupsLoading"]),A=(0,t.EW)(()=>"/api/logs/upload"),S=(0,t.EW)(()=>({Authorization:`Bearer ${e.state.auth.token}`,"X-Decrypt-Key":m.value,"X-Device-ID":_.value})),V=(0,t.EW)(()=>e.state.auth.user?.role_id),M=(0,t.EW)(()=>e.state.auth.user?.id),T=(0,t.EW)(()=>D.value.length>0&&D.value.every(e=>$e(e))&&D.value.every(e=>"parsed"===e.status||"failed"===e.status)),$=(0,t.EW)(()=>D.value.length>0&&D.value.every(e=>Xe(e))&&D.value.every(e=>"parsed"===e.status)),X=(0,t.EW)(()=>D.value.length>0&&D.value.every(e=>Oe(e))&&D.value.every(e=>"parsed"===e.status)),O=(0,t.EW)(()=>D.value.length>0&&D.value.every(e=>Ne(e))&&D.value.every(e=>"parsed"===e.status||"parse_failed"===e.status)),N=(0,t.EW)(()=>{if(0===D.value.length)return!0;const e=D.value[0].device_id;return D.value.every(a=>a.device_id===e)}),j=(0,t.EW)(()=>{if(0===D.value.length)return"";if(!N.value){const e=[...new Set(D.value.map(e=>e.device_id))];return`选中日志包含不同的设备: ${e.join(", ")}`}return""}),P=(0,t.EW)(()=>D.value.some(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status)),G=((0,t.EW)(()=>{if(0===D.value.length)return"";if(P.value){const e=D.value.filter(e=>"parsed"!==e.status&&"failed"!==e.status&&"decrypt_failed"!==e.status&&"parse_failed"!==e.status&&"file_error"!==e.status).length;return`选中的日志中有 ${e} 个未完成解析，请等待解析完成后再操作`}return""}),(0,t.EW)(()=>D.value.length>0&&D.value.every(e=>Q(e))&&D.value.every(e=>"parsed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status||"failed"===e.status))),Q=e=>1===V.value||(2===V.value||3===V.value&&e.uploader_id===M.value),Y=async()=>{try{l.value=!0;const a=ee();await e.dispatch("logs/fetchLogs",{page:u.value,limit:c.value,device_id:w.value||void 0,...a})}catch(a){K.nk.error("加载日志失败")}finally{l.value=!1}},Z=async()=>{try{await e.dispatch("logs/fetchDeviceGroups",{only_own:k.value||void 0})}catch(a){K.nk.error("加载设备分组失败")}},H=e=>{h.value=e,f.value=!0},q=e=>{c.value=e,u.value=1,Y()},J=e=>{u.value=e,Y()},ee=()=>{const e=(g.value||"").trim();return e&&/^[0-9]{4}(?:[0-9]{2}){0,3}$/.test(e)?{time_prefix:e,only_own:k.value||void 0}:{only_own:k.value||void 0}},ae=()=>{u.value=1,p.value=!1,Y()},le=()=>{g.value="",ae()},te=()=>{u.value=1,v.value=!1,Y()},se=()=>{w.value="",te()},oe=()=>{Z()},re=()=>{k.value=!1,Z()},ne=()=>{if(!m.value.trim())return void K.nk.error("请输入解密密钥或上传密钥文件");const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;if(!e.test(m.value))return void K.nk.error("密钥格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）");if(!_.value.trim())return void K.nk.warning("请输入设备编号，或使用默认值0000-00");if(!_.value||"0000-00"===_.value)return void K.nk.warning("请输入设备编号，或使用默认值0000-00");{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;if(!e.test(_.value))return void K.nk.error("设备编号格式不正确，应为数字或字母组合格式（如：4371-01、ABC-12、123-XY）")}if(!i.value)return void K.nk.error("上传组件未初始化");if(0===F.value.length)return void K.nk.error("请选择要上传的文件");if(F.value.length>50)return void K.nk.error("最多只能上传50个文件");const a=F.value.reduce((e,a)=>e+(a.size||a.raw?.size||0),0);a/1024/1024>200?K.nk.error("总文件大小不能超过200MB"):(i.value.submit(),o.value=!1,Y())},ie=e=>{const a=e.name.endsWith(".medbot"),l=e.size/1024/1024<200;return a?l?!!m.value.trim()||(K.nk.error("请输入解密密钥或上传密钥文件!"),!1):(K.nk.error("单个文件大小不能超过200MB!"),!1):(K.nk.error("只能上传 .medbot 文件!"),!1)},de=e=>{const a=e.name.endsWith(".txt"),l="systemInfo.txt"===e.name,t=e.size/1024/1024<1;return a?l?(t||K.nk.error("密钥文件大小不能超过1MB!"),!1):(K.nk.error("密钥文件名必须是 systemInfo.txt!"),!1):(K.nk.error("密钥文件必须是 .txt 格式!"),!1)},ue=e=>{const a=new FileReader;a.onload=a=>{_e(()=>{const l=(a.target.result||"").trim(),t=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;t.test(l)?(m.value=l,b.value=e.name,C.value="",K.nk.success("密钥文件读取成功")):K.nk.error("密钥文件内容格式不正确，应为MAC地址格式（如：00-01-05-77-6a-09）")})},a.readAsText(e.raw)},ce=()=>{i.value&&i.value.clearFiles(),d.value&&d.value.clearFiles(),F.value=[],m.value="",b.value="",_.value="",C.value="",L.value="",s.value=!1,r.value=0},pe=e=>e<30?`文件上传中 ${e}%`:e<60?`解密处理中 ${e}%`:e<100?`解析处理中 ${e}%`:`处理完成 ${e}%`,ve=()=>{if(s.value)return"解析正在进行中，刷新页面可能导致解析失败。确定要离开吗？"};(0,t.sV)(()=>{window.addEventListener("beforeunload",ve)});const ge=(e,a,l)=>{console.log("上传成功:",e),we(l);const t=l.length>0&&l.every(e=>"success"===e.status);t&&(s.value=!0,r.value=30,n.value="文件已上传，等待处理...",ke())},ke=()=>{let e=0;const a=30,l=async()=>{try{await Y(),e++;const t=R.value.filter(e=>"uploading"===e.status||"decrypting"===e.status||"parsing"===e.status);if(t.length>0){const o=t.filter(e=>"uploading"===e.status).length,i=t.filter(e=>"decrypting"===e.status).length,d=t.filter(e=>"parsing"===e.status).length;o>0?(r.value=30,n.value="文件上传中..."):i>0?(r.value=45,n.value="解密中..."):d>0&&(r.value=75,n.value="解析中..."),e<a?setTimeout(l,2e3):(s.value=!1,r.value=0,n.value="",K.nk.warning("处理超时，请刷新页面查看最新状态"),ce())}else{const t=R.value.every(e=>"parsed"===e.status),i=R.value.some(e=>"failed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status);t?(r.value=100,s.value=!1,n.value="",o.value=!1,ce()):i?(s.value=!1,r.value=0,n.value="",K.nk.error("部分日志处理失败，请检查日志详情"),ce()):e<a?setTimeout(l,2e3):(s.value=!1,r.value=0,n.value="",K.nk.warning("处理超时，请刷新页面查看最新状态"),ce())}}catch(t){s.value=!1,r.value=0,n.value="",K.nk.error("检查状态失败"),ce()}};setTimeout(l,1e3)},fe=e=>{K.nk.error("上传失败: "+(e.message||"未知错误"))},he=(e,a)=>{K.nk.error("最多只能上传50个文件!")},ye=(e,a)=>{we(a)},me=(e,a)=>{we(a)},be=e=>{F.value.splice(e,1)},_e=e=>{const a=window.requestIdleCallback||(e=>setTimeout(()=>e({timeRemaining:()=>0}),1));a(()=>e())},we=e=>{const a=(e||[]).map(e=>{const a=e.size||e.raw?.size||0,l=Be(a);return{...e,sizeText:l}});_e(()=>{F.value=a})},Fe=async a=>{try{a.parsing=!0,await e.dispatch("logs/parseLog",a.id),K.nk.success("解析成功"),Y()}catch(l){K.nk.error("解析失败")}finally{a.parsing=!1}},Ce=(0,t.EW)(()=>e.getters["auth/hasPermission"]?.("log:reparse")),Le=async a=>{try{if(!Ce.value)return void K.nk.error("仅管理员可重新解析");a.parsing=!0,a.status="parsing",await e.dispatch("logs/reparseLog",a.id),K.nk.success("重新解析完成"),await Y()}catch(l){const e=l.response?.data?.message||l.message||"重新解析失败";K.nk.error(e)}finally{a.parsing=!1}},De=async a=>{try{const l=await e.dispatch("logs/downloadLog",a.id),t=new Blob([l.data]),s=window.URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=a.filename,o.click(),window.URL.revokeObjectURL(s),K.nk.success("下载成功")}catch(l){K.nk.error("下载失败")}},Re=(0,E.KR)(new Set),We=e=>Re.value.has(e),Ee=async a=>{try{await U.s.confirm("确定要删除这个日志文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),Re.value.add(a.id),await(0,t.dY)(),await e.dispatch("logs/deleteLog",a.id),K.nk.success("删除成功"),await Y()}catch(l){"cancel"!==l&&K.nk.error("删除失败")}finally{Re.value.delete(a.id)}},ze=e=>{const l=a.resolve(`/batch-analysis/${e.id}`);window.open(l.href,"_blank")},Be=e=>{if(0===e)return"0 B";const a=1024,l=["B","KB","MB","GB"],t=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,t)).toFixed(2))+" "+l[t]},Ke=e=>e?new Date(e).toLocaleString("zh-CN"):"-",Ue=e=>{if(Re.value.has(e.id))return"warning";const a={uploading:"warning",decrypting:"warning",parsing:"warning",parsed:"success",failed:"danger",decrypt_failed:"danger",parse_failed:"danger",file_error:"danger"};return a[e.status]||"info"},xe=e=>{if(Re.value.has(e.id))return"删除中";const a={uploading:"日志上传中",decrypting:"解密中",parsing:"解析中",parsed:"完成",decrypt_failed:"解密失败",parse_failed:"解析失败",file_error:"文件错误",failed:"处理失败"};return a[e.status]||e.status||"-"},Ie=e=>{D.value=e;try{sessionStorage.setItem("selectedLogs",JSON.stringify(e))}catch(a){console.warn("保存选中日志到sessionStorage失败:",a)}},Ae=()=>{D.value=[]},Se=()=>{const e=D.value.map(e=>e.id).join(","),l=a.resolve(`/batch-analysis/${e}`);window.open(l.href,"_blank")},Ve=async()=>{try{K.nk.info("正在打包文件，请稍候...");const a=D.value.map(e=>e.id),l=await e.dispatch("logs/batchDownloadLogs",a),t=new Blob([l.data]),s=window.URL.createObjectURL(t),o=document.createElement("a");o.href=s;const r=(new Date).toISOString().replace(/[:.]/g,"-");o.download=`logs_batch_${r}.zip`,o.click(),window.URL.revokeObjectURL(s),K.nk.success("批量下载完成")}catch(a){console.error("批量下载失败:",a);const e=a.response?.data?.message||a.message||"批量下载失败";K.nk.error(e)}},Me=async()=>{try{if(P.value)return void K.nk.warning("请等待所有选中的日志解析完成后再进行删除操作");await U.s.confirm(`确定要删除选中的 ${D.value.length} 个日志文件吗？此操作不可恢复！`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"});const l=[...D.value],s=l.map(e=>parseInt(e.id)).filter(e=>!isNaN(e));if(0===s.length)return void K.nk.error("选中的日志ID格式不正确");s.forEach(e=>Re.value.add(e)),await(0,t.dY)();try{await e.dispatch("logs/batchDeleteLogs",s),s.forEach(e=>Re.value.delete(e)),Y(),Ae()}catch(a){console.error("批量删除失败:",a);const e=a.response?.data?.message||a.message||"批量删除失败";K.nk.error(e),s.forEach(e=>Re.value.delete(e))}}catch(l){if("cancel"!==l){console.error("批量删除错误:",l),console.error("错误详情:",{name:l.name,message:l.message,code:l.code,response:l.response?.data,status:l.response?.status,statusText:l.response?.statusText,config:{url:l.config?.url,method:l.config?.method,data:l.config?.data}});let e="批量删除失败";l.response?.data?.message?e=l.response.data.message:l.message&&(e=l.message),K.nk.error(e)}}},Te=async()=>{try{if(!Ce.value)return void K.nk.error("仅管理员可批量重新解析");if(!D.value.length)return void K.nk.warning("请先选择要重新解析的日志");if(P.value)return void K.nk.warning("请等待所有选中的日志解析完成后再进行重新解析操作");await U.s.confirm(`确定对选中的 ${D.value.length} 个日志重新解析释义吗？`,"批量重新解析确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=D.value.map(e=>e.id);D.value.forEach(e=>{e.status="parsing"}),await e.dispatch("logs/batchReparseLogs",a),await Y()}catch(a){if("cancel"!==a){const e=a.response?.data?.message||a.message||"批量重新解析失败";K.nk.error(e)}}},$e=e=>"parsed"===e.status||"failed"===e.status||"decrypt_failed"===e.status||"parse_failed"===e.status||"file_error"===e.status,Xe=e=>"parsed"===e.status,Oe=e=>"parsed"===e.status,Ne=e=>"parsed"===e.status||"parse_failed"===e.status,je=async()=>{try{const a=await e.dispatch("logs/autoFillKey",_.value);a.data.key?(m.value=a.data.key,K.nk.success("已自动填充密钥")):K.nk.warning("未找到该设备编号对应的密钥")}catch(a){console.error("自动填充密钥错误:",a);const e=a.response?.data?.message||a.message||"自动填充密钥失败";K.nk.error(e)}},Pe=()=>{const e=/^([0-9A-Fa-f]{2}-){5}[0-9A-Fa-f]{2}$/;m.value&&!e.test(m.value)?C.value="请输入有效的MAC地址格式密钥 (如: 00-01-05-77-6a-09)":C.value=""},Ge=async()=>{try{const a=await e.dispatch("logs/autoFillDeviceId",m.value);a.data.device_id?(_.value=a.data.device_id,K.nk.success("已自动填充设备编号")):K.nk.warning("未找到该密钥对应的设备编号")}catch(a){console.error("自动填充设备编号错误:",a);const e=a.response?.data?.message||a.message||"自动填充设备编号失败";K.nk.error(e)}},Qe=()=>{const e=/^[0-9A-Za-z]+-[0-9A-Za-z]+$/;_.value&&!e.test(_.value)?L.value="请输入有效的设备编号格式 (如: 4371-01、ABC-12、123-XY)":L.value=""};return(0,t.sV)(()=>{Z()}),{loading:l,uploading:s,showUploadDialog:o,overallProgress:r,processingStatus:n,progressFormat:pe,uploadRef:i,currentPage:u,pageSize:c,logs:R,total:W,uploadUrl:A,uploadHeaders:S,loadLogs:Y,handleSizeChange:q,handleCurrentChange:J,dateShortcuts:y,beforeUpload:ie,submitUpload:ne,clearUpload:ce,onUploadSuccess:ge,onUploadError:fe,onExceed:he,onFileChange:ye,onFileRemove:me,removeFile:be,handleParse:Fe,handleDownload:De,handleDelete:Ee,handleReparse:Le,canReparse:Ce,formatFileSize:Be,formatDate:Ke,getRowStatusType:Ue,getRowStatusText:xe,goToLogAnalysis:ze,isDeleting:We,userRole:V,decryptKey:m,keyUploadRef:d,keyFileName:b,deviceId:_,filterDeviceId:w,uploadFileList:F,beforeKeyUpload:de,onKeyFileChange:ue,canDeleteLog:Q,canOperate:$e,canView:Xe,canDownload:Oe,canReparseLog:Ne,keyError:C,deviceIdError:L,autoFillKey:je,validateKeyFormat:Pe,autoFillDeviceId:Ge,validateDeviceIdFormat:Qe,selectedLogs:D,canBatchOperate:T,canBatchView:$,canBatchDownload:X,canBatchReparse:O,canBatchDelete:G,isSameDevice:N,deviceCheckMessage:j,handleSelectionChange:Ie,clearSelection:Ae,handleBatchAnalyze:Se,handleBatchDownload:Ve,handleBatchDelete:Me,handleBatchReparse:Te,showNameFilterPanel:p,showDeviceFilterPanel:v,nameTimePrefix:g,onlyOwn:k,applyNameFilter:ae,resetNameFilter:le,applyDeviceFilter:te,resetDeviceFilter:se,applyOnlyOwn:oe,resetAllFilters:re,startStatusMonitoring:ke,deviceGroups:x,deviceGroupsLoading:I,showDeviceDrawer:f,selectedDeviceId:h,loadDeviceGroups:Z,openDeviceDrawer:H}}};const de=(0,oe.A)(ie,[["render",W],["__scopeId","data-v-65523978"]]);var ue=de}}]);
//# sourceMappingURL=33.d9c31df7.js.map