# 需求

# logTool 项目详细需求文档

## 一、项目概述

logTool 是一个集成故障码管理、日志上传与解析、账户与权限管理于一体的系统，面向具备不同权限的用户，提供一套完整的设备日志与故障码管理平台，支持多语言翻译及 XML 数据导出功能。

## 二、主要功能模块

### 1. 故障码管理模块

### 1.1 功能需求

- 展示部分故障码数据库中的内容，表头包含：已实现
  - subsystem
  - code
  - userInfo（由 user_hint 和 operation 拼接）
  - param1, param2, param3, param4
  - category
- 按照权限区分支持不同用户类型对于故障码数据库的增删改查操作；
  - 故障码的增加修改对于各字段的需求如下
    | 列名 | 填写方式 | 有效值 | 字段 | 是否必须填写 |
    | --- | --- | --- | --- | --- |
    | 子系统 | 01：运动控制软件；02：人机交互软件；03：医生控制台软件；04：手术台车软件；05：驱动器软件；06：图像软件；07：工具工厂软件。08：远程运动控制软件 09：远程医生控制台软件 0A: 远程驱动器软件；
    仅可以填写上述子系统编号之一 | 1、2、3、4、5、6、7、8、9、A | subsystem | Y |
    | 故障码 | 区分故障类型不能重复，以“0X010A”形式填写，最后一位必须为字母且仅为“A、B、C、D、E”中一个 A:A 类故障报警，报警等级最高，影响状态机跳转；B:B 类故障报警，报警等级次高，影响状态机跳转；C:C 类故障报警，不影响状态机跳转，可忽略；D:提示信息；E:日志记录； | 以“0X010A”形式填写;
    其中 0X 为 16 进制标志符，
    最后一位必须为字母且仅为“A、B、C、D、E”中一个；
    由子系统号与故障码组成的故障码不会重复对应唯一的故障类型 | code | Y |
    | 是否轴错误（TRUE/FALSE） | 标识此故障是否会有关节号，不影响交互软件显示；true = 有关节号，false = 无关节号 | TRUE/FALSE | is_arm_error | Y |
    | 精简提示信息 | 普通账户下人机交互软件显示的中文提示信息，中文文字填写；1.任意一个非日志记录的故障码必须有精简的提示信息或操作信息其中之一；2.提示类故障，精简提示信息与给用户的提示信息一致； | 中文文字填写 | short_message | Y |
    | 精简提示信息英文 | 普通账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | short_message_en | Y |
    | 给用户的提示信息 | 维护账户或管理员账户下人机交互软件显示的中文提示信息，中文文字填写； | 中文文字填写 | user_hint | Y |
    | 给用户的提示信息英文 | 维护账户或管理员账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | user_hint_en | Y |
    | 操作信息 | 人机交互软件显示的中文操作信息，中文文字填写； | 中文文字填写 | operation | Y |
    | 操作信息英文 | 人机交互软件显示的英文操作信息，英文文字填写； | 英文文字填写 | operation_en | Y |
    | 是否臂错误
    （TRUE/FALSE） | 决定人机交互软件是否显示“XX 臂”；TRUE = 显示“XX 臂”，FALSE = 不显示“XX 臂”， | TRUE/FALSE | is_axis_error | Y |
    | 详细信息 | 故障详细信息与描述 | 中文文字填写 | detail | Y |
    | 检测方法 | 故障检测方法的简述 | 中文文字填写 | method | Y |
    | 参数 1 | 故障日志记录的参数 1 | 中文文字填写 | param1 | Y |
    | 参数 2 | 故障日志记录的参数 2 | 中文文字填写 | param2 | Y |
    | 参数 3 | 故障日志记录的参数 3 | 中文文字填写 | param3 | Y |
    | 参数 4 | 故障日志记录的参数 4 | 中文文字填写 | param4 | Y |
    | 处理措施 | 故障的处理，根据故障码确定方式 A 类故障：recoverable 可恢复故障；B 类故障：unrecoverable 不可恢复故障；C 类故障 ignorable 可忽略故障；D 类 tip 提示信息,；E 类 log 日志记录； | recoverable
    unrecoverable
    tips
    log
    ignorable | solution | N |
    | 专家模式
    （TRUE/FALSE） | 用于区分是否在专家模式下显示记录该操作提示 | TRUE/FALSE | for_expert | N |
    | 初学者模式
    （TRUE/FALSE） | 用于区分是否在初学者模式下显示记录该操作提示 | TRUE/FALSE | for_novice | N |
    | 日志
    （TRUE/FALSE） | 用于区分 | TRUE/FALSE | related_log | N |
    | 停止上报方法 | 无需填写 | / | stop_report | N |
    | 故障等级 | 故障等级说明
    高级：A 类故障；
    中级：B 类故障；
    低级：C 类故障；
    无：提示信息或日志记录； | 高级
    中级
    低级
    无 | level | N |
    | 技术排查方案 | 故障报警的排查方案，用于故障小程序中 | 中文文字填写 | tech_solution | N |
    | 解释 | 故障报警的解释，用于日志分析工具解析；
    需要结合故障详细信息，解释故障具体含义与各参数的含义 | 中文文字填写 | explanation | N |
    | 故障分类 | 故障报警的分类，用于故障小程序中 | 软件
    硬件
    日志记录
    操作提示
    安全保护 | category | Y |
- 支持模糊搜索功能；
- 添加和修改 故障码时，支持同步添加或修改本地和远程端得故障码
  子系统 定义：01：运动控制软件；02：人机交互软件；03：医生控制台软件；04：手术台车软件；05：驱动器软件；06：图像软件；07：工具工厂软件。08：远程运动控制软件 09：远程医生控制台软件 0A: 远程驱动器软件；其中 01和08，03和09，05和0A 对应的子系统一致，仅区分了本地和远程；因此在修改或添加子系统为01和08，03和09，05和0A的故障码的弹窗内，修改故障码的弹窗：“更新本地/远程该故障码“；添加故障码的弹窗：”创建本地/远程该故障码“


- 支持导出当前故障码数据库中的内容至 XML 格式；
  - xml 是用于给其余软件解析故障码
  - 其中故障码数据库的 short_message_en 、user_hint_en 、operation_en 三列可以支持多语言模式，并且具备可扩展性
  - 需要支持生成针对不同语言的 xml，选择不同的语言可以导出 short_message_en 、user_hint_en 、operation_en 这三个字段使用不同语言的 xml;
  - xml 文件格式如 D:\code\Log\demo\logtool\example\FaultAnalysis_Chinese.xml 和 D:\code\Log\demo\logtool\example\FaultAnalysis_English.xml 分别是中文 xml 和英文 xml
  - 任何用户对于故障码的修改需要记录在系统日志中
  - 支持导出当前故障码数据库中的内容至 XML 格式；
    - xml是用于给其余软件解析故障码
    - 其中故障码数据库的short_message 、user_hint 、operation 三列可以支持多语言模式，并且具备可扩展性
    - 前端页面中多语言管理在故障码管理的下一层级中，具备导出xml、导入多语言表、搜索三个功能
        - 导入功能：支持多语言的short_message 、user_hint 、operation三个字段的导入，导入的数据格式为subsystem,code,short_message,user_hint,operation的csv文件；
        - 搜索功能：输入 子系统号 故障码 可以显示对应语言的short_message 、user_hint 、operation三个字段的内容；显示列表表头：子系统号 | 故障码 | 精简的提示信息 | 提示信息 | 操作信息
        - 导出xml：支持生成针对不同语言的xml，选择不同的语言可以导出short_message 、user_hint 、operation这三个字段使用不同语言的xml，支持以多选checkbox的方式，同时导出多国语言的xml
### 1.2 数据来源

- error_codes 数据表，包含中英文字段和分类信息；

### 1.3 权限控制

- 管理员与专家用户可新增、编辑、删除故障码；
- 所有用户可查看与导出。

### 2. 日志管理模块

### 2.1 上传日志功能

- 同时上传多个 `.medbot` 文件（不超过 50 个，合计不超过 200MB）；
- 支持输入或上传解密密钥（`systemInfo.txt`），校验格式是否为 MAC 地址；
- 填写设备编号（格式如 4371-01）；
- 若用户输入密钥，则自动填充设备编号，反之亦然（通过 logs 表检索）；

### 2.2 解密逻辑

- 解密逻辑与 `decode.py` 保持一致；
- 日志以小时为单位生成，解密结果为 TXT 文件，保存在服务器中；
- 解密后结构化内容写入 log_entries 数据表；
- 日志中提取故障码，通过 subsystem+code 匹配 error_codes 获取释义；
- 若释义含有 `{i:d}` 结构，需从 FaultMappings.json 中进行替换；
- 释义支持多释义选择（正则表达式）、单位转换；
第一位为子系统号,第二位为臂号的定义；第三位是关节号的定义
- 子系统号=1、3、5、8、9、A时，释义统一增加前缀，
    子系统号=1或8时，
    臂号定义：
        1-	左主控制臂
        2-	右主控制臂
        3-	1号工具臂
        4-	2号工具臂
        5-	3号工具臂
        6-	4号工具臂
        7-	1号调整臂
        8-	2号调整臂
        9-	3号调整臂
        A-	4号调整臂
        B-	主端IO
        C-	从端IO
    关节号定义：
        1-1关节
        2-2关节
        3-3关节
        4-4关节
        5-5关节
        6-6关节
        7-7关节
    子系统号=3或9时，
    关节号定义：
        1-扶手升降关节
        2-主手升降关节
        3-监视器升降
        4-监视器旋转
例如：142020A 2号臂2关节+释义内容


-修改日志解析页面，不要新建页面
 日志解析页面中的日志列表按照设备进行分类，表头：｜设备编号｜医院名称 | 日志数量｜更新时间｜ 操作 ｜
    - 更新时间：显示该设备编号下日志文件最新的上传时间；
    - 操作：查看手术、数据上传、日志上传、关注；
        - 查看手术、数据上传、关注功能暂不开放；
        - 日志上传与日志解析页面上侧的日志解析一致，但不需要输入设备编号和密钥了，因为已经是针对确定的设备编号上传日志；
    - 设备编号：点击设备编号，会以右侧出现的抽屉形式展开，抽屉1200px宽度，显示内容为该设备的详细日志列表（将原日志列表中所有功能，直接移植到详细日志列表，只是仅显示此设备的日志列表，需要注意原日志列表的后端分页、支持日志时间筛选，只看自己，重置筛选等操作，保证对每个日志条目的操作不缺失）
    - 医院名称：若暂无则不显示内容；
    - 抽屉的详细日志列表，包含标题（设备编号名称）、日志上传按钮、日志列表（与目前实现的日志列表一致只是仅显示对应设备编号的日志）。其中，日志列表的表头：多选框｜ 日志文件名｜ 上传用户 ID ｜上传时间｜ 操作 ｜状态；
        - 其中状态包括：上传中、解密中、解密失败、解析中、解析失败、完成、文件错误、处理失败；
        - 日志上传按钮：日志上传与日志解析页面上侧的日志解析一致，但不需要输入设备编号和密钥了，因为已经是针对确定的设备编号上传日志；
        - 其中操作包括：删除、下载、分析、重新解析（针对修改了释义规则）
        当状态是非完成状态时，不能进行任何操作
        - 下载：下载的是解密后的日志文件；
        - 删除：删除数据库中对应的日志内容，并且删除 uploads/logs/对应的日志解密文件
        - 分析：
         1）以列表形式显示当前选择的所有日志中的具体内容；表头：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义；
        2）支持模糊搜索、筛选功能；
        3）支持通过选择时间段筛选满足要求的日志；
        - 重新解析：当释义修改后，可以点击重新解析匹配最新的释义规则；
        - 操作权限如下表
| 操作类型 | 文件错误、处理失败 | 完成 | 解密失败 | 解析失败 | 上传中、解密中、解析中 |
| --- | --- | --- | --- | --- | --- |
| 查看/批量查看 | ❌ | ✔ | ❌ | ❌ | ❌ |
| 下载/批量下载 | ❌ | ✔ | ❌ | ❌ | ❌ |
| 删除/批量删除 | ✔ | ✔ | ✔ | ✔ | ❌ |
| 重新解析/批量重新解析 | ❌ | ✔ | ❌ | ✔ | ❌ |
| logs数据表写入 | ✔ | ✔ | ✔ | ✔ | ❌ |
| log_entries表写入 | ❌ | ✔ | ❌ | ❌ | ❌ |

并重新定义功能，原日志解析中的日志列表定义不变，点击设备后展现出来的日志列表，成为设备详细日志列表，在实现过程中详细日志列表需要保留原日志列表的功能；可以先临时保存日志列表所实现的所有功能，在实现设备详细日志列表时移植更准确

### 2.3 分析功能

- 多选分析日志内容：显示表格，表头为时间戳、故障码、param1~4、释义；
- 支持筛选（时间段、关键字、设备编号、上传用户等）；

### 2.4 下载/删除功能

- 下载解密后的日志文件；
- 删除功能删除数据库记录与上传文件（uploads/logs 子目录）；
### 分析功能

- 分析页面最上侧表头显示分析对象信息： 所选中的日志文件名称，设备编号；
- 分析日志内容：显示表格，表头为时间戳、故障码、param1~4、释义；
- 支持筛选（时间段、关键字、设备编号、上传用户等）；

日志分析页面需要实现
    后端分页 + 流式加载：
        具体过程：[浏览器分页UI] ←(请求 page,size)→ [Node.js API] ←(LIMIT范围分页)→ [MySQL]
    前端：页码点击 → 请求对应数据页
        虚拟滚动 + 懒加载

后端：SQL 范围分页（基于 id / 时间戳）
    结果 JSON 压缩
    查询字段最少化 + 索引优化

日志条目表格，需要做高级搜索
1. 搜索维度设计
    时间范围选择（起始时间 + 结束时间）
    故障码 
        精确匹配
        模糊匹配
        多选匹配
    参数1-4
        数值比较（大于 / 小于 / 等于 / 区间）
        多参数组合查询（P1>100 且 P3<50）
    释义
        关键词模糊搜索
        正则匹配（适合模式化的释义，比如“温度异常\d+”）

2. 前端交互方案
    A. 条件组模式（推荐）
        用户可以添加多个条件组（AND / OR 关系）
        每组：字段选择 + 比较符号 + 值
        时间戳 >= 2025-08-01 00:00:00  AND
        故障码 LIKE "ERR"              AND
        参数1 BETWEEN 100 AND 200      OR
        释义 CONTAINS "温度"
    B. 高级筛选面板：
        1.可以添加条件；
        2.导入模板的按钮 放在高级搜索内；
        3.常用的搜索方案，以标签形式放在“添加条件”按钮下方；
    高级搜索或简单搜索，把搜索表达式显示在搜索卡片中
        左边固定搜索项（时间、故障码）
        右边是可展开的“更多条件”
        类似 Excel 的筛选器，但支持区间、模糊和多选

    C. 常用搜索
        “常用搜索模板”，以按钮形式放在高级搜索旁；
        比如：器械相关，状态机，CPU，
        这些关键词对应多个条件组（AND / OR 关系），可以通过外部配置文件修改；
        支持导入自定义的 高级搜索条件;

        支持输入自然语言：把用户输入的自然语言词变成系统可识别的字段和操作符

        依赖技术/方法：

        步骤	说明	技术/工具
        分词	把句子切成词，保持领域词完整	HanLP / jieba + 自定义词典
        实体识别 (NER)	找出设备、部件、参数、故障码、时间等实体	HanLP NER / LLM / 自定义规则
        同义词标准化	将用户不同表达统一成标准词	自定义映射表 / 词典
        字段映射	将标准词对应到数据库字段及默认匹配方式	映射表 (关键词 → 字段/操作符/默认值)

导入模板要求
文件内容必须是 UTF-8 编码的 JSON“数组”，数组每个元素为一个模板对象
模板对象字段
name: 字符串，模板名称
description: 可选字符串
filters: 对象，结构与高级筛选一致
logic: 'AND' | 'OR'
conditions: 数组；每项为 { field, operator, value }
允许的字段: timestamp, error_code, param1, param2, param3, param4, explanation
允许的操作符: =, !=, >, >=, <, <=, between, notbetween, in, notin, contains(=like), startsWith, endsWith, regex
值格式
between/notbetween: value 为长度为2的数组
in/notin: 数组或逗号分隔字符串
timestamp 比较: 传可被 Date 解析的字符串（between 为两项）
参数数值比较: 传可转为数字的字符串或数字
regex: 长度 ≤ 200 的正则字符串
示例（文件内容）
提示
上传的 JSON 须是上述“数组”本体；前端会将其作为 templates 字段提交
不支持任意字段或未列出的操作符（会被后端忽略或报错）


- 支持通过选择时间段筛选满足要求的日志；
- 支持导出csv，导出筛选后的结果；
- 支持手术分析功能，按钮位于导出csv旁位于日志分析最上侧，通过分析页面所有的日志条目分析与手术相关的信息；

- - 日志查看页面最上侧显示分析对象信息： 所选中的日志文件数量，鼠标悬停后显示具体的文件名，设备编号；
- 日志查看页面有右侧的抽屉式侧边栏，用于存放摘取的日志和可视化图表，在一个侧边栏内用两个标签页存放，可视化标签页会显示用有图表的数量个数；
- 日志条目表格，表头：|标记|时间戳(文件名)|故障码|释义|参数(1~4)|操作|；
    - 首列可以选取日志标记颜色，无列名；
        - 用于标记颜色，紫、绿、黄、蓝四种颜色，标记后对应的日志条目变为对应颜色，存储在sessionStorage;
    - 时间戳列，鼠标悬停显示，文件名：xxxxxx；
    - 故障码列：用于显示故障码，支持计数功能
        - 计数：统计此故障码在所选日志中出现的次数，通过点击故障码显示该统计数据，数据显示在故障码的单元格的右上方，以角标形式，存在筛选条件时，需要基于筛选条件的基础上再统计故障码次数，**初始加载时做全局统计**：统计当前日志集里各故障码总数，**筛选器条件变化时**：点击时再实时统计，存储在sessionStorage；
    - 参数1~4：参数1-参数4显示在一个单元格中，用空格间隔开，右对齐显示可视化按钮；
    - 可视化：可视化的按钮在参数的单元格中，右对齐单元格，点击可视化按钮以popOver提供用户选择参数x,参数需要用户通过popover内的radio button选择，选项显示的是该故障码参数的具体含义（可以通过故障码后四位+子系统号在故障码表中查询到，未查询到则显示参数x），图表以此条日志的参数x为y轴，时间戳为x轴，进行可视化生成曲线图，曲线图使用https://echarts.apache.org/examples/zh/editor.html?c=area-time-axis样式，只需要在左上角显示图表标题；可视化的时间范围为打开的日志中第一次出现这个故障码的时间到最后一次出现该故障码的时间，图表的标题是参数的具体含义；生成可视化图表后，图表会在侧边栏可视化标签页显示缩略图，缩略图的标题是参数的具体含义，每一个缩略图是一个卡片形式，点击后以弹窗形式放大到视野中心，点开后的卡片标题是数据可视化，点击弹窗以为的地方关闭此弹窗，鼠标悬浮至可视化缩略图时右上角显示删除按钮（使用垃圾桶icon）
    - 操作：上下文分析，日志抓取，备注
    - 日志摘取：**日志摘取**是一个 **单一容器**，最多存 50 条日志，缩略图显示的是「剪贴板」整体，而不是一条条日志，缩略图会自动显示在右侧的抽屉中；添加日志到日志分析剪切板后，侧右抽屉侧边栏显示，日志条目的内容格式为，”时间戳 故障码 释义“的文本被复制到侧边栏内的剪贴板中，侧边栏仅显示剪贴板的缩略图，点击剪贴板后以弹窗形式展开放大，剪贴板的内容可以编辑，支持另存为txt文件，鼠标悬浮至剪贴板的缩略图时右上角显示删除按钮（使用垃圾桶icon）；
    - 上下文分析，点击上下文分析功能，显示数据输入框需要用户输入前xx分钟，后xx分钟；确认后以该日志条目为基点，选择前XX分钟后XX分析的日志；清空筛选器后复位；
    - 备注，专家和管理员用户拥有标记权限，普通用户只能查看，备注需要写入数据库？，任何用户索引到该日志都可以显示所有的备注需要区分备注的软件人，备注限制50个字，每个用户可以删除自己的标记，管理员可以删除所有标记，每一条日志支持最多5条备注；
        - 仅显示一个「📝备注图标」；
- 鼠标点击备注，弹出备注详情面板（浮层），在备注详情面板展示形式类似「评论区」；
    - 按照时间顺序显示：每条备注显示：用户名 + 角色（颜色区分，例如管理员红色，专家蓝色，普通灰色）；
    - 备注内容（限制 50 字，自动截断 + hover 展开）；
    - 创建时间；
    - 操作按钮（删除/编辑，仅对权限用户显示）。
    - 在备注详情面板中点击「+ 添加备注」按钮；
    - 普通用户 → 不显示按钮（或按钮禁用 + tooltip 提示“仅专家/管理员可添加”）。
    - **输入框**：限制 50 字，实时字数统计（`已输入 32/50`），提交时校验「该日志备注数 ≤ 5」。
- **提交备注，**写入数据库，前端立即更新该日志的备注显示（无需刷新）。
- 删除备注：
    - 用户自己 → 可以删除自己的备注；管理员 → 可以删除所有备注；专家 → 不能删别人备注。
    - 每条备注右上角显示 `🗑` 删除按钮（仅对有权限的用户可见）。
    - 删除后确认对话框：「
      
    实现方案：
    前端的主要任务是 交互+渲染，包括：
    按钮与交互
        在参数单元格右对齐放置「可视化」按钮（icon button）。
        点击后弹出下拉菜单 → 用户选择要可视化的参数（参数1~4，显示时尽量使用“参数含义”，没有映射时 fallback 到“参数x”）。

    参数含义显示
        前端发起请求时传 faultCode + subSystemId → 后端查询故障码表返回参数含义。
        前端负责渲染下拉菜单的选项文本。    

    数据可视化
        接收后端返回的时间序列数据（时间戳 + 参数值）。
        使用 ECharts 绘制折线图：
        x 轴：时间戳（优化刻度显示，避免重叠）
        y 轴：参数值
        标题：由后端返回的参数解释名称
    剪贴板交互
        可视化生成后，图表缩略图加入右侧抽屉侧边栏。
        点击缩略图 → 弹窗放大显示；点击空白关闭弹窗。
        支持「另存为图片」功能（ECharts 提供 getDataURL 导出）。
        缩略图右上角悬浮显示「垃圾桶 icon」→ 删除图表。
    后端职责
        参数解释查询
            返回该故障码的参数含义（如：param1: 电机转速, param2: 电流）。
        日志范围查询
            根据前端提供的「点击的日志条目」的故障码 → 确定该故障码的 最早和最晚时间戳（范围）。
            SQL 示例：SELECT MIN(timestamp) as startTime, MAX(timestamp) as endTime
            FROM logs
            WHERE fault_code = :faultCode
            AND file_name = :fileName;
        时间序列数据查询


- 支持隐藏某行日志，

其中由于批量日志查看页是后端分页，所以对于标记颜色，统计次数，剪贴板是需要存储在localstore中，备注需要存储在数据库，上下文分析、日志隐藏在清除筛选条件后可以被复位

不改变目前的批量日志查看的日志条目列表；

### 2.4 手术统计功能

第一阶段：

- 点击手术统计后计算日志分析中所有日志包含几场手术信息，每一场手术单独做统计计算；
- 手术统计页面显示每一场手术的统计数据，通过新建带有标签页的页面展示每一场新手术，每一个标签页代表一场手术；
- 计算统计可以通过逐条处理获取到的日志记录，根据每条日志的故障码（errCode）及其对应的参数（p1、p2、p3、p4）进行不同分支判断：
- 手术时间线：手术标签页中以时间线的方式本场手术的开机时间/上一场手术结束时间，关机时间，手术开始时间，手术结束时间；
- 器械使用时间统计：手术统计中显示4个工具臂各自安装的器械类型、udi码、使用时间；
    - 以进度条方式显示，进度条的起点和终点（与手术时间线一致）为开机时间和关机时间（没有关机时间用手术结束时间代替）进度条填充部分为器械安装的时间段，空白部分为未安装的时间段代表器械安装时间；
- 故障统计：若本场手术发生过故障，在手术时间线卡片中增加“查看故障的标签”，支持统计手术过程触发安全报警的次数和具体的报警信息，日志条目中，以A\B结尾的故障码认为触发了安全报警，解除恢复过判定为“已处理”，未解除恢复判断”未处理“，对于故障进行去重操作，对于未处理的故障，在解除恢复前只统计一次；
- 网络统计：若本场手术是远程手术，则需要统计本场手术的网络延时,在手术时间线卡片中增加“查看网络延时”的标签；远程手术判断条件：出现过故障码结尾是416D的日志且p1=1，网络延时=405E 中 p3的值；增加网络延时统计曲线图，前端使用echart，放在故障统计之后；曲线图不用突出显示数据点，仅显示手术开始到手术结束时间段的网络延时，纵坐标-延时，横坐标-时间轴，横坐起点=手术开始时间，终点=手术结束时间
- 支持显示手术过程中状态机变化曲线；

第一阶段：
手术统计功能中的这些数据可以归纳为[structured_data（结构化数据）]

- 前端仅显示手术统计的结果不做可视化 打印 surgeries 和 structured_data（结构化数据）

- 设有导出手术结构化数据导出按钮，将结构化数据保存在postgresql数据库
- 手术id生成规则：设备编号-yyyymmdd-序号；
- 点击导出按钮：系统生成一个新的`surgery_versions` 版本。对比新版本与 `surgeries.structured_data` 当前数据：
    - 如果一致：直接覆盖或忽略。
    - 如果不一致：
        1. 弹窗提示“检测到手术数据变化”
        2. 在弹窗中用可视化方式展示差异（例如表格高亮变化字段、时间轴对比器械使用或臂动作）
        3. 用户确认是否替换当前版本：
        - 确认：将 `surgeries.structured_data` 更新为新版本，并记录 `surgery_versions`
        - 取消：保留原版本不变

`surgeries.structured_data` 始终保存**用户确认后的最新版本**。

`surgery_versions` 保存所有生成的版本（未确认或历史版本），用于对比和回溯。


- 安全报警记录 表头：时间|故障码|报警信息|处理状态；此列表默认只显示前5条，其余部分折叠，需要手动展开

- 支持显示开机时间，关机时间，手术开始时间，手术结束时间 四个卡片
    - 开机时间：
    - 关机时间：
    - 手术开始时间：手术开始是开机后第一次进入状态机S20
    - 手术结束时间

- 支持统计手术过程中4个工具臂各自安装的器械类型、udi码、使用时间以进度条方式显示，器械类型定义
    器械有唯一的UDI码，若识别到器械插上，则记录时间戳，器械拔下再次记录时间戳，进度条填色部分的起点和终点就是这两个时间戳；
```
  "0": "无器械",
        "1": "持针钳",
        "2": "电钩",
        "3": "双极鸭嘴电凝钳",
        "4": "直剪",
        "5": "单极弧剪",
        "6": "双极弧形电凝钳",
        "7": "波茨剪",
        "8": "无损伤镊",
        "9": "-30度内窥镜",
        "10": "0度内窥镜",
        "11": "30度内窥镜",
        "12": "大持针钳",
        "13": "鸭嘴抓钳",
        "14": "鼠齿抓钳",
        "15": "极电铲",
        "16": "强力鸭嘴抓钳",
        "17": "超声刀",
        "18": "持钩钳",
        "19": "中号施夹钳",
        "20": "大号施夹钳",
        "21": "小剪刀持针钳",
        "22": "大剪刀持针钳",
        "23": "30度胸科镜",
        "24": "-30度胸科镜",
        "25": "单极小电钩",
        "26": "弧剪",
        "27": "小持钳",
        "28": "大宏剪",
        "29": "无损肠抓钳",
        "30": "共注双极鸭嘴",
        "31": "共注双极弧形",
        "32": "UNDEFIEND",
        "33": "新持针"
```

- 支持统计手术过程触发安全报警的次数和具体的报警信息，日志条目中，以A\B\C结尾的故障码认为触发了安全报警，在未解除恢复前的故障需要做去重处理

状态机定义
 "0": "初始化（S00）",
        "1": "使能（S01）",
        "2": "自检（S02）",
        "10": "待机（S10）",
        "12": "从手调整（S12）",
        "13": "主手跟随（S13）",
        "14": "断开主从/离合（S14）",
        "15": "初始化（S00）",
        "20": "主从控制（S20）",
        "21": "内窥镜控制（S21）",
        "30": "错误（S30）",
        "31": "关机（S31）"
```

以上的数据可以从所分析的日志条目中获取，参考 mermaid语言的日志统计流程图
graph TD 
Start(开始) --> Init[初始化全局变量]
    Init --> Reset[清空各统计列表]
    Reset --> Loop[读取每一个日志]
    
    Loop --> CheckType{日志类型判断}
    
    %% 主要分支
    CheckType --> |开机事件| PowerOn[标记开机]
    CheckType --> |关机事件| PowerOff[处理关机逻辑]
    CheckType --> |故障事件| Error[处理故障逻辑]
    CheckType --> |状态机| State310[处理状态机事件]
    CheckType --> |手术结束| State500[处理手术结束]
    CheckType --> |器械状态记录| State600[处理手术结束]
    
    %% 子流程调用
    PowerOn --> SubPowerOn
    PowerOff --> SubPowerOff
    Error --> SubError
    State310 --> Sub310
    State500 --> Sub500
	  State600 --> Sub600

%% 子流程图：开机事件处理
subgraph SubPowerOn[开机处理]
    direction TB
    s1{检查errcode是否为570e 且 p1=0 且 p2≠0?} --> |是| s2[检查下一条日志是否为571e 且 p1=0 且 p2≠0?]
    s2 --> s3{下一条符合条件?}
    s3 -->|是| s4[标记i+1为'开机']
    s4 --> s5[设置开机is_power_on=True]
    s5 --> s6[记录Tstart时间，Tdur=Tstart]
end

%% 子流程图：关机事件处理
subgraph SubPowerOff[关机处理]
    direction TB
    p1[检查errcode=310e且p2=31] --> p2[标记'关机']
    p2 --> p3[计算无故障时间: Tshutdown-Tdur]
    p3 --> p4[累加到总的无故障运行时间：noErrTime_list]
    p4 --> p5[重置errFlag/errSurical等标记]
end
%% 子流程图：故障事件处理
subgraph SubError[故障处理]
    direction TB
    e1[检查errcode结尾为a/b] --> e2[标记'故障']
    e2 --> e3{errFlag=False?}
    e3 -->|是| e4[计算无故障时间:Terr-Tdur]
    e4 --> e5[累加到总的无故障运行时间：noErrTime_list]
    e5 --> e6[添加到列表（每段无故障运行时间）]
    e3 -->|否| e7[跳过时间计算]
    e7 --> e8
    e6 --> e8[设置是否发生故障errFlag=True]
    e8 --> e9[标记该手术为故障手术errSurical=True]
    e9 --> e10[记录时间Tdur=Terr]
    e10 --> e11[是否恢复标志位errSuricalRecover=false]
end
%% 子流程图：状态机事件处理
subgraph Sub310[状态310e处理]
    direction TB
    st1{检查errcode=310e} --> st2[获取p2值作为新state]
    st2 -->st3{检查p2 = 20}
    st3 -->|是| st4{检查is_power_on=True}
    st4 -->|是| st5[标记'手术开始']
    st4 -->|否| st6[标记'状态机']
    st3 -->|否| st7{检查p1 = 0 且 p2 = 1 且 故障状态err_flag = true}
    st7 -->|是| st8[标记'故障恢复']
    st7 -->|否| st17[标记'状态机']
    st6 -->st13{检查errRecover=True}
    st13 -->|是| st14[恢复等待重新进入标志位errRecover=false]
    st14 -->st15[记录故障恢复进入主从时间 errRecoverTime = Ts20 - Trecover]
    st15 --> st16[添加到列表（从故障恢复到主从的时间）]
    st8 --> st9[记录时间Tdur=Trecover时间]
    st9 --> st10[复位errFlag=flag]
    st10 --> st11[是否恢复标志位errSur icalRecover=True]
    st11 --> st12[恢复等待重新进入标志位errRecover=True]
end
%% 子流程图：手术结束处理
subgraph Sub500[手术结束处理]
    direction TB
    sc1[检查errcode=500e且p3=0] --> sc2[更新对应臂的armState器械状态]
    sc2 --> sc3{器械全归零且state为13/10/12?}
    sc3 -->|是| sc4[标记'手术结束']
    sc4 --> sc5[手术场次surgicalCount+1]
    sc5 --> sc6[添加到列表（该场次是否为故障手术场次）]
    sc6 --> sc7[添加到列表（该场次是否故障恢复的手术场次）]
    sc7 --> sc8[复位器械状态armState=-1]
end

%% 子流程图：手术器械记录处理
subgraph Sub600[手术器械记录处理]
    direction TB
    ss1[检查errcode=500e且p3=0] --> ss2[更新对应臂的armState器械状态]
    ss2[检查器械状态变化故障码 errcode=501e,p1= 臂号-1,p2=上一状态器械类型，p3=当前器械类型] --> ss3[更新对应臂的armInst器械类型]
    ss3[检查器械状态变化故障码 errcode=510e,p1= UDI年月,p2=UDI序号，p3=UDI批次，P4=UDI尾号（acsII码形式，需要转换）] --> ss4[更新对应臂的armUDI 器械UDI=p1+p2+p3+p4]
end

- 网络统计：若本场手术是远程手术，则需要统计本场手术的网络延时,在手术时间线卡片中增加“查看网络延时的标签”；远程手术判断条件：出现过故障码结尾是416D的日志，网络延时=405E 中 p3的值；增加网络延时统计曲线图，前端使用echart，放在故障统计之后；


- 支持导出每场手术的手术统计报告pdf；
- 导出手术统计报告的pdf数据同时，导出手术日志的结构化JSON置数据库
JSON需要包含以下数据：
{
    "logStartIdx":,//本场手术关联的日志开始序号 
    "logEndIdx":,//本场手术关联的日志结束序号 
    "PowerOnTime":[]//开机时间，可以有多个
    "ShutDownTime":[]//关机时间，可以有多个
    "SurgeryStart"://手术开始时间
    "SurgeryEnd"://手术结束时间
    "device_id": "",//设备编号
    "surgeon": "",//医生，可置空
    "operation": "",//手术类型，可置空
    "status": "",//标识是否为故障手术
    //手术中的故障信息
    "error_codes": [
        {
            "code": "",
            "message": ""
        },
        {
            "code": "",
            "message": ""
        }
    ],
    //手术持续时间
    "duration": "",
    //器械使用信息、使用时间、器械类型、UDI码
    "Instruemnt_used"
}
### 设备管理功能
    dashboard中有设备管理的板块，列表显示设备信息：设备编号|设备型号|设备密钥|所属医院|
    支持修改设备信息
    仅管理员和专家用户可以查看设备列表、并拥有修改权限；
    日志上传的systeminfo密钥和设备编号与设备信息关联
    已实现：
    - 后端：新增`devices`表与接口（增删改查、自动填充），权限标识：device:read/device:create/device:update/device:delete；管理员和专家具备管理权限；
    - 日志上传：自动将设备编号与密钥同步至`devices`表（若已存在则补充密钥），自动填充优先查询`devices`表；
    - 前端：在`dashboard`添加“设备管理”菜单（管理员/专家可见），新增`Devices.vue`页面（搜索、分页、增删改），并接入API；

## 数据诊断功能

- dashboard中增加数据诊断的板块，管理员拥有权限；
- 支持导入bin格式的二进制文件（1分钟内采集到的数据），导入的文件限制同时上传的数量，一次上传5个；
- 二进制文件需要解析成对应的数据格式，解析过程参考example\dataDecode.py，解析过成中的json可参考example\title.json

- 数据分析页面显示2个主控制臂和4个工具臂的三维模型使用three.js渲染；
    1.先建立一个静态的主控制臂的三维模型，左手，其MDH模型是
    pi=3.1415926535897932384626;
    L1=0.166;
    L2=0.3;
    L3=0.35;
    L4=0.145;

    dh = [ 0,     0,         -L1,   0;
            0,     -pi / 2,   0,     pi / 2;
            L2,    0,         0,     -pi / 2;
            L3,    pi / 2,    L4,    0;
            0,     -pi / 2,   0,     0;
            0,     pi / 2,    0,     pi / 2;
            0,     pi / 2,    0,     pi        ];


暂时不显示其他图表；

用户是否可以在上传数据前，自定义数据格式； 上传数据后自定义表头名称；如何设计

- 数据格式可以通过外部配置文件配置；
- 解析后的数据支持下载，下载后是csv格式文件；
- 解析后每一个数据列具有物理意义，可以通过图表展示；
      数据分析页面先展示三个图表的机械臂数据的图表。总共3个图，图表都使用echart, 布局是左右各一个图，中间一个图，
  左侧用于显示左手术关节位置共7个关节（对应解析后的数据2-8列）；右侧用于显示右手关节位置（对应解析后的数据9-16列）；中间预留用于显示左机械臂和右机械臂3维图，使用three.j渲染。
暂时还未进行three.js数据输入

## 数据诊断功能

## 缺陷反馈
    第一部分缺陷提交
    问题标题（必填，简短一句话）
    详细描述（多行文本，支持换行，不超过500字
    上传图片（最多 3 张，缩略图预览，可删除）
    提交按钮（提交后清空表单）

    第二部分缺陷查看
    查看缺陷列表，列表表头：
    问题标题 |状态标签（颜色区分：待处理=红，已解决=绿）| 提交时间 | 查看详情 | 状态修改 
    其中查看详情，可以点击，查看缺陷具体内容；
    状态修改，可以修改状态，待处理或已解决


### 前端优化
    dashborad支持可折叠，折叠后仅显示每个板块的logo，鼠标悬停后显示具体内容，每个板块使用不同的logo；
    数据诊断功能仅对管理员开放；

### 2.5 日志记录

- 上传用户 ID、文件名、设备编号、上传时间、是否解密等写入 logs 表。

### 3. 用户与权限管理模块

### 3.1 用户功能

- 注册、登录、修改邮箱、修改密码、注销账号；
- 所有登录用户可访问个人信息页，查看自己的用户名、角色、注册时间等；

### 3.2 管理员功能

- 可访问用户管理界面：查看所有用户信息、搜索、重置密码、修改角色；
- 可新增、删除用户账户；

### 3.3 权限角色定义

| 权限           | 管理员 | 专家用户 | 普通用户 |
|--------------|--------|----------|----------|
| 用户管理       | ✅      | ❌        | ❌        |
| 故障码增删改   | ✅      | ✅        | ❌        |
| 故障码查看导出 | ✅      | ✅        | ✅        |
| 日志上传/解析  | ✅      | ✅        | ✅        |
| 日志查看所有   | ✅      | ✅        | ✅        |
| 日志删除       | ✅      | ❌        | ❌        |
| 日志删除（自己） | ✅      | ✅        | ✅        |
| 多语言管理     | ✅      | ✅        | ❌        |

### 4. 多语言支持模块

- 使用 Vue I18n 实现中英文切换；
- 所有故障码及界面文本多语言字段维护在 i18n_texts 数据表；
- 支持多语言数据的增删改查（管理员权限）；

### 5. 系统操作日志记录

### 记录范围

- 添加用户（POST /api/users）
- 修改用户（PUT /api/users/:id）
- 删除用户（DELETE /api/users/:id）
- 增删改查 故障码
- 多语言故障码导入
- 增删改查设备


### 日志内容结构

- 操作类型
- 操作人 ID
- IP 地址
- 浏览器 UA
- 操作描述
- 详细数据（如用户名、邮箱、角色等）

## 三、数据库结构

- users：用户信息（用户名、密码哈希、邮箱、角色、启用状态、注册时间）
- roles：权限角色定义表
- user_roles：用户与角色的多对多关系表
- error_codes：故障码表，包含 subsystem、code、释义及中英文参数等
- logs：日志文件元数据（文件名、设备编号、密钥、上传者、上传时间等）
- log_entries：解密后结构化数据（时间戳、故障码、参数、释义）
- i18n_texts：中英文及未来拓展语言的文本配置
- operation_logs：系统操作日志记录表（操作人、动作、IP、详细内容）

## 四、前端页面设计

### 1. 登录页

- 登录、注册、忘记密码三合一界面
- 中英文切换（右上角语言下拉菜单）

### 2. 首页导航页

包含以下导航块：

- 故障码查询
- 日志上传与分析
- 账户信息管理
- 历史日志记录

### 3. 故障码管理页

- 表格展示故障码信息
- 搜索框支持模糊搜索 subsystem/code
- 根据权限展示增删改按钮
- 导出 XML 按钮

### 4. 日志管理页

- 上传区域（支持拖拽、输入密钥、选择 systemInfo.txt）
- 日志列表表格，展示设备号、日志文件名、上传用户、上传时间
- 操作列：删除、下载、分析
- 支持批量操作（多选分析、删除、下载）
- 日志内容分析页：展示结构化条目，支持筛选与搜索

### 5. 用户管理页（管理员可见）

- 用户列表
- 搜索、重置密码、修改角色、删除账户

### 6. 个人信息页

- 展示当前登录用户信息（用户名、邮箱、角色、注册时间）
- 支持修改邮箱、密码

## 五、后端接口规范

采用 RESTful API，接口路径前缀为 `/api/`

### 示例接口

- POST /api/auth/login 登录
- POST /api/auth/register 注册
- GET /api/error-codes 获取故障码列表
- POST /api/error-codes 新增故障码（需权限）
- GET /api/logs 获取日志列表（支持过滤）
- POST /api/logs 上传日志文件
- POST /api/logs/decrypt 解密日志（或自动处理）
- GET /api/log-entries 获取解密后的结构化日志
- GET /api/users 当前用户信息
- PUT /api/users/:id 修改用户
- GET /api/roles 获取角色权限

## 六、技术选型

### 前端

- Vue.js 3.x
- Vue Router
- Vuex
- Element UI 或 Vuetify
- Vue I18n

### 后端

- Node.js + Express.js
- JWT 用户身份认证
- bcrypt 密码加密
- MySQL 数据库

### 其他

- 文件上传使用 multer
- 密钥校验与解密逻辑复用 decode.py 或重写于 Node.js
- 日志分析与格式匹配使用 JSON 配置文件 FaultMappings.json

 具体需求

\*\*故障码管理

- 前端页面可以显示所以故障码数据库中的内容；
  表头内容如下
  subsystem、code、userInfo（user_hint 和 operation 合并，逗号拼接）、param1、param2、param3、param4、category
- 支持不同用户类型对于故障码的增删改查；
- 支持对于故障码数据的简单搜索搜索；
- 支持导出故障码数据库内的数据至指定的 XML 格式文件；

\*\*日志管理功能

- 支持上传日志文件，可以同时上传多个文件，总大小不超过 200MB，文件个数不超过 50 个；
- 文件名格式：
  定义：日志记录年份|日志记录月份|日志记录日期|日志记录小时| 后缀名
  格式：YYYY |MM |DD |HH |.medbot
  例 ：2024010205.medbot
- 日志解密后才能具有可读性，解密的逻辑与 decode.py 逻辑一致
- 日志绑定唯一的解密密钥，解密密钥对应唯一的设备编号；
- 当用户输入密钥点击自动填充，通过检索 logs 数据表的方式自动填充设备编号，当用户输入设备编号点击自动填充，自动填充密钥；
- 上传日志的同时必须填写密钥和设备编号，设备编号的格式为：XXXX-XX(例 4371-01)，若无设备编号，则默认输入0000-00
- 密钥支持输入或上传密钥文件，密钥文件名为：systemInfo.txt，存储的内容是 mac 地址(例如 00-01-05-77-6a-09)，上传需要对密钥格式检验，若不符合提示用户；
- 日志文件以每一个小时为单位生成一个.medbot 日志文件；
- 上传并解密的日志存储在服务器指定的路径中，文件名与上传的文件保持一致，格式 txt;
- 解密后的日志包含内容：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义
  其中释义，可以通过解密后的提取故障码首位+('0X'+故障码后 4 位) 去匹配 error_codes 表中的 subsystem+code 获得对应的 explanation 字段获得；
  释义进一步转义规则补充：数据库中释义语句可能包含{i:d},表示需要指定当前位置匹配，i 为第 i 个参数，d 为转义表中的下标，若 d=0 则按照纯物理量转义。表示当前位置按照第 i 个参数的值，从第 d 个转义表（backend/config/FaultMappings.json）中查询并替换。
  例子：0x551E 调整臂调整按键{2:2}按下。臂号为{0:0} 臂号，上一个状态，当前状态，0
  若 p0=3，p2=1，以上故障码释译为 「调整臂调整按键已按下。臂号为 3」.
  解密后内容（结构化数据）：存入 log_entries 表
  解密后文件：保存在服务器磁盘（如 uploads/logs/），用于下载或备查。相同设备编号或相同密钥的日志存储在同一个以设备编号命名的文件夹内；
- 交互界面上，日志列表的表头：设备号 日志文件名 上传用户 ID 上传时间 操作 状态；
  其中状态包括：上传中、解密中、解析中、完成；
  其中操作包括：删除、下载、分析，
  当状态是非完成状态时，不能进行任何操作
  下载：下载的是解密后的日志文件；
  删除：删除数据库中对应的日志内容，并且删除 uploads/logs/对应的日志解密文件
  分析：
      1）以列表形式显示当前选择的所有日志中的具体内容；表头：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义；
      2）支持搜索、筛选功能；
      3）支持通过选择时间段筛选满足要求的日志；
  日志列表首列改为多选框，当用户手动选择多个日志条目时，日志列表上部显示批量分析，批量下载 批量删除的选项； 可以将选中的日志条目进行批量操作 分析时可以合并显示在一个页面中
  
  
  
- 日志列表支持筛选功能，可以通过设备编号，上传用户 ID、上传时间进行筛选；
- 日志列表可以通过多选的方式进行批量操作，

\*\*本系统的操作日志记录功能

- 针对以下功能增加日志记录
  添加用户
  路由：POST /api/users
  日志内容：操作类型“添加用户”，描述、操作人、IP、UA、详情（用户名、邮箱、角色等）
  修改用户
  路由：PUT /api/users/:id
  日志内容：操作类型“修改用户”，描述、操作人、IP、UA、详情（用户 ID、邮箱、状态、角色等）
  删除用户
  路由：DELETE /api/users/:id
  日志内容：操作类型“删除用户”，描述、操作人、IP、UA、详情（用户 ID、用户名）

## 角色权限系统

### 权限矩阵

| 权限              | 管理员 | 专家用户 | 普通用户 | 说明                   |
| ----------------- | ------ | -------- | -------- | ---------------------- |
| **用户管理**      |        |          |          |                        |
| user:read         | ✅     | ❌       | ❌       | 查询用户列表、用户详情 |
| user:create       | ✅     | ❌       | ❌       | 创建新用户             |
| user:update       | ✅     | ❌       | ❌       | 修改用户信息           |
| user:delete       | ✅     | ❌       | ❌       | 删除用户               |
| user:role:assign  | ✅     | ❌       | ❌       | 分配用户角色           |
| **角色管理**      |        |          |          |                        |
| role:read         | ✅     | ❌       | ❌       | 查询角色列表、角色详情 |
| role:create       | ✅     | ❌       | ❌       | 创建新角色             |
| role:update       | ✅     | ❌       | ❌       | 修改角色信息           |
| role:delete       | ✅     | ❌       | ❌       | 删除角色               |
| **故障码管理**    |        |          |          |                        |
| error_code:read   | ✅     | ✅       | ✅       | 查询故障码列表         |
| error_code:create | ✅     | ✅       | ❌       | 创建新故障码           |
| error_code:update | ✅     | ✅       | ❌       | 修改故障码信息         |
| error_code:delete | ✅     | ✅       | ❌       | 删除故障码             |
| error_code:export | ✅     | ✅       | ✅       | 导出故障码到 XML       |
| **多语言管理**    |        |          |          |                        |
| i18n:read         | ✅     | ✅       | ✅       | 查询多语言配置         |
| i18n:create       | ✅     | ❌       | ❌       | 创建多语言配置         |
| i18n:update       | ✅     | ❌       | ❌       | 修改多语言配置         |
| i18n:delete       | ✅     | ❌       | ❌       | 删除多语言配置         |
| **日志管理**      |        |          |          |                        |
| log:upload        | ✅     | ✅       | ✅       | 上传日志文件           |
| log:read_all      | ✅     | ✅       | ❌       | 查看所有用户日志       |
| log:read_own      | ✅     | ✅       | ✅       | 查看自己的日志         |
| log:parse         | ✅     | ✅       | ✅       | 解析日志文件           |
| log:download      | ✅     | ✅       | ✅       | 下载日志文件           |
| log:delete        | ✅     | ❌       | ❌       | 删除任何日志           |
| log:delete_own    | ✅     | ✅       | ✅       | 删除自己的日志         |

### 角色说明

#### 管理员 (ID: 1)

拥有所有权限，可以管理用户、角色、故障码、日志和多语言配置。

#### 专家用户 (ID: 2)

专注于故障码管理和日志分析，可以管理故障码、查看所有日志，但不能管理用户和角色。

#### 普通用户 (ID: 3)

基础操作权限，可以查询故障码、上传和管理自己的日志，但不能进行管理操作。

## 账户管理与个人信息权限细化

### 账户管理（用户管理板块）

- 仅管理员用户可以在 dashboard 左侧菜单看到“账户管理”板块（即“用户管理”页面）。
- 管理员可以：
  - 查看所有用户的账户信息，信息以列表形式展现，字段包括：用户名、密码（仅支持重置/修改入口，不显示明文）、账户类型（角色）、是否启用（状态）、注册时间。
  - 支持修改所有用户的密码（重置密码功能，点击按钮弹窗输入新密码）。
  - 支持修改所有用户的账户类型（角色分配/变更）。
  - 支持搜索、编辑、删除所有用户。
  - 每行最后有“修改”按钮，可编辑该用户信息。
- 非管理员用户（专家用户、普通用户）无法看到“账户管理”板块，也无法访问用户管理相关页面和接口。

### 个人信息（右上角个人菜单）

- 所有登录用户（包括管理员、专家用户、普通用户）都可以通过右上角菜单进入“个人信息”页面。
- 登录后，右上角始终显示当前用户的用户名。
- 个人信息页面仅显示当前登录用户自己的信息（用户名、邮箱、角色、注册时间等）。
- 所有用户都可以在个人信息页面修改自己的邮箱和密码。
- 个人信息页面不允许用户修改自己的角色、用户名等敏感信息。

## 前端

需要有登入页面：包含以下功能 1.登入功能； 2.注册功能 3.忘记密码功能 4.中英文切换；

首页：至少包含板块， 1.故障码查询； 2.日志解析； 3.账户信息管理； 4.历史日志记录查询；

### 典型场景

- 管理员登录后，左侧菜单有“用户管理”入口，可管理所有账户。
- 普通用户或专家用户登录后，左侧菜单没有“用户管理”入口，只能通过右上角菜单查看和修改自己的个人信息。

## 进展记录

- 完成数据库表结构设计，已写入 db_schema.sql
- 明确项目需求与技术选型
- 完成 Sequelize 用户模型（users）、故障码模型（error_codes）文件创建。
- 完成 Sequelize 角色模型（roles）、用户-角色关联模型（user_roles）、日志模型（logs）、多语言配置模型（i18n_texts）文件创建。
- 完成用户注册、登录接口，JWT 认证中间件，路由挂载等功能开发。
- 完成故障码管理接口（增删改查、支持多语言字段、路由挂载等）开发。
- 完成日志上传、解密、查询、下载接口及路由挂载等功能开发。
- 完成故障码导出 XML 接口（多语言、格式预留、路由挂载等）开发。
- 完成多语言配置接口（增删改查、路由挂载等）开发。
- 完成用户管理、角色管理接口（增删改查、分配权限、路由挂载等）开发。
- 创建 API 测试工具和文档，包括详细测试指南(API_TEST_GUIDE.md)和快速启动脚本(start-backend.bat)。
- 修复数据库模型配置中的环境变量路径问题，确保.env 文件正确加载。
- 发现并解决数据库连接失败问题：环境变量未正确加载导致用户名为空，需要创建.env 配置文件。
- 定义三种角色类型：管理员、普通用户、专家用户，并明确各角色的权限范围。
- 更新 API 测试指南，整合所有测试脚本的使用方法和详细说明。
- **权限控制系统完善**：为所有管理功能添加权限控制中间件，确保敏感数据只对管理员开放
- **修复 Sequelize 关联查询错误**：修复权限检查中间件中的关联查询别名问题，确保权限检查正常工作
- **添加认证流程调试**：为认证中间件添加详细调试信息，帮助排查 JWT token 问题
- **完善权限初始化系统**：创建完整的权限初始化脚本，确保用户角色正确分配
- **权限系统验证完成**：所有用户角色分配正确，权限控制完全正常工作
- **用户角色分配安全修复**：修复用户角色分配功能缺少 JWT 认证中间件的问题，确保所有角色分配操作都需要有效的 token 验证
- **前端开发完成**：基于 Vue.js 3 + Element Plus 创建完整的前端界面，包含登录、注册、忘记密码、故障码管理、日志解析、账户管理、历史记录、用户管理、角色管理等所有功能页面
- **前端功能实现**：完成用户认证、权限控制、国际化、文件上传、数据表格、表单验证、分页等核心功能
- **前端路由配置**：实现完整的路由系统，支持路由守卫和权限控制
- **前端状态管理**：使用 Vuex 实现完整的状态管理，包含认证、故障码、日志、用户等模块
- **前端 API 集成**：完成与后端 API 的完整集成，支持所有 CRUD 操作

## 环境配置

### 创建.env 文件

在项目根目录（E:\logTool\）创建 `.env` 文件，包含以下配置：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=yourpassword
DB_NAME=logtool

# JWT 密钥
JWT_SECRET=your_jwt_secret

# 其他配置
PORT=3000
NODE_ENV=development
```

### 重要说明

- `.env`

## 最新修复和改进

### 多语言功能优化
- **语言支持简化**：将支持的语言从50+种减少到11种指定语言（中文、英语、法语、德语、西班牙语、意大利语、葡萄牙语、荷兰语、斯洛伐克语、罗马尼亚语、丹麦语）
- **CSV导入修复**：修复了多语言故障码CSV导入功能，包括文件上传和手动输入两种方式
- **用户界面改进**：为CSV导入功能添加了详细的格式说明和示例，提高用户体验

### 技术修复详情
1. **后端修复**：
   - 更新语言映射配置，移除多余语言支持
   - 修复CSV文件上传路由配置
   - 优化批量导入数据处理逻辑

2. **前端修复**：
   - 修复CSV文件上传逻辑，确保只处理单个文件
   - 添加客户端CSV解析，支持手动输入模式
   - 为导入功能添加详细的格式说明和示例

3. **用户体验改进**：
   - 添加CSV格式说明和示例数据
   - 提供支持的语言代码列表
   - 优化界面样式，提高可读性
   - 添加数据验证规则提示
   - 改进错误处理和用户反馈

### 导入功能验证改进
- **客户端验证**：在手动输入模式下添加客户端数据验证
- **错误处理优化**：区分部分成功和完全失败的情况，提供详细的错误信息
- **用户提示改进**：在导入对话框中添加数据验证规则说明
- **表单清空功能**：导入完成后自动清空上传的文件和输入的数据
- **测试文件**：提供正确和错误数据的测试文件用于验证功能

