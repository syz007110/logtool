## 一、项目概述

logTool 是一个集成故障码管理、日志上传与解析、账户与权限管理于一体的系统，面向具备不同权限的用户，提供一套完整的设备日志与故障码管理平台，支持多语言翻译及 XML 数据导出功能。

## 二、主要功能模块

### 1. 故障码管理模块

### 1.1 功能需求

- 展示部分故障码数据库中的内容，表头：子系统号 | 故障码 | 给用户的提示信息+操作信息|参数1|参数2|参数3|参数4|检测方法|
- 按照权限区分支持不同用户类型对于故障码数据库的增删改查操作；
- 添加和修改故障码时，支持同步添加或修改本地和远程端对应的故障码，子系统定义中：其中 01和08，03和09，05和0A 对应的子系统一致，仅区分了本地和远程端，因此在修改或添加时选择了子系统为01和08，03和09，05和0A的故障码的弹窗内增加:同步选项：同步更新到本地/远程端；特别的，若修改时故障码不存在时，自动创建；
- 故障码的增加修改对于各字段的需求如下
    
    
    | 列名 | 填写方式 | 有效值 | 字段 | 必填 |
    | --- | --- | --- | --- | --- |
    | 子系统 | 01：运动控制软件；02：人机交互软件；03：医生控制台软件；04：手术台车软件；05：驱动器软件；06：图像软件；07：工具工厂软件。08：远程运动控制软件09：远程医生控制台软件0A: 远程驱动器软件；
    仅可以填写上述子系统编号之一 | 1、2、3、4、5、6、7、8、9、A | subsystem  | Y |
    | 故障码 | 区分故障类型不能重复，以“0X010A”形式填写，最后一位必须为字母且仅为“A、B、C、D、E”中一个A:A类故障报警，报警等级最高，影响状态机跳转；B:B类故障报警，报警等级次高，影响状态机跳转；C:C类故障报警，不影响状态机跳转，可忽略；D:提示信息；E:日志记录； | 以“0X010A”形式填写;
    其中0X为16进制标志符，
    最后一位必须为字母且仅为“A、B、C、D、E”中一个；
    由子系统号与故障码组成的故障码不会重复对应唯一的故障类型 | code  | Y |
    | 是否轴错误（TRUE/FALSE） | 标识此故障是否会有关节号，不影响交互软件显示；true = 有关节号，false = 无关节号 | TRUE/FALSE | is_arm_error | Y |
    | 精简提示信息 | 普通账户下人机交互软件显示的中文提示信息，中文文字填写；1.任意一个非日志记录的故障码必须有精简的提示信息或操作信息其中之一；2.提示类故障，精简提示信息与给用户的提示信息一致； | 中文文字填写 | short_message | Y |
    | 精简提示信息英文 | 普通账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | short_message_en  | Y |
    | 给用户的提示信息 | 维护账户或管理员账户下人机交互软件显示的中文提示信息，中文文字填写； | 中文文字填写 | user_hint  | Y |
    | 给用户的提示信息英文 | 维护账户或管理员账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | user_hint_en  | Y |
    | 操作信息 | 人机交互软件显示的中文操作信息，中文文字填写； | 中文文字填写 | operation  | Y |
    | 操作信息英文 | 人机交互软件显示的英文操作信息，英文文字填写； | 英文文字填写 | operation_en  | Y |
    | 是否臂错误
    （TRUE/FALSE） | 决定人机交互软件是否显示“XX臂”；TRUE = 显示“XX臂”，FALSE = 不显示“XX臂”， | TRUE/FALSE | is_axis_error  | Y |
    | 详细信息 | 故障详细信息与描述 | 中文文字填写 | detail  | Y |
    | 检测方法 | 故障检测方法的简述 | 中文文字填写 | method  | Y |
    | 参数1 | 故障日志记录的参数1 | 中文文字填写 | param1  | Y |
    | 参数2 | 故障日志记录的参数2 | 中文文字填写 | param2 | Y |
    | 参数3 | 故障日志记录的参数3 | 中文文字填写 | param3 | Y |
    | 参数4 | 故障日志记录的参数4 | 中文文字填写 | param4 | Y |
    | 处理措施 | 故障的处理，根据故障码确定
    方式A类故障：recoverable可恢复故障；recoverable可恢复故障；C类故障ignorable可忽略故障；D类tip提示信息,；E类log日志记录； | recoverable
    unrecoverable
    tips
    log
    ignorable | solution  | N |
    | 专家模式
    （TRUE/FALSE） | 用于区分是否在专家模式下显示记录该操作提示 | TRUE/FALSE | for_expert  | N |
    | 初学者模式
    （TRUE/FALSE） | 用于区分是否在初学者模式下显示记录该操作提示 | TRUE/FALSE | for_novice  | N |
    | 日志
    （TRUE/FALSE） | 用于区是否需要在UI日志中被记录 | TRUE/FALSE | related_log | N |
    | 停止上报方法 | 无需填写 | / | stop_report  | N |
    | 故障等级 | 故障等级说明、根据故障码确定
    高级：A类故障；
    中级：B类故障；
    低级：C类故障；
    无：提示信息或日志记录； | 高级
    中级
    低级
    无 | level  | N |
    | 技术排查方案 | 故障报警的排查方案，用于故障小程序中 | 中文文字填写 | tech_solution  | N |
    | 解释 | 故障报警的解释，用于日志分析工具解析；
    需要结合故障详细信息，解释故障具体含义与各参数的含义 | 中文文字填写 | explanation  | N |
    | 故障分类 | 故障报警的分类，用于故障小程序中 | 软件
    硬件
    日志记录
    操作提示
    安全保护 | category  | Y |
- 添加和修改 故障码时，支持同步添加或修改本地和远程端得故障码
子系统 定义：01：运动控制软件；02：人机交互软件；03：医生控制台软件；04：手术台车软件；05：驱动器软件；06：图像软件；07：工具工厂软件。08：远程运动控制软件 09：远程医生控制台软件 0A: 远程驱动器软件；其中 01和08，03和09，05和0A 对应的子系统一致，仅区分了本地和远程；因此在修改或添加子系统为01和08，03和09，05和0A的故障码的弹窗内增加同步本地/远程的选，勾选即可同步，特别的，当故障码不存在时自动添加；
- 故障码管理页面支持模糊搜索功能；
- 故障码管理页面增加故障码查询功能：
    - 在“添加故障码”按钮左侧，增加“故障码查询”按钮，点击后出现故障码查询的弹窗，用户输入完整的故障码（例如141010A），点击查询，显示该故障码的  |给用户的提示信息 +操作信息|参数1-4的具体含义|详细信息|检查方法|技术排查方案|故障分类|；可以借鉴释义测试功能
- 多语言管理页面
    - 支持导出当前故障码数据库中的内容至 XML 格式；
    - 其中故障码数据表（通过子系统号+故障码 对应到多语言数据表）的精简提示信息（short_message） 、给用户的提示信息（user_hint） 、操作信息（operation） 三列支持多语言模式，并且具备可扩展性；
    - 具备导出xml、导入对应语言的精简提示信息（short_message） 、给用户的提示信息（user_hint） 、操作信息（operation） 和搜索三个功能
        - 导入功能：支持多语言的精简提示信息（short_message） 、给用户的提示信息（user_hint） 、操作信息（operation）三个字段的导入（多语言数据表），导入方式支持单行导入数据格式为subsystem,code,short_message,user_hint,operation或批量导入（带表头subsystem,code,short_message,user_hint,operation的csv文件），必须满足： 精简提示信息与操作信息不都为空，给用户的提示信息与操作信息都不为空；
        - 搜索功能：输入 子系统号，故障码 可以显示对应语言的精简提示信息（short_message） 、给用户的提示信息（user_hint） 、操作信息（operation）三个字段的内容；显示列表表头：子系统号 | 故障码 | 精简的提示信息 | 提示信息 | 操作信息
        - 导出xml：支持导出针对不同语言的xml，选择不同的语言可以导出精简提示信息（short_message） 、给用户的提示信息（user_hint） 、操作信息（operation）这三个字段使用不同语言的xml，支持以多选的方式，同时导出多国语言的xml，文件名：FaultAnalysis_XXXXXX.xml，导出的xml格式后续补充；
- 用户对于故障码的增删改查、xml导入和导出记录在系统日志中

# 2. 日志管理模块

## 2.1 上传日志功能

- 支持同时上传多个 `.medbot` 文件（不超过 50 个，合计不超过 200MB）；
- 支持输入或上传解密密钥（`systemInfo.txt`），校验格式是否为 MAC 地址；
- 必须填写设备编号（格式如 4371-01,xxxx-xx 字母或数字都合法）；
- 若用户输入密钥，则可以自动填充设备编号，反之亦然（通过 logs 表检索）；
- 支持日志解密增加释义的功能；
- 释义功能支持多版本匹配和单位换算功能；

- 具备日志自动抓取上传功能，
- 目标路径的监听功能：
    - 通过外部可以配置指定的监控目录，需要监控该目录下文件夹变化或压缩包变化
        - 监控路径下子文件夹或压缩包创建或修改（文件夹写入时间变化）；
        - 监听子目录文件夹创建或修改（文件夹写入时间变化，增加文件或替换文件时文件夹写入时间会改变），对于子文件夹的递归深度根据配置设置
        - 监听到文件夹或压缩包变化 → 提取设备编号，如果 未提取到设备编号 → 就忽略改文件夹，不入库；如果 提取到设备编号 → 表示该文件夹或压缩包是有效日志来源 → 入库，后续扫描其子文件。
  - 新建 log_import_progress 表，记录文件夹/压缩包的处理进度：每批处理完成后更新 processed_files，支持断点续传
- 增加幂等性设计
    - logs 表增加唯一索引 (source_type, filepath_hash)；source_type：区分自动获取和用户上传；content_hash：用于用户上传日志的唯一性判断；
        - 自动获取：filepath_hash = hash(absolute_path)
        - 用户上传：filepath_hash = sha256(file_content)
        - 避免文件重复解析。
        - 队列任务以 文件夹/压缩包为单位，避免 Redis 中产生过多任务，一次50个文件（参乎上可配置，env/BACKGROUND_MAX_QUEUE_WAITING_TASKS）

    - 从监听路径变化的子文件文件夹名称中或已有子目录文件夹名尝试提取“设备编号”，探索层级为3级，利用正则表达式（5G-XX或4XXX-XX），若该设备编号在数据库内，则抓取新增的.medbot文件上传解密，若设备编号无法在数据库内找到，同时从监听路径中变化的子文件夹内尝试提取systeminfo.txt文件来获取密钥，若无法获取密钥则不自动抓取日志文件（.medbot）；
    - 针对压缩文件先进行解压，保存至零时目录中；定时清除，解密后再抓取日志文件上传解析；
- 对于集群启动模式下，拥有两种模式：高峰模式、非高峰模式，无论哪种模式下都只有一个进程用于监控日志路径，用于获取文件中的新增文件夹或压缩包，获取新增文件后其他进程都可以参与日志上传的任务
    - 集群中仅允许 **一个监控进程** 扫描目标路径，避免重复扫描或任务冲突。
    - 监控进程负责：
        1. 检测新增文件夹或压缩包；
        2. 将任务写入队列（Redis + MySQL import_queue）；
        3. 其他 Worker 进程从队列中获取任务并处理（解压、解密、解析、上传）。
    - 高峰模式（08:00–22:00）
        - 仅 **1 个进程**用于处理监控路径下的新增文件，称为 自动获取日志**进程**；
        - 其余进程全部用于响应用户的实时任务。
    - 非高峰模式（22:00–第二天08:00）
        - **50% 的进程**用于处理历史日志任务；
        - 其余进程继续用于响应用户实时任务。
 - 模式切换
    - 调度器在指定时间段自动切换 Worker 分配：
    - 支持手动切换，手动切换位于系统监控页面
    - 切换要求：
        1. **优雅关停**：Worker 停止拉取新任务，等待当前任务完成后再退出；
        2. **调度器等待机制**：确认在途任务数量 ≤ 阈值（如 10 个）后，再启动新 Worker；
        3. **防止数据丢失/重复**：任务状态由队列 + 数据库唯一索引保证幂等。
- 后台任务限流
    - 为避免单批处理任务过大， 自动获取日志**进程** 每次仅允许获取**最多 5 个文件夹或压缩包**；
    - 一批任务完成后再获取下一批；


目前有四种队列  
1. **logProcessingQueue** (通用队列)
   - 处理：批量删除、批量重新解析、单个删除
   - 并发数：3个进程
   - 优先级：默认

2. **realtimeProcessingQueue** (实时处理队列)
   - 处理：用户手动上传的日志
   - 并发数：2个进程
   - 优先级：高 (priority: 10)

3. **historicalProcessingQueue** (历史处理队列)
   - 处理：自动上传的历史日志
   - 并发数：1个进程
   - 优先级：低 (priority: 1)

4. **surgeryAnalysisQueue** (手术分析队列)
   - 处理：手术数据统计分析
   - 并发数：3个进程
   - 优先级：默认
   - 超时时间：10分钟 (600000ms)

进程限定条件有：
#进程类型：通用进程、用户请求进程、主进程
- 通用进程 非高峰模式50%的进程为通用进程，高峰模式：只预留一个通用进程，通用进程参与消费任何队列
- 用户进程 不参与历史处理队列，消费其他队列任务；
- 主进程 负责监控日志自动上传目录与投递，保证只有唯一一个进程监控；

flowchart TD
  Start[监控目录检测到新文件] --> IsArchive{文件是压缩包？}
  IsArchive -- 是 --> ExtractZip[解压到临时目录]
  IsArchive -- 否 --> ToProcess[直接处理该文件]

  ExtractZip --> ScanFiles[遍历临时目录中的每个文件]
  ScanFiles --> ProcessFileLoop{是否还有未处理文件？}
  ProcessFileLoop -- 有 --> NextFile[取下一个文件] --> ProcessFile
  ProcessFileLoop -- 无 --> Cleanup[清理临时目录] --> Record[写 operation_logs（批次结果）] --> End[结束]

  ToProcess --> ProcessFile

   %% 子流程：处理单个文件
  subgraph ProcessFile["处理单个日志文件"]
    direction TB
    ProcessFileStart[提取 Device ID（文件名/内容/元数据）] --> CheckDBKey{device_keys 表中有密钥？}
    CheckDBKey -- 有 --> UseDBKey[从 DB 取出（后端解密/临时凭证）] --> Decrypt[解密日志文件] --> Upload[上传/解析并写 logs & log_entries]
    CheckDBKey -- 无 --> TryExtractInFile{尝试从文件本身提取密钥？}
    TryExtractInFile -- 成功 --> SaveKeyFromFile[保存密钥（加密存储）到 device_keys] --> Decrypt
    TryExtractInFile -- 失败 --> CheckKeyDir{在检测到的新文件下的三级目录内找}
   CheckKeyDir -- 成功 --> SaveKeyFromDir[保存密钥（加密存储）到 device_keys] --> Decrypt
    CheckKeyDir -- 失败 --> Notify[记录日志]
    Decrypt --> IfDecryptOk{解密是否成功?}
    IfDecryptOk -- 是 --> Upload
    IfDecryptOk -- 否 --> MarkDecryptFail[写 logs 状态为 decrypt_failed / 通知]
  end

## 2.2 日志解密

- 解密逻辑可参照（ `decode.py` ）；
- 日志解密逻辑：解密过程中可能会发生需要使用默认密钥的情况，
    - 每个新的日志文件或检测到开机事件需要先判断解密后的参数1-4是否出现异常值（>180000）,如果出现则需要切换密钥解密；如果用户上传的密钥和默认密钥都出现参数异常则认为解密失败（用户提供的密钥不正确），解密失败的日志不进行日志解析也不写入数据表log_entries，但会写入logs表这样可以在日志列表中显示；
    - 解密失败的日志不能进行查看和重新解析；
    - 解密失败的的文件只能进行删除和批量删除的操作；
    - 解密成功的文件可以进行进一步的日志解析；
- 日志以小时为单位生成，解密结果为 TXT 文件，保存在服务器中；

## 2.3 日志解析

- 日志中提取故障码，通过 subsystem+code 匹配 error_codes 获取释义；
- 若释义含有 `{i:d}` 结构，需从 FaultMappings.json 中进行替换；i表示使用第几个参数，d表示使用json哪个字段匹配
- 释义支持多释义选择（正则表达式）、单位转换；
- 解析过程中会给释义增加前缀：

- 子系统号=1或8时臂号定义
    
            1-	左主控制臂
            2-	右主控制臂
            3-	1号工具臂
            4-	2号工具臂
            5-	3号工具臂
            6-	4号工具臂
            7-	1号调整臂
            8-	2号调整臂
            9-	3号调整臂
            A-	4号调整臂
            B-	主端IO
            C-	从端IO
    

- 关节号定义：
    
    1-1关节
    2-2关节
    3-3关节
    4-4关节
    5-5关节
    6-6关节
    7-7关节
    

- 子系统号=3或9时关节号定义：
    
    1-扶手升降关节
    2-主手升降关节
    3-监视器升降
    4-监视器旋转
    

其中如果子系统号为 8、9、A时增加前缀“远程”

- 解析后的日志内容会写入 log_entries 数据表；
- 解析后的日志文本会保存在服务器的指定目录（…\backend\uploads\logs\设备编号\）,通过设备编号的文件夹分类
- 解析失败的日志，不能进行查看操作，其余操作都可以，解析日志有超时保护，解析超过5分钟则会认为解析失败（比较容易出现在日志文件比较大的情况下）

## 2.4 日志列表

- 日志解析页面中的日志列表按照设备进行分类，表头：｜设备编号｜医院名称 | 日志数量｜更新时间｜ 操作 ｜
    - 更新时间：显示该设备编号下日志文件最新的上传时间；
    - 操作：手术数据数据、日志详情
        - 详情内的日志上传与日志解析页面表头的日志解析一致，但不需要输入设备编号和密钥了，因为已经是针对确定的设备编号上传日志；
    - 设备编号：点击设备编号，会以右侧出现的抽屉形式展开，抽屉1000px宽度，显示内容为该设备的详细日志列表
    - 医院名称：若暂无则不显示内容；
    - 抽屉的详细日志列表，包含标题（设备编号名称）、日志上传按钮、日志列表（与目前实现的日志列表一致只是仅显示对应设备编号的日志）。其中，日志列表的表头：多选框｜ 日志文件名｜ 上传用户 ID ｜上传时间｜ 操作 ｜状态；
        - 其中状态包括：上传中、解密中、解密失败、解析中、解析失败、完成、文件错误、处理失败；
        - 日志上传按钮：日志上传与日志解析页面上侧的日志解析一致，但不需要输入设备编号和密钥了，因为已经是针对确定的设备编号上传日志；
        - 其中操作包括：删除、下载、分析、重新解析（针对修改了释义规则）
        当状态是非完成状态时，不能进行任何操作
            - 下载：下载的是解密后的日志文件；
            - 删除：删除数据库中对应的日志内容，并且删除 uploads/logs/对应的日志解密文件
            - 分析：
            1）以列表形式显示当前选择的所有日志中的具体内容；表头：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义；
            2）支持模糊搜索、筛选功能；
            3）支持通过选择时间段筛选满足要求的日志；
            - 重新解析：当释义修改后，可以点击重新解析匹配最新的释义规则；
            - 操作权限如下表
        
        | 操作类型 | 文件错误、处理失败 | 完成 | 解密失败 | 解析失败 | 上传中、解密中、解析中 |
        | --- | --- | --- | --- | --- | --- |
        | 查看/批量查看 | ❌ | ✔ | ❌ | ❌ | ❌ |
        | 下载/批量下载 | ❌ | ✔ | ❌ | ❌ | ❌ |
        | 删除/批量删除 | ✔ | ✔ | ✔ | ✔ | ❌ |
        | 重新解析/批量重新解析 | ❌ | ✔ | ❌ | ✔ | ❌ |
        | logs数据表写入 | ✔ | ✔ | ✔ | ✔ | ❌ |
        | log_entries表写入 | ❌ | ✔ | ❌ | ❌ | ❌ |
    - 日志列表可以通过多选的方式进行批量操作
        - 当用户手动选择多个日志条目时，日志列表上部显示批量分析、批量下载、批量删除、批量解析的选项； 可以将选中的日志条目进行批量操作、批量分析必须满足日志属于同一个设备才能进行操作否则批量操作不可用，有提示：选中的设备包含不同的设备；限制多选的数量不能超过20个日志文件
    - 日志列表支持筛选功能，可以通过设备编号或文件名（文件名定义=YYYYMMDDHH_log.medbot）进行筛选；
    - 日志列表排序规则：按照文件名排序，文件名就是按照YYYYMMDDHH的格式生成的（即时间顺序，最新的时间排最前）；
- 手术数据详情
    - 点击手术数据详情，会以右侧出现的抽屉形式展开，抽屉1000px宽度，抽屉上侧显示医院名称和设备编号的banner, banner下侧为该设备的手术数据列表，列表表头 | 手术id | 手术术式|手术开始时间 | 手术结束时间 | 操作|，列表通过读取surgeries表的数据获取；
        - 其中操作列包括：
            - 查看日志（以批量查看日志的方式查看该场手术涉及的日志
            - 可视化，通过手术结构化数据以可视化方式显示在一个新建的单独页面中；
            - 删除，删除该手术数据记录
        - 其中手术开始时间使用
        - 手术结束时间
        - 手术持续时间
        - 手术类型：可以选择的值：故障手术、远程手术，以标签形式显示；
            - 故障手术标签鼠标悬浮后显示该手术发生的故障
- 手术数据详情
    - 点击手术数据详情，会以右侧出现的抽屉形式展开，抽屉1200px宽度，抽屉上侧显示医院名称和设备编号的banner, banner下侧为该设备的手术数据列表，列表表头： | 手术id | 手术术式 | 手术开始时间 | 手术结束时间 | 操作 |，列表通过读取postgresql的surgeries表的数据获取；
        - 其中操作列包括：
            - 查看日志（以批量查看日志的方式查看该场手术涉及的日志，通过log_entry_start_id INT（起始日志条目）， log_entry_end_id INT（结束日志条目）确定所需要查看的日志）
            - 可视化，通过手术结构化数据（structured_data JSONB）以可视化方式显示在一个新建的单独页面中；
            - 删除，删除该手术数据记录
        - 其中手术开始时间使用
        - 手术结束时间
        - 手术持续时间
        - 手术类型：可以选择的值：故障手术、远程手术，以标签形式显示；
            - 故障手术标签鼠标悬浮后显示该手术发生的故障

## 2.5 日志查看功能

- 日志查看页面最上侧显示分析对象信息： 所选中的日志文件数量，鼠标悬停后显示具体的文件名，设备编号；
- 日志查看页面有右侧的抽屉式侧边栏，用于存放摘取的日志和可视化图表，在一个侧边栏内用两个标签页存放，可视化标签页会显示用有图表的数量个数；
- 日志条目表格，表头：|标记|时间戳(文件名)|故障码|释义|参数(1~4)|操作|；
    - 首列可以选取日志标记颜色，无列名；
        - 用于标记颜色，紫、绿、黄、蓝四种颜色，标记后对应的日志条目变为对应颜色，存储在sessionStorage;
    - 时间戳列，鼠标悬停显示，文件名：xxxxxx；
    - 故障码列：用于显示故障码，支持计数功能
        - 计数：统计此故障码在所选日志中出现的次数，通过点击故障码显示该统计数据，数据显示在故障码的单元格的右上方，以角标形式，存在筛选条件时，需要基于筛选条件的基础上再统计故障码次数，**初始加载时做全局统计**：统计当前日志集里各故障码总数，**筛选器条件变化时**：点击时再实时统计，存储在sessionStorage；
    - 参数1~4：参数1-参数4显示在一个单元格中，用空格间隔开，右对齐显示可视化按钮；
        - 可视化：可视化的按钮在参数的单元格中，右对齐单元格，点击可视化按钮以popOver提供用户选择参数x,参数需要用户通过popover内的radio button选择，选项显示的是该故障码参数的具体含义（可以通过故障码后四位+子系统号在故障码表中查询到，未查询到则显示参数x），图表以此条日志的参数x为y轴，时间戳为x轴，进行可视化生成曲线图，曲线图使用https://echarts.apache.org/examples/zh/editor.html?c=area-time-axis样式，只需要在左上角显示图表标题；可视化的时间范围为打开的日志中第一次出现这个故障码的时间到最后一次出现该故障码的时间，图表的标题是参数的具体含义；生成可视化图表后，图表会在侧边栏可视化标签页显示缩略图，缩略图的标题是参数的具体含义，每一个缩略图是一个卡片形式，点击后以弹窗形式放大到视野中心，点开后的卡片标题是数据可视化，点击弹窗以为的地方关闭此弹窗，鼠标悬浮至可视化缩略图时右上角显示删除按钮（使用垃圾桶icon）；
    - 释义列：鼠标悬停显示完整的释义；
    - 操作：上下文分析，日志抓取，备注
        - 日志摘取：**日志摘取**是一个 **单一容器**，最多存 50 条日志，缩略图显示的是「剪贴板」整体，而不是一条条日志，缩略图会自动显示在右侧的抽屉中；添加日志到日志分析剪切板后，侧右抽屉侧边栏显示，日志条目的内容格式为，”时间戳 故障码 释义“的文本被复制到侧边栏内的剪贴板中，侧边栏仅显示剪贴板的缩略图，点击剪贴板后以弹窗形式展开放大，剪贴板的内容可以编辑，支持另存为txt文件，鼠标悬浮至剪贴板的缩略图时右上角显示删除按钮（使用垃圾桶icon）；
        - 上下文分析，点击上下文分析功能，显示数据输入框需要用户输入前xx分钟，后xx分钟；确认后以该日志条目为基点，选择前XX分钟后XX分析的日志；清空筛选器后复位；
        - 备注，任何用户索引到该日志都可以显示该条日志的所有备注需要区分备注的创建人，备注限制50个字，权限要求：
            
            
            | 权限\角色 | 管理员 | 专家用户 | 普通用户 |
            | --- | --- | --- | --- |
            | 创建 | ✔ | ✔ | ✔ |
            | 删除 | ✔ | ✔（仅自己创建的） | ✔（仅自己创建的） |
            | 修改 | ✔ | ✔（仅自己创建的） | ✔（仅自己创建的） |
            | 查看 | ✔ | ✔ | ✔ |
            - 仅显示一个「📝备注图标」；
            - 点击备注，弹出备注详情面板（popOver），在备注详情面板展示形式类似「评论区」；
                - 按照备注创建时间顺序显示：每条备注显示：用户名 （角色颜色区分，例如管理员红色，专家蓝色，普通灰色）；
                - 备注内容（限制 50 字）；
                - 创建时间；
                - 操作按钮（包括编辑、删除）；
                - 在备注详情面板最上侧中点击「+ 」按钮，在备注详情面板最上侧显示输入框（限制 50 字）
                - 完成输入后可以点击提交备注，备注被写入数据库，前端立即更新该日志的备注显示（无需刷新）
                - 普通用户 → 不显示按钮（或按钮禁用 + tooltip 提示“仅专家/管理员可添加”）；
                - 为了避免一次性加载过多备注，为备注添加分页，只加载最新的10条备注，用户点击"查看更多"来加载更多；
            - 每条备注有编辑按钮：
                - 每条备注右上角显示 编辑按钮（仅对有权限的用户可见）。
                - 点击编辑后该条备注激活为文本输入框，点击提交后修改数据表；
            - 每条备注有删除按钮：
                - 每条备注右上角显示 （垃圾桶icon） 删除按钮（仅对有权限的用户可见）。
                - 删除后确认对话框：「确定删除这条备注吗？」。
- 表头上方固定四种操作：时间筛选器、简单筛选器、高级搜索、清除所有条件，操作按钮下方显示搜索表达式
    - 简单筛选功能（故障码和释义的模糊搜索）；
    - 时间筛选器（精确到s）：选择时间段筛选满足要求的日志；
    - 高级搜索（弹窗形式），点开弹窗后拥有三种方式
        - 条件组模式搜索，
            - 内部设有常用标签搜索，点击”应用选择表达式“后转化为条件组组合显示；
            - 可以由用户自由组合条件组
        - 导入高级表达式的json文件；
        - 三种方式都会显示搜索表达式；
        - 弹窗内的搜索表达式旁设有保存按钮，可以将此搜索表达式保存，点击保存弹窗输入搜索表达式名称，不能重名，保存后可以在常用标签内显示，如何管理这些搜索表达式？
        - 未来拓展自然语言
- 支持手术分析功能，按钮位于导出csv旁位于日志分析最上侧，通过分析页面所有的日志条目分析与手术相关的信息；

- 支持导出csv，导出筛选后的结果；

# 3 手术统计模块

- 当前是在批量日志分析页面中点击手术统计后计算日志批量分析中所有日志条目中包含几场手术信息，每一场手术单独做统计计算，统计过程遍历每一条日志进行不同事件的判断；
- 计算统计可以通过逐条处理获取到的日志记录，根据每条日志的故障码（errCode）及其对应的参数（p1、p2、p3、p4）进行不同分支判断，具体处理过程根据[日志读取过程流程图](https://www.notion.so/259cc02ebc29801e8c8ccc4e749bbd2c?pvs=21)
    - 开机事件、关机事件、手术开始、手术结束、连台手术需要记录上一场手术结束
    - 器械相关信息记录：器械类型、udi码、使用时间
    - 故障统计：统计手术过程触发安全报警的次数和具体的报警信息，日志条目中以A\B结尾的故障码认为触发了安全报警，解除恢复过判定为“已处理”，未解除恢复判断”未处理“，对于故障进行去重操作，对于未处理的故障，在解除恢复前只统计一次；
    - 网络统计：若本场手术是远程手术，则需要统计本场手术的网络延时,远程手术判断条件：出现过故障码结尾是416d的日志且p1=1，网络延时=405e 中 p3的值；
    - 记录手术过程中状态机变化，记录变化的时间戳和状态机值 故障码后四位310e，状态机值=p2
- 这些数据可以归纳为[结构化数据](https://www.notion.so/25acc02ebc29801cad24e26ba066492c?pvs=21)

- 统计结果仅以弹窗列表形式展示，全部分析完成后显示列表内容，列表表头： | 手术id | 手术术式 | 手术开始时间 | 手术结束时间 | 操作 |
    - 其中操作列包括：
        - 可视化，通过手术结构化数据（surgeries-structured_data JSONB）以可视化方式显示在一个新建的单独页面中；
        - 查看手术的结构化数据surgeries；
        - 导出手术数据，将手术数据surgeries存入postgreSql数据库；

- 设有可视化按钮-将surgeries数据转变为可视化视图，只使用对应的surgeries数据
- 前端整体分为几个部分手术概况甘特图、手术状态机变化曲线图，安全报警统计，网络延时情况，器械使用详情表；
    - 手术概括甘特图：左上角显示图表名称：手术概括；时间轴置顶，纵轴分别为时间线，1号臂、2号臂、3号臂、4号臂；
        - 时间线显示手术重要事件包含开机、上一台手术结束时间、关机、手术开始、手术结束；其中手术开始和手术结束使用棱形标识，开机和关机使用圆形标识，视图上时间间隔较小的事件以（图案+x）的形式表示避免多个图形重叠，放大时间轴后独立显示；
        - x号臂显示臂上的器械使用情况，不同的器械使用不同颜色表示，鼠标悬停（tooltip）：显示 UDI 码、使用时长、器械的安装时刻和器械拔下的时刻，标题为器械类型；
        - 甘特图支持滚动缩放时间轴
    - 状态机变化图以时间为x轴，状态机为y轴显示，图表无背景色；
    - 当该场手术为远程手术时显示网络延时图表，以网络延时为y轴，时间为x轴，图表无背景色，若本场手术非远程手术时显示
    - 安全报警记录：表头为: 时间|故障码|释义|处理状态

- 
    - 前端显示要求：开机时间、关机时间、手术开始、手术结束等使用横向时间线的方式表示；
    - 器械信息与本场手术的起止时间，绘制一个类似甘特图的图表，x轴是本场手术的时间轴，手术时间线位于图表下方，与时间轴对齐；
        - 每个工具臂（Y 轴一行）有多个长条，表示多次使用不同器械
        - 鼠标悬停 → 提示 **UDI码 / 使用时长**
    - **核心视图：时间轴 + 甘特图组合**
        - **时间线（横向）**：按照时间顺序显示关键事件（开机、上一场手术结束时间、关机、手术开始、手术结束）以时间线形式，显示在工具臂器械甘特图上侧，避免出现横向滚动条
        - 时间轴（横向）：位于时间线下侧，在时间上对齐；
            - **X轴 = 时间**（范围：手术开始前的开机时间 ~ 手术结束后的关机时间）
            - 在时间轴上标注：
                - 开机点（绿色圆点 + label）
                - 手术开始（蓝色旗帜标记）
                - 手术结束（红色旗帜标记）
                - 关机点（灰色圆点 + label）
        - **甘特图**：显示手术过程中的器械使用情况（多条并行，按工具臂分行），使用这个echart样式https://echarts.apache.org/examples/zh/editor.html?c=custom-gantt-flight
            - 工具臂器械甘特图
                - **Y轴 = 工具臂（例如：1号臂、2号臂…），每一段条真实反应占据时间轴的范围**
                - **X轴 = 时间（与时间轴对齐）**
                - **长条**：表示该臂在某时间段使用了某器械
                    - 不同颜色区分同一条臂上安装的不同器械类型，不同颜色区分不同的工具臂
                    - 鼠标悬停（tooltip）：显示 UDI 码、使用时长、器械的安装时刻和器械拔下的时刻，器械类型，
    - 对于故障手术和远程手术，需要在页面上以标签的方式体现；
    - 器械信息显示在一个列表中，包括器械类型、udi
    - 故障手术需要显示该场手术发生的故障，显示一个列表，表头:|故障发生时间|故障码+释义|状态|
        - 其中故障码在解除恢复前做去重处理；
        - 状态列显示故障码是否被处理，已处理/未处理；
        
        网络延时图表，显示该场手术的网络延时数据，由于网络延时的数据跨度很大，高于1500的数据可以以其他标识处理，
        

- 前端显示每场手术需要写入surgeries 表的内容包括结构化数据`surgeries.structured_data`
- 设有保存按钮，将surgeries数据保存到数据库
- 手术id生成规则：设备编号-手术开始时间（YYYYMMDDHHMM）；
- 点击保存按钮：系统生成一个新的`surgery_versions` 版本。对比新版本与 `surgeries` 当前数据：
    - 如果一致：直接覆盖或忽略。
    - 如果不一致：
        1. 弹窗提示“检测到手术数据变化”
        2. 在弹窗中用可视化方式展示差异（例如表格高亮变化字段、时间轴对比器械使用或臂动作）
        3. 用户确认是否替换当前版本：
        - 确认：将 `surgeries.structured_data` 更新为新版本，并记录 `surgery_versions`
        - 取消：保留原版本不变

`surgeries.structured_data` 始终保存**用户确认后的最新版本**。

`surgery_versions` 保存所有生成的版本（未确认或历史版本），用于对比和回溯。

独立的手术数据页面，和日志解析一样使用设备编号分组显示

### 2.4 下载/删除功能

- 下载解密后的日志文件；
- 删除功能删除数据库记录与上传文件（uploads/logs 子目录）；

## 2.6 数据解析功能

- dashboard中增加数据解析板块，所有类型的用户拥有权限；
- 支持导入bin格式的二进制文件（数据采样率是100kHz 数据包括时间戳，主控制臂工具臂的关节位置速度数据，笛卡尔位姿速度数据，状态机，故障码和器械信息）
- 二进制文件需要解析成对应的数据格式，解析过程参考D:\code\Log\v0.0\logtool\example\dataDecode.py，解析过成中的json可参考D:\code\Log\v0.0\logtool\example\title.json
- 解析后的数据支持下载，下载后是csv格式文件；
- 解析后的数据，每一行是一帧的数据，每一列对应不同的物理意义；
- 其中20、21、22是左控制臂基于基座的笛卡尔位置数据，使用https://echarts.apache.org/examples/zh/editor.html?c=scatter3D-dataset&gl=1绘制三维散点图；

### 3. 用户与权限管理模块

### 3.1 用户功能

- 支持用户注册、登录、修改密码；
- 所有登录用户可访问个人信息页，查看自己的用户名、角色、注册时间等；
- 通过个人信息可以修改密码，输入邮箱；

### 3.2 管理员功能

- 可访问用户管理界面：
- 查看所有用户信息、搜索、重置密码、修改角色，可新增、删除用户账户；

### 3.3 权限角色定义

| 权限 | 管理员 | 专家用户 | 普通用户 |
| --- | --- | --- | --- |
| 用户管理 | ✅ | ❌ | ❌ |
| 故障码增删改 | ✅ | ✅ | ❌ |
| 日志上传/解析 | ✅ | ✅ | ✅ |
| 日志查看 | ✅ | ✅ | ✅ |
| 日志删除 | ✅ | ❌ | ❌ |
| 日志删除（自己） | ✅ | ✅ | ✅ |
| 故障码多语言查看 | ✅ | ✅ | ✅ |
| 故障码多语言管理 | ✅ | ✅ | ❌ |
| 数据解析 | ✅ | ✅ | ❌ |
| 手术分析 | ✅ | ✅ | ❌ |
| 故障码查询功能 | ✅ | ✅ | ✅ |
| 全局看板 | ✅ | ✅ | ✅ |
| 释义测试 | ✅ | ❌ | ❌ |
| 角色管理 | ✅ | ❌ | ❌ |
| 历史记录 | ✅ | ❌ | ❌ |
| 设备管理 | ✅ | ❌ | ❌ |
| 缺陷反馈 | ✅ | ✅ | ❌ |
| 查看手术数据 | ✅ | ✅ | ✅ |
| 删除手术数据 | ✅ | ❌ | ❌ |
| 手术数据可视化 | ✅ | ✅ | ✅ |
| 导出手术数据 | ✅ | ❌ | ❌ |

### 5. 系统操作日志记录

### 记录范围

- 添加用户（POST /api/users）
- 修改用户（PUT /api/users/:id）
- 删除用户（DELETE /api/users/:id）

### 日志内容结构

- 操作类型
- 操作人 ID
- IP 地址
- 浏览器 UA
- 操作描述
- 详细数据（如用户名、邮箱、角色等）

## 三、数据库结构

- users：用户信息（用户名、密码哈希、邮箱、角色、启用状态、注册时间）
- roles：权限角色定义表
- user_roles：用户与角色的多对多关系表
- error_codes：故障码表，包含 subsystem、code、释义及中英文参数等
- logs：日志文件元数据（文件名、设备编号、密钥、上传者、上传时间等）
- log_entries：解密后结构化数据（时间戳、故障码、参数、释义）
- i18n_texts：中英文及未来拓展语言的文本配置
- operation_logs：系统操作日志记录表（操作人、动作、IP、详细内容）


# **使用 Node.js + Electron 日志上传客户端**

为现有的项目写一个组件，用于将本地文件夹中的新增日志自动上传至系统；

# **1. 功能目标**

- 运行在 Windows。
- 监控指定目录（用户手动添加目录）。
- 发现新日志文件夹/压缩包或发现文件夹中子文件夹内有新增文件 → 上传到后端接口。
- 支持从文件夹或压缩包中提取设备名称和密钥文件systemInfo
- 支持断点续传、失败重试。
- 前端 Vue 界面，提供配置和状态展示。
- 托盘常驻，提供提示/控制。

# **2. 模块划分**

**A.**

**配置管理模块**

- 用户可在 UI 界面配置：
    - 目标监控路径（多个目录可选限制最多10个）
    - 递归深度默认为4
    - 文件类型过滤（日志文件是.medbot, 密钥systeminfo.txt
    - 上传接口地址（后端 API URL）
    - 设备编号提取规则（正则 / 文件名模式）
- 配置保存方式：config.json 本地存储，启动时加载。

**B.**

**目录监听模块**

- 监听逻辑参照 监听流程图

**上传任务队列模块**

- 本地使用 队列机制 控制并发（比如一次只上传 3 个任务）。
- 每个任务包含：

{

"device_id": "DEV123",

"file_path": "C:\\logs\\DEV123\\log1.medbot",

"status": "pending|uploading|success|failed",

"retry_count": 0

}

**上传任务队列模块**

- 本地使用 队列机制 控制并发（比如一次只上传 3 个任务）。
- 每个任务包含：

{

"device_id": "DEV123",

"file_path": "C:\\logs\\DEV123\\log1.medbot",

"status": "pending|uploading|success|failed",

"retry_count": 0

}

- 上传方式：axios.post('/api/uploadLog', FormData)
- 失败时：指数退避重试（1min → 5min → 30min）。
- 上传成功 → 本地状态标记 success（写 sqlite/lowdb）。

**D.**

**本地存储模块**

- 用于保存上传状态（防止程序重启丢失任务）：
    - 数据库存储方式：
        - 轻量方案：lowdb (基于 JSON 文件)
        - 稍重方案：sqlite
- 表结构示例：
    - upload_tasks（任务表）
    - config（配置表）

**E.**

**UI 界面模块（Vue + Electron 渲染进程）**

- 功能页面：
    - 监控目录管理（添加/删除路径）
    - 任务列表（显示当前任务状态、成功/失败次数）
    - 配置页（后端 API 地址、过滤规则）
    - 系统状态（队列长度、上传速率）
    - 与logtool的连接状态（已连接？未连接）
- 托盘菜单：
    - 显示上传状态（绿色正常、红色失败）
    - 一键暂停/恢复上传
    - 打开配置界面

**F.**

**系统提示模块**

- 事件通知：
    - 上传成功/失败 → 桌面通知（可选）
    - 新任务加入队列 → 托盘图标闪烁
- 日志记录：
    - 本地写 client.log，保存运行日志，方便排查。

**G.**

**安全性**

- 与后端 API 通讯：
    - HTTPS + JWT/Token 鉴权
- 上传数据：
    - 日志文件走 multipart/form-data
    - 携带 device_id、客户端 client_id（唯一标识客户端机器）