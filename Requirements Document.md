# 需求

# logTool 项目详细需求文档

## 一、项目概述

logTool 是一个集成故障码管理、日志上传与解析、账户与权限管理于一体的系统，面向具备不同权限的用户，提供一套完整的设备日志与故障码管理平台，支持多语言翻译及 XML 数据导出功能。

## 二、主要功能模块

### 1. 故障码管理模块

### 1.1 功能需求

- 展示部分故障码数据库中的内容，表头包含：已实现
  - subsystem
  - code
  - userInfo（由 user_hint 和 operation 拼接）
  - param1, param2, param3, param4
  - category
- 按照权限区分支持不同用户类型对于故障码数据库的增删改查操作；
  - 故障码的增加修改对于各字段的需求如下
    | 列名 | 填写方式 | 有效值 | 字段 | 是否必须填写 |
    | --- | --- | --- | --- | --- |
    | 子系统 | 01：运动控制软件；02：人机交互软件；03：医生控制台软件；04：手术台车软件；05：驱动器软件；06：图像软件；07：工具工厂软件。08：远程运动控制软件 09：远程医生控制台软件 0A: 远程驱动器软件；
    仅可以填写上述子系统编号之一 | 1、2、3、4、5、6、7、8、9、A | subsystem | Y |
    | 故障码 | 区分故障类型不能重复，以“0X010A”形式填写，最后一位必须为字母且仅为“A、B、C、D、E”中一个 A:A 类故障报警，报警等级最高，影响状态机跳转；B:B 类故障报警，报警等级次高，影响状态机跳转；C:C 类故障报警，不影响状态机跳转，可忽略；D:提示信息；E:日志记录； | 以“0X010A”形式填写;
    其中 0X 为 16 进制标志符，
    最后一位必须为字母且仅为“A、B、C、D、E”中一个；
    由子系统号与故障码组成的故障码不会重复对应唯一的故障类型 | code | Y |
    | 是否轴错误（TRUE/FALSE） | 标识此故障是否会有关节号，不影响交互软件显示；true = 有关节号，false = 无关节号 | TRUE/FALSE | is_arm_error | Y |
    | 精简提示信息 | 普通账户下人机交互软件显示的中文提示信息，中文文字填写；1.任意一个非日志记录的故障码必须有精简的提示信息或操作信息其中之一；2.提示类故障，精简提示信息与给用户的提示信息一致； | 中文文字填写 | short_message | Y |
    | 精简提示信息英文 | 普通账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | short_message_en | Y |
    | 给用户的提示信息 | 维护账户或管理员账户下人机交互软件显示的中文提示信息，中文文字填写； | 中文文字填写 | user_hint | Y |
    | 给用户的提示信息英文 | 维护账户或管理员账户下人机交互软件显示的英文提示信息，英文文字填写； | 英文文字填写 | user_hint_en | Y |
    | 操作信息 | 人机交互软件显示的中文操作信息，中文文字填写； | 中文文字填写 | operation | Y |
    | 操作信息英文 | 人机交互软件显示的英文操作信息，英文文字填写； | 英文文字填写 | operation_en | Y |
    | 是否臂错误
    （TRUE/FALSE） | 决定人机交互软件是否显示“XX 臂”；TRUE = 显示“XX 臂”，FALSE = 不显示“XX 臂”， | TRUE/FALSE | is_axis_error | Y |
    | 详细信息 | 故障详细信息与描述 | 中文文字填写 | detail | Y |
    | 检测方法 | 故障检测方法的简述 | 中文文字填写 | method | Y |
    | 参数 1 | 故障日志记录的参数 1 | 中文文字填写 | param1 | Y |
    | 参数 2 | 故障日志记录的参数 2 | 中文文字填写 | param2 | Y |
    | 参数 3 | 故障日志记录的参数 3 | 中文文字填写 | param3 | Y |
    | 参数 4 | 故障日志记录的参数 4 | 中文文字填写 | param4 | Y |
    | 处理措施 | 故障的处理，根据故障码确定方式 A 类故障：recoverable 可恢复故障；B 类故障：unrecoverable 不可恢复故障；C 类故障 ignorable 可忽略故障；D 类 tip 提示信息,；E 类 log 日志记录； | recoverable
    unrecoverable
    tips
    log
    ignorable | solution | N |
    | 专家模式
    （TRUE/FALSE） | 用于区分是否在专家模式下显示记录该操作提示 | TRUE/FALSE | for_expert | N |
    | 初学者模式
    （TRUE/FALSE） | 用于区分是否在初学者模式下显示记录该操作提示 | TRUE/FALSE | for_novice | N |
    | 日志
    （TRUE/FALSE） | 用于区分 | TRUE/FALSE | related_log | N |
    | 停止上报方法 | 无需填写 | / | stop_report | N |
    | 故障等级 | 故障等级说明
    高级：A 类故障；
    中级：B 类故障；
    低级：C 类故障；
    无：提示信息或日志记录； | 高级
    中级
    低级
    无 | level | N |
    | 技术排查方案 | 故障报警的排查方案，用于故障小程序中 | 中文文字填写 | tech_solution | N |
    | 解释 | 故障报警的解释，用于日志分析工具解析；
    需要结合故障详细信息，解释故障具体含义与各参数的含义 | 中文文字填写 | explanation | N |
    | 故障分类 | 故障报警的分类，用于故障小程序中 | 软件
    硬件
    日志记录
    操作提示
    安全保护 | category | Y |
- 支持模糊搜索功能；
- 支持导出当前故障码数据库中的内容至 XML 格式；
  - xml 是用于给其余软件解析故障码
  - 其中故障码数据库的 short_message_en 、user_hint_en 、operation_en 三列可以支持多语言模式，并且具备可扩展性
  - 需要支持生成针对不同语言的 xml，选择不同的语言可以导出 short_message_en 、user_hint_en 、operation_en 这三个字段使用不同语言的 xml;
  - xml 文件格式如 D:\code\Log\demo\logtool\example\FaultAnalysis_Chinese.xml 和 D:\code\Log\demo\logtool\example\FaultAnalysis_English.xml 分别是中文 xml 和英文 xml
  - 任何用户对于故障码的修改需要记录在系统日志中
  - 支持导出当前故障码数据库中的内容至 XML 格式；
    - xml是用于给其余软件解析故障码
    - 其中故障码数据库的short_message 、user_hint 、operation 三列可以支持多语言模式，并且具备可扩展性
    - 前端页面中多语言管理在故障码管理的下一层级中，具备导出xml、导入多语言表、搜索三个功能
        - 导入功能：支持多语言的short_message 、user_hint 、operation三个字段的导入，导入的数据格式为subsystem,code,short_message,user_hint,operation的csv文件；
        - 搜索功能：输入 子系统号 故障码 可以显示对应语言的short_message 、user_hint 、operation三个字段的内容；显示列表表头：子系统号 | 故障码 | 精简的提示信息 | 提示信息 | 操作信息
        - 导出xml：支持生成针对不同语言的xml，选择不同的语言可以导出short_message 、user_hint 、operation这三个字段使用不同语言的xml，支持以多选checkbox的方式，同时导出多国语言的xml
### 1.2 数据来源

- error_codes 数据表，包含中英文字段和分类信息；

### 1.3 权限控制

- 管理员与专家用户可新增、编辑、删除故障码；
- 所有用户可查看与导出。

### 2. 日志管理模块

### 2.1 上传日志功能

- 同时上传多个 `.medbot` 文件（不超过 50 个，合计不超过 200MB）；
- 支持输入或上传解密密钥（`systemInfo.txt`），校验格式是否为 MAC 地址；
- 填写设备编号（格式如 4371-01）；
- 若用户输入密钥，则自动填充设备编号，反之亦然（通过 logs 表检索）；

### 2.2 解密逻辑

- 解密逻辑与 `decode.py` 保持一致；
- 日志以小时为单位生成，解密结果为 TXT 文件，保存在服务器中；
- 解密后结构化内容写入 log_entries 数据表；
- 日志中提取故障码，通过 subsystem+code 匹配 error_codes 获取释义；
- 若释义含有 `{i:d}` 结构，需从 FaultMappings.json 中进行替换；

### 2.3 分析功能

- 多选分析日志内容：显示表格，表头为时间戳、故障码、param1~4、释义；
- 支持筛选（时间段、关键字、设备编号、上传用户等）；

### 2.4 下载/删除功能

- 下载解密后的日志文件；
- 删除功能删除数据库记录与上传文件（uploads/logs 子目录）；
### 分析功能

- 分析页面最上侧表头显示分析对象信息： 所选中的日志文件名称，设备编号；
- 分析日志内容：显示表格，表头为时间戳、故障码、param1~4、释义；
- 支持筛选（时间段、关键字、设备编号、上传用户等）；
- 支持通过选择时间段筛选满足要求的日志；
- 支持导出csv，导出筛选后的结果；
- 支持手术分析功能，按钮位于导出csv旁位于日志分析最上侧，通过分析页面所有的日志条目分析与手术相关的信息；

### 2.4 手术统计功能

- 点击手术统计后计算日志分析中所有日志包含几场手术信息，每一场手术单独做统计计算；
- 手术分析分析日志时，应该针对的是日志分析页面中的所有日志，统计出一场手术开始：新建一个标签页，一场手术从开始到结束的数据显示在一个标签页中，每一个标签页代表一场手术；手术序号依次累加
- 手术分析页面应该显示手术时长进度条和四个工具臂的器械使用时间进度条，每个器械的使用时长与手术时长的时间轴需要对齐；起点=开机时间或上一场手术结束时间；终点=关机时间或手术结束时间；
- 计算统计可以通过逐条处理获取到的日志记录，根据每条日志的故障码（errCode）及其对应的参数（p1、p2、p3、p4）进行不同判断：
    开机判断：检查是否满足开机条件（情况1：errCode后四位为“A01E”  情况2：errcode是否为570e 且 p1=0 且 p2≠0? 并且 s2检查下一条日志是否为571e 且 p1=0 且 p2≠0?），
        确认后标记“开机” 记录 开机时间
    关机判断：检查是否满足关机条件（情况1：errCode后四位为 ' A02E '，标记为“关机”，情况2：检查errcode=310e且p2=31）

对于开机关机的判断过于复杂；分几种情况重新梳理一下 正常
1.正常开机，如果当前无手术，记录开机时间（第一次开机）
           如果当前有手术，两种情况：（之前有关机，两个不连续的日志）
           比较上次关机时间距离本次开始时间，是否小于30分钟，若是则认为是重启，否则为新手术；清空当前手术，清空记录的开机时间和关机时间，并且记录当前开机时间

  手术开始时 记录当前的开机时间和关机时间；（一场手术可能有多个）

  手术结束时加 记录当前的开机时间和关机时间；（一场手术可能有多个）     

  正常关机 添加关机时间；

  当日志读取完成

    故障判断：检查是否满足故障条件（ errCode的最后一个字符为 'a' 或 'b' 或 'c' 时，认为发生故障。
        设置故障标志位errFlag = True

    状态机处理：检查是否满足状态机跳转条件（errCode后四位为 '310e' 的日志）
        任意故障跳转发生记录当前状态机p2；
        当 p2==20 时：如果当前仍处于开机状态bPowerOn=true，则标记为“手术开始”
        当 p1==0、p2==1 且处于故障状态（errFlag=True）时，则表示此故障被恢复errFlag=false，
    手术结束：检查是否满足（errCode后四位为“500e”且 p2 不为 0、p3 为 0 时，更新器械状态数组（InstState）；如果所有器械状态=0或-1 且当前 state 在特定值范围内（10、12 或 13），则标记该日志为“手术结束”
- 实现手术状态机变化图，只需要用曲线图表示，代码中可能存在绘制柱状图的逻辑不再需要了，是不是用chart.js实现比较合适 ，基于本场手术的currentstate数据； 绘制状态机和时间的曲线图 默认显示手术开始后5分钟的状态机图 图表支持时间轴滚动去但不改变时间轴的标尺 始终是5分钟

- 安全报警记录 表头：时间|故障码|报警信息|处理状态；此列表默认只显示前5条，其余部分折叠，需要手动展开

- 支持显示开机时间，关机时间，手术开始时间，手术结束时间 四个卡片
    - 开机时间：
    - 关机时间：
    - 手术开始时间：手术开始是开机后第一次进入状态机S20
    - 手术结束时间

- 支持统计手术过程中4个工具臂各自安装的器械类型、udi码、使用时间以进度条方式显示，器械类型定义
    器械有唯一的UDI码，若识别到器械插上，则记录时间戳，器械拔下再次记录时间戳，进度条填色部分的起点和终点就是这两个时间戳；
```
  "0": "无器械",
        "1": "持针钳",
        "2": "电钩",
        "3": "双极鸭嘴电凝钳",
        "4": "直剪",
        "5": "单极弧剪",
        "6": "双极弧形电凝钳",
        "7": "波茨剪",
        "8": "无损伤镊",
        "9": "-30度内窥镜",
        "10": "0度内窥镜",
        "11": "30度内窥镜",
        "12": "大持针钳",
        "13": "鸭嘴抓钳",
        "14": "鼠齿抓钳",
        "15": "极电铲",
        "16": "强力鸭嘴抓钳",
        "17": "超声刀",
        "18": "持钩钳",
        "19": "中号施夹钳",
        "20": "大号施夹钳",
        "21": "小剪刀持针钳",
        "22": "大剪刀持针钳",
        "23": "30度胸科镜",
        "24": "-30度胸科镜",
        "25": "单极小电钩",
        "26": "弧剪",
        "27": "小持钳",
        "28": "大宏剪",
        "29": "无损肠抓钳",
        "30": "共注双极鸭嘴",
        "31": "共注双极弧形",
        "32": "UNDEFIEND",
        "33": "新持针"
```

- 支持统计手术过程触发安全报警的次数和具体的报警信息，日志条目中，以A\B\C结尾的故障码认为触发了安全报警，在未解除恢复前的故障需要做去重处理

状态机定义
 "0": "初始化（S00）",
        "1": "使能（S01）",
        "2": "自检（S02）",
        "10": "待机（S10）",
        "12": "从手调整（S12）",
        "13": "主手跟随（S13）",
        "14": "断开主从/离合（S14）",
        "15": "初始化（S00）",
        "20": "主从控制（S20）",
        "21": "内窥镜控制（S21）",
        "30": "错误（S30）",
        "31": "关机（S31）"
```

以上的数据可以从所分析的日志条目中获取，参考 mermaid语言的日志统计流程图
graph TD 
Start(开始) --> Init[初始化全局变量]
    Init --> Reset[清空各统计列表]
    Reset --> Loop[读取每一个日志]
    
    Loop --> CheckType{日志类型判断}
    
    %% 主要分支
    CheckType --> |开机事件| PowerOn[标记开机]
    CheckType --> |关机事件| PowerOff[处理关机逻辑]
    CheckType --> |故障事件| Error[处理故障逻辑]
    CheckType --> |状态机| State310[处理状态机事件]
    CheckType --> |手术结束| State500[处理手术结束]
    CheckType --> |器械状态记录| State600[处理手术结束]
    
    %% 子流程调用
    PowerOn --> SubPowerOn
    PowerOff --> SubPowerOff
    Error --> SubError
    State310 --> Sub310
    State500 --> Sub500
	  State600 --> Sub600

%% 子流程图：开机事件处理
subgraph SubPowerOn[开机处理]
    direction TB
    s1{检查errcode是否为570e 且 p1=0 且 p2≠0?} --> |是| s2[检查下一条日志是否为571e 且 p1=0 且 p2≠0?]
    s2 --> s3{下一条符合条件?}
    s3 -->|是| s4[标记i+1为'开机']
    s4 --> s5[设置开机is_power_on=True]
    s5 --> s6[记录Tstart时间，Tdur=Tstart]
end

%% 子流程图：关机事件处理
subgraph SubPowerOff[关机处理]
    direction TB
    p1[检查errcode=310e且p2=31] --> p2[标记'关机']
    p2 --> p3[计算无故障时间: Tshutdown-Tdur]
    p3 --> p4[累加到总的无故障运行时间：noErrTime_list]
    p4 --> p5[重置errFlag/errSurical等标记]
end
%% 子流程图：故障事件处理
subgraph SubError[故障处理]
    direction TB
    e1[检查errcode结尾为a/b] --> e2[标记'故障']
    e2 --> e3{errFlag=False?}
    e3 -->|是| e4[计算无故障时间:Terr-Tdur]
    e4 --> e5[累加到总的无故障运行时间：noErrTime_list]
    e5 --> e6[添加到列表（每段无故障运行时间）]
    e3 -->|否| e7[跳过时间计算]
    e7 --> e8
    e6 --> e8[设置是否发生故障errFlag=True]
    e8 --> e9[标记该手术为故障手术errSurical=True]
    e9 --> e10[记录时间Tdur=Terr]
    e10 --> e11[是否恢复标志位errSuricalRecover=false]
end
%% 子流程图：状态机事件处理
subgraph Sub310[状态310e处理]
    direction TB
    st1{检查errcode=310e} --> st2[获取p2值作为新state]
    st2 -->st3{检查p2 = 20}
    st3 -->|是| st4{检查is_power_on=True}
    st4 -->|是| st5[标记'手术开始']
    st4 -->|否| st6[标记'状态机']
    st3 -->|否| st7{检查p1 = 0 且 p2 = 1 且 故障状态err_flag = true}
    st7 -->|是| st8[标记'故障恢复']
    st7 -->|否| st17[标记'状态机']
    st6 -->st13{检查errRecover=True}
    st13 -->|是| st14[恢复等待重新进入标志位errRecover=false]
    st14 -->st15[记录故障恢复进入主从时间 errRecoverTime = Ts20 - Trecover]
    st15 --> st16[添加到列表（从故障恢复到主从的时间）]
    st8 --> st9[记录时间Tdur=Trecover时间]
    st9 --> st10[复位errFlag=flag]
    st10 --> st11[是否恢复标志位errSur icalRecover=True]
    st11 --> st12[恢复等待重新进入标志位errRecover=True]
end
%% 子流程图：手术结束处理
subgraph Sub500[手术结束处理]
    direction TB
    sc1[检查errcode=500e且p3=0] --> sc2[更新对应臂的armState器械状态]
    sc2 --> sc3{器械全归零且state为13/10/12?}
    sc3 -->|是| sc4[标记'手术结束']
    sc4 --> sc5[手术场次surgicalCount+1]
    sc5 --> sc6[添加到列表（该场次是否为故障手术场次）]
    sc6 --> sc7[添加到列表（该场次是否故障恢复的手术场次）]
    sc7 --> sc8[复位器械状态armState=-1]
end

%% 子流程图：手术器械记录处理
subgraph Sub600[手术器械记录处理]
    direction TB
    ss1[检查errcode=500e且p3=0] --> ss2[更新对应臂的armState器械状态]
    ss2[检查器械状态变化故障码 errcode=501e,p1= 臂号-1,p2=上一状态器械类型，p3=当前器械类型] --> ss3[更新对应臂的armInst器械类型]
    ss3[检查器械状态变化故障码 errcode=510e,p1= UDI年月,p2=UDI序号，p3=UDI批次，P4=UDI尾号（acsII码形式，需要转换）] --> ss4[更新对应臂的armUDI 器械UDI=p1+p2+p3+p4]
end

- 支持导出每场手术的手术统计报告pdf；



### 2.5 日志记录

- 上传用户 ID、文件名、设备编号、上传时间、是否解密等写入 logs 表。

### 3. 用户与权限管理模块

### 3.1 用户功能

- 注册、登录、修改邮箱、修改密码、注销账号；
- 所有登录用户可访问个人信息页，查看自己的用户名、角色、注册时间等；

### 3.2 管理员功能

- 可访问用户管理界面：查看所有用户信息、搜索、重置密码、修改角色；
- 可新增、删除用户账户；

### 3.3 权限角色定义

| 权限           | 管理员 | 专家用户 | 普通用户 |
|--------------|--------|----------|----------|
| 用户管理       | ✅      | ❌        | ❌        |
| 故障码增删改   | ✅      | ✅        | ❌        |
| 故障码查看导出 | ✅      | ✅        | ✅        |
| 日志上传/解析  | ✅      | ✅        | ✅        |
| 日志查看所有   | ✅      | ✅        | ✅        |
| 日志删除       | ✅      | ❌        | ❌        |
| 日志删除（自己） | ✅      | ✅        | ✅        |
| 多语言管理     | ✅      | ✅        | ❌        |

### 4. 多语言支持模块

- 使用 Vue I18n 实现中英文切换；
- 所有故障码及界面文本多语言字段维护在 i18n_texts 数据表；
- 支持多语言数据的增删改查（管理员权限）；

### 5. 系统操作日志记录

### 记录范围

- 添加用户（POST /api/users）
- 修改用户（PUT /api/users/:id）
- 删除用户（DELETE /api/users/:id）

### 日志内容结构

- 操作类型
- 操作人 ID
- IP 地址
- 浏览器 UA
- 操作描述
- 详细数据（如用户名、邮箱、角色等）

## 三、数据库结构

- users：用户信息（用户名、密码哈希、邮箱、角色、启用状态、注册时间）
- roles：权限角色定义表
- user_roles：用户与角色的多对多关系表
- error_codes：故障码表，包含 subsystem、code、释义及中英文参数等
- logs：日志文件元数据（文件名、设备编号、密钥、上传者、上传时间等）
- log_entries：解密后结构化数据（时间戳、故障码、参数、释义）
- i18n_texts：中英文及未来拓展语言的文本配置
- operation_logs：系统操作日志记录表（操作人、动作、IP、详细内容）

## 四、前端页面设计

### 1. 登录页

- 登录、注册、忘记密码三合一界面
- 中英文切换（右上角语言下拉菜单）

### 2. 首页导航页

包含以下导航块：

- 故障码查询
- 日志上传与分析
- 账户信息管理
- 历史日志记录

### 3. 故障码管理页

- 表格展示故障码信息
- 搜索框支持模糊搜索 subsystem/code
- 根据权限展示增删改按钮
- 导出 XML 按钮

### 4. 日志管理页

- 上传区域（支持拖拽、输入密钥、选择 systemInfo.txt）
- 日志列表表格，展示设备号、日志文件名、上传用户、上传时间
- 操作列：删除、下载、分析
- 支持批量操作（多选分析、删除、下载）
- 日志内容分析页：展示结构化条目，支持筛选与搜索

### 5. 用户管理页（管理员可见）

- 用户列表
- 搜索、重置密码、修改角色、删除账户

### 6. 个人信息页

- 展示当前登录用户信息（用户名、邮箱、角色、注册时间）
- 支持修改邮箱、密码

## 五、后端接口规范

采用 RESTful API，接口路径前缀为 `/api/`

### 示例接口

- POST /api/auth/login 登录
- POST /api/auth/register 注册
- GET /api/error-codes 获取故障码列表
- POST /api/error-codes 新增故障码（需权限）
- GET /api/logs 获取日志列表（支持过滤）
- POST /api/logs 上传日志文件
- POST /api/logs/decrypt 解密日志（或自动处理）
- GET /api/log-entries 获取解密后的结构化日志
- GET /api/users 当前用户信息
- PUT /api/users/:id 修改用户
- GET /api/roles 获取角色权限

## 六、技术选型

### 前端

- Vue.js 3.x
- Vue Router
- Vuex
- Element UI 或 Vuetify
- Vue I18n

### 后端

- Node.js + Express.js
- JWT 用户身份认证
- bcrypt 密码加密
- MySQL 数据库

### 其他

- 文件上传使用 multer
- 密钥校验与解密逻辑复用 decode.py 或重写于 Node.js
- 日志分析与格式匹配使用 JSON 配置文件 FaultMappings.json

