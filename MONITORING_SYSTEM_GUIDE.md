# LogTool 监控系统完整指南

## 📊 监控系统概述

LogTool 监控系统是一个完整的系统监控解决方案，提供实时监控、历史数据分析、告警管理和可视化面板等功能。

### 🎯 核心功能

1. **实时监控** - 系统状态、性能指标、业务指标
2. **历史数据** - 指标数据持久化存储和历史分析
3. **告警系统** - 智能告警检测和通知
4. **可视化面板** - 统一的监控界面
5. **数据存储** - 基于Redis的监控数据存储

---

## 🏗️ 系统架构

### 监控数据流

```
系统组件 → 监控中间件 → 监控控制器 → 存储服务 → 监控面板
    ↓           ↓           ↓          ↓         ↓
  指标收集   数据预处理   数据聚合   数据存储   数据展示
```

### 核心组件

1. **监控中间件** (`middlewares/monitoring.js`)
   - API请求监控
   - 系统资源监控
   - 错误监控

2. **监控控制器** (`controllers/monitoringController.js`)
   - 统一监控API
   - 数据聚合处理
   - 告警检测

3. **存储服务** (`services/monitoringStorage.js`)
   - 监控数据持久化
   - 历史数据管理
   - 数据清理

4. **监控面板** (`views/MonitoringDashboard.vue`)
   - 实时数据展示
   - 历史趋势分析
   - 告警管理

---

## 📈 监控指标分类

### 1. 系统级指标

| 指标 | 描述 | 告警阈值 | 单位 |
|------|------|----------|------|
| 内存使用率 | 系统内存使用百分比 | 85% | % |
| CPU使用率 | CPU使用百分比 | 80% | % |
| 运行时间 | 系统运行时长 | - | 小时 |
| 进程状态 | 主进程和工作进程状态 | - | 状态 |

### 2. 应用级指标

| 指标 | 描述 | 告警阈值 | 单位 |
|------|------|----------|------|
| API响应时间 | 平均API响应时间 | 5000ms | 毫秒 |
| 错误率 | API错误请求百分比 | 5% | % |
| 缓存命中率 | Redis缓存命中率 | 70% | % |
| 缓存连接状态 | Redis连接状态 | - | 布尔值 |

### 3. 业务级指标

| 指标 | 描述 | 告警阈值 | 单位 |
|------|------|----------|------|
| 活跃用户数 | 当前活跃用户数量 | - | 个 |
| 队列等待任务 | 队列中等待处理的任务数 | 100 | 个 |
| 用户公平性 | 用户队列调度公平性 | 80% | % |
| 任务完成率 | 任务成功完成百分比 | 90% | % |

---

## 🔧 配置说明

### 环境变量配置

```bash
# 监控系统配置
MONITORING_STORAGE_ENABLED=true          # 启用监控数据存储
MONITORING_RETENTION_DAYS=7              # 数据保留天数
MONITORING_BATCH_SIZE=100                # 批量存储大小
MONITORING_FLUSH_INTERVAL=60000          # 刷新间隔(毫秒)

# 告警阈值配置
ALERT_MEMORY_THRESHOLD=85                # 内存告警阈值
ALERT_QUEUE_THRESHOLD=100                # 队列告警阈值
ALERT_ERROR_RATE_THRESHOLD=5             # 错误率告警阈值
ALERT_RESPONSE_TIME_THRESHOLD=5000       # 响应时间告警阈值
```

### Redis配置

监控系统依赖Redis进行数据存储，确保Redis服务正常运行：

```bash
# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

---

## 📊 API接口文档

### 1. 系统概览

```http
GET /api/monitoring/overview
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "timestamp": "2025-01-15T10:30:00.000Z",
    "system": {
      "memory": {
        "used": 512,
        "total": 1024,
        "usage": 50
      },
      "cpu": {
        "user": 1000,
        "system": 500,
        "total": 1500
      },
      "uptime": 3600
    },
    "application": {
      "cache": {
        "connected": true,
        "keys": 1500
      },
      "api": {
        "totalRequests": 10000,
        "errorRate": 2,
        "avgResponseTime": 250
      }
    },
    "business": {
      "users": {
        "total": 50,
        "active": 25
      },
      "tasks": {
        "total": 1000,
        "waiting": 50,
        "processing": 10,
        "completed": 900,
        "failed": 40
      },
      "fairness": 95
    },
    "cluster": {
      "enabled": true,
      "workers": {
        "total": 4,
        "active": 4
      }
    },
    "alerts": []
  }
}
```

### 2. 历史指标数据

```http
GET /api/monitoring/metrics/history?metric=system&hours=24
```

**参数：**
- `metric`: 指标类型 (system, application, business)
- `hours`: 时间范围（小时）

### 3. 实时指标数据

```http
GET /api/monitoring/metrics/realtime
```

### 4. 告警管理

```http
# 获取当前告警
GET /api/monitoring/alerts

# 获取告警历史
GET /api/monitoring/alerts/history?hours=24

# 设置告警阈值
POST /api/monitoring/alerts/thresholds
Content-Type: application/json

{
  "thresholds": {
    "memoryUsage": 85,
    "queueLength": 100,
    "errorRate": 5,
    "responseTime": 5000
  }
}
```

---

## 🎨 监控面板使用

### 访问监控面板

1. 启动系统后，访问前端应用
2. 导航到监控面板页面
3. 查看实时监控数据

### 面板功能

1. **系统概览卡片**
   - 内存使用率
   - 队列等待任务
   - 活跃用户数
   - 用户公平性

2. **详细监控信息**
   - 系统状态详情
   - 队列状态详情
   - 集群状态（如果启用）

3. **告警管理**
   - 当前告警显示
   - 告警历史查看
   - 告警阈值设置

### 自动刷新

- 监控面板每30秒自动刷新数据
- 支持手动刷新
- 实时数据更新

---

## 🚨 告警系统

### 告警类型

1. **系统告警**
   - 内存使用率过高
   - CPU使用率过高
   - 系统资源不足

2. **应用告警**
   - API响应时间过长
   - 错误率过高
   - 缓存连接断开

3. **业务告警**
   - 队列积压过多
   - 用户公平性过低
   - 任务失败率过高

### 告警级别

- **warning**: 警告级别，需要关注
- **critical**: 严重级别，需要立即处理
- **error**: 错误级别，系统异常

### 告警处理

1. 监控系统自动检测告警条件
2. 告警数据存储到历史记录
3. 监控面板显示告警信息
4. 管理员可设置告警阈值

---

## 📊 数据存储

### 存储策略

1. **实时数据**: 存储在内存中，定期刷新到Redis
2. **历史数据**: 存储在Redis中，按时间分片
3. **告警数据**: 立即存储到Redis
4. **数据清理**: 自动清理过期数据

### 数据保留

- 默认保留7天历史数据
- 可通过环境变量配置保留天数
- 自动清理过期数据

### 性能优化

1. **批量存储**: 数据批量写入，减少Redis操作
2. **异步处理**: 存储操作不阻塞主流程
3. **数据压缩**: 历史数据压缩存储
4. **索引优化**: 基于时间的数据索引

---

## 🔧 部署和运维

### 启动监控系统

1. **确保Redis服务运行**
   ```bash
   redis-server
   ```

2. **启动后端服务**
   ```bash
   cd backend
   npm start
   ```

3. **启动前端服务**
   ```bash
   cd frontend
   npm run serve
   ```

### 监控系统健康检查

```bash
# 检查系统健康状态
curl http://localhost:3000/health

# 检查监控API
curl http://localhost:3000/api/monitoring/overview
```

### 故障排查

1. **监控数据不更新**
   - 检查Redis连接状态
   - 检查监控中间件是否启用
   - 查看应用日志

2. **告警不触发**
   - 检查告警阈值设置
   - 检查告警检测逻辑
   - 查看告警历史记录

3. **性能问题**
   - 检查Redis性能
   - 调整批量存储大小
   - 优化数据清理频率

---

## 📈 性能优化建议

### 1. 系统优化

- 合理设置监控数据保留天数
- 调整批量存储大小和刷新间隔
- 定期清理过期数据

### 2. 告警优化

- 设置合理的告警阈值
- 避免告警风暴
- 定期检查告警历史

### 3. 存储优化

- 使用Redis集群（大规模部署）
- 优化数据存储格式
- 实施数据压缩

---

## 🔮 未来扩展

### 计划中的功能

1. **WebSocket实时推送**
   - 实时监控数据推送
   - 告警实时通知

2. **更多监控指标**
   - 数据库性能监控
   - 网络I/O监控
   - 业务指标扩展

3. **可视化增强**
   - 图表展示
   - 趋势分析
   - 报表生成

4. **告警通知**
   - 邮件通知
   - 短信通知
   - 钉钉/企业微信通知

---

## 📝 总结

LogTool监控系统提供了完整的系统监控解决方案，包括：

✅ **实时监控** - 系统状态、性能指标、业务指标  
✅ **历史数据** - 数据持久化存储和历史分析  
✅ **告警系统** - 智能告警检测和阈值管理  
✅ **可视化面板** - 统一的监控界面  
✅ **数据存储** - 基于Redis的高效存储  

通过这套监控系统，可以：

- 实时了解系统运行状态
- 及时发现和处理问题
- 分析系统性能趋势
- 优化系统配置和性能

监控系统是系统运维的重要工具，建议定期检查和优化监控配置，确保系统稳定运行。
