# Windows 版本的 Nginx 配置文件
# 使用方法：
# 1. 复制此文件到 Nginx 安装目录的 conf 目录
# 2. 修改路径和 server_name
# 3. 在 nginx.conf 中 include 此文件，或直接替换 server 块

# 移动设备检测
map $http_user_agent $is_mobile {
    default 0;
    ~*android|webos|iphone|ipad|ipod|blackberry|iemobile|opera\smini|mobile|palm|windows\sphone 1;
    ~*Mobile|Mobile|MOBILE 1;
}

server {
    listen 80;
    # Windows 配置说明：
    # - 局域网访问：使用内网 IP，如 192.168.1.100
    # - 域名访问：使用域名，如 logtool.local 或 your-domain.com
    # - 接受所有访问：使用 _ （不推荐生产环境）
    server_name 192.168.1.100;  # 改为你的 IP 或域名
    
    # Windows 路径配置（使用正斜杠或双反斜杠）
    # 示例：C:/www/logtool 或 C:\\www\\logtool
    root C:/www/logtool;  # 修改为你的前端构建文件目录
    index index.html;
    
    # 日志配置（Windows 路径）
    access_log C:/nginx/logs/logtool-access.log;
    error_log C:/nginx/logs/logtool-error.log;
    
    # 字符集
    charset utf-8;

    # 静态资源缓存配置（1年）- 最高优先级
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        # WebSocket 支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # 健康检查接口代理
    location /health {
        proxy_pass http://localhost:3000/health;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_buffering off;
    }

    # WebSocket 支持（独立路径）
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 特殊超时设置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # 移动端路径处理
    location = /m {
        return 301 /m/;
    }

    location ^~ /m/ {
        try_files $uri $uri/ /index.html;
    }

    # 主要入口页面 - 移动设备自动重定向
    location = / {
        if ($is_mobile) {
            return 301 /m;
        }
        try_files $uri $uri/ /index.html;
    }

    location = /login {
        if ($is_mobile) {
            return 301 /m/login;
        }
        try_files $uri $uri/ /index.html;
    }

    location = /register {
        if ($is_mobile) {
            return 301 /m/login;
        }
        try_files $uri $uri/ /index.html;
    }

    # 桌面端路径通用处理
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 文件上传大小限制（500MB）
    client_max_body_size 500M;
    
    # 请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 超时设置
    client_body_timeout 60s;
    client_header_timeout 60s;
}

