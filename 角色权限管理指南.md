# 角色权限管理指南

## 概述

本文档详细说明了如何修改和管理系统中的角色权限，特别是如何为专家用户添加多语言管理权限。

## 当前角色配置

系统目前定义了以下角色：

### 1. 管理员 (ADMIN)
- **ID**: 1
- **名称**: admin
- **描述**: 拥有所有权限，可以管理用户和角色
- **权限**: 所有权限

### 2. 专家用户 (EXPERT)
- **ID**: 2
- **名称**: expert
- **描述**: 拥有故障码管理权限，可查看所有日志，但不能管理用户
- **权限**: 
  - 故障码管理：增删改查、导出
  - 日志管理：上传、查看所有、解析、下载、删除自己的日志
  - 多语言管理：增删改查
  - 历史记录：查看自己的记录

### 3. 普通用户 (USER)
- **ID**: 3
- **名称**: user
- **描述**: 基础权限，可查询故障码、上传日志、查看所有日志但只能删除自己的日志
- **权限**:
  - 故障码查询：查看、导出
  - 日志管理：上传、查看所有、解析、下载、删除自己的日志
  - 多语言查询：查看
  - 历史记录：查看自己的记录

### 4. 审计员 (AUDITOR)
- **ID**: 4
- **名称**: auditor
- **描述**: 审计员，只能查看历史记录和日志，不能进行修改操作
- **权限**: 只读权限

## 权限列表

系统定义了以下权限类型：

### 用户管理权限
- `user:create` - 创建用户
- `user:read` - 查看用户
- `user:update` - 更新用户
- `user:delete` - 删除用户
- `user:role:assign` - 分配用户角色

### 角色管理权限
- `role:create` - 创建角色
- `role:read` - 查看角色
- `role:update` - 更新角色
- `role:delete` - 删除角色

### 故障码管理权限
- `error_code:create` - 创建故障码
- `error_code:read` - 查看故障码
- `error_code:update` - 更新故障码
- `error_code:delete` - 删除故障码
- `error_code:export` - 导出故障码

### 日志管理权限
- `log:upload` - 上传日志
- `log:read_all` - 查看所有用户的日志
- `log:read_own` - 查看自己的日志
- `log:parse` - 解析日志
- `log:download` - 下载日志
- `log:delete` - 删除任何日志
- `log:delete_own` - 删除自己的日志

### 多语言管理权限
- `i18n:create` - 创建多语言内容
- `i18n:read` - 查看多语言内容
- `i18n:update` - 更新多语言内容
- `i18n:delete` - 删除多语言内容

### 历史记录权限
- `history:read_all` - 查看所有历史记录
- `history:read_own` - 查看自己的历史记录
- `history:export` - 导出历史记录

## 如何修改角色权限

### 方法一：直接修改配置文件

1. 打开 `backend/src/config/roles.js` 文件
2. 找到要修改的角色配置
3. 在 `permissions` 数组中添加或删除权限

**示例：为专家用户添加多语言管理权限**

```javascript
EXPERT: {
  id: 2,
  name: 'expert',
  description: '拥有故障码管理权限，可查看所有日志，但不能管理用户',
  permissions: [
    // 故障码管理权限
    'error_code:create',
    'error_code:read',
    'error_code:update',
    'error_code:delete',
    'error_code:export',
    
    // 日志管理权限
    'log:upload',
    'log:read_all',
    'log:read_own',
    'log:parse',
    'log:download',
    'log:delete_own',
    
    // 多语言管理权限 - 新添加的权限
    'i18n:create',
    'i18n:read',
    'i18n:update',
    'i18n:delete',
    
    // 历史记录权限
    'history:read_own'
  ]
}
```

### 方法二：通过数据库修改

1. 连接到数据库
2. 查看 `roles` 表获取角色ID
3. 查看 `permissions` 表获取权限ID
4. 在 `role_permissions` 表中添加或删除关联

**SQL示例：**

```sql
-- 查看角色
SELECT * FROM roles;

-- 查看权限
SELECT * FROM permissions;

-- 为专家用户添加多语言管理权限
INSERT INTO role_permissions (role_id, permission_id) VALUES 
(2, (SELECT id FROM permissions WHERE name = 'i18n:create')),
(2, (SELECT id FROM permissions WHERE name = 'i18n:update')),
(2, (SELECT id FROM permissions WHERE name = 'i18n:delete'));
```

### 方法三：通过API接口修改

如果系统提供了角色管理API，可以通过API接口修改：

```javascript
// 更新专家用户角色权限
const updateRolePermissions = async () => {
  const response = await fetch('/api/roles/2/permissions', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${adminToken}`
    },
    body: JSON.stringify({
      permissions: [
        'error_code:create',
        'error_code:read',
        'error_code:update',
        'error_code:delete',
        'error_code:export',
        'log:upload',
        'log:read_all',
        'log:read_own',
        'log:parse',
        'log:download',
        'log:delete_own',
        'i18n:create',    // 新添加
        'i18n:read',      // 新添加
        'i18n:update',    // 新添加
        'i18n:delete',    // 新添加
        'history:read_own'
      ]
    })
  });
};
```

## 权限检查机制

### 后端权限检查

系统使用中间件进行权限检查：

```javascript
// 在路由中使用权限检查
router.post('/', auth, checkPermission('i18n:create'), upsertI18nText);
router.get('/', auth, checkPermission('i18n:read'), getI18nTexts);
router.delete('/:id', auth, checkPermission('i18n:delete'), deleteI18nText);
```

### 前端权限检查

前端使用Vuex store进行权限检查：

```javascript
// 权限检查函数
const canCreate = computed(() => {
  return store.getters['auth/hasPermission']('i18n:create')
});

const canUpdate = computed(() => {
  return store.getters['auth/hasPermission']('i18n:update')
});

const canDelete = computed(() => {
  return store.getters['auth/hasPermission']('i18n:delete')
});
```

## 测试权限修改

### 1. 创建测试用户

```sql
-- 创建专家测试用户
INSERT INTO users (username, email, password_hash, created_at, updated_at) 
VALUES ('expert_test', 'expert@test.com', '$2b$10$...', NOW(), NOW());

-- 分配专家角色
INSERT INTO user_roles (user_id, role_id) VALUES 
((SELECT id FROM users WHERE username = 'expert_test'), 2);
```

### 2. 运行测试脚本

使用提供的测试脚本验证权限：

```bash
cd backend
node test-expert-permissions.js
```

### 3. 手动测试

1. 使用专家用户登录系统
2. 访问多语言管理页面
3. 尝试执行增删改查操作
4. 验证权限是否正常工作

## 常见问题

### Q: 修改权限后需要重启服务器吗？
A: 是的，修改 `roles.js` 配置文件后需要重启后端服务器。

### Q: 如何添加新的权限类型？
A: 
1. 在 `roles.js` 中定义新权限
2. 在相应的路由中添加权限检查
3. 在前端组件中添加权限判断
4. 更新数据库权限表（如果需要）

### Q: 如何为特定用户分配多个角色？
A: 在 `user_roles` 表中为同一用户添加多个角色记录。

### Q: 权限检查失败怎么办？
A: 
1. 检查用户是否正确分配了角色
2. 检查角色是否包含所需权限
3. 查看后端日志中的权限检查调试信息
4. 确认前端权限检查逻辑正确

## 最佳实践

1. **权限最小化原则**: 只给用户必要的权限
2. **定期审查**: 定期检查和更新用户权限
3. **测试验证**: 修改权限后及时测试验证
4. **文档记录**: 记录权限变更的原因和影响
5. **备份配置**: 修改前备份原始配置文件

## 联系支持

如果在权限管理过程中遇到问题，请联系系统管理员或查看系统日志获取详细错误信息。 