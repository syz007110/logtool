user  www www;
worker_processes auto;
error_log  /www/wwwlogs/nginx_error.log  crit;
pid        /www/server/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;

stream {
    log_format tcp_format '$time_local|$remote_addr|$protocol|$status|$bytes_sent|$bytes_received|$session_time|$upstream_addr|$upstream_bytes_sent|$upstream_bytes_received|$upstream_connect_time';
  
    access_log /www/wwwlogs/tcp-access.log tcp_format;
    error_log /www/wwwlogs/tcp-error.log;
    include /www/server/panel/vhost/nginx/tcp/*.conf;
}

events
    {
        use epoll;
        worker_connections 51200;
        multi_accept on;
    }

http
    {
        include       mime.types;
		#include luawaf.conf;

		#include proxy.conf;
        lua_package_path "/www/server/nginx/lib/lua/?.lua;;";

        default_type  application/octet-stream;

        server_names_hash_bucket_size 512;
        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;
        client_max_body_size 50m;

        sendfile   on;
        tcp_nopush on;

        keepalive_timeout 60;

        tcp_nodelay on;

        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        fastcgi_temp_file_write_size 256k;
		fastcgi_intercept_errors on;

        gzip on;
        gzip_min_length  1k;
        gzip_buffers     4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 5;
        gzip_types     text/plain application/javascript application/x-javascript text/javascript text/css application/xml application/json image/jpeg image/gif image/png font/ttf font/otf image/svg+xml application/xml+rss text/x-js;
        gzip_vary on;
        gzip_proxied   expired no-cache no-store private auth;
        gzip_disable   "MSIE [1-6]\.";

        limit_conn_zone $binary_remote_addr zone=perip:10m;
		limit_conn_zone $server_name zone=perserver:10m;

        server_tokens off;
        access_log off;

# LogTool Nginx 配置示例
# 
# 使用方法:
#   1. 复制此文件到 /etc/nginx/sites-available/logtool
#   2. 修改 server_name 和路径
#   3. 创建软链接: sudo ln -s /etc/nginx/sites-available/logtool /etc/nginx/sites-enabled/
#   4. 测试配置: sudo nginx -t
#   5. 重载 Nginx: sudo systemctl reload nginx

# HTTP 服务器配置
# 注意：server_name 可以使用域名或 IP 地址
# - 有域名：server_name example.com;
# - 只有IP：server_name 192.168.1.100; 或直接使用 default_server
# - 允许所有访问：server_name _; （不推荐生产环境）

    # 移动设备检测 - 定义移动设备的 User-Agent 模式
map $http_user_agent $is_mobile {
    default 0;
    ~*android|webos|iphone|ipad|ipod|blackberry|iemobile|opera\smini|mobile|palm|windows\sphone 1;
    ~*Mobile|Mobile|MOBILE 1;
}
server {
    listen 80;
    server_name 42.121.15.87;  # 使用下划线表示接受所有域名/IP访问，或者改为你的域名/IP（如：192.168.1.100）
    
    # 日志配置
    access_log /www/wwwlogs/logtool-access.log;
    error_log /www/wwwlogs/logtool-error.log;
    # 前端静态文件目录
    root /www/server/logtool;
    index index.html;


    # 静态资源缓存配置（1年）- 最高优先级，优先匹配
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        # 静态资源不需要重定向，直接返回
        try_files $uri =404;
    }

    # 后端 API 代理 - 移动端和桌面端共用同一个 API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        # WebSocket 支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # 健康检查接口代理（不受速率限制，无需认证）
    location /health {
        proxy_pass http://localhost:3000/health;
        proxy_http_version 1.1;
        
        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        
        # 缓冲设置
        proxy_buffering off;
    }

    # WebSocket 支持（如果需要独立路径）
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 特殊超时设置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # 移动端路径 - 如果已经是移动端路径，正常处理（避免循环重定向）
    # 移动端路径重写：/m 及其子路径都回退到单页入口
    location = /m {
        return 301 /m/;
    }

    location ^~ /m/ {
        try_files $uri $uri/ /index.html;
    }

    # 主要入口页面 - 移动设备访问时自动重定向到移动端
    # 只重定向入口页面，其他页面由前端 Vue Router 处理
    location = / {
        if ($is_mobile) {
            return 301 /m;
        }
        try_files $uri $uri/ /index.html;
    }

    location = /login {
        if ($is_mobile) {
            return 301 /m/login;
        }
        try_files $uri $uri/ /index.html;
    }

    location = /register {
        if ($is_mobile) {
            return 301 /m/login;
        }
        try_files $uri $uri/ /index.html;
    }


    # 桌面端路径通用处理
    # 注意：这里不再对移动设备进行重定向，因为：
    # 1. 主要入口页面已经重定向了
    # 2. 用户可能手动输入桌面端路径，或者从其他地方链接过来
    # 3. Vue Router 可以根据路径自动加载对应的组件
    # 4. 如果需要在所有桌面端路径都重定向，可以取消下面的注释
    location / {
        # 可选：如果希望所有桌面端路径都重定向到移动端，取消下面的注释
        # if ($is_mobile) {
        #     return 301 /m;
        # }
        try_files $uri $uri/ /index.html;
    }

    # 文件上传大小限制（500MB）- 覆盖 http 块的 50m 设置
    client_max_body_size 500M;
    
    # 请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 超时设置
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # 注意：gzip 压缩已在 http 块配置，此处无需重复配置
    # server 块会自动继承 http 块的 gzip 设置
}
}
# HTTPS 服务器配置（如果使用 SSL）
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
# 
#     # SSL 证书配置（Let's Encrypt）
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/your-domain.com/chain.pem;
# 
#     # SSL 安全配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
# 
#     # HSTS
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
# 
#     # 其他配置与 HTTP 服务器相同
#     # ... (复制上面的 location 块)
# }
# 
# # HTTP 重定向到 HTTPS
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

