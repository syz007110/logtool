# 状态机图表实现说明

## 功能概述

本实现为手术统计页面添加了一个状态机变化曲线图，用于可视化显示手术过程中状态机的变化情况。图表基于Chart.js实现，具有以下特性：

1. **曲线图显示**：使用折线图而非柱状图，更直观地显示状态变化趋势
2. **绝对时间横坐标**：使用日志中的绝对时间作为横坐标，跨天时自动标记日期
3. **过滤的纵坐标**：只显示状态机定义中明确存在的状态值作为刻度
4. **非等比例间距**：纵坐标使用自定义间距映射，避免标签重叠
5. **横向滚动条**：提供可视化的滚动条控件，确保每次只显示5分钟的状态机数据
6. **鼠标滚轮支持**：支持鼠标滚轮进行时间轴滚动
7. **5分钟固定窗口**：默认显示手术开始后前5分钟的数据，支持时间轴滚动但不改变显示比例
8. **智能滚动条交互**：支持直接点击滚动条轨道跳转到对应时间段，优化拖拽体验
9. **时间轴标签优化**：横坐标显示当前5分钟窗口的起始和结束时间

## 技术实现

### 核心依赖
- **Vue.js 3**：使用Composition API进行响应式数据管理
- **Chart.js 4.5.0**：图表渲染引擎
- **Element Plus**：UI组件库

### 关键函数

#### 1. 数据准备函数
```javascript
const getStateMachineChartData = (surgery) => {
  // 解析状态机变化数据
  // 过滤手术开始后的数据
  // 计算5分钟时间窗口
  // 生成图表标签和数据
}
```

#### 2. 图表配置函数
```javascript
const getStateMachineChartOptions = (surgery) => {
  // 配置横坐标：绝对时间显示，跨天日期标记，起始结束时间标签
  // 配置纵坐标：过滤刻度，非等比例间距
  // 配置工具提示：显示状态名称和详细信息
}
```

#### 3. 状态间距映射
```javascript
const getStateSpacingMap = () => ({
  0: 0, 1: 2, 2: 4, 10: 8, 12: 10, 13: 12, 14: 14, 15: 16,
  20: 20, 21: 22, 30: 26, 31: 28
})
```

#### 4. 滚动条功能
```javascript
// 滚动条轨道点击处理
const handleTrackClick = (event, surgery) => {
  // 计算点击位置对应的目标时间
  // 直接跳转到对应的时间段
}

// 滚动条滑块样式计算
const getScrollbarThumbStyle = (surgery) => {
  // 计算滑块位置和宽度
  // 基于当前视图范围相对于总时间范围的比例
}

// 滚动条拖拽处理
const startScrollbarDrag = (event, surgery) => {
  // 开始拖拽，添加全局事件监听
  // 防止触发轨道点击事件
}

const handleScrollbarDrag = (event, surgery) => {
  // 处理拖拽过程中的时间更新
  // 基于总时间范围计算拖拽变化
}

// 左右滚动按钮
const scrollChartLeft = (surgery) => {
  // 向左滚动1分钟
}

const scrollChartRight = (surgery) => {
  // 向右滚动1分钟
}
```

## 使用方法

### 基本操作
1. **查看图表**：在手术统计页面选择任意手术，状态机图表会自动显示
2. **鼠标滚轮滚动**：在图表区域使用鼠标滚轮进行时间轴滚动
3. **滚动条操作**：
   - **直接点击**：点击滚动条轨道的任意位置直接跳转到对应时间段
   - **拖拽滑块**：拖拽滚动条滑块进行精确时间定位
   - **点击按钮**：点击左右箭头按钮进行精确滚动
   - **查看信息**：查看滚动条信息了解当前时间范围

### 滚动条控件
- **轨道**：显示整个手术时间范围，支持直接点击跳转
- **滑块**：显示当前5分钟窗口在整个手术时间中的位置
- **左箭头**：向左滚动1分钟（当可以向左滚动时启用）
- **右箭头**：向右滚动1分钟（当可以向右滚动时启用）
- **时间信息**：显示当前视图的时间范围（格式：HH:MM - HH:MM (5分钟)）

### 横坐标时间显示
- **起始时间**：显示当前5分钟窗口的开始时间（HH:MM:SS）
- **结束时间**：显示当前5分钟窗口的结束时间（HH:MM:SS）
- **中间刻度**：显示窗口内的其他时间点

## 文件修改

### 主要修改文件
- `frontend/src/views/SurgeryStatistics.vue`

### 新增功能
1. **滚动条轨道点击**：支持点击滚动条轨道直接跳转到对应时间段
2. **拖拽体验优化**：改进拖拽算法，基于总时间范围计算变化
3. **事件冲突处理**：防止拖拽和点击事件冲突
4. **横坐标时间标签**：在横坐标显示当前5分钟窗口的起始和结束时间
5. **视觉反馈增强**：滚动条滑块添加阴影效果，提升视觉体验

### 样式优化
- 滚动条轨道：浅灰色背景，圆角边框，支持点击
- 滚动条滑块：蓝色主题色，悬停和拖拽状态变化，添加阴影效果
- 控制按钮：与图表重置按钮保持一致的样式
- 信息显示：居中显示，固定宽度确保布局稳定

## 坐标轴配置

### 横坐标（X轴）
- **类型**：时间轴
- **数据源**：日志中的绝对时间
- **格式**：
  - 同一天：`HH:MM:SS`
  - 跨天：`MM-DD HH:MM`
- **刻度限制**：最多显示10个刻度
- **标题**：显示"时间"
- **特殊标签**：第一个和最后一个刻度显示当前5分钟窗口的起始和结束时间

### 纵坐标（Y轴）
- **范围**：0-30（映射后的最大值）
- **刻度生成**：使用`afterBuildTicks`回调函数
- **显示策略**：只显示状态机定义中明确存在的状态值
- **间距映射**：使用非等比例间距避免标签重叠
- **标题**：显示"状态机状态"

#### 重要说明：纵坐标刻度过滤
```javascript
afterBuildTicks: function(axis) {
  const definedStates = [0, 1, 2, 10, 12, 13, 14, 15, 20, 21, 30, 31]
  const spacingMap = getStateSpacingMap()
  axis.ticks = definedStates.map(value => ({
    value: spacingMap[value] || value,
    label: value.toString()
  }))
}
```

## 状态机定义

基于需求文档中的状态机定义，支持以下状态：
- 0: 初始化（S00）
- 1: 使能（S01）
- 2: 自检（S02）
- 10: 待机（S10）
- 12: 从手调整（S12）
- 13: 主手跟随（S13）
- 14: 断开主从/离合（S14）
- 15: 初始化（S00）
- 20: 主从控制（S20）
- 21: 内窥镜控制（S21）
- 30: 错误（S30）
- 31: 关机（S31）

## 滚动条功能详解

### 滚动条组件结构
```html
<div class="chart-scrollbar-container">
  <div class="scrollbar-track" @click="handleTrackClick($event, surgery)">
    <div class="scrollbar-thumb" :style="getScrollbarThumbStyle(surgery)"></div>
  </div>
  <div class="scrollbar-controls">
    <el-button @click="scrollChartLeft(surgery)">左箭头</el-button>
    <span class="scrollbar-info">{{ getScrollbarInfo(surgery) }}</span>
    <el-button @click="scrollChartRight(surgery)">右箭头</el-button>
  </div>
</div>
```

### 滚动条交互逻辑
1. **轨道点击**：
   - 计算点击位置占总宽度的百分比
   - 根据百分比计算目标时间
   - 直接跳转到对应的时间段
   - 确保跳转后5分钟窗口完整显示

2. **滑块拖拽**：
   - 鼠标按下时开始拖拽
   - 拖拽过程中实时更新图表时间
   - 基于总时间范围计算拖拽变化
   - 鼠标释放时结束拖拽

3. **按钮控制**：
   - 左箭头：时间向前滚动1分钟
   - 右箭头：时间向后滚动1分钟
   - 按钮状态根据可滚动范围自动启用/禁用

4. **边界检查**：
   - 确保滚动不会超出手术时间范围
   - 保持5分钟窗口的完整性

### 横坐标时间标签优化
```javascript
afterBuildTicks: function(axis) {
  const originalTicks = [...axis.ticks]
  
  if (originalTicks.length > 0 && this.chart && this.chart.data && this.chart.data.rawData && this.chart.data.rawData.length > 0) {
    const startTime = new Date(this.chart.data.rawData[0].time)
    const startLabel = startTime.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    })
    
    const endTime = new Date(this.chart.data.rawData[this.chart.data.rawData.length - 1].time)
    const endLabel = endTime.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    })
    
    originalTicks[0].label = startLabel
    originalTicks[originalTicks.length - 1].label = endLabel
  }
  
  axis.ticks = originalTicks
}
```

## 测试建议

### 功能测试
1. **基本显示**：验证图表能正确显示状态机变化数据
2. **时间轴滚动**：测试鼠标滚轮滚动功能
3. **滚动条点击**：测试点击滚动条轨道直接跳转功能
4. **滚动条拖拽**：测试滚动条滑块的拖拽功能
5. **按钮控制**：测试左右滚动按钮的功能
6. **边界情况**：测试在手术开始和结束时的滚动限制
7. **时间标签**：验证横坐标显示正确的起始和结束时间

### 数据测试
1. **跨天数据**：测试跨天手术的日期显示
2. **状态过滤**：验证只有定义的状态值显示在纵坐标
3. **时间精度**：验证时间显示的准确性
4. **跳转精度**：验证点击跳转的时间精度

### 性能测试
1. **大数据量**：测试长时间手术数据的渲染性能
2. **频繁滚动**：测试快速滚动时的响应性能
3. **内存使用**：监控长时间使用时的内存占用
4. **交互响应**：测试拖拽和点击的响应速度

## 注意事项

1. **数据依赖**：图表依赖于`surgery.state_machine_changes`数据
2. **时间格式**：确保手术开始和结束时间格式正确
3. **状态映射**：状态机定义需要与后端数据保持一致
4. **滚动性能**：大量数据时滚动可能需要优化
5. **响应式设计**：图表容器需要合适的尺寸设置
6. **事件处理**：拖拽和点击事件需要正确处理冲突
7. **时间精度**：确保时间计算和显示的精度
