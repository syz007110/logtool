# logTool 项目概要

## 主要需求

- 支持故障码的增删改查
- 支持日志上传、解密、分析、解密后下载
- 账户管理（注册、登录、权限、注销）
- 故障码的解释需要支持翻译多国语言且可拓展，支持导出 XML
- 系统支持中英文切换

## 技术架构

- 前端：Vue.js + Element UI/Vuetify + Vuex + Vue Router + Vue I18n
- 后端：Node.js + Express.js + JWT + bcrypt + MySQL

## 数据库表结构（已设计）

- 用户表（users）：存储用户信息、密码哈希、激活状态等
- 权限表（roles）：定义不同权限/角色
- 用户-权限关联表（user_roles）：多对多关联
- 故障码表（error_codes）：详见 db_schema.sql，支持多语言字段
- 日志表（logs）：存储上传日志的元数据、解密状态等
- 多语言配置表（i18n_texts）：便于后续扩展多语言内容

## 具体需求

\*\*故障码管理

- 前端页面可以显示所以故障码数据库中的内容；
  表头内容如下
  subsystem、code、userInfo（user_hint 和 operation 合并，逗号拼接）、param1、param2、param3、param4、category
- 支持不同用户类型对于故障码的增删改查；
- 支持对于故障码数据的简单搜索搜索；
- 支持导出故障码数据库内的数据至指定的 XML 格式文件；

\*\*日志管理功能

- 支持上传日志文件，可以同时上传多个文件，总大小不超过 200MB，文件个数不超过 50 个；
- 文件名格式：
  定义：日志记录年份|日志记录月份|日志记录日期|日志记录小时| 后缀名
  格式：YYYY |MM |DD |HH |.medbot
  例 ：2024010205.medbot
- 日志解密后才能具有可读性，解密的逻辑与 decode.py 逻辑一致
- 日志绑定唯一的解密密钥，解密密钥对应唯一的设备编号；
- 当用户输入密钥点击自动填充，通过检索 logs 数据表的方式自动填充设备编号，当用户输入设备编号点击自动填充，自动填充密钥；
- 上传日志的同时需要上传密钥，并填写设备编号，设备编号的格式为：XXXX-XX(例 4371-01)；
- 密钥支持输入或上传密钥文件，密钥文件名为：systemInfo.txt，存储的内容是 mac 地址(例如 00-01-05-77-6a-09)，上传需要对密钥格式检验，若不符合提示用户；
- 日志文件以每一个小时为单位生成一个.medbot 日志文件；
- 上传并解密的日志存储在服务器指定的路径中，文件名与上传的文件保持一致，格式 txt;
- 解密后的日志包含内容：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义
  其中释义，可以通过解密后的提取故障码首位+('0X'+故障码后 4 位) 去匹配 error_codes 表中的 subsystem+code 获得对应的 explanation 字段获得；
  释义进一步转义规则补充：数据库中释义语句可能包含{i:d},表示需要指定当前位置匹配，i 为第 i 个参数，d 为转义表中的下标，若 d=0 则按照纯物理量转义。表示当前位置按照第 i 个参数的值，从第 d 个转义表（backend/config/FaultMappings.json）中查询并替换。
  例子：0x551E 调整臂调整按键{2:2}按下。臂号为{0:0} 臂号，上一个状态，当前状态，0
  若 p0=3，p2=1，以上故障码释译为 「调整臂调整按键已按下。臂号为 3」.
  解密后内容（结构化数据）：存入 log_entries 表
  解密后文件：保存在服务器磁盘（如 uploads/logs/），用于下载或备查。相同设备编号或相同密钥的日志存储在同一个以设备编号命名的文件夹内；
- 交互界面上，日志列表的表头：设备号 日志文件名 上传用户 ID 上传时间 操作；其中操作包括：删除、下载、分析
  下载：下载的是解密后的日志文件；
  删除：删除数据库中对应的日志内容，并且删除 uploads/logs/对应的日志解密文件
  分析：
  以列表形式显示当前选择的所有日志中的具体内容；表头：时间戳、故障码、参数 1、参数 2、参数 3、参数 4、释义；
  支持搜索、筛选功能；
  支持通过选择时间段筛选满足要求的日志；
- 日志列表支持筛选功能，可以通过设备编号，上传用户 ID、上传时间进行筛选；
- 日志列表可以通过多选的方式进行批量操作，

\*\*本系统的操作日志记录功能

- 针对以下功能增加日志记录
  添加用户
  路由：POST /api/users
  日志内容：操作类型“添加用户”，描述、操作人、IP、UA、详情（用户名、邮箱、角色等）
  修改用户
  路由：PUT /api/users/:id
  日志内容：操作类型“修改用户”，描述、操作人、IP、UA、详情（用户 ID、邮箱、状态、角色等）
  删除用户
  路由：DELETE /api/users/:id
  日志内容：操作类型“删除用户”，描述、操作人、IP、UA、详情（用户 ID、用户名）

## 角色权限系统

### 权限矩阵

| 权限              | 管理员 | 专家用户 | 普通用户 | 说明                   |
| ----------------- | ------ | -------- | -------- | ---------------------- |
| **用户管理**      |        |          |          |                        |
| user:read         | ✅     | ❌       | ❌       | 查询用户列表、用户详情 |
| user:create       | ✅     | ❌       | ❌       | 创建新用户             |
| user:update       | ✅     | ❌       | ❌       | 修改用户信息           |
| user:delete       | ✅     | ❌       | ❌       | 删除用户               |
| user:role:assign  | ✅     | ❌       | ❌       | 分配用户角色           |
| **角色管理**      |        |          |          |                        |
| role:read         | ✅     | ❌       | ❌       | 查询角色列表、角色详情 |
| role:create       | ✅     | ❌       | ❌       | 创建新角色             |
| role:update       | ✅     | ❌       | ❌       | 修改角色信息           |
| role:delete       | ✅     | ❌       | ❌       | 删除角色               |
| **故障码管理**    |        |          |          |                        |
| error_code:read   | ✅     | ✅       | ✅       | 查询故障码列表         |
| error_code:create | ✅     | ✅       | ❌       | 创建新故障码           |
| error_code:update | ✅     | ✅       | ❌       | 修改故障码信息         |
| error_code:delete | ✅     | ✅       | ❌       | 删除故障码             |
| error_code:export | ✅     | ✅       | ✅       | 导出故障码到 XML       |
| **多语言管理**    |        |          |          |                        |
| i18n:read         | ✅     | ✅       | ✅       | 查询多语言配置         |
| i18n:create       | ✅     | ❌       | ❌       | 创建多语言配置         |
| i18n:update       | ✅     | ❌       | ❌       | 修改多语言配置         |
| i18n:delete       | ✅     | ❌       | ❌       | 删除多语言配置         |
| **日志管理**      |        |          |          |                        |
| log:upload        | ✅     | ✅       | ✅       | 上传日志文件           |
| log:read_all      | ✅     | ✅       | ❌       | 查看所有用户日志       |
| log:read_own      | ✅     | ✅       | ✅       | 查看自己的日志         |
| log:parse         | ✅     | ✅       | ✅       | 解析日志文件           |
| log:download      | ✅     | ✅       | ✅       | 下载日志文件           |
| log:delete        | ✅     | ❌       | ❌       | 删除任何日志           |
| log:delete_own    | ✅     | ✅       | ✅       | 删除自己的日志         |

### 角色说明

#### 管理员 (ID: 1)

拥有所有权限，可以管理用户、角色、故障码、日志和多语言配置。

#### 专家用户 (ID: 2)

专注于故障码管理和日志分析，可以管理故障码、查看所有日志，但不能管理用户和角色。

#### 普通用户 (ID: 3)

基础操作权限，可以查询故障码、上传和管理自己的日志，但不能进行管理操作。

## 账户管理与个人信息权限细化

### 账户管理（用户管理板块）

- 仅管理员用户可以在 dashboard 左侧菜单看到“账户管理”板块（即“用户管理”页面）。
- 管理员可以：
  - 查看所有用户的账户信息，信息以列表形式展现，字段包括：用户名、密码（仅支持重置/修改入口，不显示明文）、账户类型（角色）、是否启用（状态）、注册时间。
  - 支持修改所有用户的密码（重置密码功能，点击按钮弹窗输入新密码）。
  - 支持修改所有用户的账户类型（角色分配/变更）。
  - 支持搜索、编辑、删除所有用户。
  - 每行最后有“修改”按钮，可编辑该用户信息。
- 非管理员用户（专家用户、普通用户）无法看到“账户管理”板块，也无法访问用户管理相关页面和接口。

### 个人信息（右上角个人菜单）

- 所有登录用户（包括管理员、专家用户、普通用户）都可以通过右上角菜单进入“个人信息”页面。
- 登录后，右上角始终显示当前用户的用户名。
- 个人信息页面仅显示当前登录用户自己的信息（用户名、邮箱、角色、注册时间等）。
- 所有用户都可以在个人信息页面修改自己的邮箱和密码。
- 个人信息页面不允许用户修改自己的角色、用户名等敏感信息。

## 前端

需要有登入页面：包含以下功能 1.登入功能； 2.注册功能 3.忘记密码功能 4.中英文切换；

首页：至少包含板块， 1.故障码查询； 2.日志解析； 3.账户信息管理； 4.历史日志记录查询；

### 典型场景

- 管理员登录后，左侧菜单有“用户管理”入口，可管理所有账户。
- 普通用户或专家用户登录后，左侧菜单没有“用户管理”入口，只能通过右上角菜单查看和修改自己的个人信息。

## 进展记录

- 完成数据库表结构设计，已写入 db_schema.sql
- 明确项目需求与技术选型
- 完成 Sequelize 用户模型（users）、故障码模型（error_codes）文件创建。
- 完成 Sequelize 角色模型（roles）、用户-角色关联模型（user_roles）、日志模型（logs）、多语言配置模型（i18n_texts）文件创建。
- 完成用户注册、登录接口，JWT 认证中间件，路由挂载等功能开发。
- 完成故障码管理接口（增删改查、支持多语言字段、路由挂载等）开发。
- 完成日志上传、解密、查询、下载接口及路由挂载等功能开发。
- 完成故障码导出 XML 接口（多语言、格式预留、路由挂载等）开发。
- 完成多语言配置接口（增删改查、路由挂载等）开发。
- 完成用户管理、角色管理接口（增删改查、分配权限、路由挂载等）开发。
- 创建 API 测试工具和文档，包括自动化测试脚本(test-api.js)、详细测试指南(API_TEST_GUIDE.md)和快速启动脚本(start-backend.bat)。
- 修复数据库模型配置中的环境变量路径问题，确保.env 文件正确加载。
- 发现并解决数据库连接失败问题：环境变量未正确加载导致用户名为空，需要创建.env 配置文件。
- 定义三种角色类型：管理员、普通用户、专家用户，并明确各角色的权限范围。
- 更新 API 测试指南，整合所有测试脚本的使用方法和详细说明。
- **权限控制系统完善**：为所有管理功能添加权限控制中间件，确保敏感数据只对管理员开放
- **修复 Sequelize 关联查询错误**：修复权限检查中间件中的关联查询别名问题，确保权限检查正常工作
- **添加认证流程调试**：为认证中间件添加详细调试信息，帮助排查 JWT token 问题
- **完善权限初始化系统**：创建完整的权限初始化脚本，确保用户角色正确分配
- **权限系统验证完成**：所有用户角色分配正确，权限控制完全正常工作
- **用户角色分配安全修复**：修复用户角色分配功能缺少 JWT 认证中间件的问题，确保所有角色分配操作都需要有效的 token 验证
- **前端开发完成**：基于 Vue.js 3 + Element Plus 创建完整的前端界面，包含登录、注册、忘记密码、故障码管理、日志解析、账户管理、历史记录、用户管理、角色管理等所有功能页面
- **前端功能实现**：完成用户认证、权限控制、国际化、文件上传、数据表格、表单验证、分页等核心功能
- **前端路由配置**：实现完整的路由系统，支持路由守卫和权限控制
- **前端状态管理**：使用 Vuex 实现完整的状态管理，包含认证、故障码、日志、用户等模块
- **前端 API 集成**：完成与后端 API 的完整集成，支持所有 CRUD 操作

## 环境配置

### 创建.env 文件

在项目根目录（E:\logTool\）创建 `.env` 文件，包含以下配置：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=yourpassword
DB_NAME=logtool

# JWT 密钥
JWT_SECRET=your_jwt_secret

# 其他配置
PORT=3000
NODE_ENV=development
```

### 重要说明

- `.env`
